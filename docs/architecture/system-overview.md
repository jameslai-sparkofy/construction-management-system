# 系統架構總覽

## 🏗️ 總體架構

元心建材工程管理系統採用 **Cloudflare 全棧解決方案**，實現高效能、低延遲的全球部署。

```
┌─────────────────────────────────────────────────────────────────┐
│                        Cloudflare Edge                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   Cloudflare    │    │   Cloudflare    │    │  Cloudflare  │ │
│  │     Pages       │    │    Workers      │    │      R2      │ │
│  │                 │    │                 │    │              │ │
│  │  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌────────┐  │ │
│  │  │ Frontend  │  │    │  │    API    │  │    │  │ Files  │  │ │
│  │  │   React   │◄─┼────┼─►│  Service  │  │    │  │Storage │  │ │
│  │  │   HTML    │  │    │  │           │  │    │  │        │  │ │
│  │  └───────────┘  │    │  └───────────┘  │    │  └────────┘  │ │
│  └─────────────────┘    └─────────┬───────┘    └──────────────┘ │
│                                   │                             │
├───────────────────────────────────┼─────────────────────────────┤
│                                   ▼                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐ │
│  │   Cloudflare    │    │   Cloudflare    │    │  Cloudflare  │ │
│  │       D1        │    │       KV        │    │   Analytics  │ │
│  │                 │    │                 │    │              │ │
│  │  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌────────┐  │ │
│  │  │Engineering│  │    │  │ Sessions  │  │    │  │ Metrics│  │ │
│  │  │ Database  │  │    │  │   Cache   │  │    │  │  Logs  │  │ │
│  │  │           │  │    │  │           │  │    │  │        │  │ │
│  │  │    CRM    │  │    │  │   Users   │  │    │  │        │  │ │
│  │  │ Database  │  │    │  │           │  │    │  │        │  │ │
│  │  └───────────┘  │    │  └───────────┘  │    │  └────────┘  │ │
│  └─────────────────┘    └─────────────────┘    └──────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
                        ┌─────────────────┐
                        │  External CRM   │
                        │ (紛享銷客 FXiaoKe) │
                        │                 │
                        │  REST API Sync  │
                        └─────────────────┘
```

## 🧩 核心元件

### 1. 前端層 - Cloudflare Pages
- **框架**: Vanilla HTML/CSS/JavaScript (輕量化)
- **特點**: 全球 CDN 分發，極速載入
- **配置**: 
  - 自動 HTTPS
  - 自訂域名支援
  - Git 整合自動部署

### 2. API 層 - Cloudflare Workers
- **運行環境**: V8 Isolate (邊緣計算)
- **特點**: 
  - 零冷啟動時間
  - 全球 200+ 資料中心
  - 原生 ESM 支援
- **Worker 名稱**: `construction-management-api-clerk`
- **自訂域名**: `api.yes-ceramics.com`

### 3. 資料層 - Cloudflare D1
- **引擎**: SQLite (邊緣優化版本)
- **設計**: 雙資料庫架構
  - **DB_ENGINEERING**: 工程管理專用資料
  - **DB_CRM**: CRM 同步資料
- **特點**: 自動備份、全球複製

### 4. 儲存層 - Cloudflare R2 + KV
- **R2**: 物件儲存 (建案照片、文件)
- **KV**: 鍵值儲存 (會話、快取)
- **特點**: S3 相容、無出口費用

## 🔄 資料流向

### 1. 使用者請求流程
```
使用者瀏覽器 → Cloudflare Pages → Worker API → D1 資料庫 → 回應
     ↑                                ↓
   快取回應  ←─ KV 快取 ←──────────────┘
```

### 2. CRM 資料同步流程
```
紛享銷客 CRM → REST API → Worker → DB_CRM → 資料處理 → DB_ENGINEERING
                  ↓
             活動記錄 → project_activity_logs
```

### 3. 檔案上傳流程
```
前端 → 預簽名 URL → R2 直接上傳 → 回調通知 → Worker 更新資料庫
```

## 🎯 架構優勢

### 1. 效能優勢
- **全球邊緣部署**: 200+ 資料中心
- **零冷啟動**: Workers V8 Isolate
- **智慧快取**: KV + Cloudflare Cache
- **CDN 加速**: 靜態資源全球快取

### 2. 開發優勢
- **統一平台**: 所有服務在 Cloudflare
- **簡化部署**: 一鍵部署到全球
- **即時日誌**: 內建監控和分析
- **自動擴縮**: 無需容量規劃

### 3. 成本優勢
- **按需付費**: 只為實際使用付費
- **無基礎設施**: 無需維護伺服器
- **包含 CDN**: 無額外 CDN 費用
- **免費額度**: 開發階段免費

### 4. 安全優勢
- **內建 DDoS**: Cloudflare 原生防護
- **自動 HTTPS**: 免費 SSL 憑證
- **邊緣隔離**: Workers 天然隔離
- **訪問控制**: IP、地區限制

## 🔧 技術決策說明

### 為什麼選擇 Cloudflare 全棧？

#### 1. 整合優勢
- **統一管理**: 所有服務在一個平台
- **內網通信**: 服務間零延遲通信
- **統一計費**: 簡化成本管理
- **技術支援**: 統一技術支援來源

#### 2. 效能考量
- **邊緣計算**: API 在全球 200+ 點執行
- **資料就近**: D1 自動選擇最近節點
- **智慧路由**: Argo 智慧路由優化
- **HTTP/3 支援**: 最新網路協定

#### 3. 開發體驗
- **現代工具**: Wrangler CLI 工具鏈
- **本地開發**: 完整本地模擬環境
- **即時部署**: Git push 自動部署
- **豐富綁定**: D1、KV、R2 無縫整合

### 混合式資料庫設計

#### 為什麼使用雙資料庫？
1. **資料隔離**: CRM 資料不污染業務邏輯
2. **權限控制**: 不同資料庫不同存取權限
3. **效能優化**: 業務查詢不受 CRM 同步影響
4. **資料安全**: 降低資料洩漏風險

#### 為什麼採用 JSON + 關聯混合設計？
1. **靈活性**: JSON 欄位適應業務變化
2. **查詢效率**: 關聯欄位支援複雜查詢
3. **開發效率**: 減少資料庫遷移頻率
4. **向後相容**: 新功能不破壞現有結構

## 📊 容量規劃

### 預期負載 (年)
- **專案數**: 100 個
- **使用者數**: 500 個 (工班+業主)
- **API 請求**: 10萬次/月
- **檔案儲存**: 1GB

### Cloudflare 限制
- **Workers**: 100,000 請求/天 (免費)
- **D1**: 25GB 儲存 (付費)
- **R2**: 10GB/月 免費
- **KV**: 100,000 讀取/天 免費

### 擴展策略
- **水平擴展**: Worker 自動擴縮
- **資料庫分片**: 按專案分割資料
- **CDN 最佳化**: 靜態資源最佳化
- **快取策略**: 多層快取設計

## 🔒 安全架構

### 認證系統
- **無密碼設計**: 手機號碼 + 後三碼
- **Session 管理**: KV 儲存 JWT token
- **角色權限**: 基於角色的存取控制 (RBAC)

### 資料安全
- **傳輸加密**: HTTPS/TLS 1.3
- **儲存加密**: D1/KV/R2 原生加密
- **存取控制**: API 級別權限檢查
- **稽核記錄**: 完整操作日誌

### 網路安全
- **DDoS 防護**: Cloudflare 原生防護
- **WAF 規則**: 自訂防護規則
- **Rate Limiting**: API 限流保護
- **IP 白名單**: 管理功能 IP 限制

---

**架構版本**: 1.0.0  
**最後更新**: 2025-08-11  
**線上服務**: https://api.yes-ceramics.com