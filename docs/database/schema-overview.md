# è³‡æ–™åº«è¨­è¨ˆç¸½è¦½

## ğŸ›ï¸ è¨­è¨ˆç†å¿µ

æ¡ç”¨ **æ··åˆå¼è¨­è¨ˆ**ï¼Œçµåˆé—œè¯å¼è³‡æ–™åº«çš„åš´è¬¹æ€§èˆ‡ NoSQL çš„éˆæ´»æ€§ï¼š

- **æ ¸å¿ƒçµæ§‹**: ä½¿ç”¨å‚³çµ±é—œè¯å¼è¡¨æ ¼
- **å½ˆæ€§è³‡æ–™**: ä½¿ç”¨ JSON æ¬„ä½å„²å­˜é…ç½®
- **æ¬Šé™çµ±ä¸€**: å–®ä¸€è¡¨æ ¼ç®¡ç†æ‰€æœ‰æ¬Šé™

## ğŸ“Š è³‡æ–™åº«æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    projects     â”‚    â”‚     users       â”‚    â”‚construction_sitesâ”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ id (TEXT)       â”‚    â”‚ id (TEXT)       â”‚    â”‚ id (TEXT)       â”‚
â”‚ name            â”‚    â”‚ phone           â”‚    â”‚ project_id      â”‚
â”‚ spc_engineering â”‚â—„â”€â” â”‚ password_suffix â”‚    â”‚ opportunity_id  â”‚
â”‚ (JSON)          â”‚  â”‚ â”‚ name            â”‚    â”‚ status          â”‚
â”‚ permissions     â”‚  â”‚ â”‚ global_role     â”‚    â”‚ config (JSON)   â”‚
â”‚ (JSON)          â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
         â”‚            â”‚
         â–¼            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  project_members    â”‚                 â”‚
â”‚                     â”‚                 â”‚
â”‚ project_id â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚ user_id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ member_type ('team'|'owner')         â”‚
â”‚ team_id (å¯é¸)                       â”‚
â”‚ role ('leader'|'member'|'viewer')    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚project_team_        â”‚
          â”‚assignments          â”‚
          â”‚                     â”‚
          â”‚ project_id          â”‚
          â”‚ team_id             â”‚
          â”‚ team_name           â”‚
          â”‚ leader_user_id      â”‚
          â”‚ status              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ƒï¸ æ ¸å¿ƒè¡¨æ ¼ (7å€‹)

### 1. projects - å°ˆæ¡ˆä¸»è¡¨
- **ç”¨é€”**: å°ˆæ¡ˆåŸºæœ¬è³‡è¨Šå’Œè¨­å®š
- **è¨­è¨ˆ**: æ··åˆå¼ (é—œè¯æ¬„ä½ + JSON é…ç½®)
- **JSON æ¬„ä½**: spc_engineering, cabinet_engineering, permissions

### 2. project_members - çµ±ä¸€æ¬Šé™ç®¡ç† â­
- **ç”¨é€”**: çµ±ä¸€ç®¡ç†å·¥ç­æˆå“¡å’Œæ¥­ä¸»æ¬Šé™
- **å‰µæ–°é»**: ç”¨ member_type å€åˆ†é¡å‹ï¼Œé¿å…é‡è¤‡è¨­è¨ˆ
- **æ¬Šé™é‚è¼¯**: role + member_type çµ„åˆæ§åˆ¶

### 3. project_team_assignments - å·¥ç­é…ç½®
- **ç”¨é€”**: å°ˆæ¡ˆå·¥ç­åˆ†é…å’Œé ˜éšŠè³‡è¨Š
- **é—œè¯**: èˆ‡ project_members é…åˆä½¿ç”¨

### 4. users - ä½¿ç”¨è€…è³‡æ–™
- **ç”¨é€”**: çµ±ä¸€ä½¿ç”¨è€…è³‡æ–™ (å·¥ç­ + æ¥­ä¸»)
- **èªè­‰**: æ‰‹æ©Ÿè™Ÿç¢¼ + å¾Œä¸‰ç¢¼å¯†ç¢¼
- **ä¾†æº**: source_type æ¨™è¨˜è³‡æ–™ä¾†æº (CRM)

### 5. construction_sites - æ¡ˆå ´è³‡æ–™
- **ç”¨é€”**: å»ºæ¡ˆæ¡ˆå ´è³‡è¨Š
- **å½ˆæ€§**: config JSON å„²å­˜æ¡ˆå ´ç‰¹æ®Šè¨­å®š

### 6. project_activity_logs - æ´»å‹•è¨˜éŒ„
- **ç”¨é€”**: æ“ä½œæ—¥èªŒå’Œå¯©è¨ˆè¿½è¹¤
- **æ ¼å¼**: changes JSON å„²å­˜è®Šæ›´å…§å®¹

### 7. construction_progress - æ–½å·¥é€²åº¦
- **ç”¨é€”**: æ¡ˆå ´æ–½å·¥ç‹€æ…‹è¿½è¹¤
- **ç‹€æ…‹**: pending, in_progress, completed, repair_needed

## ğŸ”‘ çµ±ä¸€æ¬Šé™è¨­è¨ˆé‡é»

```sql
-- æ ¸å¿ƒè¨­è¨ˆç†å¿µ
CREATE TABLE project_members (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  project_id TEXT NOT NULL,
  user_id TEXT NOT NULL,
  member_type TEXT NOT NULL,  -- 'team' æˆ– 'owner'
  team_id TEXT,              -- team æˆå“¡æ‰æœ‰å€¼
  role TEXT DEFAULT 'member', -- 'leader', 'member', 'viewer'
  UNIQUE(project_id, user_id, team_id)
);
```

### æ¬Šé™é‚è¼¯
- **å·¥ç­æˆå“¡**: member_type='team', team_id=æœ‰å€¼, role='leader'|'member'
- **æ¥­ä¸»**: member_type='owner', team_id=NULL, role='viewer'
- **ç®¡ç†å“¡**: global_role='admin' (åœ¨ users è¡¨)

## ğŸ”„ è³‡æ–™åŒæ­¥ç­–ç•¥

### CRM åŒæ­¥ (DB_CRM â†’ DB_ENGINEERING)
1. **å•†æ©Ÿè³‡æ–™**: opportunities â†’ projects
2. **å·¥ç­è³‡æ–™**: workers â†’ users + project_members  
3. **æ¥­ä¸»è³‡æ–™**: contacts â†’ users + project_members
4. **æ¡ˆå ´è³‡æ–™**: sites â†’ construction_sites

### åŒæ­¥é »ç‡
- **å³æ™‚åŒæ­¥**: å°ˆæ¡ˆå»ºç«‹æ™‚
- **å®šæœŸåŒæ­¥**: æ¯æ—¥æ›´æ–°å·¥ç­å’Œæ¥­ä¸»è³‡æ–™
- **æ‰‹å‹•åŒæ­¥**: æä¾› API ç«¯é»å¼·åˆ¶åŒæ­¥

## ğŸ“ˆ æ•ˆèƒ½è€ƒé‡

### æŸ¥è©¢å„ªåŒ–
```sql
-- å¸¸ç”¨æŸ¥è©¢å·²å»ºç«‹ç´¢å¼•
CREATE INDEX idx_project_members_project ON project_members(project_id);
CREATE INDEX idx_project_members_user ON project_members(user_id);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_construction_sites_project ON construction_sites(project_id);
```

### è³‡æ–™é‡é ä¼°
- **å°ˆæ¡ˆ**: ~100å€‹/å¹´
- **ä½¿ç”¨è€…**: ~500å€‹ (å·¥ç­+æ¥­ä¸»)
- **æ¡ˆå ´**: ~10,000å€‹/å°ˆæ¡ˆ
- **æ´»å‹•è¨˜éŒ„**: ~50,000ç­†/å°ˆæ¡ˆ

## ğŸ› ï¸ ç¶­è­·æŒ‡å—

### Schema æ›´æ–°
1. æ–°å¢ migration æª”æ¡ˆåˆ° `/migrations/`
2. æ¸¬è©¦æœ¬åœ°è³‡æ–™åº«
3. éƒ¨ç½²åˆ°é ç«¯: `wrangler d1 execute DB_ENGINEERING --remote --file=new_migration.sql`

### è³‡æ–™å‚™ä»½
- D1 åŸç”Ÿä¸æ”¯æ´ç›´æ¥å‚™ä»½
- å»ºè­°å®šæœŸåŒ¯å‡ºé‡è¦è³‡æ–™åˆ° R2
- é—œéµè³‡æ–™åŒæ­¥åˆ° CRM ç³»çµ±

---

**Schema æª”æ¡ˆ**: `workers/schema-final.sql`  
**æœ€å¾Œæ›´æ–°**: 2025-08-11  
**ç‰ˆæœ¬**: 1.0.0