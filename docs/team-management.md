# 工班管理系統規格文件

## 系統概述

工班管理系統是建築工程管理平台的核心模組，負責管理工班組織、人員配置、案場分配等功能。系統支援多工班管理，一個師傅可同時屬於多個工班，並在不同工班中擔任不同角色。

## 功能架構

### 1. 工班組織結構

```
專案 (Project)
  └── 工班 (Team)
       ├── 負責人 (Team Leaders)
       └── 成員 (Team Members)
```

### 2. 核心功能

#### 2.1 工班建立與管理
- **動態建立工班**：從案場資料自動提取工班資訊
- **工班資訊管理**：名稱、案場數量、成員數量
- **工班合併處理**：自動處理 URL 編碼重複工班問題

#### 2.2 成員管理

##### 新增成員
- 支援兩種模式：
  1. **選擇現有師傅**：從 CRM 系統中選擇已存在的師傅
  2. **建立新師傅**：建立全新的師傅資料

- 新師傅建立流程：
  ```javascript
  {
    phone: "0912345678",      // 電話號碼（唯一識別）
    password: "678",           // 密碼（自動取後3碼）
    name: "張師傅",            // 姓名
    abbreviation: "張",        // 簡稱（自動取最後一字）
    team: "周華龍工班"         // 所屬工班
  }
  ```

##### 編輯成員
- 可編輯欄位：
  - ✅ 姓名
  - ✅ 簡稱
  - ✅ 角色（成員/負責人）
  - ❌ 電話（作為唯一識別，不可編輯）

##### 刪除成員
- 權限檢查
- 確認提示
- 自動更新列表

#### 2.3 角色管理

| 角色 | 說明 | 權限範圍 |
|------|------|----------|
| **負責人** (team_leader) | 工班管理者 | 可管理工班成員、編輯資料 |
| **成員** (team_member) | 一般工人 | 僅能查看工班資訊 |

### 3. 資料結構

#### 3.1 工班資料 (Team)
```javascript
{
  id: "team_001",
  name: "周華龍工班",
  siteCount: 297,           // 案場數量
  sites: ["site_001", ...], // 案場列表
  memberCount: 5,           // 成員總數
  leaders: [...],           // 負責人列表
  members: [...]            // 成員列表
}
```

#### 3.2 成員資料 (Member)
```javascript
{
  userId: "user_001",
  name: "張師傅",
  phone: "0912345678",
  abbreviation: "張",
  role: "team_member",      // team_leader | team_member
  teams: ["周華龍工班", "李明工班"], // 所屬工班（多工班支援）
  sourceType: "crm_worker",  // 資料來源
  sourceId: "worker_001"     // CRM 系統 ID
}
```

### 4. UI 介面設計

#### 4.1 工班列表顯示
- 工班按鈕：顯示名稱 + 案場數量
- 顏色區分：不同工班使用不同顏色標識
- 響應式設計：支援桌面和移動裝置

#### 4.2 成員管理介面
```
┌─────────────────────────────────────┐
│  周華龍工班 (297 個案場) - 成員管理    │
├─────────────────────────────────────┤
│  案場數量：297 個                     │
│  成員數量：5 人                       │
├─────────────────────────────────────┤
│  賴俊穎 [負責人]                      │
│  0963922033                         │
│  簡稱: 穎           [編輯] [刪除]     │
├─────────────────────────────────────┤
│  張師傅 [成員]                        │
│  0912345678                         │
│  簡稱: 張           [編輯] [刪除]     │
├─────────────────────────────────────┤
│  [+ 新增成員]  [+ 新增負責人]         │
└─────────────────────────────────────┘
```

### 5. 資料同步機制

#### 5.1 雙向同步
1. **CRM → 工程管理系統**
   - 同步工地師父資料 (object_50HJ8__c)
   - 更新 shift_type_multi_select__c 欄位

2. **工程管理系統 → CRM**
   - 新增/更新師傅資料
   - 更新工班歸屬

#### 5.2 資料一致性保證
- 使用電話號碼作為唯一識別
- 檢查重複成員避免約束錯誤
- 自動合併 URL 編碼重複工班

### 6. 錯誤處理

#### 6.1 常見錯誤及解決方案

| 錯誤類型 | 錯誤訊息 | 解決方案 |
|----------|----------|----------|
| 重複成員 | UNIQUE constraint failed | 檢查成員是否已存在 |
| URL 編碼 | %E5%91%A8... | 自動解碼處理 |
| 作用域錯誤 | wasExisting is not defined | 變數提升至函數層級 |

### 7. 效能優化

- **快取機制**：使用 window 物件快取工班資料
- **批量載入**：一次載入所有工班和成員
- **延遲載入**：僅在需要時載入詳細資料

### 8. 安全考量

- **權限控制**：基於角色的訪問控制
- **資料驗證**：前後端雙重驗證
- **敏感資料**：密碼不明文儲存

## 版本歷史

### v1.2.0 (2025-08-15)
- 修復 JavaScript 作用域錯誤
- 解決 URL 編碼工班名稱問題
- 新增成員角色標籤顯示
- 實現成員編輯功能

### v1.1.0 (2025-08-14)
- 實現動態工班管理
- 新增多工班支援
- 優化成員管理介面

### v1.0.0 (2025-08-13)
- 初始版本發布
- 基本工班 CRUD 功能

## 未來規劃

1. **進階功能**
   - 工班績效統計
   - 工時管理
   - 薪資計算

2. **整合優化**
   - 與考勤系統整合
   - 移動 APP 支援
   - 即時通訊功能

---

最後更新：2025-08-15