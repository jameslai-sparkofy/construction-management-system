<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººè³‡æ–™ - å…ƒå¿ƒå»ºæå·¥ç¨‹ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab-inactive {
            background: #f8fafc;
            color: #64748b;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- å°èˆªæ¬„ -->
    <nav class="gradient-bg text-white p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="text-2xl font-bold">ğŸ—ï¸</div>
                <h1 class="text-xl font-bold">å€‹äººè³‡æ–™ç®¡ç†</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="userName" class="font-medium">è¼‰å…¥ä¸­...</span>
                <a href="project-list.html" class="bg-white bg-opacity-20 px-4 py-2 rounded-lg hover:bg-opacity-30 transition">
                    å›åˆ°å°ˆæ¡ˆåˆ—è¡¨
                </a>
                <button id="logoutBtn" class="bg-red-500 bg-opacity-80 px-4 py-2 rounded-lg hover:bg-opacity-100 transition">
                    ç™»å‡º
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto p-6">
        <!-- åˆ†é æ¨™ç±¤ -->
        <div class="bg-white rounded-lg card-shadow mb-6">
            <div class="flex border-b">
                <button id="profileTab" class="flex-1 py-4 px-6 text-center font-medium tab-active transition" onclick="showTab('profile')">
                    ğŸ“ åŸºæœ¬è³‡æ–™
                </button>
                <button id="passwordTab" class="flex-1 py-4 px-6 text-center font-medium tab-inactive transition" onclick="showTab('password')">
                    ğŸ”’ ä¿®æ”¹å¯†ç¢¼
                </button>
                <button id="projectsTab" class="flex-1 py-4 px-6 text-center font-medium tab-inactive transition" onclick="showTab('projects')">
                    ğŸ“‹ å°ˆæ¡ˆè§’è‰²
                </button>
            </div>
        </div>

        <!-- åŸºæœ¬è³‡æ–™é é¢ -->
        <div id="profileContent" class="tab-content">
            <div class="bg-white rounded-lg card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">åŸºæœ¬è³‡æ–™</h2>
                
                <form id="profileForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                            <input 
                                type="tel" 
                                id="userPhone"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100"
                                disabled
                            >
                            <p class="text-sm text-gray-500 mt-1">æ‰‹æ©Ÿè™Ÿç¢¼ç„¡æ³•ä¿®æ”¹</p>
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">ç”¨æˆ¶è§’è‰²</label>
                            <input 
                                type="text" 
                                id="userRole"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100"
                                disabled
                            >
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">å§“å</label>
                            <input 
                                type="text" 
                                id="userName"
                                placeholder="è«‹è¼¸å…¥å§“å"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                required
                            >
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">é›»å­éƒµä»¶</label>
                            <input 
                                type="email" 
                                id="userEmail"
                                placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            >
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-medium text-blue-800 mb-2">å¸³è™Ÿç‹€æ…‹</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">å¸³è™Ÿç‹€æ…‹ï¼š</span>
                                <span id="userStatus" class="font-medium"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">æœ€å¾Œç™»å…¥ï¼š</span>
                                <span id="lastLogin" class="font-medium"></span>
                            </div>
                            <div>
                                <span class="text-gray-600">ç™»å…¥æ¬¡æ•¸ï¼š</span>
                                <span id="loginCount" class="font-medium"></span>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button 
                            type="submit" 
                            class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition font-medium"
                        >
                            å„²å­˜è®Šæ›´
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ä¿®æ”¹å¯†ç¢¼é é¢ -->
        <div id="passwordContent" class="tab-content hidden">
            <div class="bg-white rounded-lg card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">ä¿®æ”¹å¯†ç¢¼</h2>
                
                <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-6">
                    <p class="text-yellow-800">
                        <strong>æ³¨æ„ï¼š</strong>å¯†ç¢¼ç‚º3ä½æ•¸å­—ï¼Œé€šå¸¸æ˜¯æ‰‹æ©Ÿè™Ÿç¢¼çš„æœ«3ç¢¼ã€‚
                    </p>
                </div>

                <form id="passwordForm" class="space-y-6 max-w-md">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">ç›®å‰å¯†ç¢¼</label>
                        <input 
                            type="password" 
                            id="currentPassword"
                            placeholder="è«‹è¼¸å…¥ç›®å‰çš„3ä½æ•¸å¯†ç¢¼"
                            maxlength="3"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            required
                        >
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">æ–°å¯†ç¢¼</label>
                        <input 
                            type="password" 
                            id="newPassword"
                            placeholder="è«‹è¼¸å…¥æ–°çš„3ä½æ•¸å¯†ç¢¼"
                            maxlength="3"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            required
                        >
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">ç¢ºèªæ–°å¯†ç¢¼</label>
                        <input 
                            type="password" 
                            id="confirmPassword"
                            placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼"
                            maxlength="3"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            required
                        >
                    </div>

                    <div class="flex justify-end">
                        <button 
                            type="submit" 
                            class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition font-medium"
                        >
                            ä¿®æ”¹å¯†ç¢¼
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- å°ˆæ¡ˆè§’è‰²é é¢ -->
        <div id="projectsContent" class="tab-content hidden">
            <div class="bg-white rounded-lg card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">æˆ‘çš„å°ˆæ¡ˆè§’è‰²</h2>
                
                <div id="projectsList" class="space-y-4">
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">ğŸ“‹</div>
                        <p class="text-gray-500">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æˆåŠŸ/éŒ¯èª¤è¨Šæ¯ -->
        <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>
    </div>

    <script src="config.js"></script>
    <script src="js/unified-auth.js"></script>
    <script>
        let currentUser = null;

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // æª¢æŸ¥èªè­‰
            if (!window.UnifiedAuth.requireAuth()) {
                return;
            }

            currentUser = window.UnifiedAuth.getUser();
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name || 'æœªè¨­å®š';
            }

            // è¼‰å…¥ç”¨æˆ¶è³‡æ–™
            await loadUserProfile();
            
            // ç¶å®šäº‹ä»¶
            bindEvents();
        });

        // é¡¯ç¤ºåˆ†é 
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // ç§»é™¤æ‰€æœ‰æ´»å‹•æ¨™ç±¤æ¨£å¼
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.className = 'flex-1 py-4 px-6 text-center font-medium tab-inactive transition';
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„å…§å®¹
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            document.getElementById(tabName + 'Tab').className = 'flex-1 py-4 px-6 text-center font-medium tab-active transition';
            
            // å¦‚æœæ˜¯å°ˆæ¡ˆåˆ†é ï¼Œè¼‰å…¥å°ˆæ¡ˆè³‡æ–™
            if (tabName === 'projects') {
                loadUserProjects();
            }
        }

        // è¼‰å…¥ç”¨æˆ¶è³‡æ–™
        async function loadUserProfile() {
            try {
                const response = await fetch(`${CONFIG.API.WORKER_API_URL}/api/v1/users/me`, {
                    headers: window.UnifiedAuth.getRequestHeaders()
                });

                const data = await response.json();
                
                if (data.success) {
                    const user = data.user;
                    
                    // å¡«å…¥è¡¨å–®
                    document.getElementById('userPhone').value = user.phone || '';
                    document.getElementById('userRole').value = getRoleDisplayName(user.role);
                    document.getElementById('userName').value = user.name || '';
                    document.getElementById('userEmail').value = user.email || '';
                    document.getElementById('userStatus').textContent = getStatusDisplayName(user.user_status);
                    document.getElementById('lastLogin').textContent = formatDateTime(user.last_login);
                    document.getElementById('loginCount').textContent = user.login_count || 0;
                } else {
                    showMessage('è¼‰å…¥ç”¨æˆ¶è³‡æ–™å¤±æ•—ï¼š' + data.error, 'error');
                }
            } catch (error) {
                console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™éŒ¯èª¤:', error);
                showMessage('è¼‰å…¥ç”¨æˆ¶è³‡æ–™ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // è¼‰å…¥ç”¨æˆ¶å°ˆæ¡ˆ
        async function loadUserProjects() {
            try {
                const response = await fetch(`${CONFIG.API.WORKER_API_URL}/api/v1/users/me/projects`, {
                    headers: window.UnifiedAuth.getRequestHeaders()
                });

                const data = await response.json();
                
                if (data.success) {
                    renderProjects(data.projects);
                } else {
                    showMessage('è¼‰å…¥å°ˆæ¡ˆè³‡æ–™å¤±æ•—ï¼š' + data.error, 'error');
                }
            } catch (error) {
                console.error('è¼‰å…¥å°ˆæ¡ˆè³‡æ–™éŒ¯èª¤:', error);
                showMessage('è¼‰å…¥å°ˆæ¡ˆè³‡æ–™ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // æ¸²æŸ“å°ˆæ¡ˆåˆ—è¡¨
        function renderProjects(projects) {
            const container = document.getElementById('projectsList');
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">ğŸ“­</div>
                        <p class="text-gray-500">ç›®å‰æ²’æœ‰åƒèˆ‡ä»»ä½•å°ˆæ¡ˆ</p>
                    </div>
                `;
                return;
            }

            const html = projects.map(project => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-lg text-gray-800">${project.project_name}</h3>
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 text-sm rounded">${project.project_status}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
                        <div>
                            <span class="font-medium">ç”¨æˆ¶é¡å‹ï¼š</span>
                            <span class="text-gray-800">${getUserTypeDisplayName(project.user_role)}</span>
                        </div>
                        ${project.team_name ? `
                        <div>
                            <span class="font-medium">å·¥ç­ï¼š</span>
                            <span class="text-gray-800">${project.team_name}</span>
                        </div>
                        <div>
                            <span class="font-medium">å·¥ç­è§’è‰²ï¼š</span>
                            <span class="text-gray-800">${getRoleDisplayName(project.team_role)}</span>
                        </div>
                        ` : '<div></div><div></div>'}
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        åŠ å…¥æ™‚é–“ï¼š${formatDateTime(project.joined_at)}
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // ç¶å®šäº‹ä»¶
        function bindEvents() {
            // å€‹äººè³‡æ–™è¡¨å–®
            document.getElementById('profileForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await updateProfile();
            });

            // ä¿®æ”¹å¯†ç¢¼è¡¨å–®
            document.getElementById('passwordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await changePassword();
            });

            // ç™»å‡ºæŒ‰éˆ•
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                    window.UnifiedAuth.logout();
                    window.location.href = 'index.html';
                }
            });
        }

        // æ›´æ–°å€‹äººè³‡æ–™
        async function updateProfile() {
            try {
                const name = document.getElementById('userName').value.trim();
                const email = document.getElementById('userEmail').value.trim();

                const response = await fetch(`${CONFIG.API.WORKER_API_URL}/api/v1/users/me`, {
                    method: 'PUT',
                    headers: window.UnifiedAuth.getRequestHeaders(),
                    body: JSON.stringify({ name, email })
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage('å€‹äººè³‡æ–™æ›´æ–°æˆåŠŸ', 'success');
                    
                    // æ›´æ–°å°èˆªæ¬„çš„ç”¨æˆ¶åç¨±
                    document.querySelector('nav #userName').textContent = name;
                    
                    // æ›´æ–°æœ¬åœ°å­˜å„²çš„ç”¨æˆ¶è³‡è¨Š
                    const updatedUser = { ...currentUser, name, email };
                    localStorage.setItem('user', JSON.stringify(updatedUser));
                    currentUser = updatedUser;
                } else {
                    showMessage('æ›´æ–°å¤±æ•—ï¼š' + data.error, 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°å€‹äººè³‡æ–™éŒ¯èª¤:', error);
                showMessage('æ›´æ–°å€‹äººè³‡æ–™ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // ä¿®æ”¹å¯†ç¢¼
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // é©—è­‰å¯†ç¢¼æ ¼å¼
            if (!/^\d{3}$/.test(newPassword)) {
                showMessage('æ–°å¯†ç¢¼å¿…é ˆç‚º3ä½æ•¸å­—', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´', 'error');
                return;
            }

            try {
                const response = await fetch(`${CONFIG.API.WORKER_API_URL}/api/v1/users/change-password`, {
                    method: 'POST',
                    headers: window.UnifiedAuth.getRequestHeaders(),
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showMessage('å¯†ç¢¼ä¿®æ”¹æˆåŠŸ', 'success');
                    
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('passwordForm').reset();
                } else {
                    showMessage('å¯†ç¢¼ä¿®æ”¹å¤±æ•—ï¼š' + data.error, 'error');
                }
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç¢¼éŒ¯èª¤:', error);
                showMessage('ä¿®æ”¹å¯†ç¢¼ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const messageEl = document.createElement('div');
            messageEl.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-4 max-w-sm`;
            messageEl.textContent = message;

            container.appendChild(messageEl);

            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        // è¼”åŠ©å‡½æ•¸
        function getRoleDisplayName(role) {
            const roleNames = {
                'super_admin': 'Super Admin',
                'admin': 'ç®¡ç†å“¡',
                'user': 'ä¸€èˆ¬ç”¨æˆ¶',
                'owner': 'æ¥­ä¸»',
                'team_leader': 'å·¥ç­é•·',
                'member': 'å·¥ç­æˆå“¡'
            };
            return roleNames[role] || role;
        }

        function getUserTypeDisplayName(userType) {
            const typeNames = {
                'admin': 'ç®¡ç†å“¡',
                'owner': 'æ¥­ä¸»',
                'worker': 'å·¥ç­'
            };
            return typeNames[userType] || userType;
        }

        function getStatusDisplayName(status) {
            const statusNames = {
                'active': 'å·²å•Ÿç”¨',
                'pending': 'å¾…å•Ÿç”¨',
                'suspended': 'å·²æš«åœ'
            };
            return statusNames[status] || status;
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return 'ç„¡';
            return new Date(dateStr).toLocaleString('zh-TW');
        }
    </script>
</body>
</html>