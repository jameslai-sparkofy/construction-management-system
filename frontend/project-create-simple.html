<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建立工程專案 - 元心建材工程管理系統 v1.2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 800px;
            padding: 3rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .form-section {
            margin-bottom: 2.5rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-icon {
            width: 24px;
            height: 24px;
            background: #4f46e5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .select-control {
            background: white;
            cursor: pointer;
        }

        .engineering-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .engineering-option {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .engineering-option:hover {
            border-color: #4f46e5;
            background: #eef2ff;
        }

        .engineering-option.selected {
            border-color: #4f46e5;
            background: #4f46e5;
            color: white;
        }

        .engineering-option input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .engineering-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            pointer-events: none;
        }

        .engineering-description {
            font-size: 0.9rem;
            opacity: 0.8;
            pointer-events: none;
        }

        .engineering-option.selected .engineering-description {
            opacity: 0.9;
        }

        .checkmark {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }

        .engineering-option.selected .checkmark {
            opacity: 1;
        }

        .project-summary {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .summary-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: #64748b;
        }

        .summary-value {
            font-weight: 500;
            color: #1e293b;
        }

        .actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 3rem;
        }

        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            font-size: 1.1rem;
            padding: 1rem 3rem;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            display: none;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            display: none;
        }

        @media (max-width: 640px) {
            .container {
                padding: 2rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .engineering-types {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>建立工程專案</h1>
            <p>選擇商機和工程類型，快速建立新專案</p>
        </div>

        <form id="createProjectForm">
            <!-- 選擇商機 -->
            <div class="form-section">
                <div class="section-title">
                    <div class="section-icon">1</div>
                    選擇商機
                </div>
                
                <div class="form-group">
                    <label for="opportunitySearch" class="form-label">搜尋商機</label>
                    <input type="text" id="opportunitySearch" class="form-control" placeholder="輸入關鍵字搜尋商機...">
                </div>
                
                <div class="form-group">
                    <label for="opportunitySelect" class="form-label">選擇要建立專案的商機 *</label>
                    <select id="opportunitySelect" class="form-control select-control" required>
                        <option value="">請選擇商機...</option>
                    </select>
                </div>
            </div>

            <!-- 選擇工程類型 -->
            <div class="form-section">
                <div class="section-title">
                    <div class="section-icon">2</div>
                    選擇工程類型
                </div>
                
                <div class="engineering-types">
                    <label class="engineering-option" for="spcEngineering">
                        <input type="checkbox" id="spcEngineering" name="engineeringTypes" value="spc">
                        <div class="engineering-title">SPC 工程</div>
                        <div class="engineering-description">石材、磁磚等表面材料施工工程</div>
                        <div class="checkmark">✓</div>
                    </label>
                    
                    <label class="engineering-option" for="cabinetEngineering">
                        <input type="checkbox" id="cabinetEngineering" name="engineeringTypes" value="cabinet">
                        <div class="engineering-title">浴櫃工程</div>
                        <div class="engineering-description">衛浴設備、櫃體安裝工程</div>
                        <div class="checkmark">✓</div>
                    </label>
                </div>
            </div>

            <!-- 專案摘要 -->
            <div class="project-summary" id="projectSummary" style="display: none;">
                <div class="summary-title">專案摘要</div>
                <div class="summary-item">
                    <span class="summary-label">商機名稱</span>
                    <span class="summary-value" id="summaryOpportunityName">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">專案名稱</span>
                    <span class="summary-value" id="summaryProjectName">-</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">工程類型</span>
                    <span class="summary-value" id="summaryEngineeringTypes">-</span>
                </div>
            </div>

            <!-- 錯誤和成功訊息 -->
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>

            <!-- 操作按鈕 -->
            <div class="actions">
                <a href="project-list.html" class="btn btn-secondary">
                    ← 返回專案列表
                </a>
                
                <button type="submit" class="btn btn-primary" id="createBtn" disabled>
                    <span class="btn-text">建立專案</span>
                    <div class="loading">
                        <div class="spinner"></div>
                        建立中...
                    </div>
                </button>
            </div>
        </form>
    </div>

    <script src="config.js"></script>
    <script>
        // ========================================
        // 全域變數
        // ========================================
        let opportunities = [];
        let selectedOpportunity = null;
        let selectedEngineeringTypes = [];

        // ========================================
        // 初始化
        // ========================================
        document.addEventListener('DOMContentLoaded', async function() {
            await loadConfig();
            await loadOpportunities();
            setupEventListeners();
        });

        // ========================================
        // 載入商機資料
        // ========================================
        async function loadOpportunities() {
            try {
                console.log('Loading opportunities from CRM...');
                
                // 使用和原版 project-create.html 相同的邏輯
                const API_BASE_URL = CONFIG?.API?.CRM_API_URL || 'https://fx-d1-rest-api.lai-jameslai.workers.dev';
                const API_TOKEN = CONFIG?.API?.CRM_API_TOKEN || 'fx-crm-api-secret-2025';
                
                // 如果新配置沒有 CRM_API_URL，使用直接 CRM API
                const crmApiUrl = API_BASE_URL.includes('fx-d1-rest-api') ? 
                    'https://d1.yes-ceramics.com/rest' : API_BASE_URL;
                
                console.log('Using CRM API:', crmApiUrl);
                
                const response = await fetch(`${crmApiUrl}/newopportunityobj?limit=500`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                // 過濾出贏單的商機（和原版相同）
                const allOpportunities = result.results || [];
                opportunities = allOpportunities.filter(opp => 
                    opp.sales_status__r === '贏單' || opp.sales_status === '2'
                );
                
                console.log(`Loaded ${opportunities.length} winning opportunities (from ${allOpportunities.length} total)`);
                populateOpportunitySelect();
                
            } catch (error) {
                console.error('Failed to load opportunities:', error);
                showError('載入商機資料失敗: ' + error.message);
            }
        }

        function populateOpportunitySelect(searchTerm = '') {
            const select = document.getElementById('opportunitySelect');
            
            // 清空現有選項（保留預設選項）
            select.innerHTML = '<option value="">請選擇商機...</option>';
            
            // 過濾商機（如果有搜尋條件）
            let filteredOpportunities = opportunities;
            if (searchTerm.trim()) {
                const term = searchTerm.toLowerCase();
                filteredOpportunities = opportunities.filter(opp => {
                    const name = (opp.name || '').toLowerCase();
                    const id = (opp._id || '').toLowerCase();
                    return name.includes(term) || id.includes(term);
                });
            }
            
            // 添加商機選項
            filteredOpportunities.forEach(opp => {
                const option = document.createElement('option');
                option.value = opp._id;
                option.textContent = opp.name || `商機 ${opp._id.slice(-8)}`;
                option.dataset.opportunityData = JSON.stringify(opp);
                select.appendChild(option);
            });
            
            // 顯示搜尋結果數量
            if (searchTerm.trim()) {
                const searchResult = document.getElementById('searchResult') || (() => {
                    const div = document.createElement('div');
                    div.id = 'searchResult';
                    div.style.cssText = 'font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;';
                    document.getElementById('opportunitySearch').parentNode.appendChild(div);
                    return div;
                })();
                searchResult.textContent = `找到 ${filteredOpportunities.length} 個商機`;
            } else {
                const searchResult = document.getElementById('searchResult');
                if (searchResult) searchResult.remove();
            }
        }

        // ========================================
        // 事件監聽器
        // ========================================
        function setupEventListeners() {
            // 商機搜尋
            document.getElementById('opportunitySearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value;
                populateOpportunitySelect(searchTerm);
                
                // 清除當前選擇（如果搜尋條件改變）
                const select = document.getElementById('opportunitySelect');
                if (select.value && searchTerm.trim()) {
                    const currentOption = select.querySelector(`option[value="${select.value}"]`);
                    if (!currentOption) {
                        select.value = '';
                        selectedOpportunity = null;
                        updateProjectSummary();
                        updateCreateButton();
                    }
                }
            });
            
            // 商機選擇
            document.getElementById('opportunitySelect').addEventListener('change', handleOpportunityChange);
            
            // 工程類型選擇
            document.querySelectorAll('input[name="engineeringTypes"]').forEach(checkbox => {
                checkbox.addEventListener('change', handleEngineeringTypeChange);
            });
            
            // 工程類型卡片點擊
            document.querySelectorAll('.engineering-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    console.log('Engineering option clicked:', e.target.tagName, e.target);
                    // 防止雙重觸發：只處理非 input 元素的點擊
                    if (e.target.tagName !== 'INPUT') {
                        e.preventDefault(); // 防止 label 自動觸發 input
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        console.log('Checkbox found:', checkbox);
                        checkbox.checked = !checkbox.checked;
                        console.log('Checkbox state:', checkbox.checked);
                        
                        // 手動調用處理函數
                        handleEngineeringTypeChange({ target: checkbox });
                    }
                });
            });
            
            // 表單提交
            document.getElementById('createProjectForm').addEventListener('submit', handleFormSubmit);
        }

        function handleOpportunityChange(e) {
            const selectedValue = e.target.value;
            
            if (selectedValue) {
                const optionElement = e.target.querySelector(`option[value="${selectedValue}"]`);
                const opportunityData = JSON.parse(optionElement.dataset.opportunityData);
                
                selectedOpportunity = {
                    id: opportunityData._id,
                    name: opportunityData.name || `商機 ${opportunityData._id.slice(-8)}`,
                    data: opportunityData
                };
            } else {
                selectedOpportunity = null;
            }
            
            updateProjectSummary();
            updateCreateButton();
        }

        function handleEngineeringTypeChange(e) {
            console.log('Engineering type change handler called:', e.target.value, e.target.checked);
            const option = e.target.closest('.engineering-option');
            console.log('Option element:', option);
            
            if (e.target.checked) {
                option.classList.add('selected');
                if (!selectedEngineeringTypes.includes(e.target.value)) {
                    selectedEngineeringTypes.push(e.target.value);
                }
            } else {
                option.classList.remove('selected');
                selectedEngineeringTypes = selectedEngineeringTypes.filter(type => type !== e.target.value);
            }
            
            console.log('Selected engineering types:', selectedEngineeringTypes);
            updateProjectSummary();
            updateCreateButton();
        }

        // ========================================
        // UI 更新
        // ========================================
        function updateProjectSummary() {
            const summary = document.getElementById('projectSummary');
            
            if (selectedOpportunity || selectedEngineeringTypes.length > 0) {
                // 顯示摘要
                summary.style.display = 'block';
                
                // 更新摘要內容
                document.getElementById('summaryOpportunityName').textContent = 
                    selectedOpportunity ? selectedOpportunity.name : '-';
                
                document.getElementById('summaryProjectName').textContent = 
                    selectedOpportunity ? selectedOpportunity.name : '-';
                
                const engineeringTypeNames = selectedEngineeringTypes.map(type => {
                    switch (type) {
                        case 'spc': return 'SPC 工程';
                        case 'cabinet': return '浴櫃工程';
                        default: return type;
                    }
                });
                
                document.getElementById('summaryEngineeringTypes').textContent = 
                    engineeringTypeNames.length > 0 ? engineeringTypeNames.join(', ') : '未選擇';
            } else {
                summary.style.display = 'none';
            }
        }

        function updateCreateButton() {
            const createBtn = document.getElementById('createBtn');
            const canCreate = selectedOpportunity && selectedEngineeringTypes.length > 0;
            
            createBtn.disabled = !canCreate;
        }

        // ========================================
        // 專案建立
        // ========================================
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!selectedOpportunity || selectedEngineeringTypes.length === 0) {
                showError('請選擇商機和至少一種工程類型');
                return;
            }
            
            await createProject();
        }

        async function createProject() {
            const createBtn = document.getElementById('createBtn');
            const btnText = createBtn.querySelector('.btn-text');
            const loadingSpinner = createBtn.querySelector('.loading');
            
            try {
                // 顯示載入狀態
                createBtn.disabled = true;
                btnText.style.display = 'none';
                loadingSpinner.style.display = 'flex';
                hideMessages();
                
                // 準備專案資料
                const projectData = {
                    opportunity_id: selectedOpportunity.id,
                    name: selectedOpportunity.name,
                    spc_engineering: selectedEngineeringTypes.includes('spc') ? JSON.stringify({ enabled: true }) : null,
                    cabinet_engineering: selectedEngineeringTypes.includes('cabinet') ? JSON.stringify({ enabled: true }) : null,
                    status: 'active'
                };
                
                console.log('Creating project with data:', projectData);
                
                // 發送建立請求
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(projectData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Project created successfully:', result);
                
                // 顯示成功訊息
                showSuccess('專案建立成功！正在跳轉到專案詳情頁面...');
                
                // 3秒後跳轉到專案詳情頁
                setTimeout(() => {
                    window.location.href = `project-detail.html?id=${result.project.id}`;
                }, 2000);
                
            } catch (error) {
                console.error('Failed to create project:', error);
                showError('建立專案失敗: ' + error.message);
                
                // 恢復按鈕狀態
                createBtn.disabled = false;
                btnText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
            }
        }

        // ========================================
        // 工具函數
        // ========================================
        function getToken() {
            return localStorage.getItem('token') || 'missing-auth-token';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // 捲動到錯誤訊息
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            // 捲動到成功訊息
            successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        async function loadConfig() {
            // Config 會由 config.js 設定全域變數
            if (typeof CONFIG === 'undefined') {
                console.warn('CONFIG not loaded, using default values');
                return;
            }
            
            // 使用統一 API 配置
            window.WORKER_API_URL = CONFIG.API.WORKER_API_URL;
            
            console.log('Config loaded successfully', {
                workerApiUrl: window.WORKER_API_URL,
                environment: CONFIG.ENVIRONMENT
            });
        }
    </script>
</body>
</html>