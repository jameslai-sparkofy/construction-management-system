<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案詳情 - 元心建材工程管理系統 v1.2.1</title>
    <script src="js/version-manager.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Official Colors from screenshot */
            --heading: #222222;
            --body-text: #6b7280;
            --primary: #84C7D0;
            --secondary: #6C6F7D;
            --border: #e5e7eb;
            --border-primary: #d1d5db;
            
            /* Status Colors */
            --completed: #84c7d0;
            --in-progress: #f59e0b;
            --pending: #ffffff;
            --maintenance: #fbbf24;
            --maintenance-done: #415a77;
            --no-unit: #f3f4f6;
            
            /* Extended Palette */
            --background: #f9fafb;
            --surface: #ffffff;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: var(--background);
            color: var(--body-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        .header {
            background: var(--surface);
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--body-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }

        .back-btn:hover {
            background: var(--background);
        }

        .project-info {
            flex: 1;
        }

        .project-info h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--heading);
            margin-bottom: 0.125rem;
        }

        .project-info p {
            font-size: 0.8125rem;
            color: var(--body-text);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .header-actions button {
            padding: 0.5rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--body-text);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        #userManagementBtn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        #userManagementBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .header-actions button:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }











        .role-admin {
            background: #fee2e2;
            color: #991b1b;
        }

        .role-owner {
            background: #fef3c7;
            color: #92400e;
        }

        .role-foreman {
            background: #d1fae5;
            color: #065f46;
        }

        .role-worker {
            background: #dbeafe;
            color: #1e40af;
        }


        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0;
            padding: 0;
            background: var(--surface);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            box-shadow: none;
        }

        .nav-tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            position: relative;
            margin-bottom: -2px;
            border-radius: 0;
        }

        .nav-tab:hover {
            color: var(--heading);
            background: rgba(132, 199, 208, 0.05);
        }

        .nav-tab.active {
            color: var(--primary);
            background: transparent;
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        /* Building Grid Content */
        .building-grid-wrapper {
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .building-tabs {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 1rem;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .building-btn {
            padding: 1rem 3rem;
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--body-text);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.95rem;
            min-width: 120px;
            text-align: center;
        }

        .building-btn:hover:not(.active) {
            background: rgba(132, 199, 208, 0.1);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }

        .building-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(132, 199, 208, 0.3);
        }

        /* Floor Grid Table */
        .floor-grid-container {
            padding: 1.5rem;
            overflow-x: auto;
        }

        .floor-grid {
            width: 100%;
            border-collapse: collapse;
        }

        .floor-grid thead th {
            padding: 0.4rem;
            text-align: center;
            font-weight: 600;
            color: var(--heading);
            background: var(--background);
            border: 1px solid var(--border);
        }

        .floor-grid tbody th {
            padding: 0.4rem;
            text-align: center;
            font-weight: 600;
            color: var(--heading);
            background: var(--background);
            border: 1px solid var(--border);
        }

        .grid-cell {
            padding: 0.4rem;
            border: 1px solid var(--border);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: var(--pending);
            min-width: 120px;
            height: 60px;
        }

        .grid-cell:hover {
            background: rgba(132, 199, 208, 0.1);
            border-color: var(--primary);
        }

        .grid-cell.completed {
            background: var(--completed);
            color: white;
        }

        .grid-cell.no-unit {
            background: var(--no-unit);
            cursor: default;
            pointer-events: none;
        }

        .cell-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .cell-line1 {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .cell-line2 {
            font-size: 0.75rem;
            color: var(--body-text);
        }

        .cell-team {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #84C7D0;
            color: white;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            line-height: 20px;
            margin-left: 0.25rem;
        }

        .grid-cell.completed .cell-team {
            background: #5A9BA5;
        }

        .maintenance-badges {
            position: absolute;
            top: 4px;
            right: 4px;
            display: flex;
            gap: 4px;
        }

        .maintenance-badge {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--maintenance);
            color: var(--heading);
            font-size: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .maintenance-badge.done {
            background: var(--maintenance-done);
            color: white;
        }

        /* Modal Styles from site-modal-final */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 95vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        /* Compact Header */
        .modal-header {
            background: linear-gradient(135deg, #84C7D0 0%, #6C6F7D 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex: 1;
        }

        .site-basic-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-label {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .info-value {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .divider {
            width: 1px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .modal-share-btn {
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Modal Body */
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* 媒體區塊 - 動態佈局 */
        .media-container {
            margin-bottom: 1rem;
        }

        .media-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 6px;
        }

        .section-icon {
            font-size: 1.125rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        /* 照片網格 - 緊湊佈局 */
        .photos-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            min-height: 90px;
        }

        .photo-box {
            width: 80px;
            height: 80px;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .photo-box:hover {
            border-color: #84C7D0;
            background: #f0fdf4;
        }

        .photo-box.has-image {
            border-style: solid;
            border-color: #84C7D0;
            padding: 2px;
        }

        .photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            cursor: zoom-in;
        }

        .photo-box.add-photo {
            background: #f9fafb;
        }

        .photo-box.add-photo:hover {
            background: #e5f7fa;
            border-color: #84C7D0;
        }

        /* 所有媒體區塊的緊湊排列 - 始終橫向 */
        .all-media-compact {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .all-media-compact .media-container {
            flex: 1;
            min-width: 30%;
            margin-bottom: 0;
        }

        .all-media-compact .photos-wrapper {
            min-height: 80px;
        }

        /* 施工前備註區塊 - 可收合 */
        .before-construction-section {
            background: #fef9f3;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .before-construction-section.collapsed {
            background: transparent;
            margin-bottom: 0.5rem;
        }

        .notes-header {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fef9f3;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .before-construction-section.collapsed .notes-header {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }

        .notes-content {
            padding: 0 1rem 1rem;
            max-height: 200px;
            transition: all 0.3s ease;
        }

        .before-construction-section.collapsed .notes-content {
            max-height: 0;
            padding: 0 1rem;
            overflow: hidden;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            color: #6b7280;
        }

        .before-construction-section.collapsed .expand-icon {
            transform: rotate(-90deg);
        }

        .notes-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 80px;
        }

        .photo-remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            line-height: 1;
        }

        .photo-box.has-image:hover .photo-remove-btn {
            display: flex;
        }

        /* 施工完成區塊 - 使用藍綠色 */
        .completion-section {
            background: #c5edf2;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #84C7D0;
        }

        .completion-checkbox {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .completion-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .completion-label {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            user-select: none;
        }

        .worker-name {
            font-size: 0.875rem;
            color: #4f46e5;
            margin-left: 0.5rem;
            font-weight: normal;
        }

        .completion-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .completion-fields.active {
            opacity: 1;
            pointer-events: auto;
        }

        #completionFields2 {
            display: grid;
            grid-template-columns: 1fr;
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        #completionFields2.active {
            opacity: 1;
            pointer-events: auto;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .field-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .field-input {
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
        }

        .field-input:focus {
            outline: none;
            border-color: #84C7D0;
            box-shadow: 0 0 0 3px rgba(132, 199, 208, 0.2);
        }

        /* 提交按鈕 - 醒目設計 */
        .submit-section {
            padding: 1.5rem;
            background: white;
            border-top: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .btn-cancel {
            padding: 0.875rem 1.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            color: #6b7280;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-submit {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #84C7D0 0%, #6eb5c0 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1.125rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(132, 199, 208, 0.3);
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(132, 199, 208, 0.4);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                transform: translateY(30px); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0); 
                opacity: 1; 
            }
        }

        /* Lightbox 樣式 */
        #lightbox {
            animation: fadeIn 0.3s ease;
        }

        /* Loading state */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            color: var(--body-text);
        }

        .error-message {
            background: #fee;
            color: #c00;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* Construction Team Info in Legend */
        .construction-team-info {
            margin: 0;
            border-top: 1px solid var(--border);
        }

        .team-info-toggle {
            display: none;
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: var(--background);
            border: none;
            border-bottom: 1px solid var(--border);
            text-align: left;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--heading);
            font-weight: 600;
        }

        .team-info-toggle::after {
            content: '';
            float: right;
        }

        .team-info-content {
            display: block;
        }

        /* Collapsible sections for mobile */
        .section-toggle {
            display: none;
            width: 100%;
            padding: 0.75rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            color: var(--heading);
            cursor: pointer;
            text-align: left;
            margin-bottom: 0.5rem;
        }

        .section-toggle::after {
            content: '▼';
            float: right;
            transition: transform 0.3s;
        }

        .section-toggle.collapsed::after {
            transform: rotate(-90deg);
        }

        /* Tablet and Mobile Nav Tabs */
        @media (max-width: 768px) {
            /* Collapsible sections */
            .section-toggle {
                display: block;
            }

            .stats-section.collapsed,
            .construction-info.collapsed .construction-info-content {
                display: none;
            }

            .construction-info {
                padding: 0.75rem 1rem;
            }

            .construction-info.collapsed {
                padding: 0;
                margin: 0;
                background: transparent;
            }
            
            /* Construction team info toggle on mobile */
            .team-info-toggle {
                display: block;
            }
            
            .construction-team-info.collapsed .team-info-content {
                display: none;
            }
            
            .construction-team-info.collapsed .team-info-toggle::after {
                content: ' ▶';
            }
            
            .construction-team-info:not(.collapsed) .team-info-toggle::after {
                content: ' ▼';
            }

            .nav-tabs {
                padding: 0 1rem;
            }
            
            .nav-tab {
                padding: 0.875rem 1.25rem;
                font-size: 0.9rem;
            }
            
            .building-tabs {
                padding: 0.75rem 1rem;
                gap: 0.5rem;
            }
            
            .building-btn {
                padding: 0.875rem 2.25rem;
                font-size: 0.875rem;
                min-width: 100px;
            }
        }
        
        @media (max-width: 640px) {
            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0;
                margin-bottom: 1rem;
            }
            
            .nav-tab {
                flex-shrink: 0;
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                white-space: nowrap;
                min-width: fit-content;
            }
            
            .building-grid-wrapper {
                margin: 0.5rem;
            }
            
            .building-tabs {
                padding: 0.5rem;
                gap: 0.375rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0.5rem;
            }
            
            .building-btn {
                flex-shrink: 0;
                padding: 0.75rem 2rem;
                font-size: 0.8125rem;
                min-width: 90px;
                border-width: 1.5px;
            }
            
            .floor-grid-container {
                padding: 0.5rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
        }
        
        /* 手機優化 */
        @media (max-width: 768px) {
            .project-stats {
                flex-direction: column;
                gap: 1rem;
            }

            .floor-grid-container {
                padding: 0.5rem;
            }
            
            .floor-grid {
                min-width: 500px;
            }
            
            .floor-grid th,
            .floor-grid td {
                padding: 0.5rem 0.375rem;
                font-size: 0.75rem;
            }
            
            .site-cell {
                padding: 0.375rem;
                min-height: 45px;
            }
            
            .site-unit {
                font-size: 0.8125rem;
            }
            
            .site-info {
                font-size: 0.625rem;
                gap: 0.125rem;
            }
            
            .site-area {
                font-size: 0.625rem;
            }
            
            .site-team,
            .site-worker {
                font-size: 0.625rem;
            }

            .modal-container {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .modal-overlay {
                padding: 0;
            }

            .modal-body {
                padding: 1rem 0;
            }

            .header-info {
                overflow-x: auto;
                padding-bottom: 0.25rem;
            }

            .site-basic-info {
                min-width: fit-content;
            }

            .completion-fields {
                grid-template-columns: 1fr;
            }
            
            #completionFields2 {
                margin-top: 0.5rem !important;
            }
            
            #completionFields2 .field-group {
                grid-column: span 1 !important;
            }
            
            .before-construction-section {
                margin: 0 1rem 1rem;
            }
            
            .completion-section {
                margin: 0 1rem 1rem;
            }

            .all-media-compact {
                gap: 0.25rem;
                padding: 0 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .all-media-compact .media-container {
                flex: 1;
                min-width: 0;
                max-width: 33.333%;
            }
            
            .media-header {
                padding: 0.375rem 0.5rem;
                background: #f3f4f6;
                margin-bottom: 0.375rem;
                border-radius: 4px;
            }
            
            .section-icon {
                font-size: 1rem;
                display: none;
            }
            
            .section-title {
                font-size: 0.875rem;
                font-weight: 500;
                text-align: center;
                width: 100%;
                color: #374151;
            }
            
            .photos-wrapper {
                padding: 0.375rem;
                min-height: 65px;
                max-height: 65px;
                overflow-x: auto;
                overflow-y: hidden;
                display: flex;
                gap: 0.25rem;
            }
            
            .photo-box {
                width: 55px;
                height: 55px;
                flex-shrink: 0;
            }
            
            .photo-box div {
                font-size: 1.25rem !important;
            }
            
            .photo-box.has-image .photo-remove-btn {
                width: 18px;
                height: 18px;
                font-size: 0.75rem;
                top: 2px;
                right: 2px;
                background: rgba(0, 0, 0, 0.7);
                border-radius: 3px;
            }
        }
        /* Statistics Cards */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background: var(--surface);
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #84C7D0 0%, #6eb5c0 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .stat-card:nth-child(2) .stat-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .stat-card:nth-child(3) .stat-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-card:nth-child(4) .stat-icon {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--heading);
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--body-text);
        }

        @media (max-width: 1024px) {
            .stats-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 0;
            }
            
            .header {
                padding: 1rem;
                margin-bottom: 0.5rem;
            }
            
            .header-content {
                gap: 0.75rem;
            }
            
            .back-btn {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }
            
            .project-info h1 {
                font-size: 1.25rem;
            }
            
            .project-info p {
                font-size: 0.75rem;
            }
            
            .header-actions {
                flex-direction: row;
                gap: 0.5rem;
            }
            
            .header-actions button {
                padding: 0.5rem;
                font-size: 0.875rem;
            }
            
            .header-actions button span:last-child {
                display: none; /* Hide text labels on mobile, keep icons */
            }
            
            .stats-section {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                padding: 0 1rem;
                margin: 1rem 0;
            }
            
            .stat-card {
                padding: 0.875rem;
                gap: 0.75rem;
            }
            
            .stat-icon {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
                border-radius: 8px;
            }
            
            .stat-value {
                font-size: 1.25rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
        }
        
        /* Legend */
        .legend-container {
            display: flex;
            gap: 2rem;
            padding: 1rem 1.5rem;
            background: var(--background);
            border-top: 1px solid var(--border);
            margin: 0;
        }

        .legend-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* Team management modal */
        .team-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .team-modal.active {
            display: flex;
        }
        
        .team-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .team-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .team-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--heading);
        }
        
        .team-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .team-modal-close:hover {
            background: #e5e7eb;
        }
        
        .team-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .team-members-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .team-member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .team-member-item:hover {
            background: #f3f4f6;
        }
        
        .team-member-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .team-member-name {
            font-weight: 500;
            color: var(--heading);
        }
        
        .team-member-phone {
            font-size: 0.875rem;
            color: var(--body-text);
        }
        
        .team-member-role {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #84C7D0;
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.25rem;
        }
        
        .team-member-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .team-action-btn {
            padding: 0.5rem;
            border: none;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .team-action-btn:hover {
            background: #e5e7eb;
        }
        
        .team-action-btn.delete {
            color: #ef4444;
        }
        
        .team-action-btn.delete:hover {
            background: #fee2e2;
        }
        
        .add-member-btn {
            width: 100%;
            padding: 0.75rem;
            margin-top: 1rem;
            border: 2px dashed #d1d5db;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: var(--body-text);
        }
        
        .add-member-btn:hover {
            border-color: #84C7D0;
            background: #f0fdfa;
            color: #0f766e;
        }

        .legend-title {
            font-weight: 600;
            color: var(--heading);
            margin-right: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--body-text);
            cursor: default;
        }
        
        .legend-item[title] {
            cursor: help;
        }
        
        .legend-item[title]:hover {
            opacity: 0.8;
        }

        .legend-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            border: 1px solid var(--border);
        }

        .legend-icon.completed {
            background: var(--completed);
            color: white;
            border-color: var(--completed);
        }

        .legend-icon.pending {
            background: var(--pending);
            color: var(--body-text);
        }

        .legend-icon.empty {
            background: var(--no-unit);
            color: var(--body-text);
        }

        /* Team Icons */
        .team-icon {
            width: 24px;
            height: 24px;
            border-radius: 3px;
            background: #84C7D0;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
        }
        
        /* Responsive Legend */
        @media (max-width: 768px) {
            .legend-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .legend-group {
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 640px) {
            .legend-container {
                margin: 0.5rem;
                padding: 0.75rem;
            }
            
            .legend-item {
                font-size: 0.75rem;
            }
            
            .legend-icon {
                width: 20px;
                height: 20px;
                font-size: 0.75rem;
            }
            
            .team-icon {
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
            }
        }

        /* Loading spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="config.js"></script>
    <script src="js/unified-auth.js"></script>
    <script src="js/unified-permissions.js"></script>
    <script src="js/user-profile-component.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        // Supabase configuration
        const supabaseUrl = 'https://pbecqosbkuyypsgwxnmq.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBiZWNxb3Nia3V5eXBzZ3d4bm1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDgyOTcsImV4cCI6MjA3MDIyNDI5N30.RxgJZpII8Fm1ym6UtMEdmw87DExR1MxtJXISag9vszQ';
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        window.supabase = supabase;
        
        // Get current user from Supabase
        async function getCurrentSupabaseUser() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    window.currentSupabaseUser = user;
                    return user;
                }
            } catch (error) {
                console.log('無法獲取 Supabase 用戶:', error);
            }
            return null;
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', getCurrentSupabaseUser);
    </script>
</head>
<body>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="goBack()">←</button>
                <div class="project-info">
                    <h1 id="projectName">載入中...</h1>
                    <p id="projectDescription">正在載入專案資料...</p>
                </div>
                <div class="header-actions" style="display: flex; align-items: center; gap: 0.75rem;">
                    <!-- 用戶管理按鈕 (管理員和領班可見) -->
                    <button id="userManagementBtn" onclick="goToUserManagement()" style="display: none;">
                        <span>👥</span>
                        <span>用戶管理</span>
                    </button>
                    

                    <button class="btn-report">
                        <span>📊</span>
                        <span>報表</span>
                    </button>
                    <button class="btn-settings">
                        <span>⚙️</span>
                        <span>編輯</span>
                    </button>
                    <button class="btn-export">
                        <span>📥</span>
                        <span>匯出</span>
                    </button>
                    <button class="btn-delete" style="background: #fee2e2; color: #dc2626; display: none;">
                        <span>🗑️</span>
                        <span>刪除</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <button class="section-toggle" onclick="toggleSection('statsSection')">統計資訊</button>
        <div class="stats-section" id="statsSection">
            <div class="stat-card">
                <div class="stat-icon">🏢</div>
                <div class="stat-content">
                    <div class="stat-value" id="statTotalSites">0</div>
                    <div class="stat-label">總案場數</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">✓</div>
                <div class="stat-content">
                    <div class="stat-value" id="statCompleted">0</div>
                    <div class="stat-label">已完工</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⏳</div>
                <div class="stat-content">
                    <div class="stat-value" id="statPending">0</div>
                    <div class="stat-label">待施工</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🔧</div>
                <div class="stat-content">
                    <div class="stat-value" id="statMaintenance">0</div>
                    <div class="stat-label">待維修</div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="spc">SPC工程</button>
            <button class="nav-tab" data-tab="cabinet">浴櫃工程</button>
            <button class="nav-tab" data-tab="maintenance">維修單</button>
            <button class="nav-tab" data-tab="announcements">進度公告</button>
        </div>

        <!-- Building Grid -->
        <div class="building-grid-wrapper">
            <div class="building-tabs" id="buildingTabs">
                <!-- 動態生成建築物標籤 -->
            </div>
            
            <!-- Legend -->
            <div id="gridLegend" class="legend-container">
                <div class="legend-group" style="background: rgba(132, 199, 208, 0.1); padding: 0.5rem 1rem; border-radius: 6px;">
                    <span class="legend-title">狀態：</span>
                    <div class="legend-item">
                        <div class="legend-icon completed"></div>
                        <span>完成</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon pending"></div>
                        <span>待施工</span>
                    </div>
                    <div class="legend-item" title="代表第1次的維修單待維修">
                        <div class="legend-icon" style="background: #fbbf24; color: white; border-color: #fbbf24; border-radius: 3px;">
                            <span style="font-size: 0.75rem; font-weight: 700;">1</span>
                        </div>
                        <span>待維修</span>
                    </div>
                    <div class="legend-item" title="代表第2次的維修單已維修">
                        <div class="legend-icon" style="background: #415a77; color: white; border-color: #415a77; border-radius: 3px;">
                            <span style="font-size: 0.75rem; font-weight: 700;">2</span>
                        </div>
                        <span>已維修</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon empty">✕</div>
                        <span>無此戶</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #d999b9; color: white; border-color: #d999b9; border-radius: 50%; width: 20px; height: 20px;">!</div>
                        <span>特別備註</span>
                    </div>
                </div>
            </div>
            
            <!-- Construction Team Info -->
            <div class="construction-team-info" id="constructionTeamInfo">
                <button class="team-info-toggle" onclick="toggleTeamInfo()">工班資訊</button>
                <div class="team-info-content">
                    <div style="padding: 1rem 1.5rem; background: #fffbeb;">
                        <div class="legend-group" style="background: transparent; padding: 0;">
                            <span class="legend-title">工班：</span>
                            <div class="legend-item" id="legendTeams">
                                <!-- 動態生成工班圖例 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="floor-grid-container">
                <div id="gridContent" class="loading">
                    載入中...
                </div>
            </div>
        </div>
    </div>

    <!-- Site Details Modal -->
    <div class="modal-overlay" id="siteModal">
        <div class="modal-container">
            <!-- Compact Header -->
            <div class="modal-header">
                <div class="header-info">
                    <div class="site-basic-info">
                        <div class="info-item">
                            <span class="info-label">棟別</span>
                            <span class="info-value" id="modalBuilding">-</span>
                        </div>
                        <div class="divider"></div>
                        <div class="info-item">
                            <span class="info-label">樓層</span>
                            <span class="info-value" id="modalFloor">-</span>
                        </div>
                        <div class="divider"></div>
                        <div class="info-item">
                            <span class="info-label">戶別</span>
                            <span class="info-value" id="modalUnit">-</span>
                        </div>
                        <div class="divider"></div>
                        <div class="info-item">
                            <span class="info-label">工班</span>
                            <span class="info-value" id="modalTeam">-</span>
                        </div>
                    </div>
                </div>
                <div class="modal-header-actions">
                    <button class="modal-share-btn" onclick="shareLink()">分享</button>
                    <button class="modal-close" onclick="closeModal()">×</button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <!-- 平面圖和施工前照片 - 一排兩列 -->
                <div class="all-media-compact" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <!-- 平面圖 -->
                    <div class="media-container">
                        <div class="media-header">
                            <span class="section-icon">📐</span>
                            <span class="section-title">平面圖</span>
                        </div>
                        <div class="photos-wrapper" id="floorPlanPhotos">
                            <div class="photo-box add-photo" onclick="uploadPhoto('floorPlan')">
                                <div style="font-size: 1.5rem; color: #9ca3af;">+</div>
                            </div>
                        </div>
                    </div>

                    <!-- 施工前照片 -->
                    <div class="media-container">
                        <div class="media-header">
                            <span class="section-icon">📷</span>
                            <span class="section-title">施工前照片</span>
                        </div>
                        <div class="photos-wrapper" id="beforePhotos">
                            <div class="photo-box add-photo" onclick="uploadPhoto('before')">
                                <div style="font-size: 1.5rem; color: #9ca3af;">+</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 施工前備註 - 可收合 -->
                <div class="before-construction-section collapsed" id="notesSection">
                    <div class="notes-header" onclick="toggleNotes()">
                        <div class="section-title" style="margin: 0;">
                            <span>📝</span>
                            <span>施工前特別備註</span>
                        </div>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="notes-content">
                        <textarea class="notes-input" id="notesInput" placeholder="請輸入施工前的特別注意事項..." onchange="checkNotesValue()"></textarea>
                    </div>
                </div>

                <!-- 施工完成 - 重要區塊 -->
                <div class="completion-section">
                    <div class="completion-checkbox">
                        <input type="checkbox" id="completionCheck" onchange="handleCompletionChange()">
                        <label class="completion-label" for="completionCheck">
                            施工完成
                            <span class="worker-name" id="workerName"></span>
                        </label>
                    </div>
                    <div class="completion-fields" id="completionFields">
                        <div class="field-group">
                            <label class="field-label">鋪設坪數</label>
                            <input type="number" class="field-input" id="areaInput" placeholder="15.5" step="0.1">
                        </div>
                        <div class="field-group">
                            <label class="field-label">師傅</label>
                            <input type="text" class="field-input" id="workerInput" readonly style="background: #f3f4f6;">
                        </div>
                    </div>
                    <div class="completion-fields" id="completionFields2" style="margin-top: 0.75rem;">
                        <div class="field-group" style="grid-column: span 2;">
                            <label class="field-label">施工日期</label>
                            <input type="date" class="field-input" id="dateInput">
                        </div>
                    </div>
                    
                    <!-- 工班施工完備註 -->
                    <div class="completion-fields" id="completionFields3" style="margin-top: 0.75rem; opacity: 0.5; pointer-events: none; transition: all 0.3s ease;">
                        <div class="field-group" style="grid-column: span 2;">
                            <label class="field-label">工班施工完備註</label>
                            <textarea class="field-input" id="workShiftCompletionNoteInput" rows="3" placeholder="請輸入施工完成備註..."></textarea>
                        </div>
                    </div>
                    
                    <!-- 完工照片和工地狀況照片在同一行 -->
                    <div class="completion-fields" style="margin-top: 0.75rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; opacity: 0.5; pointer-events: none; transition: all 0.3s ease;" id="completionPhotosRow">
                        <!-- 完工照片 -->
                        <div class="field-group" id="completionPhotos">
                            <label class="field-label">完工照片</label>
                            <div class="photos-wrapper" id="afterPhotos" style="border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.5rem; min-height: 100px; background: white;">
                                <div class="photo-box add-photo" onclick="uploadPhoto('after')">
                                    <div style="font-size: 1.5rem; color: #9ca3af;">+</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 工地狀況照片(施工後) -->
                        <div class="field-group" id="completionDifficultyPhotos">
                            <label class="field-label">工地狀況照片(施工後)</label>
                            <div class="photos-wrapper" id="difficultyPhotos" style="border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.5rem; min-height: 100px; background: white;">
                                <div class="photo-box add-photo" onclick="uploadPhoto('difficulty')">
                                    <div style="font-size: 1.5rem; color: #9ca3af;">+</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 提交區 -->
            <div class="submit-section">
                <button class="btn-cancel" onclick="closeModal()">取消</button>
                <button class="btn-submit" onclick="submitForm()">提交</button>
            </div>
        </div>
    </div>

    <!-- Lightbox for images -->
    <div id="lightbox" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; cursor: zoom-out;" onclick="closeLightbox()">
        <img id="lightboxImg" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%; object-fit: contain;">
    </div>
    
    <!-- Team Management Modal -->
    <div id="teamModal" class="team-modal">
        <div class="team-modal-content">
            <div class="team-modal-header">
                <h2 class="team-modal-title" id="teamModalTitle">工班成員管理</h2>
                <button class="team-modal-close" onclick="closeTeamModal()">✕</button>
            </div>
            <div class="team-modal-body">
                <div class="team-members-list" id="teamMembersList">
                    <!-- Members will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Member Management Modal (Add/Remove Members) -->
    <div id="memberManagementModal" class="team-modal">
        <div class="team-modal-content" style="max-width: 900px;">
            <div class="team-modal-header">
                <h2 class="team-modal-title">
                    管理成員 - <span id="managementTeamName"></span>
                </h2>
                <button class="team-modal-close" onclick="closeMemberManagementModal()">✕</button>
            </div>
            <div class="team-modal-body">
                <div class="member-management-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <!-- Left: Current Members -->
                    <div>
                        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">現有成員</h3>
                        <div id="currentMembersList" style="max-height: 300px; overflow-y: auto;">
                            <!-- Current members will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Right: Available Workers -->
                    <div>
                        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">可加入的師傅</h3>
                        <div id="workersList" style="max-height: 300px; overflow-y: auto;">
                            <!-- Available workers will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <!-- Quick Add Section -->
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">快速新增師傅</h3>
                    <div style="display: grid; grid-template-columns: 2fr 2fr 1fr 1fr auto; gap: 0.5rem; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #6b7280;">姓名</label>
                            <input type="text" id="quickAddName" placeholder="輸入姓名" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #6b7280;">電話</label>
                            <input type="tel" id="quickAddPhone" placeholder="請輸入手機號碼" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #6b7280;">簡稱</label>
                            <input type="text" id="quickAddAbbr" placeholder="自動" maxlength="2"
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #6b7280;">密碼</label>
                            <input type="text" id="quickAddPassword" placeholder="自動" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <button onclick="quickAddMember()" 
                                style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #3b82f6, #10b981); color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
                            新增
                        </button>
                    </div>
                    <div id="quickAddMessage" style="margin-top: 0.5rem; font-size: 0.875rem;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Member Modal -->
    <div id="addMemberModal" class="team-modal" style="display: none;">
        <div class="team-modal-content" style="max-width: 700px;">
            <div class="team-modal-header">
                <h2 class="team-modal-title">
                    <span id="addMemberTitle">新增成員</span>
                    <span id="addMemberTeamName" style="color: #3b82f6; font-size: 0.9rem; margin-left: 0.5rem;"></span>
                </h2>
                <button class="team-modal-close" onclick="closeAddMemberModal()">✕</button>
            </div>
            <div class="team-modal-body">
                <!-- Loading indicator -->
                <div id="memberModalLoading" style="display: none; text-align: center; padding: 2rem; color: #6b7280;">
                    <div style="display: inline-block; width: 32px; height: 32px; border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <div style="margin-top: 1rem;">載入中...</div>
                </div>
                
                <!-- Tab selection for existing/new member -->
                <div id="memberModalContent" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb;">
                    <button id="existingMemberTab" onclick="switchMemberTab('existing')" 
                            style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid #3b82f6; color: #3b82f6; cursor: pointer; font-weight: 600;">
                        選擇現有師傅
                    </button>
                    <button id="newMemberTab" onclick="switchMemberTab('new')" 
                            style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; cursor: pointer; font-weight: 600;">
                        建立新師傅
                    </button>
                </div>
                
                    <!-- Existing member selection -->
                    <div id="existingMemberSection">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">搜尋師傅</label>
                            <input type="text" id="workerSearchInput" placeholder="輸入姓名或電話搜尋..." 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"
                                   onkeyup="searchWorkers()">
                        </div>
                        <div id="workersList" style="max-height: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.5rem;">
                            <div style="text-align: center; color: #9ca3af; padding: 2rem;">載入中...</div>
                        </div>
                    </div>
                    
                    <!-- New member form -->
                    <div id="newMemberSection" style="display: none;">
                        <div style="display: grid; gap: 1rem;">
                            <!-- 角色選擇 -->
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                                <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: #374151;">設定角色</label>
                                <div style="display: flex; gap: 1rem;">
                                    <label style="flex: 1; display: flex; align-items: center; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" 
                                           id="memberRoleLabel"
                                           onclick="selectRole('team_member')">
                                        <input type="radio" id="roleMember" name="memberRole" value="team_member" checked style="margin-right: 0.5rem;">
                                        <span style="flex: 1;">
                                            <strong style="color: #1f2937;">一般成員</strong>
                                            <div style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem;">可查看及更新案場資料</div>
                                        </span>
                                    </label>
                                    <label style="flex: 1; display: flex; align-items: center; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                                           id="leaderRoleLabel"
                                           onclick="selectRole('team_leader')">
                                        <input type="radio" id="roleLeader" name="memberRole" value="team_leader" style="margin-right: 0.5rem;">
                                        <span style="flex: 1;">
                                            <strong style="color: #1f2937;">負責人</strong>
                                            <div style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem;">可管理工班成員及案場</div>
                                        </span>
                                    </label>
                                </div>
                            </div>
                            <!-- 電話/帳號 和 密碼 在同一行 -->
                            <div style="display: flex; gap: 1rem;">
                                <div style="flex: 2;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">電話/帳號 <span style="color: red;">*</span></label>
                                    <input type="tel" id="newMemberPhone" placeholder="輸入手機號碼" 
                                           onblur="checkDuplicatePhone()"
                                           oninput="updatePasswordDisplay()"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">密碼</label>
                                    <input type="text" id="memberPassword" readonly 
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f3f4f6;">
                                </div>
                            </div>
                            <!-- 姓名 和 簡稱 在同一行 -->
                            <div style="display: flex; gap: 1rem;">
                                <div style="flex: 2;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">姓名 <span style="color: red;">*</span></label>
                                    <input type="text" id="newMemberName" placeholder="輸入師傅姓名" 
                                           oninput="updateAbbreviation()"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">簡稱 <span style="color: red;">*</span></label>
                                    <input type="text" id="newMemberAbbreviation" placeholder="自動填入" maxlength="2"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                </div>
                            </div>
                            <!-- 重複提示區域 -->
                            <div id="duplicateWarning" style="display: none; padding: 1rem; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
                                <p style="color: #92400e; font-weight: 600; margin: 0 0 0.5rem 0;">
                                    此電話號碼已存在！
                                </p>
                                <div id="existingWorkerInfo" style="color: #92400e; margin: 0;"></div>
                                <p style="color: #92400e; margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                    按確認將把此師傅加入到當前工班。
                                </p>
                            </div>
                            <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; margin-top: 0.5rem;">
                                <p style="color: #92400e; font-size: 0.875rem; margin: 0;">
                                    <strong>提示：</strong>新建師傅將自動加入到 object_50HJ8__c 工地師父資料表和 users 表中，
                                    並將此工班資訊寫入 shift_type_multi_select__c 欄位。
                                </p>
                                
                                <!-- Duplicate phone warning -->
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button onclick="closeAddMemberModal()" style="padding: 0.5rem 1rem; margin-right: 0.5rem; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer;">取消</button>
                        <button id="confirmAddMemberBtn" onclick="confirmAddMember()" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;" disabled>確認新增</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = CONFIG?.API?.CRM_API_URL || CONFIG?.API?.D1_REST_API_URL || 'https://fx-d1-rest-api.lai-jameslai.workers.dev';
        // 使用統一配置的 API URL，移除 hardcode fallback
        const WORKER_API_URL = CONFIG?.API?.WORKER_API_URL || (
            console.error('CONFIG.API.WORKER_API_URL not found! Check config.js loading.'),
            'ERROR_NO_API_CONFIG'
        );
        const API_TOKEN = CONFIG?.API?.CRM_API_TOKEN || CONFIG?.API?.REST_API_TOKEN || 'fx-crm-api-secret-2025';

        // Generate MongoDB ObjectId
        function generateObjectId() {
            const timestamp = Math.floor(Date.now() / 1000).toString(16).padStart(8, '0');
            const randomBytes = Array.from({length: 16}, () => 
                Math.floor(Math.random() * 16).toString(16)
            ).join('');
            return timestamp + randomBytes;
        }

        // 欄位對應表
        const fieldMapping = {
            building: 'field_WD7k1__c',     // 棟別
            floor: 'field_Q6Svh__c',         // 樓層
            unit: 'field_XuJP2__c',          // 戶別
            team: 'shift_time__c',           // 工班
            area: 'field_B2gh1__c',          // 鋪設坪數
            worker: 'field_u1wpv__c',        // 工班師父
            date: 'field_23pFq__c',          // 施工日期
            completed: 'construction_completed__c',  // 施工完成
            beforeNotes: 'field_sF6fn__c',   // 施工前備註
            floorPlan: 'field_3T38o__c',     // 平面圖
            beforePhotos: 'field_V3d91__c',  // 施工前照片
            afterPhotos: 'field_3Fqof__c',   // 完工照片
            label: 'field_23Z5i__c',         // 標籤
            stage: 'field_z9H6O__c',         // 階段
            siteArea: 'field_tXAko__c',      // 工地坪數
            opportunityId: 'field_1P96q__c',  // 商機關聯
            workShiftCompletionNote: 'work_shift_completion_note__c',  // 工班施工完備註
            constructionDifficultyPhotos: 'construction_difficulty_ph__c'  // 工地狀況照片(施工後)
        };

        // Global variables
        let currentProject = null;
        let currentSites = [];
        let currentUser = null;
        let currentUserProjectRole = null; // 當前用戶在專案中的角色
        let currentBuilding = 'A';
        let isDataLoading = true;
        let isTeamsReady = false;
        let currentSiteId = null;


        // Team name to ID mapping cache
        let teamNameToIdMap = {};
        let teamIdToNameMap = {};
        
        // Load team mappings from SupplierObj
        async function loadTeamMappings() {
            try {
                console.log('Loading team mappings from SupplierObj...');
                const response = await fetch(`${API_BASE_URL}/rest/SupplierObj?limit=500`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const suppliers = data.results || [];
                    
                    // Build mapping for teams (suppliers with "工班" or specific company names)
                    suppliers.forEach(supplier => {
                        const name = supplier.name;
                        const id = supplier._id;
                        const abbreviation = supplier.abbreviation__c; // 取得簡稱
                        
                        // Check if this is likely a team/construction company
                        if (name && (name.includes('工班') || name.includes('師傅') || 
                                     name.includes('有限公司') || name.includes('企業'))) {
                            teamNameToIdMap[name] = id;
                            teamIdToNameMap[id] = {
                                name: name,
                                abbreviation: abbreviation || null
                            };
                            
                            // Also map common variations to handle edge cases
                            // Handle potential encoding issues
                            const decodedName = decodeURIComponent(name).trim();
                            if (decodedName !== name) {
                                teamNameToIdMap[decodedName] = id;
                            }
                        }
                    });
                    
                    console.log('Team mappings loaded:', Object.keys(teamNameToIdMap).length, 'teams');
                }
            } catch (error) {
                console.error('Failed to load team mappings:', error);
            }
        }
        
        // Helper function to get team ID from name
        function getTeamIdFromName(teamName) {
            return teamNameToIdMap[teamName] || teamName;
        }
        
        // Helper function to get team name from ID
        function getTeamNameFromId(teamId) {
            return teamIdToNameMap[teamId] || teamId;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Get project ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            const siteId = urlParams.get('site_id');
            const tabName = urlParams.get('tab') || 'spc';  // Default to 'spc' tab
            
            if (!projectId) {
                showError('未提供專案 ID');
                return;
            }
            
            // Initialize user profile component in header-actions
            const headerActions = document.querySelector('.header-actions');
            window.initUserProfile({
                showRole: true, // 顯示角色資訊
                showProfile: true, // 顯示用戶資料組件
                projectId: projectId,
                container: headerActions
            });
            
            // IMPORTANT: Load team mappings FIRST before any other data
            console.log('載入工班映射...');
            await loadTeamMappings();
            console.log('工班映射載入完成:', Object.keys(teamNameToIdMap).length, '個工班');

            
            // Update user management button visibility
            updateUserManagementButton();

            // Load user data
            await loadUserData();
            
            // Load project data (this will also load sites)
            await loadProject(projectId);
            
            // Load teams data after sites are loaded
            // This will be called after sites are processed
            // await loadProjectTeams(projectId); // Will be called from loadSites
            
            // If site_id is provided, open the modal
            if (siteId) {
                await openSiteModal(siteId);
            }

            // Setup event listeners
            setupEventListeners();
            
            // Switch to the tab specified in URL
            if (tabName && tabName !== 'spc') {
                // Find and click the corresponding tab
                const targetTab = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
                if (targetTab) {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    targetTab.classList.add('active');
                    handleTabSwitch(tabName);
                }
            }
        });

        // Load user data
        async function loadUserData() {
            // 從 localStorage 讀取 token（統一使用 localStorage）
            const token = localStorage.getItem('token');
            
            if (!token) {
                console.error('No token found in localStorage');
                window.location.href = 'login-simple.html';
                return;
            }

            try {
                const response = await fetch(`${WORKER_API_URL}/api/v1/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    currentUser = result.user || result;
                    
                    // 獲取用戶在專案中的角色
                    await getCurrentUserProjectRole();
                    
                    // 應用角色基礎的視圖控制
                    applyRoleBasedView();
                    
                } else if (response.status === 401) {
                    // Token 無效，返回登入頁
                    localStorage.removeItem('token');
                    window.location.href = 'login-simple.html';
                }
            } catch (error) {
                console.error('Error fetching current user:', error);
                // 如果發生錯誤，設置默認用戶（為了向後兼容）
                currentUser = {
                    id: 'user_001',
                    name: '王師傅',
                    phone: '0912345678'
                };
                
                // 仍然嘗試獲取角色
                await getCurrentUserProjectRole();
                applyRoleBasedView();
            }
        }

        // Load teams for the project (combine site teams with user data)
        async function loadProjectTeams(projectId) {
            try {
                // Wait for sites to be loaded first
                if (!window.projectTeamsFromSites) {
                    console.log('Waiting for sites data...');
                    return;
                }
                
                // Get team members from users table
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/teams`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'dev-token'}`
                    }
                });
                
                if (!response.ok) {
                    console.error('Failed to load team members');
                    // Still display teams even if no members
                    displayTeamsWithSiteInfo();
                    return;
                }
                
                const data = await response.json();
                
                // Combine site team info with user data
                const combinedTeams = [];
                
                // Process teams from sites (now using team ID as key) - ONLY teams with sites
                window.projectTeamsFromSites.forEach((teamInfo, teamId) => {
                    // Only process teams that have sites
                    if (teamInfo.siteCount > 0) {
                        // Find matching team from users data using team ID
                        const teamWithMembers = data.teams?.find(t => {
                            // Handle URL encoded team IDs
                            const decodedTeamId = decodeURIComponent(t.id || '');
                            const decodedTeamName = decodeURIComponent(t.name || '');
                            
                            // Match by team ID or decoded name to ID mapping
                            return t.id === teamId || 
                                   decodedTeamId === teamId || 
                                   teamNameToIdMap[decodedTeamName] === teamId;
                        }) || {
                            id: teamId,
                            name: teamInfo.name,
                            members: [],
                            leaders: [],
                            memberCount: 0
                        };
                        
                        // Combine the data
                        combinedTeams.push({
                            ...teamWithMembers,
                            id: teamId,  // Use team ID
                            name: teamInfo.name || teamWithMembers.name || `工班 ${teamId}`,
                            siteCount: teamInfo.siteCount,
                            sites: teamInfo.sites
                        });
                    }
                });
                
                // DO NOT add teams from user data that don't have sites
                // Only show teams that are actually assigned to sites
                console.log(`顯示 ${combinedTeams.length} 個有案場的工班，${window.unassignedSitesCount || 0} 個未分配案場`);
                
                displayTeams(combinedTeams);
                window.projectTeams = combinedTeams;
                isTeamsReady = true;
                console.log('[DEBUG] Teams loaded and ready:', combinedTeams.length);
                
            } catch (error) {
                console.error('Error loading teams:', error);
                // Still display teams from sites even on error
                displayTeamsWithSiteInfo();
            }
        }
        
        // Display teams with site info only (fallback)
        function displayTeamsWithSiteInfo() {
            const teams = [];
            window.projectTeamsFromSites?.forEach((teamInfo, teamId) => {
                teams.push({
                    id: teamId,  // Use team ID
                    name: teamInfo.name,  // Use the name stored in teamInfo
                    siteCount: teamInfo.siteCount,
                    sites: teamInfo.sites,
                    members: [],
                    leaders: [],
                    memberCount: 0
                });
            });
            displayTeams(teams);
            window.projectTeams = teams;
        }
        
        // Display team icons
        function displayTeams(teams) {
            const legendTeams = document.getElementById('legendTeams');
            if (!legendTeams) return;
            
            legendTeams.innerHTML = '';
            
            if (!teams || teams.length === 0) {
                legendTeams.innerHTML = '<span style="color: #9ca3af;">尚無工班</span>';
                return;
            }
            
            // 過濾工班：如果不是管理員且有特定工班歸屬，只顯示自己的工班
            let filteredTeams = teams;
            if (!window.isAdmin && window.userTeams && window.userTeams.size > 0) {
                filteredTeams = teams.filter(team => window.userTeams.has(team.name));
                console.log('工班過濾結果:', filteredTeams.map(t => t.name));
            }
            
            if (filteredTeams.length === 0) {
                legendTeams.innerHTML = '<span style="color: #9ca3af;">無可顯示的工班</span>';
                return;
            }
            
            // Check if mobile
            const isMobile = window.innerWidth <= 768;
            
            // Create wrapper for carousel on mobile
            if (isMobile) {
                const carouselWrapper = document.createElement('div');
                carouselWrapper.style.cssText = 'position: relative; overflow: hidden;';
                
                // Create carousel controls
                const prevBtn = document.createElement('button');
                prevBtn.innerHTML = '◀';
                prevBtn.style.cssText = `
                    position: absolute;
                    left: 0;
                    top: 50%;
                    transform: translateY(-50%);
                    background: rgba(255, 255, 255, 0.95);
                    border: 1px solid #e5e7eb;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    z-index: 10;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                
                const nextBtn = document.createElement('button');
                nextBtn.innerHTML = '▶';
                nextBtn.style.cssText = `
                    position: absolute;
                    right: 0;
                    top: 50%;
                    transform: translateY(-50%);
                    background: rgba(255, 255, 255, 0.95);
                    border: 1px solid #e5e7eb;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    z-index: 10;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                
                // Create scrollable container
                const scrollContainer = document.createElement('div');
                scrollContainer.style.cssText = `
                    overflow-x: auto;
                    overflow-y: hidden;
                    scroll-behavior: smooth;
                    padding: 5px 40px;
                    -webkit-overflow-scrolling: touch;
                    scrollbar-width: none;
                    -ms-overflow-style: none;
                `;
                
                // Add CSS to hide scrollbar
                const style = document.createElement('style');
                style.textContent = `
                    #legendTeams ::-webkit-scrollbar {
                        display: none;
                    }
                    #legendTeams {
                        -ms-overflow-style: none;
                        scrollbar-width: none;
                    }
                `;
                if (!document.querySelector('style[data-carousel-style]')) {
                    style.setAttribute('data-carousel-style', 'true');
                    document.head.appendChild(style);
                }
                
                const teamsContainer = document.createElement('div');
                teamsContainer.style.cssText = 'display: flex; gap: 0.75rem; flex-wrap: nowrap; align-items: center;';
                teamsContainer.id = 'teamsCarousel';
                
                // Add scroll event handlers
                prevBtn.onclick = () => {
                    scrollContainer.scrollBy({ left: -200, behavior: 'smooth' });
                };
                
                nextBtn.onclick = () => {
                    scrollContainer.scrollBy({ left: 200, behavior: 'smooth' });
                };
                
                // Update button states based on scroll position
                const updateScrollButtons = () => {
                    const scrollLeft = scrollContainer.scrollLeft;
                    const scrollWidth = scrollContainer.scrollWidth;
                    const clientWidth = scrollContainer.clientWidth;
                    
                    prevBtn.style.opacity = scrollLeft <= 0 ? '0.3' : '1';
                    prevBtn.style.cursor = scrollLeft <= 0 ? 'not-allowed' : 'pointer';
                    
                    nextBtn.style.opacity = scrollLeft >= scrollWidth - clientWidth - 10 ? '0.3' : '1';
                    nextBtn.style.cursor = scrollLeft >= scrollWidth - clientWidth - 10 ? 'not-allowed' : 'pointer';
                };
                
                scrollContainer.addEventListener('scroll', updateScrollButtons);
                
                // Build carousel structure
                scrollContainer.appendChild(teamsContainer);
                carouselWrapper.appendChild(prevBtn);
                carouselWrapper.appendChild(nextBtn);
                carouselWrapper.appendChild(scrollContainer);
                
                legendTeams.appendChild(carouselWrapper);
                
                // Add scroll indicator
                const scrollIndicator = document.createElement('div');
                scrollIndicator.style.cssText = `
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    margin-top: 10px;
                    gap: 4px;
                `;
                
                // Calculate number of pages
                const updateScrollIndicator = () => {
                    const scrollWidth = scrollContainer.scrollWidth;
                    const clientWidth = scrollContainer.clientWidth;
                    const scrollLeft = scrollContainer.scrollLeft;
                    const numPages = Math.ceil(scrollWidth / clientWidth);
                    const currentPage = Math.floor((scrollLeft + clientWidth / 2) / clientWidth);
                    
                    scrollIndicator.innerHTML = '';
                    for (let i = 0; i < numPages; i++) {
                        const dot = document.createElement('span');
                        dot.style.cssText = `
                            width: ${i === currentPage ? '20px' : '6px'};
                            height: 6px;
                            border-radius: 3px;
                            background: ${i === currentPage ? '#84C7D0' : '#d1d5db'};
                            transition: all 0.3s;
                            cursor: pointer;
                        `;
                        dot.onclick = () => {
                            scrollContainer.scrollTo({ left: i * clientWidth, behavior: 'smooth' });
                        };
                        scrollIndicator.appendChild(dot);
                    }
                };
                
                scrollContainer.addEventListener('scroll', () => {
                    updateScrollButtons();
                    updateScrollIndicator();
                });
                
                legendTeams.appendChild(scrollIndicator);
                
                // Initial states
                setTimeout(() => {
                    updateScrollButtons();
                    updateScrollIndicator();
                }, 100);
            } else {
                // Desktop layout
                const teamsContainer = document.createElement('div');
                teamsContainer.style.cssText = 'display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;';
                legendTeams.appendChild(teamsContainer);
            }
            
            // Get the container to add teams to
            const teamsContainer = isMobile ? 
                document.getElementById('teamsCarousel') : 
                legendTeams.querySelector('div');
            
            // 先添加所有工班按鈕
            filteredTeams.forEach(team => {
                const teamButton = document.createElement('button');
                const buttonWidth = isMobile ? '160px' : '80px';
                teamButton.style.cssText = `
                    cursor: pointer; 
                    padding: 0.625rem 1rem; 
                    background: #84C7D0; 
                    color: white; 
                    border: none;
                    border-radius: 20px; 
                    font-weight: 600; 
                    font-size: 0.875rem;
                    display: inline-flex; 
                    align-items: center; 
                    gap: 0.5rem; 
                    transition: all 0.2s;
                    min-width: ${buttonWidth};
                    white-space: nowrap;
                    flex-shrink: 0;
                `;
                
                // Show full team name with site count badge
                const teamNameSpan = document.createElement('span');
                teamNameSpan.textContent = team.name || `工班 ${team.id}`;
                
                const countBadge = document.createElement('span');
                countBadge.style.cssText = `
                    background: #ef4444; 
                    color: white; 
                    border-radius: 12px; 
                    padding: 2px 8px; 
                    font-size: 0.75rem; 
                    min-width: 24px; 
                    text-align: center; 
                    display: inline-block;
                    font-weight: bold;
                `;
                countBadge.textContent = team.siteCount || 0;
                
                teamButton.appendChild(teamNameSpan);
                teamButton.appendChild(countBadge);
                
                // Tooltip shows both site count and member count
                const siteText = team.siteCount ? `${team.siteCount} 個案場` : '無案場';
                const memberText = team.memberCount ? `${team.memberCount} 位成員` : '無成員';
                teamButton.title = `${team.name}\n${siteText}\n${memberText}`;
                
                // Add hover effect
                teamButton.onmouseenter = () => {
                    teamButton.style.transform = 'scale(1.05)';
                    teamButton.style.boxShadow = '0 4px 12px rgba(132, 199, 208, 0.4)';
                    teamButton.style.background = '#6BB8C3';
                };
                teamButton.onmouseleave = () => {
                    teamButton.style.transform = 'scale(1)';
                    teamButton.style.boxShadow = 'none';
                    teamButton.style.background = '#84C7D0';
                };
                
                // Fix onclick event
                teamButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Team button clicked:', team.name);
                    showTeamModal(team);
                });
                
                teamsContainer.appendChild(teamButton);
            });
            
            // 最後添加「未分配」按鈕（如果有未分配的案場）
            console.log('[DEBUG] 檢查未分配按鈕顯示條件: window.unassignedSitesCount =', window.unassignedSitesCount);
            if (window.unassignedSitesCount > 0) {
                console.log('[DEBUG] 創建未分配按鈕，數量:', window.unassignedSitesCount);
                const unassignedButton = document.createElement('button');
                const buttonWidth = isMobile ? '160px' : '100px';
                unassignedButton.style.cssText = `
                    cursor: pointer; 
                    padding: 0.625rem 1rem; 
                    background: #6b7280; 
                    color: white; 
                    border: none;
                    border-radius: 20px; 
                    font-weight: 600; 
                    font-size: 0.875rem;
                    display: inline-flex; 
                    align-items: center; 
                    gap: 0.5rem; 
                    transition: all 0.2s;
                    min-width: ${buttonWidth};
                    white-space: nowrap;
                    flex-shrink: 0;
                `;
                
                // 未分配文字
                const unassignedSpan = document.createElement('span');
                unassignedSpan.textContent = '未分配';
                
                // 數量標籤
                const countBadge = document.createElement('span');
                countBadge.style.cssText = `
                    background: #dc2626; 
                    color: white; 
                    border-radius: 12px; 
                    padding: 2px 8px; 
                    font-size: 0.75rem; 
                    min-width: 24px; 
                    text-align: center; 
                    display: inline-block;
                    font-weight: bold;
                `;
                countBadge.textContent = window.unassignedSitesCount;
                
                unassignedButton.appendChild(unassignedSpan);
                unassignedButton.appendChild(countBadge);
                
                unassignedButton.title = `${window.unassignedSitesCount} 個案場尚未分配工班`;
                
                // 添加懸停效果
                unassignedButton.onmouseenter = () => {
                    unassignedButton.style.transform = 'scale(1.05)';
                    unassignedButton.style.boxShadow = '0 4px 12px rgba(107, 114, 128, 0.4)';
                    unassignedButton.style.background = '#4b5563';
                };
                unassignedButton.onmouseleave = () => {
                    unassignedButton.style.transform = 'scale(1)';
                    unassignedButton.style.boxShadow = 'none';
                    unassignedButton.style.background = '#6b7280';
                };
                
                // 點擊事件 - 顯示未分配案場列表
                unassignedButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showUnassignedSitesModal();
                });
                
                teamsContainer.appendChild(unassignedButton);
            }
            
            legendTeams.appendChild(teamsContainer);
        }
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Re-render teams display on resize
                if (window.projectTeams && window.projectTeams.length > 0) {
                    displayTeams(window.projectTeams);
                }
            }, 250);
        });
        
        // Show team management modal with unified interface
        async function showTeamModal(team) {
            // Check if data is ready
            if (isDataLoading || !window.currentProject) {
                alert('數據載入中，請稍候...');
                return;
            }
            
            const modal = document.getElementById('teamModal');
            const title = document.getElementById('teamModalTitle');
            const membersList = document.getElementById('teamMembersList');
            
            // Update title with site count
            const siteInfo = team.siteCount ? `(${team.siteCount} 個案場)` : '(無案場)';
            title.textContent = `${team.name} ${siteInfo}`;
            window.currentTeam = team;
            
            // Store members list in window for other functions to access
            const leaders = team.leaders || [];
            const members = team.members || [];
            
            // Get current user permissions
            const currentUserRole = getCurrentUserRole();
            const canEdit = currentUserRole === 'admin' || 
                           (currentUserRole === 'team_leader' && isCurrentUserTeamLeader(team));
            
            // Display team members list (original simple design)
            membersList.innerHTML = `
                <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #6b7280;">案場數量：</span>
                        <span style="font-weight: 600;">${team.siteCount || 0} 個</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #6b7280;">成員數量：</span>
                        <span style="font-weight: 600;">${leaders.length + members.length} 人</span>
                    </div>
                </div>
                
                ${leaders.length > 0 ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">負責人</h4>
                        ${leaders.map(leader => `
                            <div class="team-member-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px; margin-bottom: 0.5rem;">
                                <div>
                                    <div style="font-weight: 600; color: #065f46;">${leader.name}</div>
                                    <div style="color: #6b7280; font-size: 0.75rem;">${leader.phone}</div>
                                </div>
                                ${canEdit ? `
                                    <button onclick="removeMemberFromTeam('${leader.userId || leader.id}', '${leader.name}')" 
                                            style="padding: 0.25rem 0.5rem; background: #fee2e2; border: none; border-radius: 4px; cursor: pointer; color: #991b1b; font-size: 0.75rem;">
                                        移除
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${members.length > 0 ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">成員</h4>
                        ${members.map(member => `
                            <div class="team-member-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 0.5rem;">
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">${member.name}</div>
                                    <div style="color: #6b7280; font-size: 0.75rem;">${member.phone}</div>
                                </div>
                                ${canEdit ? `
                                    <button onclick="removeMemberFromTeam('${member.userId || member.id}', '${member.name}')" 
                                            style="padding: 0.25rem 0.5rem; background: #fee2e2; border: none; border-radius: 4px; cursor: pointer; color: #991b1b; font-size: 0.75rem;">
                                        移除
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${leaders.length === 0 && members.length === 0 ? `
                    <div style="text-align: center; padding: 2rem; color: #9ca3af;">
                        尚無成員
                    </div>
                ` : ''}
                
                ${canEdit ? `
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                        <button onclick="showMemberManagementModal()" 
                                style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #84C7D0, #6eb5c0); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            管理成員
                        </button>
                    </div>
                ` : ''}
            `;
            
            modal.classList.add('active');
        }
        
        // Close team modal
        function closeTeamModal() {
            document.getElementById('teamModal').classList.remove('active');
        }
        
        // Show unassigned sites modal
        function showUnassignedSitesModal() {
            // 收集未分配的案場
            const unassignedSites = currentSites.filter(site => {
                const teamValue = site[fieldMapping.team];
                return !teamValue || teamValue === '-';
            });
            
            // 使用現有的 teamModal 來顯示
            const modal = document.getElementById('teamModal');
            const title = document.getElementById('teamModalTitle');
            const membersList = document.getElementById('teamMembersList');
            
            title.textContent = `未分配案場 (${unassignedSites.length} 個)`;
            
            // 按棟別分組顯示未分配案場
            const sitesByBuilding = {};
            unassignedSites.forEach(site => {
                const building = site[fieldMapping.building] || 'A';
                if (!sitesByBuilding[building]) {
                    sitesByBuilding[building] = [];
                }
                sitesByBuilding[building].push(site);
            });
            
            membersList.innerHTML = `
                <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="color: #991b1b; font-weight: 600;">
                        共有 ${unassignedSites.length} 個案場尚未分配工班
                    </div>
                </div>
                
                ${Object.entries(sitesByBuilding).map(([building, sites]) => `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #374151; font-size: 0.875rem; margin-bottom: 0.5rem;">
                            ${building}棟 (${sites.length} 個)
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem;">
                            ${sites.map(site => `
                                <div style="padding: 0.5rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 4px; text-align: center; font-size: 0.75rem;">
                                    ${site[fieldMapping.floor]}F-${site[fieldMapping.unit]}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
            
            modal.classList.add('active');
        }
        
        // Show member management modal (separate modal for adding/removing members)
        async function showMemberManagementModal() {
            const modal = document.getElementById('memberManagementModal');
            const teamNameSpan = document.getElementById('managementTeamName');
            
            if (!modal) {
                console.error('Member management modal not found');
                return;
            }
            
            // Set team name
            if (window.currentTeam) {
                teamNameSpan.textContent = window.currentTeam.name;
            }
            
            // Load workers for the current team
            await loadWorkers();
            
            // Setup quick add listeners
            setupQuickAddListeners();
            
            // Show the modal
            modal.classList.add('active');
        }
        
        // Close member management modal
        function closeMemberManagementModal() {
            const modal = document.getElementById('memberManagementModal');
            if (modal) {
                modal.classList.remove('active');
            }
            
            // Reload team modal to show updated members
            if (window.currentTeam) {
                showTeamModal(window.currentTeam);
            }
        }
        
        // Setup quick add listeners
        function setupQuickAddListeners() {
            const nameInput = document.getElementById('quickAddName');
            const phoneInput = document.getElementById('quickAddPhone');
            const abbrInput = document.getElementById('quickAddAbbr');
            const passwordInput = document.getElementById('quickAddPassword');
            
            if (nameInput) {
                nameInput.addEventListener('input', () => {
                    // Auto-fill abbreviation
                    if (nameInput.value && !abbrInput.value) {
                        abbrInput.value = nameInput.value.slice(-1);
                    }
                });
            }
            
            if (phoneInput) {
                phoneInput.addEventListener('input', () => {
                    // Auto-generate password (last 3 digits)
                    if (phoneInput.value.length >= 3 && passwordInput) {
                        // Only auto-fill if password field is empty or still has the auto-generated value
                        if (!passwordInput.value || passwordInput.getAttribute('data-auto') === 'true') {
                            passwordInput.value = phoneInput.value.slice(-3);
                            passwordInput.setAttribute('data-auto', 'true');
                        }
                    }
                });
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('input', () => {
                    // Mark as manually edited
                    if (passwordInput.value) {
                        passwordInput.setAttribute('data-auto', 'false');
                    }
                });
            }
        }
        
        // Quick add member
        async function quickAddMember() {
            const name = document.getElementById('quickAddName').value.trim();
            const phone = document.getElementById('quickAddPhone').value.trim();
            const abbreviation = document.getElementById('quickAddAbbr').value.trim() || name.slice(-1);
            const password = document.getElementById('quickAddPassword').value.trim() || phone.slice(-3);
            const messageDiv = document.getElementById('quickAddMessage');
            
            if (!name || !phone) {
                messageDiv.innerHTML = '<span style="color: #dc2626;">請填寫姓名和電話</span>';
                return;
            }
            
            // Validate phone format
            if (!/^09\d{8}$/.test(phone)) {
                messageDiv.innerHTML = '<span style="color: #dc2626;">請輸入正確的手機號碼格式</span>';
                return;
            }
            
            messageDiv.innerHTML = '<span style="color: #6b7280;">新增中...</span>';
            
            try {
                // Generate MongoDB ObjectId
                const objectId = generateObjectId();
                
                // Create worker in CRM
                const workerData = {
                    _id: objectId,
                    name: name,
                    phone_number__c: phone,
                    account__c: phone,
                    password__c: password,  // Use the password from input field
                    abbreviation__c: abbreviation,
                    shift_type_multi_select__c: JSON.stringify([window.currentTeam.id]),
                    record_type: 'default__c',
                    life_status: 'normal'
                };
                
                const response = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(workerData)
                });
                
                if (response.ok) {
                    messageDiv.innerHTML = '<span style="color: #10b981;">✓ 成員新增成功！</span>';
                    
                    // Clear inputs
                    document.getElementById('quickAddName').value = '';
                    document.getElementById('quickAddPhone').value = '';
                    document.getElementById('quickAddAbbr').value = '';
                    document.getElementById('quickAddPassword').value = '';
                    
                    // Refresh the modal after 1 second
                    setTimeout(() => {
                        showTeamModal(window.currentTeam);
                    }, 1000);
                } else {
                    const error = await response.text();
                    console.error('Failed to create worker:', error);
                    messageDiv.innerHTML = '<span style="color: #dc2626;">新增失敗，請稍後再試</span>';
                }
            } catch (error) {
                console.error('Error adding member:', error);
                messageDiv.innerHTML = '<span style="color: #dc2626;">新增失敗：' + error.message + '</span>';
            }
        }
        
        // Add existing member to team
        async function addExistingMemberToTeam(workerId, workerName) {
            if (!confirm(`確定要將 ${workerName} 加入到 ${window.currentTeam.name}？`)) {
                return;
            }
            
            try {
                // Get current worker data
                const getResponse = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c/${workerId}`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error('無法取得成員資料');
                }
                
                const workerData = await getResponse.json();
                const currentTeams = workerData.shift_type_multi_select__c || [];
                
                // Add team ID if not already present
                if (!currentTeams.includes(window.currentTeam.id)) {
                    currentTeams.push(window.currentTeam.id);
                }
                
                // Update worker with new team
                const updateResponse = await fetch(`${API_BASE_URL}/crud/object_50HJ8__c/${workerId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        shift_type_multi_select__c: currentTeams
                    })
                });
                
                if (updateResponse.ok) {
                    alert(`${workerName} 已成功加入工班！`);
                    showTeamModal(window.currentTeam); // Refresh modal
                } else {
                    throw new Error('更新失敗');
                }
            } catch (error) {
                console.error('Error adding member to team:', error);
                alert('加入失敗：' + error.message);
            }
        }
        
        // Remove member from team
        async function removeMemberFromTeam(memberId, memberName) {
            if (!confirm(`確定要將 ${memberName} 從 ${window.currentTeam.name} 移除？`)) {
                return;
            }
            
            try {
                // Get current worker data
                const getResponse = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c/${memberId}`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error('無法取得成員資料');
                }
                
                const workerData = await getResponse.json();
                let currentTeams = workerData.shift_type_multi_select__c || [];
                
                // Remove team ID
                currentTeams = currentTeams.filter(id => id !== window.currentTeam.id);
                
                // Update worker
                const updateResponse = await fetch(`${API_BASE_URL}/crud/object_50HJ8__c/${memberId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        shift_type_multi_select__c: currentTeams
                    })
                });
                
                if (updateResponse.ok) {
                    alert(`${memberName} 已從工班移除`);
                    showTeamModal(window.currentTeam); // Refresh modal
                } else {
                    throw new Error('更新失敗');
                }
            } catch (error) {
                console.error('Error removing member from team:', error);
                alert('移除失敗：' + error.message);
            }
        }
        
        // Get current user role (mock for now, should be from session)
        // 獲取當前用戶在專案中的角色和權限
        async function getCurrentUserProjectRole() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            
            if (!projectId) return null;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const allUsers = result.data.all || [];
                    
                    // 查找當前用戶的專案角色
                    const currentUserInProject = allUsers.find(user => 
                        user.user_id === currentUser?.id || 
                        user.phone === currentUser?.phone
                    );
                    
                    if (currentUserInProject) {
                        currentUserProjectRole = {
                            user_type: currentUserInProject.user_type,
                            role: currentUserInProject.role,
                            team_id: currentUserInProject.team_id,
                            team_name: currentUserInProject.team_name,
                            can_view_other_teams: currentUserInProject.can_view_other_teams || currentUserInProject.user_type === 'admin' || currentUserInProject.user_type === 'owner'
                        };
                        
                        console.log('Current user project role:', currentUserProjectRole);
                    } else {
                        // 如果找不到用戶在專案中的記錄，檢查是否為 global admin
                        if (currentUser?.user_type === 'admin' || currentUser?.role === 'admin') {
                            currentUserProjectRole = {
                                user_type: 'admin',
                                role: 'admin',
                                team_id: null,
                                team_name: null,
                                can_view_other_teams: true
                            };
                        } else {
                            console.warn('Current user not found in project users');
                            currentUserProjectRole = null;
                        }
                    }
                }
            } catch (error) {
                console.error('Error getting current user project role:', error);
                currentUserProjectRole = null;
            }
            
            return currentUserProjectRole;
        }

        function getCurrentUserRole() {
            // 兼容現有代碼，返回簡化的角色
            if (currentUserProjectRole) {
                if (currentUserProjectRole.user_type === 'admin') return 'admin';
                if (currentUserProjectRole.user_type === 'owner') return 'owner';
                if (currentUserProjectRole.user_type === 'worker') {
                    return currentUserProjectRole.role === 'leader' ? 'team_leader' : 'team_member';
                }
            }
            return 'admin'; // Default fallback for existing code
        }

        // 應用角色基礎的視圖控制
        function applyRoleBasedView() {
            // 檢查全局 Super Admin 權限
            if (currentUser && (currentUser.global_role === 'super_admin' || currentUser.role === 'super_admin' || currentUser.user_type === 'super_admin')) {
                console.log('Global Super Admin detected, granting full permissions');
                const userManagementBtn = document.getElementById('userManagementBtn');
                if (userManagementBtn) userManagementBtn.style.display = 'flex';
                showAdminFeatures();
                return; // Skip project-specific role checks
            }
            
            if (!currentUserProjectRole) {
                console.warn('No project role found for current user');
                return;
            }

            console.log('Applying role-based view for:', currentUserProjectRole);

            // 控制用戶管理按鈕的可見性
            const userManagementBtn = document.getElementById('userManagementBtn');
            if (currentUserProjectRole.user_type === 'admin' || currentUserProjectRole.user_type === 'super_admin') {
                // Admin/Super Admin: 可以看到和操作所有內容
                if (userManagementBtn) userManagementBtn.style.display = 'flex';
                
                // 顯示刪除按鈕（只有 admin/super_admin 可以看到）
                showAdminFeatures();
            } else if (currentUserProjectRole.user_type === 'owner') {
                // Owner: 只能查看，隱藏管理功能
                if (userManagementBtn) userManagementBtn.style.display = 'none';
                
                // 隱藏編輯相關的按鈕和功能
                hideEditingFeatures();
            } else if (currentUserProjectRole.user_type === 'worker') {
                if (currentUserProjectRole.role === 'leader') {
                    // Team Leader: 可以管理自己的工班，有限的用戶管理權限
                    if (userManagementBtn) userManagementBtn.style.display = 'flex';
                    
                    // 隱藏專案級別的編輯功能（如刪除專案按鈕）
                    hideProjectLevelEditingFeatures();
                    
                    // 只能編輯自己工班的內容
                    restrictToOwnTeam();
                } else {
                    // Worker: 只能查看，最少權限
                    if (userManagementBtn) userManagementBtn.style.display = 'none';
                    
                    // 隱藏所有編輯功能
                    hideEditingFeatures();
                    restrictToOwnTeam();
                }
            }
            
            // 更新頁面標題以反映當前角色
            updatePageTitleWithRole();
        }

        // 隱藏編輯功能
        function hideEditingFeatures() {
            // 隱藏所有編輯按鈕
            const editButtons = document.querySelectorAll('.btn-edit, .edit-btn, [onclick*="edit"], [onclick*="Edit"]');
            editButtons.forEach(btn => {
                if (btn.textContent.includes('編輯') || btn.textContent.includes('修改') || btn.textContent.includes('更新')) {
                    btn.style.display = 'none';
                }
            });
            
            // 隱藏新增按鈕
            const addButtons = document.querySelectorAll('.btn-add, .add-btn, [onclick*="add"], [onclick*="Add"], [onclick*="create"]');
            addButtons.forEach(btn => {
                if (btn.textContent.includes('新增') || btn.textContent.includes('添加') || btn.textContent.includes('建立')) {
                    btn.style.display = 'none';
                }
            });
            
            // 隱藏刪除按鈕
            const deleteButtons = document.querySelectorAll('.btn-delete, .delete-btn, [onclick*="delete"], [onclick*="remove"]');
            deleteButtons.forEach(btn => {
                if (btn.textContent.includes('刪除') || btn.textContent.includes('移除')) {
                    btn.style.display = 'none';
                }
            });
        }

        // 隱藏專案級別的編輯功能（工班負責人不能刪除/編輯專案）
        function hideProjectLevelEditingFeatures() {
            // 隱藏專案刪除按鈕
            const projectDeleteButtons = document.querySelectorAll('.btn-delete');
            projectDeleteButtons.forEach(btn => {
                if (btn.textContent.includes('刪除')) {
                    btn.style.display = 'none';
                }
            });
            
            // 隱藏專案編輯按鈕
            const projectEditButtons = document.querySelectorAll('.btn-edit');
            projectEditButtons.forEach(btn => {
                if (btn.textContent.includes('編輯')) {
                    btn.style.display = 'none';
                }
            });
        }

        // 顯示管理員功能（只有 admin 可以看到刪除/編輯按鈕）
        function showAdminFeatures() {
            // 顯示專案刪除按鈕
            const projectDeleteButtons = document.querySelectorAll('.btn-delete');
            projectDeleteButtons.forEach(btn => {
                if (btn.textContent.includes('刪除')) {
                    btn.style.display = 'flex';
                }
            });
            
            // 顯示專案編輯按鈕
            const projectEditButtons = document.querySelectorAll('.btn-edit');
            projectEditButtons.forEach(btn => {
                if (btn.textContent.includes('編輯')) {
                    btn.style.display = 'flex';
                }
            });
        }

        // 限制只能查看自己的工班
        function restrictToOwnTeam() {
            if (!currentUserProjectRole.team_id) return;
            
            console.log('Restricting view to team:', currentUserProjectRole.team_name);
            
            // 修改全局工班過濾器，只顯示用戶所屬的工班
            window.currentUserTeamFilter = currentUserProjectRole.team_id;
            
            // 如果有工班按鈕容器，隱藏其他工班
            setTimeout(() => {
                filterTeamDisplay();
            }, 1000); // 延遲執行，確保工班數據已載入
        }

        // 過濾工班顯示
        function filterTeamDisplay() {
            if (!currentUserProjectRole || !currentUserProjectRole.team_id) return;
            
            // 隱藏不屬於當前用戶的工班按鈕
            const teamButtons = document.querySelectorAll('button[title*="工班"]');
            teamButtons.forEach(button => {
                const teamName = button.querySelector('span')?.textContent;
                if (teamName && teamName !== currentUserProjectRole.team_name) {
                    button.style.display = 'none';
                }
            });
            
            // 過濾工班資訊顯示
            const teamInfoElements = document.querySelectorAll('.team-info, .team-member-item, .team-section');
            teamInfoElements.forEach(element => {
                if (element.textContent && element.textContent.includes(currentUserProjectRole.team_name)) {
                    element.style.display = 'block';
                } else if (element.textContent && element.textContent.includes('工班')) {
                    element.style.display = 'none';
                }
            });
        }

        // 更新頁面標題以反映當前角色
        function updatePageTitleWithRole() {
            // 禁用角色顯示 - 不在頁面標題中顯示角色資訊
            return;
        }
        
        // Check if current user is team leader of this team
        function isCurrentUserTeamLeader(team) {
            // TODO: Check if current user is in team.leaders
            const currentUserId = localStorage.getItem('userId');
            return team.leaders?.some(leader => leader.userId === currentUserId);
        }
        
        // Edit team member
        function editMember(userId, memberData) {
            // Parse member data if it's a string
            if (typeof memberData === 'string') {
                try {
                    memberData = JSON.parse(memberData);
                } catch (e) {
                    console.error('Failed to parse member data:', e);
                    return;
                }
            }
            
            // Show edit modal
            showEditMemberModal(userId, memberData);
        }
        
        // Show edit member modal
        function showEditMemberModal(userId, memberData) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('editMemberModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'editMemberModal';
                modal.className = 'team-modal';
                modal.innerHTML = `
                    <div class="team-modal-content" style="max-width: 500px;">
                        <div class="team-modal-header">
                            <h2 class="team-modal-title">編輯成員資料</h2>
                            <button class="team-modal-close" onclick="closeEditMemberModal()">✕</button>
                        </div>
                        <div class="team-modal-body" id="editMemberForm">
                            <!-- Form will be populated here -->
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Populate form
            const formContainer = document.getElementById('editMemberForm');
            formContainer.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">姓名</label>
                        <input type="text" id="editMemberName" value="${memberData.name || ''}" 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">電話 (不可編輯)</label>
                        <input type="text" value="${memberData.phone || ''}" readonly
                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f3f4f6;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">簡稱</label>
                        <input type="text" id="editMemberAbbreviation" value="${memberData.abbreviation || ''}" 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">角色</label>
                        <select id="editMemberRole" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="team_member" ${memberData.role !== 'team_leader' ? 'selected' : ''}>成員</option>
                            <option value="team_leader" ${memberData.role === 'team_leader' ? 'selected' : ''}>負責人</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; text-align: right;">
                    <button onclick="closeEditMemberModal()" 
                            style="padding: 0.5rem 1rem; margin-right: 0.5rem; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer;">
                        取消
                    </button>
                    <button onclick="saveEditMember('${userId}')" 
                            style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        儲存
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        // Close edit member modal
        function closeEditMemberModal() {
            const modal = document.getElementById('editMemberModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        // Save edited member data
        async function saveEditMember(userId) {
            const name = document.getElementById('editMemberName').value.trim();
            const abbreviation = document.getElementById('editMemberAbbreviation').value.trim();
            const role = document.getElementById('editMemberRole').value;
            
            if (!name) {
                alert('請輸入姓名');
                return;
            }
            
            const projectId = window.currentProject?.id;
            const teamId = window.currentTeam?.id || window.currentTeam?.name;
            
            if (!projectId || !teamId) {
                alert('無法取得專案或工班資訊');
                return;
            }
            
            try {
                // Update member data
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/teams/${teamId}/members/${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'dev-token'}`
                    },
                    body: JSON.stringify({
                        name,
                        abbreviation,
                        role
                    })
                });
                
                if (response.ok) {
                    alert('成員資料已更新');
                    closeEditMemberModal();
                    // Reload team data
                    await loadProjectTeams(projectId);
                    // Refresh modal
                    const updatedTeam = window.projectTeams?.find(t => 
                        t.id === teamId || t.name === teamId
                    );
                    if (updatedTeam) {
                        showTeamModal(updatedTeam);
                    }
                } else {
                    const error = await response.json();
                    alert('更新失敗: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating member:', error);
                alert('更新失敗: ' + error.message);
            }
        }
        
        // Delete team member
        async function deleteMember(userId, memberName) {
            if (!confirm(`確定要移除 ${memberName || '此成員'} 嗎？`)) return;
            
            const projectId = window.currentProject?.id;
            const teamId = window.currentTeam?.id || window.currentTeam?.name;
            
            if (!projectId || !teamId) {
                alert('無法取得專案或工班資訊');
                return;
            }
            
            // Check permissions
            const currentUserRole = getCurrentUserRole();
            if (currentUserRole !== 'admin' && 
                !(currentUserRole === 'team_leader' && isCurrentUserTeamLeader(window.currentTeam))) {
                alert('您沒有權限執行此操作');
                return;
            }
            
            try {
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/teams/${teamId}/members/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'dev-token'}`
                    }
                });
                
                if (response.ok) {
                    alert('成員已移除');
                    // Reload team data
                    await loadProjectTeams(projectId);
                    // Refresh modal
                    const updatedTeam = window.projectTeams?.find(t => 
                        t.id === teamId || t.name === teamId
                    );
                    if (updatedTeam) {
                        showTeamModal(updatedTeam);
                    }
                } else {
                    const error = await response.json();
                    alert('移除失敗: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting member:', error);
                alert('移除失敗');
            }
        }
        
        // Show add member form
        let selectedWorker = null;
        let addMemberRole = 'team_member';
        let currentMemberTab = 'existing';
        
        // Function to select role in the modal
        function selectRole(role) {
            addMemberRole = role;
            
            // Update UI to show selected role
            const memberLabel = document.getElementById('memberRoleLabel');
            const leaderLabel = document.getElementById('leaderRoleLabel');
            const memberRadio = document.getElementById('roleMember');
            const leaderRadio = document.getElementById('roleLeader');
            
            if (!memberLabel || !leaderLabel) return;
            
            if (role === 'team_member') {
                memberLabel.style.borderColor = '#3b82f6';
                memberLabel.style.background = 'rgba(59, 130, 246, 0.05)';
                leaderLabel.style.borderColor = '#e5e7eb';
                leaderLabel.style.background = 'transparent';
                if (memberRadio) memberRadio.checked = true;
                if (leaderRadio) leaderRadio.checked = false;
            } else {
                leaderLabel.style.borderColor = '#10b981';
                leaderLabel.style.background = 'rgba(16, 185, 129, 0.05)';
                memberLabel.style.borderColor = '#e5e7eb';
                memberLabel.style.background = 'transparent';
                if (leaderRadio) leaderRadio.checked = true;
                if (memberRadio) memberRadio.checked = false;
            }
        }
        
        async function showAddMemberForm(role) {
            // Check if data is still loading
            if (isDataLoading || !isTeamsReady) {
                alert('無法取得專案或工班資訊，請稍候再試');
                console.error('Data still loading:', {
                    isDataLoading,
                    isTeamsReady,
                    currentProject: window.currentProject,
                    currentTeam: window.currentTeam
                });
                return;
            }
            
            // Validate that we have required data
            if (!window.currentProject || !window.currentTeam) {
                alert('無法取得專案或工班資訊，請稍候再試');
                console.error('Missing required data:', {
                    currentProject: window.currentProject,
                    currentTeam: window.currentTeam
                });
                return;
            }
            
            // If no role specified, default to team_member
            if (!role) {
                addMemberRole = 'team_member';
            } else {
                addMemberRole = role;
            }
            
            // Initialize role selection UI
            selectRole(addMemberRole);
            
            const modal = document.getElementById('addMemberModal');
            const title = document.getElementById('addMemberTitle');
            const teamNameSpan = document.getElementById('addMemberTeamName');
            
            // Update title - generic since role is selected in modal
            title.textContent = '新增工班成員';
            
            // Show team name
            if (window.currentTeam) {
                teamNameSpan.textContent = `(${window.currentTeam.name || window.currentTeam.id})`;
            }
            
            // Reset to existing tab
            switchMemberTab('existing');
            
            // Show modal
            modal.style.display = 'block';
            modal.classList.add('active');
            
            // Load workers from object_50HJ8__c
            await loadWorkers();
        }
        
        // Switch between existing/new member tabs
        function switchMemberTab(tab) {
            currentMemberTab = tab;
            
            const existingTab = document.getElementById('existingMemberTab');
            const newTab = document.getElementById('newMemberTab');
            const existingSection = document.getElementById('existingMemberSection');
            const newSection = document.getElementById('newMemberSection');
            const confirmBtn = document.getElementById('confirmAddMemberBtn');
            
            if (tab === 'existing') {
                // Show existing member selection
                existingTab.style.borderBottom = '3px solid #3b82f6';
                existingTab.style.color = '#3b82f6';
                newTab.style.borderBottom = '3px solid transparent';
                newTab.style.color = '#6b7280';
                
                existingSection.style.display = 'block';
                newSection.style.display = 'none';
                
                // Show loading and load workers if needed
                if (!window.allWorkers || window.allWorkers.length === 0) {
                    showMemberModalLoading();
                    loadWorkers().then(() => {
                        hideMemberModalLoading();
                    }).catch(error => {
                        console.error('Failed to load workers:', error);
                        hideMemberModalLoading();
                    });
                } else {
                    hideMemberModalLoading();
                }
                
                // Enable confirm button only if a worker is selected
                confirmBtn.disabled = !selectedWorker;
            } else {
                // Show new member form
                existingTab.style.borderBottom = '3px solid transparent';
                existingTab.style.color = '#6b7280';
                newTab.style.borderBottom = '3px solid #3b82f6';
                newTab.style.color = '#3b82f6';
                
                existingSection.style.display = 'none';
                newSection.style.display = 'block';
                
                // Enable confirm button based on form validation
                validateNewMemberForm();
            }
        }
        
        // Validate new member form
        function validateNewMemberForm() {
            const name = document.getElementById('newMemberName').value.trim();
            const phone = document.getElementById('newMemberPhone').value.trim();
            const abbreviation = document.getElementById('newMemberAbbreviation').value.trim();
            const confirmBtn = document.getElementById('confirmAddMemberBtn');
            
            // Name and abbreviation are required
            confirmBtn.disabled = !(name && phone && abbreviation);
        }
        
        // Auto-update password display when phone number changes
        function updatePasswordDisplay() {
            const phone = document.getElementById('newMemberPhone').value;
            const passwordField = document.getElementById('memberPassword');
            if (phone.length >= 3) {
                passwordField.value = phone.slice(-3);
            } else {
                passwordField.value = '';
            }
        }
        
        // Auto-fill abbreviation from name's last character
        function updateAbbreviation() {
            const name = document.getElementById('newMemberName').value;
            const abbrField = document.getElementById('newMemberAbbreviation');
            if (name.length > 0 && !abbrField.value) {
                // Only auto-fill if abbreviation is empty
                abbrField.value = name.slice(-1);
            }
            validateNewMemberForm();
        }
        
        // Check for duplicate phone numbers
        async function checkDuplicatePhone() {
            const phone = document.getElementById('newMemberPhone').value.trim();
            const duplicateWarning = document.getElementById('duplicateWarning');
            const existingWorkerInfo = document.getElementById('existingWorkerInfo');
            
            if (!phone) {
                duplicateWarning.style.display = 'none';
                return;
            }
            
            try {
                // Check in object_50HJ8__c for existing workers
                const response = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c?phone_number__c=${encodeURIComponent(phone)}`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const existingWorkers = data.results || [];
                    
                    if (existingWorkers.length > 0) {
                        const existingWorker = existingWorkers[0];
                        
                        // Show duplicate warning
                        duplicateWarning.style.display = 'block';
                        existingWorkerInfo.innerHTML = `
                            <strong>現有師傅資料：</strong><br>
                            姓名：${existingWorker.name || '未命名'}<br>
                            簡稱：${existingWorker.abbreviation__c || '無'}
                        `;
                        
                        // Auto-fill name and abbreviation with existing data
                        document.getElementById('newMemberName').value = existingWorker.name || '';
                        document.getElementById('newMemberAbbreviation').value = existingWorker.abbreviation__c || '';
                        
                        // Validate the form
                        validateNewMemberForm();
                    } else {
                        // No duplicate found
                        duplicateWarning.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error checking duplicate phone:', error);
                duplicateWarning.style.display = 'none';
            }
        }
        
        // Add event listeners for new member form
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('newMemberName');
            const phoneInput = document.getElementById('newMemberPhone');
            const abbrInput = document.getElementById('newMemberAbbreviation');
            
            if (nameInput) {
                nameInput.addEventListener('input', () => {
                    updateAbbreviation();
                    validateNewMemberForm();
                });
            }
            if (phoneInput) {
                phoneInput.addEventListener('input', () => {
                    updatePasswordDisplay();
                    validateNewMemberForm();
                });
                phoneInput.addEventListener('blur', checkDuplicatePhone);
            }
            if (abbrInput) {
                abbrInput.addEventListener('input', validateNewMemberForm);
            }
        });
        
        // Close add member modal
        function closeAddMemberModal() {
            const modal = document.getElementById('addMemberModal');
            modal.style.display = 'none';
            modal.classList.remove('active');
            selectedWorker = null;
            
            // Clear existing member search
            document.getElementById('workerSearchInput').value = '';
            
            // Clear new member form
            document.getElementById('newMemberName').value = '';
            document.getElementById('newMemberPhone').value = '';
            document.getElementById('newMemberAbbreviation').value = '';
            
            // Disable confirm button
            document.getElementById('confirmAddMemberBtn').disabled = true;
        }
        
        // Show loading indicator in member modal
        function showMemberModalLoading() {
            const loading = document.getElementById('memberModalLoading');
            const content = document.getElementById('memberModalContent');
            if (loading && content) {
                loading.style.display = 'block';
                content.style.display = 'none';
            }
        }
        
        // Hide loading indicator in member modal
        function hideMemberModalLoading() {
            const loading = document.getElementById('memberModalLoading');
            const content = document.getElementById('memberModalContent');
            if (loading && content) {
                loading.style.display = 'none';
                content.style.display = 'block';
            }
        }
        
        // Load workers from object_50HJ8__c
        async function loadWorkers() {
            const workersList = document.getElementById('workersList');
            workersList.innerHTML = ''; // Clear list while loading
            
            try {
                // Debug logging
                console.log('Loading workers from:', `${API_BASE_URL}/rest/object_50HJ8__c`);
                console.log('Using token:', API_TOKEN);
                
                const response = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c?limit=500`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Failed to load workers: ${response.status} ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Workers data:', data);
                
                const workers = data.records || data || [];
                
                // If data structure is different, try to adapt
                if (Array.isArray(data)) {
                    displayWorkers(data);
                    window.allWorkers = data;
                } else if (data.results) {
                    displayWorkers(data.results);
                    window.allWorkers = data.results;
                } else if (data.records) {
                    displayWorkers(data.records);
                    window.allWorkers = data.records;
                } else {
                    console.warn('Unexpected data structure:', data);
                    displayWorkers([]);
                    window.allWorkers = [];
                }
                
            } catch (error) {
                console.error('Error loading workers:', error);
                workersList.innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 2rem;">
                        <div>載入失敗</div>
                        <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #6b7280;">
                            ${error.message}
                        </div>
                        <button onclick="loadWorkers()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            重試
                        </button>
                    </div>
                `;
            }
        }
        
        // Display workers list
        function displayWorkers(workers) {
            const workersList = document.getElementById('workersList');
            
            // Filter workers to only show those belonging to the current team
            let filteredWorkers = workers;
            if (window.currentTeam) {
                const currentTeamId = window.currentTeam.id;  // 使用工班 ID
                console.log('Filtering workers for team ID:', currentTeamId);
                
                filteredWorkers = workers.filter(worker => {
                    // Check if worker belongs to current team
                    let workerTeamIds = worker.shift_type_multi_select__c || [];
                    if (typeof workerTeamIds === 'string') {
                        try {
                            workerTeamIds = JSON.parse(workerTeamIds);
                        } catch {
                            workerTeamIds = [];
                        }
                    }
                    if (!Array.isArray(workerTeamIds)) {
                        workerTeamIds = [];
                    }
                    
                    // 檢查工班 ID 是否在陣列中
                    const belongsToTeam = workerTeamIds.includes(currentTeamId);
                    if (belongsToTeam) {
                        console.log(`Worker ${worker.name} belongs to team ${currentTeamId}`);
                    }
                    return belongsToTeam;
                });
            }
            
            if (filteredWorkers.length === 0) {
                workersList.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 2rem;">此工班尚無可選擇的師傅</div>';
                return;
            }
            
            workersList.innerHTML = '';
            filteredWorkers.forEach(worker => {
                const workerItem = document.createElement('div');
                workerItem.style.cssText = `
                    padding: 0.75rem 1rem;
                    border-bottom: 1px solid #e5e7eb;
                    cursor: pointer;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    transition: background 0.2s;
                `;
                
                // Get teams the worker belongs to - use the resolved names
                let workerTeams = worker.shift_type_multi_select__c__r || [];
                if (typeof workerTeams === 'string') {
                    try {
                        workerTeams = JSON.parse(workerTeams);
                    } catch {
                        workerTeams = [];
                    }
                }
                if (!Array.isArray(workerTeams)) {
                    workerTeams = [];
                }
                
                // Extract team names from the resolved array
                const teamNames = workerTeams.map(team => 
                    typeof team === 'object' && team.name ? team.name : team
                ).filter(name => name);
                
                const teamsDisplay = teamNames.length > 0 
                    ? `<span style="color: #ef4444; font-size: 0.75rem;">(${teamNames.join(', ')})</span>`
                    : '';
                
                workerItem.innerHTML = `
                    <div>
                        <div style="font-weight: 500;">
                            ${worker.name || '未命名'} 
                            ${teamsDisplay}
                        </div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${worker.phone_number__c || worker.account__c || '無電話'}</div>
                    </div>
                    <input type="radio" name="workerSelect" value="${worker._id}" style="cursor: pointer;">
                `;
                
                workerItem.onmouseenter = () => workerItem.style.background = '#f9fafb';
                workerItem.onmouseleave = () => workerItem.style.background = 'white';
                
                workerItem.onclick = () => {
                    // Clear previous selection
                    document.querySelectorAll('input[name="workerSelect"]').forEach(radio => radio.checked = false);
                    // Select this worker
                    workerItem.querySelector('input[type="radio"]').checked = true;
                    selectedWorker = worker;
                    document.getElementById('confirmAddMemberBtn').disabled = false;
                };
                
                workersList.appendChild(workerItem);
            });
        }
        
        // Search workers
        function searchWorkers() {
            const searchTerm = document.getElementById('workerSearchInput').value.toLowerCase();
            
            if (!window.allWorkers) return;
            
            const filtered = window.allWorkers.filter(worker => {
                const name = (worker.name || '').toLowerCase();
                const phone = (worker.phone_number__c || worker.account__c || '').toLowerCase();
                return name.includes(searchTerm) || phone.includes(searchTerm);
            });
            
            displayWorkers(filtered);
        }
        
        // Confirm add member
        async function confirmAddMember() {
            const projectId = window.currentProject?.id;
            const teamId = window.currentTeam?.id || window.currentTeam?.name;
            
            console.log('[DEBUG] confirmAddMember called');
            console.log('[DEBUG] Current project:', window.currentProject);
            console.log('[DEBUG] Current team:', window.currentTeam);
            console.log('[DEBUG] Project ID:', projectId);
            console.log('[DEBUG] Team ID:', teamId);
            console.log('[DEBUG] isDataLoading:', isDataLoading);
            console.log('[DEBUG] isTeamsReady:', isTeamsReady);
            
            if (!projectId) {
                alert('專案資料尚未載入完成，請稍候再試');
                console.error('[ERROR] Missing project ID');
                return;
            }
            
            if (!teamId) {
                alert('無法取得工班資訊，請重新選擇工班');
                console.error('[ERROR] Missing team ID');
                return;
            }
            
            try {
                let memberData;
                let wasExisting = false;
                let workerName = '';
                
                if (currentMemberTab === 'existing') {
                    // Adding existing worker
                    if (!selectedWorker) return;
                    
                    memberData = {
                        userId: selectedWorker._id,
                        name: selectedWorker.name || '未命名',
                        phone: selectedWorker.phone_number__c || selectedWorker.account__c || '',
                        role: addMemberRole,
                        sourceType: 'crm_worker',
                        sourceId: selectedWorker._id,
                        createdBy: 'admin'
                    };
                    
                    workerName = selectedWorker.name || '師傅';
                    
                    // Update shift_type_multi_select__c for existing worker
                    await updateWorkerTeamField(selectedWorker._id, teamId);
                    
                } else {
                    // Creating new worker
                    const name = document.getElementById('newMemberName').value.trim();
                    const phone = document.getElementById('newMemberPhone').value.trim();
                    const abbreviation = document.getElementById('newMemberAbbreviation').value.trim();
                    
                    if (!name || !phone) {
                        alert('請填寫必填欄位');
                        return;
                    }
                    
                    // First create worker in object_50HJ8__c (or update if exists)
                    const result = await createNewWorker(name, phone, abbreviation, teamId);
                    
                    if (!result) {
                        alert('建立師傅失敗');
                        return;
                    }
                    
                    const newWorkerId = result.id || result;
                    wasExisting = result.existing || false;
                    workerName = result.name || name;
                    
                    if (wasExisting) {
                        console.log('使用現有師傅，已更新其工班資訊');
                    }
                    
                    memberData = {
                        userId: newWorkerId,
                        name: name,
                        phone: phone,
                        role: addMemberRole,
                        sourceType: 'crm_worker',
                        sourceId: newWorkerId,
                        createdBy: 'admin'
                    };
                }
                
                // First check if member already exists in this team
                const checkExistingResponse = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/teams/${teamId}/members`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'dev-token'}`
                    }
                });
                
                if (checkExistingResponse.ok) {
                    const existingMembers = await checkExistingResponse.json();
                    const memberExists = existingMembers.some(member => 
                        member.userId === memberData.userId || 
                        member.phone === memberData.phone
                    );
                    
                    if (memberExists) {
                        alert(`${workerName || '此師傅'} 已經是這個工班的成員了！`);
                        return;
                    }
                }
                
                // Add member to team
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/teams/${teamId}/members`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token') || 'dev-token'}`
                    },
                    body: JSON.stringify(memberData)
                });
                
                if (response.ok) {
                    // Customize message based on whether it was a new or existing worker
                    let message;
                    if (currentMemberTab === 'new' && wasExisting) {
                        message = `${workerName} 已加入工班！\n(該電話號碼已存在，已更新其工班資訊)`;
                    } else {
                        message = addMemberRole === 'team_leader' ? '負責人已新增' : '成員已新增';
                    }
                    alert(message);
                    closeAddMemberModal();
                    // Reload team members
                    await loadProjectTeams(projectId);
                    // Refresh the modal
                    if (window.currentTeam) {
                        const updatedTeam = window.projectTeams?.find(t => t.id === teamId);
                        if (updatedTeam) {
                            showTeamModal(updatedTeam);
                        }
                    }
                } else {
                    const error = await response.json();
                    alert('新增失敗: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding member:', error);
                alert('新增失敗: ' + error.message);
            }
        }
        
        // Create new worker in object_50HJ8__c
        async function createNewWorker(name, phone, abbreviation, teamId) {
            try {
                // First check if a worker with this phone already exists
                console.log('Checking for existing worker with phone:', phone);
                
                const checkResponse = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c?phone_number__c=${encodeURIComponent(phone)}`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (checkResponse.ok) {
                    const checkData = await checkResponse.json();
                    const existingWorkers = checkData.results || [];
                    
                    if (existingWorkers.length > 0) {
                        // Worker with this phone already exists, just update their teams
                        const existingWorker = existingWorkers[0];
                        console.log('Found existing worker:', existingWorker.name, 'Phone:', existingWorker.phone_number__c);
                        
                        // Update the worker's team field in CRM
                        await updateWorkerTeamField(existingWorker._id, teamId);
                        
                        // Also update the user's teams in engineering management users table
                        try {
                            // First check if user exists
                            const checkUserResponse = await fetch(`${WORKER_API_URL}/api/v1/users/phone/${phone}`, {
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('token') || 'dev-token'}`
                                }
                            });
                            
                            if (checkUserResponse.ok) {
                                // User exists, update their teams
                                const existingUser = await checkUserResponse.json();
                                const updatedTeams = existingUser.teams || [];
                                if (!updatedTeams.includes(teamId)) {
                                    updatedTeams.push(teamId);
                                }
                                
                                const updateResponse = await fetch(`${WORKER_API_URL}/api/v1/users/${existingUser.id}`, {
                                    method: 'PATCH',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${localStorage.getItem('token') || 'dev-token'}`
                                    },
                                    body: JSON.stringify({ teams: updatedTeams })
                                });
                                
                                if (updateResponse.ok) {
                                    console.log('User teams updated in engineering management');
                                }
                            } else if (checkUserResponse.status === 404) {
                                // User doesn't exist in engineering management, create them
                                const password = phone.slice(-3);
                                const userData = {
                                    name: existingWorker.name,
                                    phone: phone,
                                    password: password,
                                    role: 'worker',
                                    teams: [teamId]
                                };
                                
                                const userResponse = await fetch(`${WORKER_API_URL}/api/v1/users`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${localStorage.getItem('token') || 'dev-token'}`
                                    },
                                    body: JSON.stringify(userData)
                                });
                                
                                if (userResponse.ok) {
                                    console.log('User created in engineering management for existing CRM worker');
                                }
                            }
                        } catch (userError) {
                            console.warn('Error updating/creating user in engineering management:', userError);
                            // Don't fail the whole operation
                        }
                        
                        // Return the existing worker info
                        return {
                            id: existingWorker._id,
                            existing: true,
                            name: existingWorker.name
                        };
                    }
                }
                
                // No existing worker, create new one
                const password = phone.slice(-3);
                
                // Generate a MongoDB ObjectId-like string for _id
                // Format: 8 hex chars (timestamp) + 16 hex chars (random)
                const timestamp = Math.floor(Date.now() / 1000).toString(16).padStart(8, '0');
                const randomHex = Array.from({length: 16}, () => Math.floor(Math.random() * 16).toString(16)).join('');
                const generatedId = timestamp + randomHex;
                
                const workerData = {
                    _id: generatedId,  // Add the generated ID
                    name: name,
                    phone_number__c: phone,
                    account__c: phone,
                    password__c: password,
                    abbreviation__c: abbreviation || name.slice(0, 1),
                    shift_type_multi_select__c: JSON.stringify([window.currentTeam?.id || teamId]), // Use team ID (not URL-encoded) for shift_type field as JSON string
                    record_type: 'default__c',
                    life_status: 'normal'
                };
                
                console.log('Creating new worker:', workerData);
                
                const response = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(workerData)
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    console.error('Failed to create worker:', error);
                    throw new Error('Failed to create worker');
                }
                
                const result = await response.json();
                console.log('Worker created:', result);
                
                // Also create user in engineering management users table
                try {
                    const userData = {
                        name: name,
                        phone: phone,
                        password: password,
                        role: 'worker',
                        teams: [teamId]
                    };
                    
                    const userResponse = await fetch(`${WORKER_API_URL}/api/v1/users`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token') || 'dev-token'}`
                        },
                        body: JSON.stringify(userData)
                    });
                    
                    if (userResponse.ok) {
                        const userResult = await userResponse.json();
                        console.log('User also created in engineering management:', userResult);
                    } else {
                        console.warn('Failed to create user in engineering management, but worker was created in CRM');
                    }
                } catch (userError) {
                    console.warn('Error creating user in engineering management:', userError);
                    // Don't fail the whole operation if engineering management user creation fails
                }
                
                // Return the new worker ID
                return result._id || result.id || result.insertId;
                
            } catch (error) {
                console.error('Error creating worker:', error);
                return null;
            }
        }
        
        // Update worker's shift_type_multi_select__c to add team
        async function updateWorkerTeamField(workerId, teamId) {
            try {
                // First get existing worker data
                const getResponse = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c?_id=${workerId}`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (!getResponse.ok) {
                    console.error('Failed to get worker data');
                    return;
                }
                
                const data = await getResponse.json();
                const worker = data.results?.[0] || data[0];
                
                if (!worker) {
                    console.error('Worker not found');
                    return;
                }
                
                // Get existing teams or initialize empty array
                let existingTeams = worker.shift_type_multi_select__c || [];
                if (typeof existingTeams === 'string') {
                    try {
                        existingTeams = JSON.parse(existingTeams);
                    } catch {
                        existingTeams = [existingTeams];
                    }
                }
                if (!Array.isArray(existingTeams)) {
                    existingTeams = [];
                }
                
                // Use team ID for consistency (not URL-encoded, just the actual ID)
                const teamIdToUse = window.currentTeam?.id || teamId;
                
                // Add new team if not already present
                if (!existingTeams.includes(teamIdToUse)) {
                    existingTeams.push(teamIdToUse);
                }
                
                // Update worker with new team list
                const updateResponse = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c/${workerId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        shift_type_multi_select__c: JSON.stringify(existingTeams)
                    })
                });
                
                if (!updateResponse.ok) {
                    console.error('Failed to update worker team field');
                }
                
            } catch (error) {
                console.error('Error updating worker team field:', error);
            }
        }
        
        // Edit member (placeholder)
        function editMember(userId) {
            alert('編輯成員功能開發中...');
            // TODO: Implement edit member form
        }

        // Load project data
        async function loadProject(projectId) {
            try {
                isDataLoading = true;
                console.log('[DEBUG] Starting project load:', projectId);
                // Fetch project data from engineering management API
                const response = await fetch(
                    `${CONFIG.API.WORKER_API_URL}/api/v1/projects/${projectId}`,
                    {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('[DEBUG] Project API response:', result);
                
                if (result.success && result.project) {
                    currentProject = result.project;
                    window.currentProject = result.project; // Save globally for team functions
                    console.log('[DEBUG] Project loaded successfully:', window.currentProject);
                    updateProjectInfo();
                    await loadSites();
                } else {
                    showError('專案不存在');
                }
            } catch (error) {
                console.error('Error loading project:', error);
                showError('載入專案失敗: ' + error.message);
            } finally {
                isDataLoading = false;
                console.log('[DEBUG] Project loading complete. isDataLoading:', isDataLoading);
            }
        }

        // Update project info in header
        function updateProjectInfo() {
            if (!currentProject) return;
            
            document.getElementById('projectName').textContent = currentProject.name || '未命名專案';
            document.getElementById('projectDescription').textContent = 
                currentProject.field_tOYE1__c || '暫無描述'; // 假設有描述欄位
        }

        // Load sites for the project
        async function loadSites() {
            try {
                // Ensure team mappings are loaded first
                if (Object.keys(teamNameToIdMap).length === 0) {
                    console.log('工班映射尚未載入，先載入映射...');
                    await loadTeamMappings();
                }
                
                // Use opportunity_id to fetch related sites
                const opportunityId = currentProject.opportunity_id;
                
                if (!opportunityId) {
                    console.warn('No opportunity_id found for project');
                    showError('無法載入案場資料：缺少商機關聯');
                    return;
                }
                
                console.log('[DEBUG] Loading sites for opportunity:', opportunityId);
                console.log('[DEBUG] Team mappings loaded:', Object.keys(teamNameToIdMap).length, '個工班');
                
                // Show loading state
                const gridContent = document.getElementById('gridContent');
                gridContent.innerHTML = '<div class="loading">載入案場資料中...</div>';
                
                // Fetch sites data
                const response = await fetch(
                    `${API_BASE_URL}/rest/object_8W9cb__c?field_1P96q__c=${opportunityId}&limit=500`,
                    {
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to load sites');
                }

                const result = await response.json();
                // Handle both dataList and results format
                currentSites = result.dataList || result.results || [];
                
                // Process and display sites
                processSitesData();
                renderBuildingTabs();
                renderFloorGrid();
                updateStatistics();
                
                // Clear error state if successful
                gridContent.classList.remove('loading');
            } catch (error) {
                console.error('Error loading sites:', error);
                showError('載入案場資料失敗');
            }
        }

        // Process sites data
        function processSitesData() {
            // Group sites by building
            const buildings = {};
            const teamsMap = new Map(); // 收集所有工班及其案場數
            const buildingTeams = {}; // 記錄每個棟別的工班
            let unassignedCount = 0; // 統計未分配的案場數
            
            currentSites.forEach(site => {
                const building = site[fieldMapping.building] || 'A';
                if (!buildings[building]) {
                    buildings[building] = [];
                    buildingTeams[building] = new Set(); // 記錄該棟的工班
                }
                buildings[building].push(site);
                
                // 收集工班資訊及統計案場數
                const teamNameFromSite = site[fieldMapping.team];  // shift_time__c 可能是工班名稱或 ID
                
                if (teamNameFromSite && teamNameFromSite !== '-') {
                    // 從名稱獲取對應的工班 ID
                    let teamId = teamNameToIdMap[teamNameFromSite];
                    
                    if (!teamId) {
                        // Try decoding in case of URL encoding issues
                        const decodedName = decodeURIComponent(teamNameFromSite).trim();
                        teamId = teamNameToIdMap[decodedName];
                        
                        if (!teamId) {
                            // 如果 teamNameFromSite 本身就是 ID，直接使用
                            if (teamNameFromSite.match(/^[0-9a-f]{24}$/)) {
                                teamId = teamNameFromSite;
                                // 嘗試從 teamIdToNameMap 獲取名稱和簡稱
                                const teamInfo = teamIdToNameMap[teamId];
                                const teamName = teamInfo?.name || teamNameFromSite;
                                const teamAbbreviation = teamInfo?.abbreviation || null;
                                if (!teamsMap.has(teamId)) {
                                    teamsMap.set(teamId, {
                                        id: teamId,
                                        name: teamName,
                                        abbreviation: teamAbbreviation,
                                        siteCount: 0,
                                        sites: []
                                    });
                                }
                            } else {
                                console.warn(`找不到工班 "${teamNameFromSite}" 的 ID 映射，視為未分配`);
                                unassignedCount++;
                                return; // Skip this iteration
                            }
                        }
                    }
                    
                    // 使用 teamId 作為唯一的 key
                    if (!teamsMap.has(teamId)) {
                        const teamInfo = teamIdToNameMap[teamId];
                        teamsMap.set(teamId, {
                            id: teamId,
                            name: teamInfo?.name || teamNameFromSite, // 優先使用映射的名稱
                            abbreviation: teamInfo?.abbreviation || null,
                            siteCount: 0,
                            sites: []
                        });
                    }
                    const teamData = teamsMap.get(teamId);
                    teamData.siteCount++;
                    teamData.sites.push(site._id);
                    
                    // 記錄此棟別有此工班（使用 ID）
                    buildingTeams[building].add(teamId);
                } else {
                    // 沒有工班的案場，計入未分配
                    unassignedCount++;
                }
            });
            
            // Store processed data
            window.sitesGroupedByBuilding = buildings;
            window.projectTeamsFromSites = teamsMap; // 儲存從案場提取的工班資訊
            window.buildingTeamsMap = buildingTeams; // 儲存每個棟別的工班列表
            window.unassignedSitesCount = unassignedCount; // 儲存未分配案場數量
            console.log('[DEBUG] processSitesData: 設置 window.unassignedSitesCount =', unassignedCount);
            
            // 自動選擇第一個有資料的棟別作為預設
            const sortedBuildings = Object.keys(buildings).sort();
            if (sortedBuildings.length > 0) {
                currentBuilding = sortedBuildings[0];
            }
            
            // 更新工班圖例（傳遞包含案場數的工班資訊）
            updateTeamLegend(teamsMap);
            
            // Now load team members from users table
            const projectId = new URLSearchParams(window.location.search).get('id');
            if (projectId) {
                loadProjectTeams(projectId);
            }
        }
        
        // Update team legend
        async function updateTeamLegend(teams) {
            const legendTeams = document.getElementById('legendTeams');
            if (!legendTeams) return;
            
            if (teams.size === 0) {
                legendTeams.innerHTML = '<span style="color: #9ca3af;">無工班資料</span>';
                return;
            }
            
            // 檢查當前用戶權限 - 使用統一權限系統
            window.isAdmin = false;
            window.userTeams = new Set(); // 用戶負責的工班
            let isAdmin = window.isAdmin;
            let userTeams = window.userTeams;
            
            try {
                // 使用統一權限系統檢查管理員權限
                if (window.permissions) {
                    await window.permissions.init();
                    isAdmin = window.isAdmin = await window.permissions.isAdmin();
                }
                
                // 如果不是管理員，獲取用戶所屬的工班
                if (!isAdmin && currentProject) {
                    try {
                        const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${currentProject.id}/users`, {
                            headers: AuthUtils.getRequestHeaders()
                        });
                        
                        if (response.ok) {
                            const responseData = await response.json();
                            const users = responseData.data?.all || responseData; // 支援新舊API格式
                            const currentUser = AuthUtils.getUser();
                            
                            if (Array.isArray(users)) {
                                // 找到當前用戶所屬的工班（支援多種匹配方式）
                                users.forEach(user => {
                                if ((user.phone === currentUser?.phone) || 
                                    (user.user_id === currentUser?.id) ||
                                    (user.user_id === currentUser?.source_id)) {
                                    if (user.team_name) {
                                        userTeams.add(user.team_name);
                                        window.userTeams.add(user.team_name);
                                        console.log(`找到用戶所屬工班: ${user.team_name}`);
                                    }
                                }
                            });
                            } else {
                                console.log('API回應格式不正確，users不是陣列:', typeof users);
                            }
                        }
                    } catch (error) {
                        console.log('獲取用戶工班失敗:', error);
                    }
                }
            } catch (error) {
                console.log('權限檢查錯誤:', error);
            }
            
            // 權限檢查完成後，重新渲染棟別按鈕以應用過濾
            if (typeof renderBuildingTabs === 'function') {
                renderBuildingTabs();
            }
            
            let items = [];
            teams.forEach((abbr, name) => {
                // 如果不是管理員且有特定工班歸屬，只顯示自己的工班
                if (!isAdmin && userTeams.size > 0 && !userTeams.has(name)) {
                    return; // 跳過不屬於自己的工班
                }
                
                // 檢查是否顯示成員管理按鈕 - 考慮模擬用戶權限
                const currentPermissions = getCurrentUserPermissions();
                const showManageButton = currentPermissions.isAdmin || 
                                       (currentPermissions.can_manage_members && userTeams.has(name));
                
                items.push(`
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="team-icon">${abbr}</span>
                        <span>${name}</span>
                        ${showManageButton ? `
                            <button onclick="openTeamMemberManagement('${name}')" 
                                    style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; 
                                           background: #10b981; color: white; 
                                           border: none; border-radius: 4px; 
                                           font-size: 0.75rem; cursor: pointer;"
                                    title="管理 ${name} 成員">
                                管理成員
                            </button>
                        ` : ''}
                    </div>
                `);
            });
            
            // 將工班分開顯示為多個 legend-item
            legendTeams.innerHTML = items.map(item => `<div class="legend-item">${item}</div>`).join('');
        }
        
        // 開啟工班成員管理頁面
        async function openTeamMemberManagement(teamName) {
            if (!currentProject) {
                alert('專案資料尚未載入');
                return;
            }
            
            try {
                // 根據工班名稱獲取工班ID
                const { data: team } = await window.supabase
                    .from('teams')
                    .select('id')
                    .eq('project_id', currentProject.id)
                    .eq('name', teamName)
                    .single();
                
                if (team) {
                    // 導向統一用戶管理頁面
                    window.location.href = `user-management.html?project_id=${currentProject.id}`;
                } else {
                    alert('找不到工班資料');
                }
            } catch (error) {
                console.error('開啟成員管理失敗:', error);
                alert('開啟成員管理失敗');
            }
        }

        // Render building tabs
        function renderBuildingTabs() {
            const tabsContainer = document.getElementById('buildingTabs');
            const buildings = Object.keys(window.sitesGroupedByBuilding || {}).sort();
            const buildingTeams = window.buildingTeamsMap || {};
            
            tabsContainer.innerHTML = buildings.map(building => {
                // 取得此棟的工班列表（工班ID）
                const teamIds = buildingTeams[building] ? Array.from(buildingTeams[building]) : [];
                let teamDisplay = '';
                
                if (teamIds.length > 0) {
                    // 從工班ID獲取工班名稱，然後取簡稱
                    const teamAbbrs = teamIds
                        .map(teamId => {
                            // 從 projectTeamsFromSites 獲取工班資訊
                            const teamInfo = window.projectTeamsFromSites?.get(teamId);
                            return teamInfo;
                        })
                        .filter(teamInfo => {
                            if (!teamInfo) return false;
                            
                            // 檢查用戶權限：如果不是管理員且不屬於該工班，則過濾掉
                            if (!window.isAdmin && window.userTeams.size > 0 && !window.userTeams.has(teamInfo.name)) {
                                console.log(`過濾掉工班: ${teamInfo.name}，用戶工班: ${Array.from(window.userTeams).join(', ')}`);
                                return false;
                            }
                            return true;
                        })
                        .map(teamInfo => {
                            // 優先使用 abbreviation__c 欄位
                            if (teamInfo.abbreviation) {
                                return teamInfo.abbreviation;
                            }
                            // 如果沒有 abbreviation__c，使用原邏輯
                            if (teamInfo.name) {
                                const name = teamInfo.name;
                                // 如果是「XX工班」格式，取XX的最後一個字
                                const match = name.match(/(.+?)工班/);
                                if (match) {
                                    return match[1].slice(-1); // 取工班前面名字的最後一個字
                                }
                                // 否則直接取名稱的最後一個字
                                return name.slice(-1);
                            }
                            return '';
                        })
                        .filter(abbr => abbr !== ''); // 過濾掉空字串
                    
                    if (teamAbbrs.length > 0) {
                        teamDisplay = ' | ' + teamAbbrs.join(' ');
                    }
                }
                
                return `
                    <button class="building-btn ${building === currentBuilding ? 'active' : ''}" 
                            data-building="${building}"
                            style="padding: 0.75rem 1.25rem;">
                        <span>${building}棟${teamDisplay}</span>
                    </button>
                `;
            }).join('');
        }

        // Render floor grid
        function renderFloorGrid() {
            const gridContent = document.getElementById('gridContent');
            
            // Show loading state immediately
            gridContent.style.opacity = '0.5';
            gridContent.style.pointerEvents = 'none';
            
            // Use requestAnimationFrame to ensure smooth transition
            requestAnimationFrame(() => {
                const sites = window.sitesGroupedByBuilding[currentBuilding] || [];
                
                if (sites.length === 0) {
                    gridContent.innerHTML = '<div class="error-message">此棟別暫無案場資料</div>';
                    gridContent.style.opacity = '1';
                    gridContent.style.pointerEvents = 'auto';
                    return;
                }

            // Group by floor and unit
            const floorMap = {};
            const units = new Set();
            
            sites.forEach(site => {
                const floor = site[fieldMapping.floor] || 0;
                const unit = site[fieldMapping.unit] || '';
                
                if (!floorMap[floor]) {
                    floorMap[floor] = {};
                }
                floorMap[floor][unit] = site;
                units.add(unit);
            });

            // Sort floors and units
            const sortedFloors = Object.keys(floorMap).sort((a, b) => b - a);
            const sortedUnits = Array.from(units).sort();

            // Generate table HTML
            let html = '<table class="floor-grid"><thead><tr><th></th>';
            sortedUnits.forEach(unit => {
                html += `<th>${unit}</th>`;
            });
            html += '</tr></thead><tbody>';

            sortedFloors.forEach(floor => {
                // Convert to integer for display
                const floorInt = Math.floor(parseFloat(floor));
                html += `<tr><th>${floorInt}F</th>`;
                sortedUnits.forEach(unit => {
                    const site = floorMap[floor][unit];
                    if (site) {
                        const isCompleted = site[fieldMapping.completed];
                        const team = site[fieldMapping.team] || '-';
                        const area = site[fieldMapping.area] || site[fieldMapping.siteArea] || '-';
                        const worker = site[fieldMapping.worker] || '';
                        const date = site[fieldMapping.date] || '';
                        
                        // Get team abbreviation (first character of team name if no abbreviation field exists)
                        // 檢查用戶權限：如果不是管理員且不屬於該工班，則不顯示工班簡稱
                        let teamAbbr = '';
                        if (team && team !== '-') {
                            if (window.isAdmin || window.userTeams.size === 0 || window.userTeams.has(team)) {
                                teamAbbr = site.team_abbreviation || team.charAt(0);
                            }
                        } else {
                            teamAbbr = team;
                        }
                        
                        // Get worker abbreviation (last character of name if abbreviation field is empty)
                        const workerAbbr = site.worker_abbreviation || (worker ? worker.charAt(worker.length - 1) : worker);
                        
                        // Format date properly (handle timestamp or string)
                        let formattedDate = '';
                        if (date) {
                            // Check if date is a timestamp (number or numeric string)
                            const timestamp = parseInt(date);
                            if (!isNaN(timestamp) && timestamp > 1000000000) {
                                // Convert milliseconds to date string
                                const dateObj = new Date(timestamp);
                                formattedDate = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
                            } else if (typeof date === 'string' && date.includes('-')) {
                                // Convert YYYY-MM-DD to M/D format
                                const parts = date.split('-');
                                if (parts.length === 3) {
                                    formattedDate = `${parseInt(parts[1])}/${parseInt(parts[2])}`;
                                }
                            } else {
                                formattedDate = date; // Use as-is if already formatted
                            }
                        }
                        
                        html += `
                            <td class="grid-cell ${isCompleted ? 'completed' : ''}" 
                                onclick="openSiteModal('${site._id}')">
                                <div class="cell-content">
                                    ${isCompleted ? 
                                        `<div class="cell-line1">${formattedDate}${workerAbbr ? ' | ' + workerAbbr : ''}</div>
                                         <div class="cell-line2">${area}坪<span class="cell-team">${teamAbbr ? ' ' + teamAbbr : ''}</span></div>` :
                                        `<div class="cell-line1">${area}坪<span class="cell-team">${teamAbbr ? ' ' + teamAbbr : ''}</span></div>`
                                    }
                                </div>
                            </td>
                        `;
                    } else {
                        html += '<td class="grid-cell no-unit"></td>';
                    }
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            
            // Update DOM and restore opacity
            gridContent.innerHTML = html;
            
            // Restore opacity after render
            requestAnimationFrame(() => {
                gridContent.style.opacity = '1';
                gridContent.style.pointerEvents = 'auto';
            });
        });
        }

        // Update statistics
        function updateStatistics() {
            const buildings = Object.keys(window.sitesGroupedByBuilding || {});
            const totalSites = currentSites.length;
            const completedSites = currentSites.filter(site => site[fieldMapping.completed]).length;
            const pendingSites = totalSites - completedSites;
            const completionRate = totalSites > 0 ? Math.round((completedSites / totalSites) * 100) : 0;
            
            // Update stat cards
            document.getElementById('statTotalSites').textContent = totalSites;
            document.getElementById('statCompleted').textContent = completedSites;
            document.getElementById('statPending').textContent = pendingSites;
            document.getElementById('statMaintenance').textContent = 0; // TODO: Get actual maintenance count
            
            // Store stats globally for later use
            window.projectStats = {
                buildingCount: buildings.length,
                unitCount: totalSites,
                completedCount: completedSites,
                pendingCount: pendingSites,
                completionRate: completionRate
            };
        }

        // 檢查案場存取權限
        async function checkSiteAccessPermission(siteId) {
            try {
                // 如果是管理員或業主，允許存取所有案場
                if (window.permissions) {
                    await window.permissions.init();
                    const isAdmin = await window.permissions.isAdmin();
                    if (isAdmin) return true;
                    
                    // 檢查是否為業主
                    const projectPermissions = await window.permissions.getProjectPermissions(currentProject?.id);
                    if (projectPermissions?.user_type === 'owner') return true;
                }
                
                // 對於工班成員，檢查案場是否屬於他們的工班
                const site = currentSites.find(s => s._id === siteId);
                if (!site) return false;
                
                // 獲取當前用戶的工班
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${currentProject?.id}/users`, {
                    headers: AuthUtils.getRequestHeaders()
                });
                
                if (response.ok) {
                    const responseData = await response.json();
                    const users = responseData.data?.all || responseData; // 支援新舊API格式
                    const currentUser = AuthUtils.getUser();
                    
                    if (Array.isArray(users)) {
                        const userInfo = users.find(user => 
                        user.phone === currentUser?.phone ||
                        user.user_id === currentUser?.id ||
                        user.user_id === currentUser?.source_id
                    );
                    
                        if (userInfo?.team_name) {
                            // 檢查案場是否分配給用戶的工班
                            const siteTeamName = site[fieldMapping.team] || site.shift_time__c; // 使用正確的欄位
                            return siteTeamName === userInfo.team_name;
                        }
                    } else {
                        console.log('檢查案場權限: API回應格式不正確');
                    }
                }
                
                return false; // 預設不允許存取
            } catch (error) {
                console.error('檢查案場權限失敗:', error);
                return false;
            }
        }

        // Open site modal
        async function openSiteModal(siteId) {
            // 檢查用戶權限
            const hasPermission = await checkSiteAccessPermission(siteId);
            if (!hasPermission) {
                alert('您沒有權限查看此案場');
                return;
            }
            
            currentSiteId = siteId;
            
            // Find site data
            const site = currentSites.find(s => s._id === siteId);
            if (!site) {
                // Try to fetch from API
                await fetchSiteData(siteId);
                return;
            }
            
            // Update modal with site data
            updateModalWithSiteData(site);
            
            // Show modal
            const modal = document.getElementById('siteModal');
            modal.classList.add('active');
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('site_id', siteId);
            window.history.pushState({}, '', url);
        }

        // Fetch site data from API
        async function fetchSiteData(siteId) {
            try {
                const response = await fetch(
                    `${API_BASE_URL}/rest/object_8W9cb__c?_id=${siteId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch site data');
                }

                const result = await response.json();
                // Handle both dataList and results format
                const sites = result.dataList || result.results;
                if (sites && sites.length > 0) {
                    updateModalWithSiteData(sites[0]);
                    
                    // Show modal
                    const modal = document.getElementById('siteModal');
                    modal.classList.add('active');
                }
            } catch (error) {
                console.error('Error fetching site:', error);
                alert('載入案場資料失敗');
            }
        }

        // Update modal with site data
        function updateModalWithSiteData(site) {
            // Store current site data globally for other functions to access
            window.currentSiteData = site;
            
            // Basic info
            document.getElementById('modalBuilding').textContent = 
                (site[fieldMapping.building] || 'A') + '棟';
            // Convert floor to integer for display
            const floor = Math.floor(parseFloat(site[fieldMapping.floor] || '1'));
            document.getElementById('modalFloor').textContent = floor + 'F';
            document.getElementById('modalUnit').textContent = 
                site[fieldMapping.unit] || '-';
            document.getElementById('modalTeam').textContent = 
                site[fieldMapping.team] || '-';
            
            // Notes
            const notes = site[fieldMapping.beforeNotes] || '';
            document.getElementById('notesInput').value = notes;
            checkNotesValue();
            
            // Completion status
            const isCompleted = site[fieldMapping.completed];
            const checkbox = document.getElementById('completionCheck');
            checkbox.checked = isCompleted;
            
            if (isCompleted) {
                document.getElementById('areaInput').value = site[fieldMapping.area] || '';
                document.getElementById('workerInput').value = site[fieldMapping.worker] || '';
                
                // Handle date field - convert timestamp to YYYY-MM-DD format for date input
                const dateValue = site[fieldMapping.date];
                if (dateValue) {
                    const timestamp = parseInt(dateValue);
                    if (!isNaN(timestamp) && timestamp > 1000000000) {
                        // Convert milliseconds to YYYY-MM-DD
                        const dateObj = new Date(timestamp);
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const day = String(dateObj.getDate()).padStart(2, '0');
                        document.getElementById('dateInput').value = `${year}-${month}-${day}`;
                    } else {
                        document.getElementById('dateInput').value = dateValue;
                    }
                } else {
                    document.getElementById('dateInput').value = '';
                }
                
                document.getElementById('completionFields').classList.add('active');
                document.getElementById('completionFields2').classList.add('active');
                
                // 啟用新欄位
                const fields3 = document.getElementById('completionFields3');
                const completionPhotosRow = document.getElementById('completionPhotosRow');
                
                fields3.classList.add('active');
                fields3.style.opacity = '1';
                fields3.style.pointerEvents = 'auto';
                
                completionPhotosRow.classList.add('active');
                completionPhotosRow.style.opacity = '1';
                completionPhotosRow.style.pointerEvents = 'auto';
                
                document.getElementById('workerName').textContent = `- ${site[fieldMapping.worker] || ''}`;
            } else {
                // 未完成時，預設填入今天日期、工地坪數和當前用戶
                document.getElementById('areaInput').value = site[fieldMapping.siteArea] || '';
                document.getElementById('workerInput').value = currentUser ? currentUser.name : '';
                setToday();
                
                document.getElementById('completionFields').classList.remove('active');
                document.getElementById('completionFields2').classList.remove('active');
                
                // 禁用新欄位
                const fields3 = document.getElementById('completionFields3');
                const completionPhotosRow = document.getElementById('completionPhotosRow');
                
                fields3.classList.remove('active');
                fields3.style.opacity = '0.5';
                fields3.style.pointerEvents = 'none';
                
                completionPhotosRow.classList.remove('active');
                completionPhotosRow.style.opacity = '0.5';
                completionPhotosRow.style.pointerEvents = 'none';
                
                document.getElementById('workerName').textContent = '';
            }
            
            // Load photos if any
            loadExistingPhotos(site);
        }

        // Load existing photos
        function loadExistingPhotos(site) {
            // Clear existing photos (except add buttons)
            ['floorPlanPhotos', 'beforePhotos', 'afterPhotos', 'difficultyPhotos'].forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    const addButton = container.querySelector('.add-photo');
                    container.innerHTML = '';
                    if (addButton) {
                        container.appendChild(addButton);
                    }
                }
            });
            
            // Load floor plan
            if (site[fieldMapping.floorPlan]) {
                addPhotoToContainer('floorPlanPhotos', site[fieldMapping.floorPlan]);
            }
            
            // Load before photos
            if (site[fieldMapping.beforePhotos]) {
                const beforePhotosData = site[fieldMapping.beforePhotos];
                
                // 處理不同格式的照片數據
                if (typeof beforePhotosData === 'string' && beforePhotosData.trim()) {
                    // 檢查是否為 JSON 格式（從 D1 database 來的數據）
                    if (beforePhotosData.startsWith('[') && beforePhotosData.includes('signedUrl')) {
                        try {
                            const photoArray = JSON.parse(beforePhotosData);
                            photoArray.forEach(photoObj => {
                                if (photoObj.signedUrl) {
                                    addPhotoToContainer('beforePhotos', photoObj.signedUrl);
                                }
                            });
                        } catch (e) {
                            console.error('[ERROR] Failed to parse photo JSON:', e);
                            // 如果解析失敗，嘗試用逗號分割
                            const photos = beforePhotosData.split(',').filter(p => p.trim());
                            photos.forEach(photo => {
                                if (photo.trim()) {
                                    addPhotoToContainer('beforePhotos', photo.trim());
                                }
                            });
                        }
                    } else {
                        // 處理逗號分隔的 URL 格式
                        const photos = beforePhotosData.split(',').filter(p => p.trim());
                        photos.forEach(photo => {
                            if (photo.trim()) {
                                addPhotoToContainer('beforePhotos', photo.trim());
                            }
                        });
                    }
                } else if (Array.isArray(beforePhotosData)) {
                    beforePhotosData.forEach(photo => {
                        if (typeof photo === 'object' && photo.signedUrl) {
                            addPhotoToContainer('beforePhotos', photo.signedUrl);
                        } else if (typeof photo === 'string' && photo.trim()) {
                            addPhotoToContainer('beforePhotos', photo.trim());
                        }
                    });
                }
            }
            
            // Load after photos
            if (site[fieldMapping.afterPhotos]) {
                const afterPhotosData = site[fieldMapping.afterPhotos];
                
                // 處理不同格式的照片數據
                if (typeof afterPhotosData === 'string' && afterPhotosData.trim()) {
                    // 檢查是否為 JSON 格式（從 D1 database 來的數據）
                    if (afterPhotosData.startsWith('[') && afterPhotosData.includes('signedUrl')) {
                        try {
                            const photoArray = JSON.parse(afterPhotosData);
                            photoArray.forEach(photoObj => {
                                if (photoObj.signedUrl) {
                                    addPhotoToContainer('afterPhotos', photoObj.signedUrl);
                                }
                            });
                        } catch (e) {
                            console.error('[ERROR] Failed to parse after photos JSON:', e);
                            // 如果解析失敗，嘗試用逗號分割
                            const photos = afterPhotosData.split(',').filter(p => p.trim());
                            photos.forEach(photo => {
                                if (photo.trim()) {
                                    addPhotoToContainer('afterPhotos', photo.trim());
                                }
                            });
                        }
                    } else {
                        // 處理逗號分隔的 URL 格式
                        const photos = afterPhotosData.split(',').filter(p => p.trim());
                        photos.forEach(photo => {
                            if (photo.trim()) {
                                addPhotoToContainer('afterPhotos', photo.trim());
                            }
                        });
                    }
                } else if (Array.isArray(afterPhotosData)) {
                    afterPhotosData.forEach(photo => {
                        if (typeof photo === 'object' && photo.signedUrl) {
                            addPhotoToContainer('afterPhotos', photo.signedUrl);
                        } else if (typeof photo === 'string' && photo.trim()) {
                            addPhotoToContainer('afterPhotos', photo.trim());
                        }
                    });
                }
            }
            
            // Load construction difficulty photos (施工後)
            if (site[fieldMapping.constructionDifficultyPhotos]) {
                const difficultyPhotosData = site[fieldMapping.constructionDifficultyPhotos];
                
                // 處理不同格式的照片數據
                if (typeof difficultyPhotosData === 'string' && difficultyPhotosData.trim()) {
                    // 檢查是否為 JSON 格式（從 D1 database 來的數據）
                    if (difficultyPhotosData.startsWith('[') && difficultyPhotosData.includes('signedUrl')) {
                        try {
                            const photoArray = JSON.parse(difficultyPhotosData);
                            photoArray.forEach(photoObj => {
                                if (photoObj.signedUrl) {
                                    addPhotoToContainer('difficultyPhotos', photoObj.signedUrl);
                                }
                            });
                        } catch (e) {
                            console.error('[ERROR] Failed to parse difficulty photos JSON:', e);
                            // 如果解析失敗，嘗試用逗號分割
                            const photos = difficultyPhotosData.split(',').filter(p => p.trim());
                            photos.forEach(photo => {
                                if (photo.trim()) {
                                    addPhotoToContainer('difficultyPhotos', photo.trim());
                                }
                            });
                        }
                    } else {
                        // 處理逗號分隔的 URL 格式
                        const photos = difficultyPhotosData.split(',').filter(p => p.trim());
                        photos.forEach(photo => {
                            if (photo.trim()) {
                                addPhotoToContainer('difficultyPhotos', photo.trim());
                            }
                        });
                    }
                } else if (Array.isArray(difficultyPhotosData)) {
                    difficultyPhotosData.forEach(photo => {
                        if (typeof photo === 'object' && photo.signedUrl) {
                            addPhotoToContainer('difficultyPhotos', photo.signedUrl);
                        } else if (typeof photo === 'string' && photo.trim()) {
                            addPhotoToContainer('difficultyPhotos', photo.trim());
                        }
                    });
                }
            }
            
            // Load work shift completion note
            if (site[fieldMapping.workShiftCompletionNote]) {
                document.getElementById('workShiftCompletionNoteInput').value = site[fieldMapping.workShiftCompletionNote];
            }
        }

        // Add photo to container
        function addPhotoToContainer(containerId, photoUrl) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error('[ERROR] Container not found:', containerId);
                return;
            }
            
            // 直接使用提供的 URL（從 D1 database 來的 signedUrl 已經是完整的）
            const fullPhotoUrl = photoUrl;
            
            console.log('[DEBUG] Adding photo to container:', containerId, 'URL:', fullPhotoUrl);
            
            const photoBox = document.createElement('div');
            photoBox.className = 'photo-box has-image';
            
            const img = document.createElement('img');
            img.src = fullPhotoUrl;
            img.alt = '照片';
            img.style.cursor = 'zoom-in';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            
            // 添加錯誤處理
            img.onerror = () => {
                console.error('[ERROR] Failed to load image:', fullPhotoUrl);
                // 嘗試使用原始URL
                if (fullPhotoUrl !== photoUrl) {
                    console.log('[DEBUG] Trying original URL:', photoUrl);
                    img.src = photoUrl;
                    img.onerror = () => {
                        console.error('[ERROR] Failed to load original URL too:', photoUrl);
                        // 顯示錯誤占位符
                        photoBox.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">無法載入圖片</div>';
                    };
                }
            };
            
            img.onload = () => {
                console.log('[DEBUG] Image loaded successfully:', fullPhotoUrl);
            };
            
            img.onclick = () => openLightbox(fullPhotoUrl);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'photo-remove-btn';
            removeBtn.innerHTML = '×';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removePhoto(removeBtn);
            };
            
            photoBox.appendChild(img);
            photoBox.appendChild(removeBtn);
            
            // Insert before add button
            const addButton = container.querySelector('.add-photo');
            if (addButton) {
                container.insertBefore(photoBox, addButton);
            } else {
                container.appendChild(photoBox);
            }
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('siteModal');
            modal.classList.remove('active');
            
            // Remove site_id from URL
            const url = new URL(window.location);
            url.searchParams.delete('site_id');
            window.history.pushState({}, '', url);
            
            currentSiteId = null;
        }

        // Handle completion checkbox change
        function handleCompletionChange() {
            const checkbox = document.getElementById('completionCheck');
            const fields = document.getElementById('completionFields');
            const fields2 = document.getElementById('completionFields2');
            const workerName = document.getElementById('workerName');
            const workerInput = document.getElementById('workerInput');
            
            // Don't toggle here - checkbox state is already changed by user click
            
            if (checkbox.checked) {
                fields.classList.add('active');
                fields2.classList.add('active');
                
                // 啟用新欄位
                const fields3 = document.getElementById('completionFields3');
                const completionPhotosRow = document.getElementById('completionPhotosRow');
                
                fields3.classList.add('active');
                fields3.style.opacity = '1';
                fields3.style.pointerEvents = 'auto';
                
                completionPhotosRow.classList.add('active');
                completionPhotosRow.style.opacity = '1';
                completionPhotosRow.style.pointerEvents = 'auto';
                
                // Auto-fill values
                if (!document.getElementById('dateInput').value) {
                    setToday();
                }
                
                // Auto-fill area from site data (工地坪數)
                if (currentSiteId && currentSites.length > 0) {
                    const site = currentSites.find(s => s._id === currentSiteId);
                    if (site && site[fieldMapping.siteArea]) {
                        document.getElementById('areaInput').value = site[fieldMapping.siteArea];
                    }
                }
                
                // Auto-fill worker name from current user
                if (currentUser && currentUser.name) {
                    workerInput.value = currentUser.name;
                    workerInput.setAttribute('value', currentUser.name);
                    // Show worker name in label
                    workerName.textContent = `- ${currentUser.name}`;
                }
                
                // Vibration feedback
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            } else {
                fields.classList.remove('active');
                fields2.classList.remove('active');
                
                // 禁用新欄位
                const fields3 = document.getElementById('completionFields3');
                const completionPhotosRow = document.getElementById('completionPhotosRow');
                
                fields3.classList.remove('active');
                fields3.style.opacity = '0.5';
                fields3.style.pointerEvents = 'none';
                
                completionPhotosRow.classList.remove('active');
                completionPhotosRow.style.opacity = '0.5';
                completionPhotosRow.style.pointerEvents = 'none';
                
                workerName.textContent = '';
                workerInput.value = '';
                workerInput.removeAttribute('value');
            }
        }

        // Set today's date
        function setToday() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('dateInput').value = `${yyyy}-${mm}-${dd}`;
        }

        // Toggle notes
        function toggleNotes() {
            const section = document.getElementById('notesSection');
            section.classList.toggle('collapsed');
        }

        // Check notes value
        function checkNotesValue() {
            const section = document.getElementById('notesSection');
            const input = document.getElementById('notesInput');
            
            if (input.value && input.value.trim() !== '') {
                section.classList.remove('collapsed');
            } else {
                section.classList.add('collapsed');
            }
        }

        // Upload photo
        function uploadPhoto(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = async (e) => {
                const files = e.target.files;
                
                for (let file of files) {
                    // Upload to R2
                    const photoUrl = await uploadToR2(file);
                    if (photoUrl) {
                        // Add to UI
                        let containerId;
                        switch(type) {
                            case 'floorPlan':
                                containerId = 'floorPlanPhotos';
                                break;
                            case 'before':
                                containerId = 'beforePhotos';
                                break;
                            case 'after':
                                containerId = 'afterPhotos';
                                break;
                            case 'difficulty':
                                containerId = 'difficultyPhotos';
                                break;
                        }
                        addPhotoToContainer(containerId, photoUrl);
                    }
                }
            };
            input.click();
        }

        // Upload to R2
        async function uploadToR2(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${WORKER_API_URL}/api/v1/files/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const result = await response.json();
                return result.url;
            } catch (error) {
                console.error('Upload error:', error);
                alert('上傳失敗');
                return null;
            }
        }

        // Remove photo
        function removePhoto(btn) {
            btn.parentElement.remove();
        }

        // Open lightbox
        function openLightbox(src) {
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightboxImg');
            img.src = src;
            lightbox.style.display = 'block';
        }

        // Close lightbox
        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
        }

        // Share link
        function shareLink() {
            const url = window.location.href;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('連結已複製！\n' + url);
                });
            }
        }

        // Submit form
        async function submitForm() {
            if (!currentSiteId) return;
            
            const isCompleted = document.getElementById('completionCheck').checked;
            
            // Prepare update data
            const updateData = {
                [fieldMapping.beforeNotes]: document.getElementById('notesInput').value,
                [fieldMapping.completed]: isCompleted
            };
            
            if (isCompleted) {
                const area = document.getElementById('areaInput').value;
                const date = document.getElementById('dateInput').value;
                const worker = document.getElementById('workerInput').value;
                const workShiftCompletionNote = document.getElementById('workShiftCompletionNoteInput').value;
                
                if (!area || !date) {
                    alert('請填寫鋪設坪數和施工日期！');
                    return;
                }
                
                updateData[fieldMapping.area] = area;
                updateData[fieldMapping.date] = date;
                updateData[fieldMapping.worker] = worker;
                
                // 新增工班施工完備註
                if (workShiftCompletionNote) {
                    updateData[fieldMapping.workShiftCompletionNote] = workShiftCompletionNote;
                }
                
                // Update stage if completed
                updateData[fieldMapping.stage] = '驗收';
                updateData[fieldMapping.label] = '已完工';
            }
            
            // Collect photo URLs
            const floorPlanPhotos = collectPhotoUrls('floorPlanPhotos');
            const beforePhotos = collectPhotoUrls('beforePhotos');
            const afterPhotos = collectPhotoUrls('afterPhotos');
            const difficultyPhotos = collectPhotoUrls('difficultyPhotos');
            
            if (floorPlanPhotos.length > 0) {
                updateData[fieldMapping.floorPlan] = floorPlanPhotos[0]; // Only one floor plan
            }
            if (beforePhotos.length > 0) {
                updateData[fieldMapping.beforePhotos] = beforePhotos.join(',');
            }
            if (afterPhotos.length > 0) {
                updateData[fieldMapping.afterPhotos] = afterPhotos.join(',');
            }
            // 新增工地狀況照片(施工後)
            if (difficultyPhotos.length > 0) {
                updateData[fieldMapping.constructionDifficultyPhotos] = difficultyPhotos.join(',');
            }
            
            try {
                // Update site data using mixed approach (D1-only write)
                const response = await fetch(
                    `${WORKER_API_URL}/rest/object_8W9cb__c/${currentSiteId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    }
                );
                
                if (!response.ok) {
                    throw new Error('Update failed');
                }
                
                // Vibration feedback
                if (navigator.vibrate) {
                    navigator.vibrate([50, 30, 50]);
                }
                
                alert('提交成功！');
                
                // Reload sites to refresh grid
                await loadSites();
                
                // Close modal
                closeModal();
            } catch (error) {
                console.error('Submit error:', error);
                alert('提交失敗，請稍後再試');
            }
        }

        // Collect photo URLs from container
        function collectPhotoUrls(containerId) {
            const container = document.getElementById(containerId);
            const images = container.querySelectorAll('.has-image img');
            return Array.from(images).map(img => img.src);
        }

        // Load progress announcements from database
        async function loadProgressAnnouncements() {
            const gridContent = document.getElementById('gridContent');
            
            // Show loading
            gridContent.innerHTML = `
                <div style="padding: 2rem; text-align: center;">
                    <div class="loading">載入進度公告中...</div>
                </div>
            `;
            
            try {
                // Use opportunity_id to fetch related announcements
                const opportunityId = currentProject.opportunity_id;
                
                if (!opportunityId) {
                    console.warn('No opportunity_id found for project');
                    gridContent.innerHTML = `
                        <div style="padding: 2rem;">
                            <div style="background: #fee; color: #c00; padding: 1rem; border-radius: 8px;">
                                無法載入進度公告：缺少商機關聯
                            </div>
                        </div>
                    `;
                    return;
                }
                
                console.log('[DEBUG] Loading announcements for opportunity:', opportunityId);
                
                // Fetch announcements from API
                const response = await fetch(
                    `${API_BASE_URL}/rest/progress_management_announ__c?field_RFr42__c=${opportunityId}&order_by=order_by&limit=50`,
                    {
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to load announcements');
                }

                const result = await response.json();
                const announcements = result.dataList || result.results || [];
                
                // Display announcements
                if (announcements.length > 0) {
                    let html = `
                        <div style="padding: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="color: var(--heading);">進度公告</h2>
                                <button onclick="addAnnouncement()" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    新增公告
                                </button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                    `;
                    
                    announcements.forEach(announcement => {
                        const content = announcement.announcement_content__c || '無內容';
                        const createTime = announcement.create_time ? 
                            new Date(announcement.create_time).toLocaleDateString('zh-TW') : 
                            '未知日期';
                        const showToTeam = announcement.field_q97ij__c ? '✓ 工班可見' : '';
                        const showToOwner = announcement.field_uO778__c ? '✓ 業主可見' : '';
                        const announcementNumber = announcement.name || '';
                        
                        // Check if there's an image
                        const imageHtml = announcement.field_dvR88__c ? 
                            `<img src="${announcement.field_dvR88__c}" style="max-width: 100%; margin-top: 0.5rem; border-radius: 4px;" alt="公告圖片">` : 
                            '';
                        
                        html += `
                            <div style="padding: 1rem; background: var(--background); border-left: 4px solid var(--primary); border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong style="color: var(--heading);">公告 #${announcementNumber}</strong>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        ${showToTeam ? `<span style="color: var(--primary); font-size: 0.75rem;">${showToTeam}</span>` : ''}
                                        ${showToOwner ? `<span style="color: var(--primary); font-size: 0.75rem;">${showToOwner}</span>` : ''}
                                        <span style="color: var(--body-text); font-size: 0.875rem;">${createTime}</span>
                                    </div>
                                </div>
                                <p style="color: var(--body-text); white-space: pre-wrap;">${content}</p>
                                ${imageHtml}
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    gridContent.innerHTML = html;
                } else {
                    // No announcements
                    gridContent.innerHTML = `
                        <div style="padding: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="color: var(--heading);">進度公告</h2>
                                <button onclick="addAnnouncement()" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    新增公告
                                </button>
                            </div>
                            <div style="background: var(--background); padding: 2rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">📢</div>
                                <p style="color: var(--body-text);">目前沒有進度公告</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                gridContent.innerHTML = `
                    <div style="padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="color: var(--heading);">進度公告</h2>
                            <button onclick="addAnnouncement()" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                新增公告
                            </button>
                        </div>
                        <div style="background: #fee; color: #c00; padding: 1rem; border-radius: 8px;">
                            載入進度公告失敗：${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Add new announcement (placeholder function)
        function addAnnouncement() {
            alert('新增公告功能開發中...');
        }

        // Toggle collapsible sections
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const button = section.previousElementSibling;
            
            if (section && button && button.classList.contains('section-toggle')) {
                section.classList.toggle('collapsed');
                button.classList.toggle('collapsed');
            }
        }

        // Toggle construction team info
        function toggleTeamInfo() {
            const teamInfo = document.getElementById('constructionTeamInfo');
            if (teamInfo) {
                teamInfo.classList.toggle('collapsed');
            }
        }

        // Initialize collapsible sections on mobile
        function initCollapsibleSections() {
            if (window.innerWidth <= 768) {
                // Collapse sections by default on mobile
                const statsSection = document.getElementById('statsSection');
                const constructionTeamInfo = document.getElementById('constructionTeamInfo');
                const statsToggle = statsSection?.previousElementSibling;
                
                if (statsSection && statsToggle && statsToggle.classList.contains('section-toggle')) {
                    statsSection.classList.add('collapsed');
                    statsToggle.classList.add('collapsed');
                }
                
                // Collapse construction team info by default on mobile
                if (constructionTeamInfo) {
                    constructionTeamInfo.classList.add('collapsed');
                }
            }
        }

        // Call on page load and resize
        window.addEventListener('DOMContentLoaded', initCollapsibleSections);
        window.addEventListener('resize', () => {
            // Remove collapsed state when switching to desktop
            if (window.innerWidth > 768) {
                const sections = document.querySelectorAll('.stats-section, .construction-team-info');
                const toggles = document.querySelectorAll('.section-toggle');
                
                sections.forEach(section => section.classList.remove('collapsed'));
                toggles.forEach(toggle => toggle.classList.remove('collapsed'));
            }
        });

        // Handle tab switching
        function handleTabSwitch(tabName) {
            const gridWrapper = document.querySelector('.building-grid-wrapper');
            const gridContent = document.getElementById('gridContent');
            const legend = document.getElementById('gridLegend');
            const buildingTabs = document.getElementById('buildingTabs');
            
            // Update URL with the new tab parameter
            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            window.history.pushState({}, '', url);
            
            switch(tabName) {
                case 'spc':
                    // Show SPC engineering grid (current view)
                    gridWrapper.style.display = 'block';
                    buildingTabs.style.display = 'flex';
                    legend.style.display = 'flex';
                    renderFloorGrid();
                    break;
                    
                case 'cabinet':
                    // Show cabinet engineering message
                    gridWrapper.style.display = 'block';
                    buildingTabs.style.display = 'none';
                    legend.style.display = 'none';
                    gridContent.innerHTML = `
                        <div style="padding: 3rem; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">🚫</div>
                            <h2 style="color: var(--heading); margin-bottom: 0.5rem;">本專案未包含浴櫃工程服務</h2>
                            <p style="color: var(--body-text);">此專案僅提供 SPC 工程服務</p>
                        </div>
                    `;
                    break;
                    
                case 'maintenance':
                    // Show maintenance orders
                    gridWrapper.style.display = 'block';
                    buildingTabs.style.display = 'none';
                    legend.style.display = 'none';
                    gridContent.innerHTML = `
                        <div style="padding: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="color: var(--heading);">維修單管理</h2>
                                <button style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    新增維修單
                                </button>
                            </div>
                            <div style="background: var(--background); padding: 2rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">🔧</div>
                                <p style="color: var(--body-text);">目前沒有維修單</p>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'announcements':
                    // Show progress announcements
                    gridWrapper.style.display = 'block';
                    buildingTabs.style.display = 'none';
                    legend.style.display = 'none';
                    loadProgressAnnouncements();
                    break;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const tabName = this.dataset.tab;
                    handleTabSwitch(tabName);
                });
            });

            // Building switching - use event delegation properly
            document.getElementById('buildingTabs').addEventListener('click', (e) => {
                // Find the actual button element (could be the target or its parent)
                let button = e.target.closest('.building-btn');
                
                if (button) {
                    // Prevent multiple rapid clicks
                    if (button.dataset.switching === 'true') return;
                    button.dataset.switching = 'true';
                    
                    // Update active state
                    document.querySelectorAll('.building-btn').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Update current building
                    const newBuilding = button.dataset.building;
                    if (currentBuilding !== newBuilding) {
                        currentBuilding = newBuilding;
                        console.log('Switching to building:', currentBuilding);
                        renderFloorGrid();
                    }
                    
                    // Allow clicking again after a short delay
                    setTimeout(() => {
                        button.dataset.switching = 'false';
                    }, 300);
                }
            });

            // Modal background click to close
            document.getElementById('siteModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeModal();
                }
            });

            // ESC key to close modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });

            // Report button
            const reportBtn = document.querySelector('.btn-report');
            if (reportBtn) {
                reportBtn.addEventListener('click', () => {
                    showPermissionAlert('報表功能');
                });
            }

            // Export button
            const exportBtn = document.querySelector('.btn-export');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    showPermissionAlert('匯出功能');
                });
            }

            // Settings button (Edit)
            const settingsBtn = document.querySelector('.btn-settings');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => {
                    // 直接導航到編輯頁面
                    const projectId = new URLSearchParams(window.location.search).get('id');
                    if (projectId) {
                        // 使用標準的編輯模式 URL
                        window.location.href = `project-create.html?id=${projectId}`;
                    }
                });
            }

            // Delete button
            const deleteBtn = document.querySelector('.btn-delete');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async () => {
                    const projectId = new URLSearchParams(window.location.search).get('id');
                    const projectName = document.getElementById('projectName').textContent;
                    
                    if (projectId && confirm(`確定要刪除專案「${projectName}」嗎？此操作無法復原。`)) {
                        try {
                            const response = await fetch(
                                `${WORKER_API_URL}/api/v1/projects/${projectId}`,
                                {
                                    method: 'DELETE',
                                    headers: AuthUtils.getRequestHeaders()
                                }
                            );

                            if (response.ok) {
                                alert('專案已成功刪除');
                                window.location.href = 'project-list.html';
                            } else {
                                const error = await response.json();
                                throw new Error(error.error || '刪除失敗');
                            }
                        } catch (error) {
                            console.error('刪除專案失敗:', error);
                            alert('刪除專案時發生錯誤：' + error.message);
                        }
                    }
                });
            }
        }

        // Go back
        function goBack() {
            window.location.href = 'project-list.html';
        }

        // Go to user management page
        function goToUserManagement() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            if (projectId) {
                window.location.href = `project-user-management.html?project_id=${projectId}`;
            }
        }

        // Show/hide user management button based on user role
        function updateUserManagementButton() {
            const userManagementBtn = document.getElementById('userManagementBtn');
            if (!userManagementBtn) return;
            
            // Get current user role
            const userRole = getCurrentUserRole();
            const isAdmin = userRole === 'admin';
            const isLeader = currentUser?.role === 'foreman' || currentUser?.role === 'leader';
            
            // Show button for admin or leader
            if (isAdmin || isLeader) {
                userManagementBtn.style.display = 'flex';
            } else {
                userManagementBtn.style.display = 'none';
            }
        }

        // Show error
        function showError(message) {
            const gridContent = document.getElementById('gridContent');
            gridContent.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // Show permission alert
        function showPermissionAlert(feature) {
            // Create alert modal if it doesn't exist
            let alertModal = document.getElementById('permissionAlertModal');
            if (!alertModal) {
                alertModal = document.createElement('div');
                alertModal.id = 'permissionAlertModal';
                alertModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: none;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const alertContent = document.createElement('div');
                alertContent.style.cssText = `
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                `;
                
                alertContent.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🔒</div>
                    <h2 style="color: #1e293b; margin-bottom: 1rem; font-size: 1.5rem;">權限不足</h2>
                    <p id="permissionMessage" style="color: #64748b; margin-bottom: 1.5rem;">您沒有權限使用此功能</p>
                    <button onclick="document.getElementById('permissionAlertModal').style.display='none'" 
                            style="padding: 0.75rem 2rem; background: #84C7D0; color: white; border: none; 
                                   border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 500;">
                        確定
                    </button>
                `;
                
                alertModal.appendChild(alertContent);
                document.body.appendChild(alertModal);
                
                // Close on background click
                alertModal.addEventListener('click', (e) => {
                    if (e.target === alertModal) {
                        alertModal.style.display = 'none';
                    }
                });
            }
            
            // Update message and show
            const message = document.getElementById('permissionMessage');
            if (message) {
                message.textContent = `您沒有權限使用${feature}。請聯繫管理員開通權限。`;
            }
            alertModal.style.display = 'flex';
        }


        // 取得角色中文名稱
        function getRoleName(role) {
            const roleNames = {
                admin: '管理員',
                owner: '業主',
                foreman: '工班負責人',
                worker: '工班成員'
            };
            return roleNames[role] || role;
        }

        // 修改權限檢查函數，考慮模擬用戶
        function getCurrentUserPermissions() {
            // 檢查是否有統一權限系統的模擬用戶
            if (window.permissions && window.permissions.isSimulating()) {
                const contextUser = window.permissions.getCurrentContextUser();
                if (contextUser) {
                    return {
                        isAdmin: false,
                        role: contextUser.role || contextUser.user_type,
                        can_view: true,
                        can_edit: true,
                        can_manage_members: contextUser.role === 'leader',
                        can_view_other_teams: false,
                        user_id: contextUser.id,
                        phone: contextUser.phone,
                        name: contextUser.name
                    };
                }
            } else {
                // 返回原始管理員權限
                const currentUser = window.permissions?.currentUser || JSON.parse(localStorage.getItem('user') || '{}');
                return {
                    isAdmin: true,
                    role: 'admin',
                    can_view: true,
                    can_edit: true,
                    can_manage_members: true,
                    can_view_other_teams: true,
                    user_id: currentUser?.id || 'admin',
                    phone: currentUser?.phone || '0900000001',
                    name: currentUser?.name || '系統管理員'
                };
            }
        }

    </script>
</body>
</html>