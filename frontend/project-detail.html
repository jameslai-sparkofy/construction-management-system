<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞àÊ°àË©≥ÊÉÖ - ÂÖÉÂøÉÂª∫ÊùêÂ∑•Á®ãÁÆ°ÁêÜÁ≥ªÁµ± v1.2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Official Colors from screenshot */
            --heading: #222222;
            --body-text: #6b7280;
            --primary: #84C7D0;
            --secondary: #6C6F7D;
            --border: #e5e7eb;
            --border-primary: #d1d5db;
            
            /* Status Colors */
            --completed: #84c7d0;
            --in-progress: #f59e0b;
            --pending: #ffffff;
            --maintenance: #fbbf24;
            --maintenance-done: #415a77;
            --no-unit: #f3f4f6;
            
            /* Extended Palette */
            --background: #f9fafb;
            --surface: #ffffff;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: var(--background);
            color: var(--body-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header */
        .header {
            background: var(--surface);
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--body-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }

        .back-btn:hover {
            background: var(--background);
        }

        .project-info {
            flex: 1;
        }

        .project-info h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--heading);
            margin-bottom: 0.125rem;
        }

        .project-info p {
            font-size: 0.8125rem;
            color: var(--body-text);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .header-actions button {
            padding: 0.5rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--body-text);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-actions button:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Ë¶ñËßíÂàáÊèõÂô®Ê®£Âºè */
        .perspective-switcher {
            position: relative;
            display: none; /* È†êË®≠Èö±ËóèÔºåÂè™ÊúâÁÆ°ÁêÜÂì°ÂèØË¶ã */
        }

        .perspective-switcher.show {
            display: block;
        }

        .perspective-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
        }

        .perspective-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .perspective-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            min-width: 280px;
            z-index: 1000;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .perspective-dropdown.show {
            display: block;
        }

        .perspective-group {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .perspective-group:last-child {
            border-bottom: none;
        }

        .perspective-group-title {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: var(--background);
        }

        .perspective-item {
            padding: 0.75rem 1rem;
            color: var(--body-text);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .perspective-item:hover {
            background: var(--background);
            color: var(--primary);
        }

        .perspective-item.active {
            background: #f0f9ff;
            color: var(--primary);
            font-weight: 500;
        }

        .perspective-role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .role-admin {
            background: #fee2e2;
            color: #991b1b;
        }

        .role-owner {
            background: #fef3c7;
            color: #92400e;
        }

        .role-foreman {
            background: #d1fae5;
            color: #065f46;
        }

        .role-worker {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Ê®°Êì¨Ê®°ÂºèÊèêÁ§∫Ê¢ù */
        .simulation-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 0.75rem 1rem;
            text-align: center;
            font-weight: 500;
            display: none;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .simulation-banner.show {
            display: block;
        }

        .exit-simulation-btn {
            background: rgba(255,255,255,0.2) !important;
            color: white !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
            padding: 0.25rem 0.5rem !important;
            font-size: 0.75rem !important;
            margin-left: 1rem;
        }

        .exit-simulation-btn:hover {
            background: rgba(255,255,255,0.3) !important;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0;
            padding: 0;
            background: var(--surface);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            box-shadow: none;
        }

        .nav-tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            position: relative;
            margin-bottom: -2px;
            border-radius: 0;
        }

        .nav-tab:hover {
            color: var(--heading);
            background: rgba(132, 199, 208, 0.05);
        }

        .nav-tab.active {
            color: var(--primary);
            background: transparent;
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        /* Building Grid Content */
        .building-grid-wrapper {
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .building-tabs {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 1rem;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .building-btn {
            padding: 1rem 3rem;
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--body-text);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.95rem;
            min-width: 120px;
            text-align: center;
        }

        .building-btn:hover:not(.active) {
            background: rgba(132, 199, 208, 0.1);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
        }

        .building-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(132, 199, 208, 0.3);
        }

        /* Floor Grid Table */
        .floor-grid-container {
            padding: 1.5rem;
            overflow-x: auto;
        }

        .floor-grid {
            width: 100%;
            border-collapse: collapse;
        }

        .floor-grid thead th {
            padding: 0.4rem;
            text-align: center;
            font-weight: 600;
            color: var(--heading);
            background: var(--background);
            border: 1px solid var(--border);
        }

        .floor-grid tbody th {
            padding: 0.4rem;
            text-align: center;
            font-weight: 600;
            color: var(--heading);
            background: var(--background);
            border: 1px solid var(--border);
        }

        .grid-cell {
            padding: 0.4rem;
            border: 1px solid var(--border);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: var(--pending);
            min-width: 120px;
            height: 60px;
        }

        .grid-cell:hover {
            background: rgba(132, 199, 208, 0.1);
            border-color: var(--primary);
        }

        .grid-cell.completed {
            background: var(--completed);
            color: white;
        }

        .grid-cell.no-unit {
            background: var(--no-unit);
            cursor: default;
            pointer-events: none;
        }

        .cell-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .cell-line1 {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .cell-line2 {
            font-size: 0.75rem;
            color: var(--body-text);
        }

        .cell-team {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #84C7D0;
            color: white;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            line-height: 20px;
            margin-left: 0.25rem;
        }

        .grid-cell.completed .cell-team {
            background: #5A9BA5;
        }

        .maintenance-badges {
            position: absolute;
            top: 4px;
            right: 4px;
            display: flex;
            gap: 4px;
        }

        .maintenance-badge {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--maintenance);
            color: var(--heading);
            font-size: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .maintenance-badge.done {
            background: var(--maintenance-done);
            color: white;
        }

        /* Modal Styles from site-modal-final */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-container {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 95vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        /* Compact Header */
        .modal-header {
            background: linear-gradient(135deg, #84C7D0 0%, #6C6F7D 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex: 1;
        }

        .site-basic-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-label {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .info-value {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .divider {
            width: 1px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .modal-share-btn {
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Modal Body */
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* Â™íÈ´îÂçÄÂ°ä - ÂãïÊÖã‰ΩàÂ±Ä */
        .media-container {
            margin-bottom: 1rem;
        }

        .media-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 6px;
        }

        .section-icon {
            font-size: 1.125rem;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        /* ÁÖßÁâáÁ∂≤Ê†º - Á∑äÊπä‰ΩàÂ±Ä */
        .photos-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            min-height: 90px;
        }

        .photo-box {
            width: 80px;
            height: 80px;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .photo-box:hover {
            border-color: #84C7D0;
            background: #f0fdf4;
        }

        .photo-box.has-image {
            border-style: solid;
            border-color: #84C7D0;
            padding: 2px;
        }

        .photo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            cursor: zoom-in;
        }

        .photo-box.add-photo {
            background: #f9fafb;
        }

        .photo-box.add-photo:hover {
            background: #e5f7fa;
            border-color: #84C7D0;
        }

        /* ÊâÄÊúâÂ™íÈ´îÂçÄÂ°äÁöÑÁ∑äÊπäÊéíÂàó - ÂßãÁµÇÊ©´Âêë */
        .all-media-compact {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .all-media-compact .media-container {
            flex: 1;
            min-width: 30%;
            margin-bottom: 0;
        }

        .all-media-compact .photos-wrapper {
            min-height: 80px;
        }

        /* ÊñΩÂ∑•ÂâçÂÇôË®ªÂçÄÂ°ä - ÂèØÊî∂Âêà */
        .before-construction-section {
            background: #fef9f3;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .before-construction-section.collapsed {
            background: transparent;
            margin-bottom: 0.5rem;
        }

        .notes-header {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fef9f3;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .before-construction-section.collapsed .notes-header {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }

        .notes-content {
            padding: 0 1rem 1rem;
            max-height: 200px;
            transition: all 0.3s ease;
        }

        .before-construction-section.collapsed .notes-content {
            max-height: 0;
            padding: 0 1rem;
            overflow: hidden;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            color: #6b7280;
        }

        .before-construction-section.collapsed .expand-icon {
            transform: rotate(-90deg);
        }

        .notes-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 80px;
        }

        .photo-remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            line-height: 1;
        }

        .photo-box.has-image:hover .photo-remove-btn {
            display: flex;
        }

        /* ÊñΩÂ∑•ÂÆåÊàêÂçÄÂ°ä - ‰ΩøÁî®ËóçÁ∂†Ëâ≤ */
        .completion-section {
            background: #c5edf2;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #84C7D0;
        }

        .completion-checkbox {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .completion-checkbox input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .completion-label {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            user-select: none;
        }

        .worker-name {
            font-size: 0.875rem;
            color: #4f46e5;
            margin-left: 0.5rem;
            font-weight: normal;
        }

        .completion-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .completion-fields.active {
            opacity: 1;
            pointer-events: auto;
        }

        #completionFields2 {
            display: grid;
            grid-template-columns: 1fr;
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        #completionFields2.active {
            opacity: 1;
            pointer-events: auto;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .field-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .field-input {
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            background: white;
        }

        .field-input:focus {
            outline: none;
            border-color: #84C7D0;
            box-shadow: 0 0 0 3px rgba(132, 199, 208, 0.2);
        }

        /* Êèê‰∫§ÊåâÈàï - ÈÜíÁõÆË®≠Ë®à */
        .submit-section {
            padding: 1.5rem;
            background: white;
            border-top: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .btn-cancel {
            padding: 0.875rem 1.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            color: #6b7280;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-submit {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #84C7D0 0%, #6eb5c0 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1.125rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(132, 199, 208, 0.3);
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(132, 199, 208, 0.4);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                transform: translateY(30px); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0); 
                opacity: 1; 
            }
        }

        /* Lightbox Ê®£Âºè */
        #lightbox {
            animation: fadeIn 0.3s ease;
        }

        /* Loading state */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            color: var(--body-text);
        }

        .error-message {
            background: #fee;
            color: #c00;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* Construction Team Info in Legend */
        .construction-team-info {
            margin: 0;
            border-top: 1px solid var(--border);
        }

        .team-info-toggle {
            display: none;
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: var(--background);
            border: none;
            border-bottom: 1px solid var(--border);
            text-align: left;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--heading);
            font-weight: 600;
        }

        .team-info-toggle::after {
            content: '';
            float: right;
        }

        .team-info-content {
            display: block;
        }

        /* Collapsible sections for mobile */
        .section-toggle {
            display: none;
            width: 100%;
            padding: 0.75rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            color: var(--heading);
            cursor: pointer;
            text-align: left;
            margin-bottom: 0.5rem;
        }

        .section-toggle::after {
            content: '‚ñº';
            float: right;
            transition: transform 0.3s;
        }

        .section-toggle.collapsed::after {
            transform: rotate(-90deg);
        }

        /* Tablet and Mobile Nav Tabs */
        @media (max-width: 768px) {
            /* Collapsible sections */
            .section-toggle {
                display: block;
            }

            .stats-section.collapsed,
            .construction-info.collapsed .construction-info-content {
                display: none;
            }

            .construction-info {
                padding: 0.75rem 1rem;
            }

            .construction-info.collapsed {
                padding: 0;
                margin: 0;
                background: transparent;
            }
            
            /* Construction team info toggle on mobile */
            .team-info-toggle {
                display: block;
            }
            
            .construction-team-info.collapsed .team-info-content {
                display: none;
            }
            
            .construction-team-info.collapsed .team-info-toggle::after {
                content: ' ‚ñ∂';
            }
            
            .construction-team-info:not(.collapsed) .team-info-toggle::after {
                content: ' ‚ñº';
            }

            .nav-tabs {
                padding: 0 1rem;
            }
            
            .nav-tab {
                padding: 0.875rem 1.25rem;
                font-size: 0.9rem;
            }
            
            .building-tabs {
                padding: 0.75rem 1rem;
                gap: 0.5rem;
            }
            
            .building-btn {
                padding: 0.875rem 2.25rem;
                font-size: 0.875rem;
                min-width: 100px;
            }
        }
        
        @media (max-width: 640px) {
            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0;
                margin-bottom: 1rem;
            }
            
            .nav-tab {
                flex-shrink: 0;
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                white-space: nowrap;
                min-width: fit-content;
            }
            
            .building-grid-wrapper {
                margin: 0.5rem;
            }
            
            .building-tabs {
                padding: 0.5rem;
                gap: 0.375rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0.5rem;
            }
            
            .building-btn {
                flex-shrink: 0;
                padding: 0.75rem 2rem;
                font-size: 0.8125rem;
                min-width: 90px;
                border-width: 1.5px;
            }
            
            .floor-grid-container {
                padding: 0.5rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
        }
        
        /* ÊâãÊ©üÂÑ™Âåñ */
        @media (max-width: 768px) {
            .project-stats {
                flex-direction: column;
                gap: 1rem;
            }

            .floor-grid-container {
                padding: 0.5rem;
            }
            
            .floor-grid {
                min-width: 500px;
            }
            
            .floor-grid th,
            .floor-grid td {
                padding: 0.5rem 0.375rem;
                font-size: 0.75rem;
            }
            
            .site-cell {
                padding: 0.375rem;
                min-height: 45px;
            }
            
            .site-unit {
                font-size: 0.8125rem;
            }
            
            .site-info {
                font-size: 0.625rem;
                gap: 0.125rem;
            }
            
            .site-area {
                font-size: 0.625rem;
            }
            
            .site-team,
            .site-worker {
                font-size: 0.625rem;
            }

            .modal-container {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .modal-overlay {
                padding: 0;
            }

            .modal-body {
                padding: 1rem 0;
            }

            .header-info {
                overflow-x: auto;
                padding-bottom: 0.25rem;
            }

            .site-basic-info {
                min-width: fit-content;
            }

            .completion-fields {
                grid-template-columns: 1fr;
            }
            
            #completionFields2 {
                margin-top: 0.5rem !important;
            }
            
            #completionFields2 .field-group {
                grid-column: span 1 !important;
            }
            
            .before-construction-section {
                margin: 0 1rem 1rem;
            }
            
            .completion-section {
                margin: 0 1rem 1rem;
            }

            .all-media-compact {
                gap: 0.25rem;
                padding: 0 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .all-media-compact .media-container {
                flex: 1;
                min-width: 0;
                max-width: 33.333%;
            }
            
            .media-header {
                padding: 0.375rem 0.5rem;
                background: #f3f4f6;
                margin-bottom: 0.375rem;
                border-radius: 4px;
            }
            
            .section-icon {
                font-size: 1rem;
                display: none;
            }
            
            .section-title {
                font-size: 0.875rem;
                font-weight: 500;
                text-align: center;
                width: 100%;
                color: #374151;
            }
            
            .photos-wrapper {
                padding: 0.375rem;
                min-height: 65px;
                max-height: 65px;
                overflow-x: auto;
                overflow-y: hidden;
                display: flex;
                gap: 0.25rem;
            }
            
            .photo-box {
                width: 55px;
                height: 55px;
                flex-shrink: 0;
            }
            
            .photo-box div {
                font-size: 1.25rem !important;
            }
            
            .photo-box.has-image .photo-remove-btn {
                width: 18px;
                height: 18px;
                font-size: 0.75rem;
                top: 2px;
                right: 2px;
                background: rgba(0, 0, 0, 0.7);
                border-radius: 3px;
            }
        }
        /* Statistics Cards */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background: var(--surface);
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #84C7D0 0%, #6eb5c0 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .stat-card:nth-child(2) .stat-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .stat-card:nth-child(3) .stat-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-card:nth-child(4) .stat-icon {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--heading);
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--body-text);
        }

        @media (max-width: 1024px) {
            .stats-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 0;
            }
            
            .header {
                padding: 1rem;
                margin-bottom: 0.5rem;
            }
            
            .header-content {
                gap: 0.75rem;
            }
            
            .back-btn {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }
            
            .project-info h1 {
                font-size: 1.25rem;
            }
            
            .project-info p {
                font-size: 0.75rem;
            }
            
            .header-actions {
                flex-direction: row;
                gap: 0.5rem;
            }
            
            .header-actions button {
                padding: 0.5rem;
                font-size: 0.875rem;
            }
            
            .header-actions button span:last-child {
                display: none; /* Hide text labels on mobile, keep icons */
            }
            
            .stats-section {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                padding: 0 1rem;
                margin: 1rem 0;
            }
            
            .stat-card {
                padding: 0.875rem;
                gap: 0.75rem;
            }
            
            .stat-icon {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
                border-radius: 8px;
            }
            
            .stat-value {
                font-size: 1.25rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
        }
        
        /* Legend */
        .legend-container {
            display: flex;
            gap: 2rem;
            padding: 1rem 1.5rem;
            background: var(--background);
            border-top: 1px solid var(--border);
            margin: 0;
        }

        .legend-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* Team management modal */
        .team-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .team-modal.active {
            display: flex;
        }
        
        .team-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .team-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .team-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--heading);
        }
        
        .team-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .team-modal-close:hover {
            background: #e5e7eb;
        }
        
        .team-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .team-members-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .team-member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .team-member-item:hover {
            background: #f3f4f6;
        }
        
        .team-member-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .team-member-name {
            font-weight: 500;
            color: var(--heading);
        }
        
        .team-member-phone {
            font-size: 0.875rem;
            color: var(--body-text);
        }
        
        .team-member-role {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #84C7D0;
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.25rem;
        }
        
        .team-member-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .team-action-btn {
            padding: 0.5rem;
            border: none;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .team-action-btn:hover {
            background: #e5e7eb;
        }
        
        .team-action-btn.delete {
            color: #ef4444;
        }
        
        .team-action-btn.delete:hover {
            background: #fee2e2;
        }
        
        .add-member-btn {
            width: 100%;
            padding: 0.75rem;
            margin-top: 1rem;
            border: 2px dashed #d1d5db;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: var(--body-text);
        }
        
        .add-member-btn:hover {
            border-color: #84C7D0;
            background: #f0fdfa;
            color: #0f766e;
        }

        .legend-title {
            font-weight: 600;
            color: var(--heading);
            margin-right: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--body-text);
            cursor: default;
        }
        
        .legend-item[title] {
            cursor: help;
        }
        
        .legend-item[title]:hover {
            opacity: 0.8;
        }

        .legend-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
            border: 1px solid var(--border);
        }

        .legend-icon.completed {
            background: var(--completed);
            color: white;
            border-color: var(--completed);
        }

        .legend-icon.pending {
            background: var(--pending);
            color: var(--body-text);
        }

        .legend-icon.empty {
            background: var(--no-unit);
            color: var(--body-text);
        }

        /* Team Icons */
        .team-icon {
            width: 24px;
            height: 24px;
            border-radius: 3px;
            background: #84C7D0;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
        }
        
        /* Responsive Legend */
        @media (max-width: 768px) {
            .legend-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .legend-group {
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 640px) {
            .legend-container {
                margin: 0.5rem;
                padding: 0.75rem;
            }
            
            .legend-item {
                font-size: 0.75rem;
            }
            
            .legend-icon {
                width: 20px;
                height: 20px;
                font-size: 0.75rem;
            }
            
            .team-icon {
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
            }
        }

        /* Loading spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="config.js"></script>
    <script src="js/unified-auth.js"></script>
    <script src="js/unified-permissions.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        // Supabase configuration
        const supabaseUrl = 'https://pbecqosbkuyypsgwxnmq.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBiZWNxb3Nia3V5eXBzZ3d4bm1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDgyOTcsImV4cCI6MjA3MDIyNDI5N30.RxgJZpII8Fm1ym6UtMEdmw87DExR1MxtJXISag9vszQ';
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        window.supabase = supabase;
        
        // Get current user from Supabase
        async function getCurrentSupabaseUser() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    window.currentSupabaseUser = user;
                    return user;
                }
            } catch (error) {
                console.log('ÁÑ°Ê≥ïÁç≤Âèñ Supabase Áî®Êà∂:', error);
            }
            return null;
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', getCurrentSupabaseUser);
    </script>
</head>
<body>
    <!-- Ê®°Êì¨Ê®°ÂºèÊèêÁ§∫Ê¢ù -->
    <div class="simulation-banner" id="simulationBanner">
        <span id="simulationText">üé≠ ÁõÆÂâçÊ≠£Âú®Ê®°Êì¨Ë¶ñËßíÔºö<strong id="simulatedUserName"></strong></span>
        <button class="exit-simulation-btn" onclick="exitSimulation()">
            ‚ùå ËøîÂõûÁÆ°ÁêÜÂì°Ë¶ñËßí
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="goBack()">‚Üê</button>
                <div class="project-info">
                    <h1 id="projectName">ËºâÂÖ•‰∏≠...</h1>
                    <p id="projectDescription">Ê≠£Âú®ËºâÂÖ•Â∞àÊ°àË≥áÊñô...</p>
                </div>
                <div class="header-actions">
                    <!-- Ë¶ñËßíÂàáÊèõÂô® (ÂÉÖÁÆ°ÁêÜÂì°ÂèØË¶ã) -->
                    <div class="perspective-switcher" id="perspectiveSwitcher">
                        <button class="perspective-btn" onclick="togglePerspectiveDropdown()">
                            <span>üë§</span>
                            <span>ÂàáÊèõË¶ñËßí</span>
                        </button>
                        <div class="perspective-dropdown" id="perspectiveDropdown">
                            <div class="perspective-group">
                                <div class="perspective-group-title">ÁÆ°ÁêÜÂì°</div>
                                <div class="perspective-item active" onclick="switchPerspective(null)">
                                    <span>üîß</span>
                                    <span>ÁÆ°ÁêÜÂì°Ë¶ñËßí (Áï∂Ââç)</span>
                                </div>
                            </div>
                            <div id="perspectiveUsersList">
                                <!-- ÂãïÊÖãËºâÂÖ•Áî®Êà∂ÂàóË°® -->
                            </div>
                        </div>
                    </div>

                    <button class="btn-report">
                        <span>üìä</span>
                        <span>Â†±Ë°®</span>
                    </button>
                    <button class="btn-settings">
                        <span>‚öôÔ∏è</span>
                        <span>Á∑®ËºØ</span>
                    </button>
                    <button class="btn-export">
                        <span>üì•</span>
                        <span>ÂåØÂá∫</span>
                    </button>
                    <button class="btn-delete" style="background: #fee2e2; color: #dc2626;">
                        <span>üóëÔ∏è</span>
                        <span>Âà™Èô§</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <button class="section-toggle" onclick="toggleSection('statsSection')">Áµ±Ë®àË≥áË®ä</button>
        <div class="stats-section" id="statsSection">
            <div class="stat-card">
                <div class="stat-icon">üè¢</div>
                <div class="stat-content">
                    <div class="stat-value" id="statTotalSites">0</div>
                    <div class="stat-label">Á∏ΩÊ°àÂ†¥Êï∏</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úì</div>
                <div class="stat-content">
                    <div class="stat-value" id="statCompleted">0</div>
                    <div class="stat-label">Â∑≤ÂÆåÂ∑•</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-content">
                    <div class="stat-value" id="statPending">0</div>
                    <div class="stat-label">ÂæÖÊñΩÂ∑•</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üîß</div>
                <div class="stat-content">
                    <div class="stat-value" id="statMaintenance">0</div>
                    <div class="stat-label">ÂæÖÁ∂≠‰øÆ</div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="spc">SPCÂ∑•Á®ã</button>
            <button class="nav-tab" data-tab="cabinet">Êµ¥Ê´ÉÂ∑•Á®ã</button>
            <button class="nav-tab" data-tab="maintenance">Á∂≠‰øÆÂñÆ</button>
            <button class="nav-tab" data-tab="announcements">ÈÄ≤Â∫¶ÂÖ¨Âëä</button>
        </div>

        <!-- Building Grid -->
        <div class="building-grid-wrapper">
            <div class="building-tabs" id="buildingTabs">
                <!-- ÂãïÊÖãÁîüÊàêÂª∫ÁØâÁâ©Ê®ôÁ±§ -->
            </div>
            
            <!-- Legend -->
            <div id="gridLegend" class="legend-container">
                <div class="legend-group" style="background: rgba(132, 199, 208, 0.1); padding: 0.5rem 1rem; border-radius: 6px;">
                    <span class="legend-title">ÁãÄÊÖãÔºö</span>
                    <div class="legend-item">
                        <div class="legend-icon completed"></div>
                        <span>ÂÆåÊàê</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon pending"></div>
                        <span>ÂæÖÊñΩÂ∑•</span>
                    </div>
                    <div class="legend-item" title="‰ª£Ë°®Á¨¨1Ê¨°ÁöÑÁ∂≠‰øÆÂñÆÂæÖÁ∂≠‰øÆ">
                        <div class="legend-icon" style="background: #fbbf24; color: white; border-color: #fbbf24; border-radius: 3px;">
                            <span style="font-size: 0.75rem; font-weight: 700;">1</span>
                        </div>
                        <span>ÂæÖÁ∂≠‰øÆ</span>
                    </div>
                    <div class="legend-item" title="‰ª£Ë°®Á¨¨2Ê¨°ÁöÑÁ∂≠‰øÆÂñÆÂ∑≤Á∂≠‰øÆ">
                        <div class="legend-icon" style="background: #415a77; color: white; border-color: #415a77; border-radius: 3px;">
                            <span style="font-size: 0.75rem; font-weight: 700;">2</span>
                        </div>
                        <span>Â∑≤Á∂≠‰øÆ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon empty">‚úï</div>
                        <span>ÁÑ°Ê≠§Êà∂</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #d999b9; color: white; border-color: #d999b9; border-radius: 50%; width: 20px; height: 20px;">!</div>
                        <span>ÁâπÂà•ÂÇôË®ª</span>
                    </div>
                </div>
            </div>
            
            <!-- Construction Team Info -->
            <div class="construction-team-info" id="constructionTeamInfo">
                <button class="team-info-toggle" onclick="toggleTeamInfo()">Â∑•Áè≠Ë≥áË®ä</button>
                <div class="team-info-content">
                    <div style="padding: 1rem 1.5rem; background: #fffbeb;">
                        <div class="legend-group" style="background: transparent; padding: 0;">
                            <span class="legend-title">Â∑•Áè≠Ôºö</span>
                            <div class="legend-item" id="legendTeams">
                                <!-- ÂãïÊÖãÁîüÊàêÂ∑•Áè≠Âúñ‰æã -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="floor-grid-container">
                <div id="gridContent" class="loading">
                    ËºâÂÖ•‰∏≠...
                </div>
            </div>
        </div>
    </div>

    <!-- Site Details Modal -->
    <div class="modal-overlay" id="siteModal">
        <div class="modal-container">
            <!-- Compact Header -->
            <div class="modal-header">
                <div class="header-info">
                    <div class="site-basic-info">
                        <div class="info-item">
                            <span class="info-label">Ê£üÂà•</span>
                            <span class="info-value" id="modalBuilding">-</span>
                        </div>
                        <div class="divider"></div>
                        <div class="info-item">
                            <span class="info-label">Ê®ìÂ±§</span>
                            <span class="info-value" id="modalFloor">-</span>
                        </div>
                        <div class="divider"></div>
                        <div class="info-item">
                            <span class="info-label">Êà∂Âà•</span>
                            <span class="info-value" id="modalUnit">-</span>
                        </div>
                        <div class="divider"></div>
                        <div class="info-item">
                            <span class="info-label">Â∑•Áè≠</span>
                            <span class="info-value" id="modalTeam">-</span>
                        </div>
                    </div>
                </div>
                <div class="modal-header-actions">
                    <button class="modal-share-btn" onclick="shareLink()">ÂàÜ‰∫´</button>
                    <button class="modal-close" onclick="closeModal()">√ó</button>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <!-- Âπ≥Èù¢ÂúñÂíåÊñΩÂ∑•ÂâçÁÖßÁâá - ‰∏ÄÊéíÂÖ©Âàó -->
                <div class="all-media-compact" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <!-- Âπ≥Èù¢Âúñ -->
                    <div class="media-container">
                        <div class="media-header">
                            <span class="section-icon">üìê</span>
                            <span class="section-title">Âπ≥Èù¢Âúñ</span>
                        </div>
                        <div class="photos-wrapper" id="floorPlanPhotos">
                            <div class="photo-box add-photo" onclick="uploadPhoto('floorPlan')">
                                <div style="font-size: 1.5rem; color: #9ca3af;">+</div>
                            </div>
                        </div>
                    </div>

                    <!-- ÊñΩÂ∑•ÂâçÁÖßÁâá -->
                    <div class="media-container">
                        <div class="media-header">
                            <span class="section-icon">üì∑</span>
                            <span class="section-title">ÊñΩÂ∑•ÂâçÁÖßÁâá</span>
                        </div>
                        <div class="photos-wrapper" id="beforePhotos">
                            <div class="photo-box add-photo" onclick="uploadPhoto('before')">
                                <div style="font-size: 1.5rem; color: #9ca3af;">+</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÊñΩÂ∑•ÂâçÂÇôË®ª - ÂèØÊî∂Âêà -->
                <div class="before-construction-section collapsed" id="notesSection">
                    <div class="notes-header" onclick="toggleNotes()">
                        <div class="section-title" style="margin: 0;">
                            <span>üìù</span>
                            <span>ÊñΩÂ∑•ÂâçÁâπÂà•ÂÇôË®ª</span>
                        </div>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="notes-content">
                        <textarea class="notes-input" id="notesInput" placeholder="Ë´ãËº∏ÂÖ•ÊñΩÂ∑•ÂâçÁöÑÁâπÂà•Ê≥®ÊÑè‰∫ãÈ†Ö..." onchange="checkNotesValue()"></textarea>
                    </div>
                </div>

                <!-- ÊñΩÂ∑•ÂÆåÊàê - ÈáçË¶ÅÂçÄÂ°ä -->
                <div class="completion-section">
                    <div class="completion-checkbox">
                        <input type="checkbox" id="completionCheck" onchange="handleCompletionChange()">
                        <label class="completion-label" for="completionCheck">
                            ÊñΩÂ∑•ÂÆåÊàê
                            <span class="worker-name" id="workerName"></span>
                        </label>
                    </div>
                    <div class="completion-fields" id="completionFields">
                        <div class="field-group">
                            <label class="field-label">Èã™Ë®≠Âù™Êï∏</label>
                            <input type="number" class="field-input" id="areaInput" placeholder="15.5" step="0.1">
                        </div>
                        <div class="field-group">
                            <label class="field-label">Â∏´ÂÇÖ</label>
                            <input type="text" class="field-input" id="workerInput" readonly style="background: #f3f4f6;">
                        </div>
                    </div>
                    <div class="completion-fields" id="completionFields2" style="margin-top: 0.75rem;">
                        <div class="field-group" style="grid-column: span 2;">
                            <label class="field-label">ÊñΩÂ∑•Êó•Êúü</label>
                            <input type="date" class="field-input" id="dateInput">
                        </div>
                    </div>
                    
                    <!-- ÂÆåÂ∑•ÁÖßÁâá - ÁßªÂà∞ÊñΩÂ∑•ÂÆåÊàêÂçÄÂ°äÂÖß -->
                    <div class="completion-fields" id="completionPhotos" style="margin-top: 1rem; opacity: 0.5; pointer-events: none; transition: all 0.3s ease;">
                        <div class="media-container" style="grid-column: span 2;">
                            <div class="media-header">
                                <span class="section-icon">‚úÖ</span>
                                <span class="section-title">ÂÆåÂ∑•ÁÖßÁâá</span>
                            </div>
                            <div class="photos-wrapper" id="afterPhotos">
                                <div class="photo-box add-photo" onclick="uploadPhoto('after')">
                                    <div style="font-size: 1.5rem; color: #9ca3af;">+</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Êèê‰∫§ÂçÄ -->
            <div class="submit-section">
                <button class="btn-cancel" onclick="closeModal()">ÂèñÊ∂à</button>
                <button class="btn-submit" onclick="submitForm()">Êèê‰∫§</button>
            </div>
        </div>
    </div>

    <!-- Lightbox for images -->
    <div id="lightbox" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; cursor: zoom-out;" onclick="closeLightbox()">
        <img id="lightboxImg" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%; object-fit: contain;">
    </div>
    
    <!-- Team Management Modal -->
    <div id="teamModal" class="team-modal">
        <div class="team-modal-content">
            <div class="team-modal-header">
                <h2 class="team-modal-title" id="teamModalTitle">Â∑•Áè≠ÊàêÂì°ÁÆ°ÁêÜ</h2>
                <button class="team-modal-close" onclick="closeTeamModal()">‚úï</button>
            </div>
            <div class="team-modal-body">
                <div class="team-members-list" id="teamMembersList">
                    <!-- Members will be loaded here -->
                </div>
                <div style="margin-top: 1rem;">
                    <button class="add-member-btn" onclick="showAddMemberForm()" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #3b82f6, #10b981); color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                        + Êñ∞Â¢ûÊàêÂì°
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Member Modal -->
    <div id="addMemberModal" class="team-modal" style="display: none;">
        <div class="team-modal-content" style="max-width: 700px;">
            <div class="team-modal-header">
                <h2 class="team-modal-title">
                    <span id="addMemberTitle">Êñ∞Â¢ûÊàêÂì°</span>
                    <span id="addMemberTeamName" style="color: #3b82f6; font-size: 0.9rem; margin-left: 0.5rem;"></span>
                </h2>
                <button class="team-modal-close" onclick="closeAddMemberModal()">‚úï</button>
            </div>
            <div class="team-modal-body">
                <!-- Loading indicator -->
                <div id="memberModalLoading" style="display: none; text-align: center; padding: 2rem; color: #6b7280;">
                    <div style="display: inline-block; width: 32px; height: 32px; border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <div style="margin-top: 1rem;">ËºâÂÖ•‰∏≠...</div>
                </div>
                
                <!-- Tab selection for existing/new member -->
                <div id="memberModalContent" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb;">
                    <button id="existingMemberTab" onclick="switchMemberTab('existing')" 
                            style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid #3b82f6; color: #3b82f6; cursor: pointer; font-weight: 600;">
                        ÈÅ∏ÊìáÁèæÊúâÂ∏´ÂÇÖ
                    </button>
                    <button id="newMemberTab" onclick="switchMemberTab('new')" 
                            style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; cursor: pointer; font-weight: 600;">
                        Âª∫Á´ãÊñ∞Â∏´ÂÇÖ
                    </button>
                </div>
                
                    <!-- Existing member selection -->
                    <div id="existingMemberSection">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ÊêúÂ∞ãÂ∏´ÂÇÖ</label>
                            <input type="text" id="workerSearchInput" placeholder="Ëº∏ÂÖ•ÂßìÂêçÊàñÈõªË©±ÊêúÂ∞ã..." 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;"
                                   onkeyup="searchWorkers()">
                        </div>
                        <div id="workersList" style="max-height: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.5rem;">
                            <div style="text-align: center; color: #9ca3af; padding: 2rem;">ËºâÂÖ•‰∏≠...</div>
                        </div>
                    </div>
                    
                    <!-- New member form -->
                    <div id="newMemberSection" style="display: none;">
                        <div style="display: grid; gap: 1rem;">
                            <!-- ËßíËâ≤ÈÅ∏Êìá -->
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                                <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: #374151;">Ë®≠ÂÆöËßíËâ≤</label>
                                <div style="display: flex; gap: 1rem;">
                                    <label style="flex: 1; display: flex; align-items: center; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" 
                                           id="memberRoleLabel"
                                           onclick="selectRole('team_member')">
                                        <input type="radio" id="roleMember" name="memberRole" value="team_member" checked style="margin-right: 0.5rem;">
                                        <span style="flex: 1;">
                                            <strong style="color: #1f2937;">‰∏ÄËà¨ÊàêÂì°</strong>
                                            <div style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem;">ÂèØÊü•ÁúãÂèäÊõ¥Êñ∞Ê°àÂ†¥Ë≥áÊñô</div>
                                        </span>
                                    </label>
                                    <label style="flex: 1; display: flex; align-items: center; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                                           id="leaderRoleLabel"
                                           onclick="selectRole('team_leader')">
                                        <input type="radio" id="roleLeader" name="memberRole" value="team_leader" style="margin-right: 0.5rem;">
                                        <span style="flex: 1;">
                                            <strong style="color: #1f2937;">Ë≤†Ë≤¨‰∫∫</strong>
                                            <div style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem;">ÂèØÁÆ°ÁêÜÂ∑•Áè≠ÊàêÂì°ÂèäÊ°àÂ†¥</div>
                                        </span>
                                    </label>
                                </div>
                            </div>
                            <!-- ÈõªË©±/Â∏≥Ëôü Âíå ÂØÜÁ¢º Âú®Âêå‰∏ÄË°å -->
                            <div style="display: flex; gap: 1rem;">
                                <div style="flex: 2;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ÈõªË©±/Â∏≥Ëôü <span style="color: red;">*</span></label>
                                    <input type="tel" id="newMemberPhone" placeholder="Ëº∏ÂÖ•ÊâãÊ©üËôüÁ¢º" 
                                           onblur="checkDuplicatePhone()"
                                           oninput="updatePasswordDisplay()"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ÂØÜÁ¢º</label>
                                    <input type="text" id="memberPassword" readonly 
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f3f4f6;">
                                </div>
                            </div>
                            <!-- ÂßìÂêç Âíå Á∞°Á®± Âú®Âêå‰∏ÄË°å -->
                            <div style="display: flex; gap: 1rem;">
                                <div style="flex: 2;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ÂßìÂêç <span style="color: red;">*</span></label>
                                    <input type="text" id="newMemberName" placeholder="Ëº∏ÂÖ•Â∏´ÂÇÖÂßìÂêç" 
                                           oninput="updateAbbreviation()"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Á∞°Á®± <span style="color: red;">*</span></label>
                                    <input type="text" id="newMemberAbbreviation" placeholder="Ëá™ÂãïÂ°´ÂÖ•" maxlength="2"
                                           style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                </div>
                            </div>
                            <!-- ÈáçË§áÊèêÁ§∫ÂçÄÂüü -->
                            <div id="duplicateWarning" style="display: none; padding: 1rem; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px;">
                                <p style="color: #92400e; font-weight: 600; margin: 0 0 0.5rem 0;">
                                    Ê≠§ÈõªË©±ËôüÁ¢ºÂ∑≤Â≠òÂú®ÔºÅ
                                </p>
                                <div id="existingWorkerInfo" style="color: #92400e; margin: 0;"></div>
                                <p style="color: #92400e; margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                    ÊåâÁ¢∫Ë™çÂ∞áÊääÊ≠§Â∏´ÂÇÖÂä†ÂÖ•Âà∞Áï∂ÂâçÂ∑•Áè≠„ÄÇ
                                </p>
                            </div>
                            <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; margin-top: 0.5rem;">
                                <p style="color: #92400e; font-size: 0.875rem; margin: 0;">
                                    <strong>ÊèêÁ§∫Ôºö</strong>Êñ∞Âª∫Â∏´ÂÇÖÂ∞áËá™ÂãïÂä†ÂÖ•Âà∞ object_50HJ8__c Â∑•Âú∞Â∏´Áà∂Ë≥áÊñôË°®Âíå users Ë°®‰∏≠Ôºå
                                    ‰∏¶Â∞áÊ≠§Â∑•Áè≠Ë≥áË®äÂØ´ÂÖ• shift_type_multi_select__c Ê¨Ñ‰Ωç„ÄÇ
                                </p>
                                
                                <!-- Duplicate phone warning -->
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button onclick="closeAddMemberModal()" style="padding: 0.5rem 1rem; margin-right: 0.5rem; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer;">ÂèñÊ∂à</button>
                        <button id="confirmAddMemberBtn" onclick="confirmAddMember()" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;" disabled>Á¢∫Ë™çÊñ∞Â¢û</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = CONFIG?.API?.CRM_API_URL || CONFIG?.API?.D1_REST_API_URL || 'https://fx-d1-rest-api.lai-jameslai.workers.dev';
        const WORKER_API_URL = CONFIG?.API?.WORKER_API_URL || 'https://construction-management-api.lai-jameslai.workers.dev';
        const API_TOKEN = CONFIG?.API?.CRM_API_TOKEN || CONFIG?.API?.REST_API_TOKEN || 'fx-crm-api-secret-2025';

        // Ê¨Ñ‰ΩçÂ∞çÊáâË°®
        const fieldMapping = {
            building: 'field_WD7k1__c',     // Ê£üÂà•
            floor: 'field_Q6Svh__c',         // Ê®ìÂ±§
            unit: 'field_XuJP2__c',          // Êà∂Âà•
            team: 'shift_time__c',           // Â∑•Áè≠
            area: 'field_B2gh1__c',          // Èã™Ë®≠Âù™Êï∏
            worker: 'field_u1wpv__c',        // Â∑•Áè≠Â∏´Áà∂
            date: 'field_23pFq__c',          // ÊñΩÂ∑•Êó•Êúü
            completed: 'construction_completed__c',  // ÊñΩÂ∑•ÂÆåÊàê
            beforeNotes: 'field_sF6fn__c',   // ÊñΩÂ∑•ÂâçÂÇôË®ª
            floorPlan: 'field_3T38o__c',     // Âπ≥Èù¢Âúñ
            beforePhotos: 'field_V3d91__c',  // ÊñΩÂ∑•ÂâçÁÖßÁâá
            afterPhotos: 'field_3Fqof__c',   // ÂÆåÂ∑•ÁÖßÁâá
            label: 'field_23Z5i__c',         // Ê®ôÁ±§
            stage: 'field_z9H6O__c',         // ÈöéÊÆµ
            siteArea: 'field_tXAko__c',      // Â∑•Âú∞Âù™Êï∏
            opportunityId: 'field_1P96q__c'  // ÂïÜÊ©üÈóúËÅØ
        };

        // Global variables
        let currentProject = null;
        let currentSites = [];
        let currentUser = null;
        let currentBuilding = 'A';
        let isDataLoading = true;
        let isTeamsReady = false;
        let currentSiteId = null;

        // Ë¶ñËßíÂàáÊèõÁõ∏ÈóúËÆäÈáè
        let allProjectUsers = []; // Â∞àÊ°à‰∏≠ÁöÑÊâÄÊúâÁî®Êà∂

        // Team name to ID mapping cache
        let teamNameToIdMap = {};
        let teamIdToNameMap = {};
        
        // Load team mappings from SupplierObj
        async function loadTeamMappings() {
            try {
                console.log('Loading team mappings from SupplierObj...');
                const response = await fetch(`${API_BASE_URL}/rest/SupplierObj?limit=500`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const suppliers = data.results || [];
                    
                    // Build mapping for teams (suppliers with "Â∑•Áè≠" or specific company names)
                    suppliers.forEach(supplier => {
                        const name = supplier.name;
                        const id = supplier._id;
                        
                        // Check if this is likely a team/construction company
                        if (name && (name.includes('Â∑•Áè≠') || name.includes('Â∏´ÂÇÖ') || 
                                     name.includes('ÊúâÈôêÂÖ¨Âè∏') || name.includes('‰ºÅÊ•≠'))) {
                            teamNameToIdMap[name] = id;
                            teamIdToNameMap[id] = name;
                        }
                    });
                    
                    console.log('Team mappings loaded:', Object.keys(teamNameToIdMap).length, 'teams');
                }
            } catch (error) {
                console.error('Failed to load team mappings:', error);
            }
        }
        
        // Helper function to get team ID from name
        function getTeamIdFromName(teamName) {
            return teamNameToIdMap[teamName] || teamName;
        }
        
        // Helper function to get team name from ID
        function getTeamNameFromId(teamId) {
            return teamIdToNameMap[teamId] || teamId;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Get project ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            const siteId = urlParams.get('site_id');
            const tabName = urlParams.get('tab') || 'spc';  // Default to 'spc' tab
            
            if (!projectId) {
                showError('Êú™Êèê‰æõÂ∞àÊ°à ID');
                return;
            }
            
            // IMPORTANT: Load team mappings FIRST before any other data
            console.log('ËºâÂÖ•Â∑•Áè≠Êò†Â∞Ñ...');
            await loadTeamMappings();
            console.log('Â∑•Áè≠Êò†Â∞ÑËºâÂÖ•ÂÆåÊàê:', Object.keys(teamNameToIdMap).length, 'ÂÄãÂ∑•Áè≠');

            // Initialize perspective switcher for admin
            await initializePerspectiveSwitcher(projectId);

            // Load user data
            await loadUserData();
            
            // Load project data (this will also load sites)
            await loadProject(projectId);
            
            // Load teams data after sites are loaded
            // This will be called after sites are processed
            // await loadProjectTeams(projectId); // Will be called from loadSites
            
            // If site_id is provided, open the modal
            if (siteId) {
                await openSiteModal(siteId);
            }

            // Setup event listeners
            setupEventListeners();
            
            // Switch to the tab specified in URL
            if (tabName && tabName !== 'spc') {
                // Find and click the corresponding tab
                const targetTab = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
                if (targetTab) {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    targetTab.classList.add('active');
                    handleTabSwitch(tabName);
                }
            }
        });

        // Load user data
        async function loadUserData() {
            // Try to get user from localStorage or session
            const userStr = localStorage.getItem('user');
            if (userStr) {
                currentUser = JSON.parse(userStr);
            } else {
                // Default user for testing
                currentUser = {
                    id: 'user_001',
                    name: 'ÁéãÂ∏´ÂÇÖ',
                    phone: '0912345678'
                };
            }
        }

        // Load teams for the project (combine site teams with user data)
        async function loadProjectTeams(projectId) {
            try {
                // Wait for sites to be loaded first
                if (!window.projectTeamsFromSites) {
                    console.log('Waiting for sites data...');
                    return;
                }
                
                // Get team members from users table
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/teams`, {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token') || 'dev-token'}`
                    }
                });
                
                if (!response.ok) {
                    console.error('Failed to load team members');
                    // Still display teams even if no members
                    displayTeamsWithSiteInfo();
                    return;
                }
                
                const data = await response.json();
                
                // Combine site team info with user data
                const combinedTeams = [];
                
                // Process teams from sites (now using team ID as key)
                window.projectTeamsFromSites.forEach((teamInfo, teamId) => {
                    // Find matching team from users data using team ID
                    const teamWithMembers = data.teams?.find(t => {
                        // Match by team ID
                        return t.id === teamId;
                    }) || {
                        id: teamId,
                        name: teamInfo.name,
                        members: [],
                        leaders: [],
                        memberCount: 0
                    };
                    
                    // Combine the data
                    combinedTeams.push({
                        ...teamWithMembers,
                        id: teamId,  // Use team ID
                        name: teamInfo.name || teamWithMembers.name || `Â∑•Áè≠ ${teamId}`,
                        siteCount: teamInfo.siteCount,
                        sites: teamInfo.sites
                    });
                });
                
                // Also include teams from users that might not have sites yet
                data.teams?.forEach(team => {
                    // Decode team name if it's URL encoded
                    let decodedTeamName = team.name;
                    try {
                        // Check if the name looks URL encoded
                        if (team.name && team.name.includes('%')) {
                            decodedTeamName = decodeURIComponent(team.name);
                        }
                    } catch (e) {
                        console.warn('Failed to decode team name:', team.name, e);
                    }
                    
                    // Check with both original and decoded name
                    if (!window.projectTeamsFromSites.has(team.name) && 
                        !window.projectTeamsFromSites.has(decodedTeamName)) {
                        combinedTeams.push({
                            ...team,
                            name: decodedTeamName, // Use decoded name
                            siteCount: 0,
                            sites: []
                        });
                    }
                });
                
                displayTeams(combinedTeams);
                window.projectTeams = combinedTeams;
                isTeamsReady = true;
                console.log('[DEBUG] Teams loaded and ready:', combinedTeams.length);
                
            } catch (error) {
                console.error('Error loading teams:', error);
                // Still display teams from sites even on error
                displayTeamsWithSiteInfo();
            }
        }
        
        // Display teams with site info only (fallback)
        function displayTeamsWithSiteInfo() {
            const teams = [];
            window.projectTeamsFromSites?.forEach((teamInfo, teamName) => {
                teams.push({
                    name: teamName,
                    siteCount: teamInfo.siteCount,
                    sites: teamInfo.sites,
                    members: [],
                    leaders: [],
                    memberCount: 0
                });
            });
            displayTeams(teams);
            window.projectTeams = teams;
        }
        
        // Display team icons
        function displayTeams(teams) {
            const legendTeams = document.getElementById('legendTeams');
            if (!legendTeams) return;
            
            legendTeams.innerHTML = '';
            
            if (!teams || teams.length === 0) {
                legendTeams.innerHTML = '<span style="color: #9ca3af;">Â∞öÁÑ°Â∑•Áè≠</span>';
                return;
            }
            
            // Check if mobile
            const isMobile = window.innerWidth <= 768;
            
            // Create wrapper for carousel on mobile
            if (isMobile) {
                const carouselWrapper = document.createElement('div');
                carouselWrapper.style.cssText = 'position: relative; overflow: hidden;';
                
                // Create carousel controls
                const prevBtn = document.createElement('button');
                prevBtn.innerHTML = '‚óÄ';
                prevBtn.style.cssText = `
                    position: absolute;
                    left: 0;
                    top: 50%;
                    transform: translateY(-50%);
                    background: rgba(255, 255, 255, 0.95);
                    border: 1px solid #e5e7eb;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    z-index: 10;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                
                const nextBtn = document.createElement('button');
                nextBtn.innerHTML = '‚ñ∂';
                nextBtn.style.cssText = `
                    position: absolute;
                    right: 0;
                    top: 50%;
                    transform: translateY(-50%);
                    background: rgba(255, 255, 255, 0.95);
                    border: 1px solid #e5e7eb;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    z-index: 10;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                
                // Create scrollable container
                const scrollContainer = document.createElement('div');
                scrollContainer.style.cssText = `
                    overflow-x: auto;
                    overflow-y: hidden;
                    scroll-behavior: smooth;
                    padding: 5px 40px;
                    -webkit-overflow-scrolling: touch;
                    scrollbar-width: none;
                    -ms-overflow-style: none;
                `;
                
                // Add CSS to hide scrollbar
                const style = document.createElement('style');
                style.textContent = `
                    #legendTeams ::-webkit-scrollbar {
                        display: none;
                    }
                    #legendTeams {
                        -ms-overflow-style: none;
                        scrollbar-width: none;
                    }
                `;
                if (!document.querySelector('style[data-carousel-style]')) {
                    style.setAttribute('data-carousel-style', 'true');
                    document.head.appendChild(style);
                }
                
                const teamsContainer = document.createElement('div');
                teamsContainer.style.cssText = 'display: flex; gap: 0.75rem; flex-wrap: nowrap; align-items: center;';
                teamsContainer.id = 'teamsCarousel';
                
                // Add scroll event handlers
                prevBtn.onclick = () => {
                    scrollContainer.scrollBy({ left: -200, behavior: 'smooth' });
                };
                
                nextBtn.onclick = () => {
                    scrollContainer.scrollBy({ left: 200, behavior: 'smooth' });
                };
                
                // Update button states based on scroll position
                const updateScrollButtons = () => {
                    const scrollLeft = scrollContainer.scrollLeft;
                    const scrollWidth = scrollContainer.scrollWidth;
                    const clientWidth = scrollContainer.clientWidth;
                    
                    prevBtn.style.opacity = scrollLeft <= 0 ? '0.3' : '1';
                    prevBtn.style.cursor = scrollLeft <= 0 ? 'not-allowed' : 'pointer';
                    
                    nextBtn.style.opacity = scrollLeft >= scrollWidth - clientWidth - 10 ? '0.3' : '1';
                    nextBtn.style.cursor = scrollLeft >= scrollWidth - clientWidth - 10 ? 'not-allowed' : 'pointer';
                };
                
                scrollContainer.addEventListener('scroll', updateScrollButtons);
                
                // Build carousel structure
                scrollContainer.appendChild(teamsContainer);
                carouselWrapper.appendChild(prevBtn);
                carouselWrapper.appendChild(nextBtn);
                carouselWrapper.appendChild(scrollContainer);
                
                legendTeams.appendChild(carouselWrapper);
                
                // Add scroll indicator
                const scrollIndicator = document.createElement('div');
                scrollIndicator.style.cssText = `
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    margin-top: 10px;
                    gap: 4px;
                `;
                
                // Calculate number of pages
                const updateScrollIndicator = () => {
                    const scrollWidth = scrollContainer.scrollWidth;
                    const clientWidth = scrollContainer.clientWidth;
                    const scrollLeft = scrollContainer.scrollLeft;
                    const numPages = Math.ceil(scrollWidth / clientWidth);
                    const currentPage = Math.floor((scrollLeft + clientWidth / 2) / clientWidth);
                    
                    scrollIndicator.innerHTML = '';
                    for (let i = 0; i < numPages; i++) {
                        const dot = document.createElement('span');
                        dot.style.cssText = `
                            width: ${i === currentPage ? '20px' : '6px'};
                            height: 6px;
                            border-radius: 3px;
                            background: ${i === currentPage ? '#84C7D0' : '#d1d5db'};
                            transition: all 0.3s;
                            cursor: pointer;
                        `;
                        dot.onclick = () => {
                            scrollContainer.scrollTo({ left: i * clientWidth, behavior: 'smooth' });
                        };
                        scrollIndicator.appendChild(dot);
                    }
                };
                
                scrollContainer.addEventListener('scroll', () => {
                    updateScrollButtons();
                    updateScrollIndicator();
                });
                
                legendTeams.appendChild(scrollIndicator);
                
                // Initial states
                setTimeout(() => {
                    updateScrollButtons();
                    updateScrollIndicator();
                }, 100);
            } else {
                // Desktop layout
                const teamsContainer = document.createElement('div');
                teamsContainer.style.cssText = 'display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;';
                legendTeams.appendChild(teamsContainer);
            }
            
            // Get the container to add teams to
            const teamsContainer = isMobile ? 
                document.getElementById('teamsCarousel') : 
                legendTeams.querySelector('div');
            
            teams.forEach(team => {
                const teamButton = document.createElement('button');
                const buttonWidth = isMobile ? '160px' : '80px';
                teamButton.style.cssText = `
                    cursor: pointer; 
                    padding: 0.625rem 1rem; 
                    background: #84C7D0; 
                    color: white; 
                    border: none;
                    border-radius: 20px; 
                    font-weight: 600; 
                    font-size: 0.875rem;
                    display: inline-flex; 
                    align-items: center; 
                    gap: 0.5rem; 
                    transition: all 0.2s;
                    min-width: ${buttonWidth};
                    white-space: nowrap;
                    flex-shrink: 0;
                `;
                
                // Show full team name with site count badge
                const teamNameSpan = document.createElement('span');
                teamNameSpan.textContent = team.name || `Â∑•Áè≠ ${team.id}`;
                
                const countBadge = document.createElement('span');
                countBadge.style.cssText = `
                    background: #ef4444; 
                    color: white; 
                    border-radius: 12px; 
                    padding: 2px 8px; 
                    font-size: 0.75rem; 
                    min-width: 24px; 
                    text-align: center; 
                    display: inline-block;
                    font-weight: bold;
                `;
                countBadge.textContent = team.siteCount || 0;
                
                teamButton.appendChild(teamNameSpan);
                teamButton.appendChild(countBadge);
                
                // Tooltip shows both site count and member count
                const siteText = team.siteCount ? `${team.siteCount} ÂÄãÊ°àÂ†¥` : 'ÁÑ°Ê°àÂ†¥';
                const memberText = team.memberCount ? `${team.memberCount} ‰ΩçÊàêÂì°` : 'ÁÑ°ÊàêÂì°';
                teamButton.title = `${team.name}\n${siteText}\n${memberText}`;
                
                // Add hover effect
                teamButton.onmouseenter = () => {
                    teamButton.style.transform = 'scale(1.05)';
                    teamButton.style.boxShadow = '0 4px 12px rgba(132, 199, 208, 0.4)';
                    teamButton.style.background = '#6BB8C3';
                };
                teamButton.onmouseleave = () => {
                    teamButton.style.transform = 'scale(1)';
                    teamButton.style.boxShadow = 'none';
                    teamButton.style.background = '#84C7D0';
                };
                
                // Fix onclick event
                teamButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Team button clicked:', team.name);
                    showTeamModal(team);
                });
                
                teamsContainer.appendChild(teamButton);
            });
            
            legendTeams.appendChild(teamsContainer);
        }
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Re-render teams display on resize
                if (window.projectTeams && window.projectTeams.length > 0) {
                    displayTeams(window.projectTeams);
                }
            }, 250);
        });
        
        // Show team management modal
        function showTeamModal(team) {
            // Check if data is ready
            if (isDataLoading || !window.currentProject) {
                alert('Êï∏ÊìöËºâÂÖ•‰∏≠ÔºåË´ãÁ®çÂÄô...');
                return;
            }
            
            const modal = document.getElementById('teamModal');
            const title = document.getElementById('teamModalTitle');
            const membersList = document.getElementById('teamMembersList');
            
            // Update title with site count
            const siteInfo = team.siteCount ? `(${team.siteCount} ÂÄãÊ°àÂ†¥)` : '(ÁÑ°Ê°àÂ†¥)';
            title.innerHTML = `${team.name} ${siteInfo} - ÊàêÂì°ÁÆ°ÁêÜ`;
            window.currentTeam = team;
            
            // Display team info summary
            membersList.innerHTML = `
                <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: #6b7280;">Ê°àÂ†¥Êï∏ÈáèÔºö</span>
                        <span style="font-weight: 600;">${team.siteCount || 0} ÂÄã</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #6b7280;">ÊàêÂì°Êï∏ÈáèÔºö</span>
                        <span style="font-weight: 600;">${team.memberCount || 0} ‰∫∫</span>
                    </div>
                </div>
            `;
            
            // Get current user permissions
            const currentUserRole = getCurrentUserRole();
            const canEdit = currentUserRole === 'admin' || 
                           (currentUserRole === 'team_leader' && isCurrentUserTeamLeader(team));
            
            // Display team members (leaders first, then members)
            const leaders = team.leaders || [];
            const members = team.members || [];
            const allMembers = [...leaders.map(l => ({...l, role: 'team_leader'})), ...members];
            
            if (allMembers.length === 0) {
                membersList.innerHTML += '<div style="text-align: center; color: #9ca3af; padding: 2rem;">Â∞öÁÑ°ÊàêÂì°</div>';
            } else {
                allMembers.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'team-member-item';
                    memberItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 0.5rem;';
                    
                    // Role badge color and text
                    const roleBadge = member.role === 'team_leader' 
                        ? '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Ë≤†Ë≤¨‰∫∫</span>'
                        : '<span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">ÊàêÂì°</span>';
                    
                    memberItem.innerHTML = `
                        <div class="team-member-info" style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-weight: 600; color: #1f2937;">${member.name || member.abbreviation || 'Êú™Áü•'}</span>
                                ${roleBadge}
                            </div>
                            <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">${member.phone}</div>
                            ${member.abbreviation ? `<div style="color: #9ca3af; font-size: 0.75rem;">Á∞°Á®±: ${member.abbreviation}</div>` : ''}
                        </div>
                        ${canEdit ? `
                        <div class="team-member-actions" style="display: flex; gap: 0.5rem;">
                            <button class="team-action-btn" onclick="editMember('${member.userId || member.id}', ${JSON.stringify(member).replace(/"/g, '&quot;')})" 
                                    style="padding: 0.5rem; background: #f3f4f6; border: none; border-radius: 4px; cursor: pointer;" 
                                    title="Á∑®ËºØ">
                                ‚úèÔ∏è
                            </button>
                            <button class="team-action-btn delete" onclick="deleteMember('${member.userId || member.id}', '${member.name}')" 
                                    style="padding: 0.5rem; background: #fee2e2; border: none; border-radius: 4px; cursor: pointer;" 
                                    title="Âà™Èô§">
                                üóëÔ∏è
                            </button>
                        </div>
                        ` : ''}
                    `;
                    membersList.appendChild(memberItem);
                });
            }
            
            modal.classList.add('active');
        }
        
        // Close team modal
        function closeTeamModal() {
            document.getElementById('teamModal').classList.remove('active');
        }
        
        // Get current user role (mock for now, should be from session)
        function getCurrentUserRole() {
            // TODO: Get from actual session/auth
            return 'admin'; // Default to admin for testing
        }
        
        // Check if current user is team leader of this team
        function isCurrentUserTeamLeader(team) {
            // TODO: Check if current user is in team.leaders
            const currentUserId = sessionStorage.getItem('userId');
            return team.leaders?.some(leader => leader.userId === currentUserId);
        }
        
        // Edit team member
        function editMember(userId, memberData) {
            // Parse member data if it's a string
            if (typeof memberData === 'string') {
                try {
                    memberData = JSON.parse(memberData);
                } catch (e) {
                    console.error('Failed to parse member data:', e);
                    return;
                }
            }
            
            // Show edit modal
            showEditMemberModal(userId, memberData);
        }
        
        // Show edit member modal
        function showEditMemberModal(userId, memberData) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('editMemberModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'editMemberModal';
                modal.className = 'team-modal';
                modal.innerHTML = `
                    <div class="team-modal-content" style="max-width: 500px;">
                        <div class="team-modal-header">
                            <h2 class="team-modal-title">Á∑®ËºØÊàêÂì°Ë≥áÊñô</h2>
                            <button class="team-modal-close" onclick="closeEditMemberModal()">‚úï</button>
                        </div>
                        <div class="team-modal-body" id="editMemberForm">
                            <!-- Form will be populated here -->
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Populate form
            const formContainer = document.getElementById('editMemberForm');
            formContainer.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ÂßìÂêç</label>
                        <input type="text" id="editMemberName" value="${memberData.name || ''}" 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ÈõªË©± (‰∏çÂèØÁ∑®ËºØ)</label>
                        <input type="text" value="${memberData.phone || ''}" readonly
                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f3f4f6;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Á∞°Á®±</label>
                        <input type="text" id="editMemberAbbreviation" value="${memberData.abbreviation || ''}" 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ËßíËâ≤</label>
                        <select id="editMemberRole" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="team_member" ${memberData.role !== 'team_leader' ? 'selected' : ''}>ÊàêÂì°</option>
                            <option value="team_leader" ${memberData.role === 'team_leader' ? 'selected' : ''}>Ë≤†Ë≤¨‰∫∫</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; text-align: right;">
                    <button onclick="closeEditMemberModal()" 
                            style="padding: 0.5rem 1rem; margin-right: 0.5rem; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer;">
                        ÂèñÊ∂à
                    </button>
                    <button onclick="saveEditMember('${userId}')" 
                            style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ÂÑ≤Â≠ò
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        // Close edit member modal
        function closeEditMemberModal() {
            const modal = document.getElementById('editMemberModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        // Save edited member data
        async function saveEditMember(userId) {
            const name = document.getElementById('editMemberName').value.trim();
            const abbreviation = document.getElementById('editMemberAbbreviation').value.trim();
            const role = document.getElementById('editMemberRole').value;
            
            if (!name) {
                alert('Ë´ãËº∏ÂÖ•ÂßìÂêç');
                return;
            }
            
            const projectId = window.currentProject?.id;
            const teamId = window.currentTeam?.id || window.currentTeam?.name;
            
            if (!projectId || !teamId) {
                alert('ÁÑ°Ê≥ïÂèñÂæóÂ∞àÊ°àÊàñÂ∑•Áè≠Ë≥áË®ä');
                return;
            }
            
            try {
                // Update member data
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/teams/${teamId}/members/${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('token') || 'dev-token'}`
                    },
                    body: JSON.stringify({
                        name,
                        abbreviation,
                        role
                    })
                });
                
                if (response.ok) {
                    alert('ÊàêÂì°Ë≥áÊñôÂ∑≤Êõ¥Êñ∞');
                    closeEditMemberModal();
                    // Reload team data
                    await loadProjectTeams(projectId);
                    // Refresh modal
                    const updatedTeam = window.projectTeams?.find(t => 
                        t.id === teamId || t.name === teamId
                    );
                    if (updatedTeam) {
                        showTeamModal(updatedTeam);
                    }
                } else {
                    const error = await response.json();
                    alert('Êõ¥Êñ∞Â§±Êïó: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating member:', error);
                alert('Êõ¥Êñ∞Â§±Êïó: ' + error.message);
            }
        }
        
        // Delete team member
        async function deleteMember(userId, memberName) {
            if (!confirm(`Á¢∫ÂÆöË¶ÅÁßªÈô§ ${memberName || 'Ê≠§ÊàêÂì°'} ÂóéÔºü`)) return;
            
            const projectId = window.currentProject?.id;
            const teamId = window.currentTeam?.id || window.currentTeam?.name;
            
            if (!projectId || !teamId) {
                alert('ÁÑ°Ê≥ïÂèñÂæóÂ∞àÊ°àÊàñÂ∑•Áè≠Ë≥áË®ä');
                return;
            }
            
            // Check permissions
            const currentUserRole = getCurrentUserRole();
            if (currentUserRole !== 'admin' && 
                !(currentUserRole === 'team_leader' && isCurrentUserTeamLeader(window.currentTeam))) {
                alert('ÊÇ®Ê≤íÊúâÊ¨äÈôêÂü∑Ë°åÊ≠§Êìç‰Ωú');
                return;
            }
            
            try {
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/teams/${teamId}/members/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token') || 'dev-token'}`
                    }
                });
                
                if (response.ok) {
                    alert('ÊàêÂì°Â∑≤ÁßªÈô§');
                    // Reload team data
                    await loadProjectTeams(projectId);
                    // Refresh modal
                    const updatedTeam = window.projectTeams?.find(t => 
                        t.id === teamId || t.name === teamId
                    );
                    if (updatedTeam) {
                        showTeamModal(updatedTeam);
                    }
                } else {
                    const error = await response.json();
                    alert('ÁßªÈô§Â§±Êïó: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting member:', error);
                alert('ÁßªÈô§Â§±Êïó');
            }
        }
        
        // Show add member form
        let selectedWorker = null;
        let addMemberRole = 'team_member';
        let currentMemberTab = 'existing';
        
        // Function to select role in the modal
        function selectRole(role) {
            addMemberRole = role;
            
            // Update UI to show selected role
            const memberLabel = document.getElementById('memberRoleLabel');
            const leaderLabel = document.getElementById('leaderRoleLabel');
            const memberRadio = document.getElementById('roleMember');
            const leaderRadio = document.getElementById('roleLeader');
            
            if (!memberLabel || !leaderLabel) return;
            
            if (role === 'team_member') {
                memberLabel.style.borderColor = '#3b82f6';
                memberLabel.style.background = 'rgba(59, 130, 246, 0.05)';
                leaderLabel.style.borderColor = '#e5e7eb';
                leaderLabel.style.background = 'transparent';
                if (memberRadio) memberRadio.checked = true;
                if (leaderRadio) leaderRadio.checked = false;
            } else {
                leaderLabel.style.borderColor = '#10b981';
                leaderLabel.style.background = 'rgba(16, 185, 129, 0.05)';
                memberLabel.style.borderColor = '#e5e7eb';
                memberLabel.style.background = 'transparent';
                if (leaderRadio) leaderRadio.checked = true;
                if (memberRadio) memberRadio.checked = false;
            }
        }
        
        async function showAddMemberForm(role) {
            // Check if data is still loading
            if (isDataLoading || !isTeamsReady) {
                alert('ÁÑ°Ê≥ïÂèñÂæóÂ∞àÊ°àÊàñÂ∑•Áè≠Ë≥áË®äÔºåË´ãÁ®çÂÄôÂÜçË©¶');
                console.error('Data still loading:', {
                    isDataLoading,
                    isTeamsReady,
                    currentProject: window.currentProject,
                    currentTeam: window.currentTeam
                });
                return;
            }
            
            // Validate that we have required data
            if (!window.currentProject || !window.currentTeam) {
                alert('ÁÑ°Ê≥ïÂèñÂæóÂ∞àÊ°àÊàñÂ∑•Áè≠Ë≥áË®äÔºåË´ãÁ®çÂÄôÂÜçË©¶');
                console.error('Missing required data:', {
                    currentProject: window.currentProject,
                    currentTeam: window.currentTeam
                });
                return;
            }
            
            // If no role specified, default to team_member
            if (!role) {
                addMemberRole = 'team_member';
            } else {
                addMemberRole = role;
            }
            
            // Initialize role selection UI
            selectRole(addMemberRole);
            
            const modal = document.getElementById('addMemberModal');
            const title = document.getElementById('addMemberTitle');
            const teamNameSpan = document.getElementById('addMemberTeamName');
            
            // Update title - generic since role is selected in modal
            title.textContent = 'Êñ∞Â¢ûÂ∑•Áè≠ÊàêÂì°';
            
            // Show team name
            if (window.currentTeam) {
                teamNameSpan.textContent = `(${window.currentTeam.name || window.currentTeam.id})`;
            }
            
            // Reset to existing tab
            switchMemberTab('existing');
            
            // Show modal
            modal.style.display = 'block';
            modal.classList.add('active');
            
            // Load workers from object_50HJ8__c
            await loadWorkers();
        }
        
        // Switch between existing/new member tabs
        function switchMemberTab(tab) {
            currentMemberTab = tab;
            
            const existingTab = document.getElementById('existingMemberTab');
            const newTab = document.getElementById('newMemberTab');
            const existingSection = document.getElementById('existingMemberSection');
            const newSection = document.getElementById('newMemberSection');
            const confirmBtn = document.getElementById('confirmAddMemberBtn');
            
            if (tab === 'existing') {
                // Show existing member selection
                existingTab.style.borderBottom = '3px solid #3b82f6';
                existingTab.style.color = '#3b82f6';
                newTab.style.borderBottom = '3px solid transparent';
                newTab.style.color = '#6b7280';
                
                existingSection.style.display = 'block';
                newSection.style.display = 'none';
                
                // Show loading and load workers if needed
                if (!window.allWorkers || window.allWorkers.length === 0) {
                    showMemberModalLoading();
                    loadWorkers().then(() => {
                        hideMemberModalLoading();
                    }).catch(error => {
                        console.error('Failed to load workers:', error);
                        hideMemberModalLoading();
                    });
                } else {
                    hideMemberModalLoading();
                }
                
                // Enable confirm button only if a worker is selected
                confirmBtn.disabled = !selectedWorker;
            } else {
                // Show new member form
                existingTab.style.borderBottom = '3px solid transparent';
                existingTab.style.color = '#6b7280';
                newTab.style.borderBottom = '3px solid #3b82f6';
                newTab.style.color = '#3b82f6';
                
                existingSection.style.display = 'none';
                newSection.style.display = 'block';
                
                // Enable confirm button based on form validation
                validateNewMemberForm();
            }
        }
        
        // Validate new member form
        function validateNewMemberForm() {
            const name = document.getElementById('newMemberName').value.trim();
            const phone = document.getElementById('newMemberPhone').value.trim();
            const abbreviation = document.getElementById('newMemberAbbreviation').value.trim();
            const confirmBtn = document.getElementById('confirmAddMemberBtn');
            
            // Name and abbreviation are required
            confirmBtn.disabled = !(name && phone && abbreviation);
        }
        
        // Auto-update password display when phone number changes
        function updatePasswordDisplay() {
            const phone = document.getElementById('newMemberPhone').value;
            const passwordField = document.getElementById('memberPassword');
            if (phone.length >= 3) {
                passwordField.value = phone.slice(-3);
            } else {
                passwordField.value = '';
            }
        }
        
        // Auto-fill abbreviation from name's last character
        function updateAbbreviation() {
            const name = document.getElementById('newMemberName').value;
            const abbrField = document.getElementById('newMemberAbbreviation');
            if (name.length > 0 && !abbrField.value) {
                // Only auto-fill if abbreviation is empty
                abbrField.value = name.slice(-1);
            }
            validateNewMemberForm();
        }
        
        // Check for duplicate phone numbers
        async function checkDuplicatePhone() {
            const phone = document.getElementById('newMemberPhone').value.trim();
            const duplicateWarning = document.getElementById('duplicateWarning');
            const existingWorkerInfo = document.getElementById('existingWorkerInfo');
            
            if (!phone) {
                duplicateWarning.style.display = 'none';
                return;
            }
            
            try {
                // Check in object_50HJ8__c for existing workers
                const response = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c?phone_number__c=${encodeURIComponent(phone)}`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const existingWorkers = data.results || [];
                    
                    if (existingWorkers.length > 0) {
                        const existingWorker = existingWorkers[0];
                        
                        // Show duplicate warning
                        duplicateWarning.style.display = 'block';
                        existingWorkerInfo.innerHTML = `
                            <strong>ÁèæÊúâÂ∏´ÂÇÖË≥áÊñôÔºö</strong><br>
                            ÂßìÂêçÔºö${existingWorker.name || 'Êú™ÂëΩÂêç'}<br>
                            Á∞°Á®±Ôºö${existingWorker.abbreviation__c || 'ÁÑ°'}
                        `;
                        
                        // Auto-fill name and abbreviation with existing data
                        document.getElementById('newMemberName').value = existingWorker.name || '';
                        document.getElementById('newMemberAbbreviation').value = existingWorker.abbreviation__c || '';
                        
                        // Validate the form
                        validateNewMemberForm();
                    } else {
                        // No duplicate found
                        duplicateWarning.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error checking duplicate phone:', error);
                duplicateWarning.style.display = 'none';
            }
        }
        
        // Add event listeners for new member form
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('newMemberName');
            const phoneInput = document.getElementById('newMemberPhone');
            const abbrInput = document.getElementById('newMemberAbbreviation');
            
            if (nameInput) {
                nameInput.addEventListener('input', () => {
                    updateAbbreviation();
                    validateNewMemberForm();
                });
            }
            if (phoneInput) {
                phoneInput.addEventListener('input', () => {
                    updatePasswordDisplay();
                    validateNewMemberForm();
                });
                phoneInput.addEventListener('blur', checkDuplicatePhone);
            }
            if (abbrInput) {
                abbrInput.addEventListener('input', validateNewMemberForm);
            }
        });
        
        // Close add member modal
        function closeAddMemberModal() {
            const modal = document.getElementById('addMemberModal');
            modal.style.display = 'none';
            modal.classList.remove('active');
            selectedWorker = null;
            
            // Clear existing member search
            document.getElementById('workerSearchInput').value = '';
            
            // Clear new member form
            document.getElementById('newMemberName').value = '';
            document.getElementById('newMemberPhone').value = '';
            document.getElementById('newMemberAbbreviation').value = '';
            
            // Disable confirm button
            document.getElementById('confirmAddMemberBtn').disabled = true;
        }
        
        // Show loading indicator in member modal
        function showMemberModalLoading() {
            const loading = document.getElementById('memberModalLoading');
            const content = document.getElementById('memberModalContent');
            if (loading && content) {
                loading.style.display = 'block';
                content.style.display = 'none';
            }
        }
        
        // Hide loading indicator in member modal
        function hideMemberModalLoading() {
            const loading = document.getElementById('memberModalLoading');
            const content = document.getElementById('memberModalContent');
            if (loading && content) {
                loading.style.display = 'none';
                content.style.display = 'block';
            }
        }
        
        // Load workers from object_50HJ8__c
        async function loadWorkers() {
            const workersList = document.getElementById('workersList');
            workersList.innerHTML = ''; // Clear list while loading
            
            try {
                // Debug logging
                console.log('Loading workers from:', `${API_BASE_URL}/rest/object_50HJ8__c`);
                console.log('Using token:', API_TOKEN);
                
                const response = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c?limit=500`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`Failed to load workers: ${response.status} ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Workers data:', data);
                
                const workers = data.records || data || [];
                
                // If data structure is different, try to adapt
                if (Array.isArray(data)) {
                    displayWorkers(data);
                    window.allWorkers = data;
                } else if (data.results) {
                    displayWorkers(data.results);
                    window.allWorkers = data.results;
                } else if (data.records) {
                    displayWorkers(data.records);
                    window.allWorkers = data.records;
                } else {
                    console.warn('Unexpected data structure:', data);
                    displayWorkers([]);
                    window.allWorkers = [];
                }
                
            } catch (error) {
                console.error('Error loading workers:', error);
                workersList.innerHTML = `
                    <div style="text-align: center; color: #ef4444; padding: 2rem;">
                        <div>ËºâÂÖ•Â§±Êïó</div>
                        <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #6b7280;">
                            ${error.message}
                        </div>
                        <button onclick="loadWorkers()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ÈáçË©¶
                        </button>
                    </div>
                `;
            }
        }
        
        // Display workers list
        function displayWorkers(workers) {
            const workersList = document.getElementById('workersList');
            
            // Filter workers to only show those belonging to the current team
            let filteredWorkers = workers;
            if (window.currentTeam) {
                const currentTeamId = window.currentTeam.id;  // ‰ΩøÁî®Â∑•Áè≠ ID
                console.log('Filtering workers for team ID:', currentTeamId);
                
                filteredWorkers = workers.filter(worker => {
                    // Check if worker belongs to current team
                    let workerTeamIds = worker.shift_type_multi_select__c || [];
                    if (typeof workerTeamIds === 'string') {
                        try {
                            workerTeamIds = JSON.parse(workerTeamIds);
                        } catch {
                            workerTeamIds = [];
                        }
                    }
                    if (!Array.isArray(workerTeamIds)) {
                        workerTeamIds = [];
                    }
                    
                    // Ê™¢Êü•Â∑•Áè≠ ID ÊòØÂê¶Âú®Èô£Âàó‰∏≠
                    const belongsToTeam = workerTeamIds.includes(currentTeamId);
                    if (belongsToTeam) {
                        console.log(`Worker ${worker.name} belongs to team ${currentTeamId}`);
                    }
                    return belongsToTeam;
                });
            }
            
            if (filteredWorkers.length === 0) {
                workersList.innerHTML = '<div style="text-align: center; color: #9ca3af; padding: 2rem;">Ê≠§Â∑•Áè≠Â∞öÁÑ°ÂèØÈÅ∏ÊìáÁöÑÂ∏´ÂÇÖ</div>';
                return;
            }
            
            workersList.innerHTML = '';
            filteredWorkers.forEach(worker => {
                const workerItem = document.createElement('div');
                workerItem.style.cssText = `
                    padding: 0.75rem 1rem;
                    border-bottom: 1px solid #e5e7eb;
                    cursor: pointer;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    transition: background 0.2s;
                `;
                
                // Get teams the worker belongs to - use the resolved names
                let workerTeams = worker.shift_type_multi_select__c__r || [];
                if (typeof workerTeams === 'string') {
                    try {
                        workerTeams = JSON.parse(workerTeams);
                    } catch {
                        workerTeams = [];
                    }
                }
                if (!Array.isArray(workerTeams)) {
                    workerTeams = [];
                }
                
                // Extract team names from the resolved array
                const teamNames = workerTeams.map(team => 
                    typeof team === 'object' && team.name ? team.name : team
                ).filter(name => name);
                
                const teamsDisplay = teamNames.length > 0 
                    ? `<span style="color: #ef4444; font-size: 0.75rem;">(${teamNames.join(', ')})</span>`
                    : '';
                
                workerItem.innerHTML = `
                    <div>
                        <div style="font-weight: 500;">
                            ${worker.name || 'Êú™ÂëΩÂêç'} 
                            ${teamsDisplay}
                        </div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${worker.phone_number__c || worker.account__c || 'ÁÑ°ÈõªË©±'}</div>
                    </div>
                    <input type="radio" name="workerSelect" value="${worker._id}" style="cursor: pointer;">
                `;
                
                workerItem.onmouseenter = () => workerItem.style.background = '#f9fafb';
                workerItem.onmouseleave = () => workerItem.style.background = 'white';
                
                workerItem.onclick = () => {
                    // Clear previous selection
                    document.querySelectorAll('input[name="workerSelect"]').forEach(radio => radio.checked = false);
                    // Select this worker
                    workerItem.querySelector('input[type="radio"]').checked = true;
                    selectedWorker = worker;
                    document.getElementById('confirmAddMemberBtn').disabled = false;
                };
                
                workersList.appendChild(workerItem);
            });
        }
        
        // Search workers
        function searchWorkers() {
            const searchTerm = document.getElementById('workerSearchInput').value.toLowerCase();
            
            if (!window.allWorkers) return;
            
            const filtered = window.allWorkers.filter(worker => {
                const name = (worker.name || '').toLowerCase();
                const phone = (worker.phone_number__c || worker.account__c || '').toLowerCase();
                return name.includes(searchTerm) || phone.includes(searchTerm);
            });
            
            displayWorkers(filtered);
        }
        
        // Confirm add member
        async function confirmAddMember() {
            const projectId = window.currentProject?.id;
            const teamId = window.currentTeam?.id || window.currentTeam?.name;
            
            console.log('[DEBUG] confirmAddMember called');
            console.log('[DEBUG] Current project:', window.currentProject);
            console.log('[DEBUG] Current team:', window.currentTeam);
            console.log('[DEBUG] Project ID:', projectId);
            console.log('[DEBUG] Team ID:', teamId);
            console.log('[DEBUG] isDataLoading:', isDataLoading);
            console.log('[DEBUG] isTeamsReady:', isTeamsReady);
            
            if (!projectId) {
                alert('Â∞àÊ°àË≥áÊñôÂ∞öÊú™ËºâÂÖ•ÂÆåÊàêÔºåË´ãÁ®çÂÄôÂÜçË©¶');
                console.error('[ERROR] Missing project ID');
                return;
            }
            
            if (!teamId) {
                alert('ÁÑ°Ê≥ïÂèñÂæóÂ∑•Áè≠Ë≥áË®äÔºåË´ãÈáçÊñ∞ÈÅ∏ÊìáÂ∑•Áè≠');
                console.error('[ERROR] Missing team ID');
                return;
            }
            
            try {
                let memberData;
                let wasExisting = false;
                let workerName = '';
                
                if (currentMemberTab === 'existing') {
                    // Adding existing worker
                    if (!selectedWorker) return;
                    
                    memberData = {
                        userId: selectedWorker._id,
                        name: selectedWorker.name || 'Êú™ÂëΩÂêç',
                        phone: selectedWorker.phone_number__c || selectedWorker.account__c || '',
                        role: addMemberRole,
                        sourceType: 'crm_worker',
                        sourceId: selectedWorker._id,
                        createdBy: 'admin'
                    };
                    
                    workerName = selectedWorker.name || 'Â∏´ÂÇÖ';
                    
                    // Update shift_type_multi_select__c for existing worker
                    await updateWorkerTeamField(selectedWorker._id, teamId);
                    
                } else {
                    // Creating new worker
                    const name = document.getElementById('newMemberName').value.trim();
                    const phone = document.getElementById('newMemberPhone').value.trim();
                    const abbreviation = document.getElementById('newMemberAbbreviation').value.trim();
                    
                    if (!name || !phone) {
                        alert('Ë´ãÂ°´ÂØ´ÂøÖÂ°´Ê¨Ñ‰Ωç');
                        return;
                    }
                    
                    // First create worker in object_50HJ8__c (or update if exists)
                    const result = await createNewWorker(name, phone, abbreviation, teamId);
                    
                    if (!result) {
                        alert('Âª∫Á´ãÂ∏´ÂÇÖÂ§±Êïó');
                        return;
                    }
                    
                    const newWorkerId = result.id || result;
                    wasExisting = result.existing || false;
                    workerName = result.name || name;
                    
                    if (wasExisting) {
                        console.log('‰ΩøÁî®ÁèæÊúâÂ∏´ÂÇÖÔºåÂ∑≤Êõ¥Êñ∞ÂÖ∂Â∑•Áè≠Ë≥áË®ä');
                    }
                    
                    memberData = {
                        userId: newWorkerId,
                        name: name,
                        phone: phone,
                        role: addMemberRole,
                        sourceType: 'crm_worker',
                        sourceId: newWorkerId,
                        createdBy: 'admin'
                    };
                }
                
                // First check if member already exists in this team
                const checkExistingResponse = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/teams/${teamId}/members`, {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token') || 'dev-token'}`
                    }
                });
                
                if (checkExistingResponse.ok) {
                    const existingMembers = await checkExistingResponse.json();
                    const memberExists = existingMembers.some(member => 
                        member.userId === memberData.userId || 
                        member.phone === memberData.phone
                    );
                    
                    if (memberExists) {
                        alert(`${workerName || 'Ê≠§Â∏´ÂÇÖ'} Â∑≤Á∂ìÊòØÈÄôÂÄãÂ∑•Áè≠ÁöÑÊàêÂì°‰∫ÜÔºÅ`);
                        return;
                    }
                }
                
                // Add member to team
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/teams/${teamId}/members`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('token') || 'dev-token'}`
                    },
                    body: JSON.stringify(memberData)
                });
                
                if (response.ok) {
                    // Customize message based on whether it was a new or existing worker
                    let message;
                    if (currentMemberTab === 'new' && wasExisting) {
                        message = `${workerName} Â∑≤Âä†ÂÖ•Â∑•Áè≠ÔºÅ\n(Ë©≤ÈõªË©±ËôüÁ¢ºÂ∑≤Â≠òÂú®ÔºåÂ∑≤Êõ¥Êñ∞ÂÖ∂Â∑•Áè≠Ë≥áË®ä)`;
                    } else {
                        message = addMemberRole === 'team_leader' ? 'Ë≤†Ë≤¨‰∫∫Â∑≤Êñ∞Â¢û' : 'ÊàêÂì°Â∑≤Êñ∞Â¢û';
                    }
                    alert(message);
                    closeAddMemberModal();
                    // Reload team members
                    await loadProjectTeams(projectId);
                    // Refresh the modal
                    if (window.currentTeam) {
                        const updatedTeam = window.projectTeams?.find(t => t.id === teamId);
                        if (updatedTeam) {
                            showTeamModal(updatedTeam);
                        }
                    }
                } else {
                    const error = await response.json();
                    alert('Êñ∞Â¢ûÂ§±Êïó: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding member:', error);
                alert('Êñ∞Â¢ûÂ§±Êïó: ' + error.message);
            }
        }
        
        // Create new worker in object_50HJ8__c
        async function createNewWorker(name, phone, abbreviation, teamId) {
            try {
                // First check if a worker with this phone already exists
                console.log('Checking for existing worker with phone:', phone);
                
                const checkResponse = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c?phone_number__c=${encodeURIComponent(phone)}`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (checkResponse.ok) {
                    const checkData = await checkResponse.json();
                    const existingWorkers = checkData.results || [];
                    
                    if (existingWorkers.length > 0) {
                        // Worker with this phone already exists, just update their teams
                        const existingWorker = existingWorkers[0];
                        console.log('Found existing worker:', existingWorker.name, 'Phone:', existingWorker.phone_number__c);
                        
                        // Update the worker's team field in CRM
                        await updateWorkerTeamField(existingWorker._id, teamId);
                        
                        // Also update the user's teams in engineering management users table
                        try {
                            // First check if user exists
                            const checkUserResponse = await fetch(`${WORKER_API_URL}/api/v1/users/phone/${phone}`, {
                                headers: {
                                    'Authorization': `Bearer ${sessionStorage.getItem('token') || 'dev-token'}`
                                }
                            });
                            
                            if (checkUserResponse.ok) {
                                // User exists, update their teams
                                const existingUser = await checkUserResponse.json();
                                const updatedTeams = existingUser.teams || [];
                                if (!updatedTeams.includes(teamId)) {
                                    updatedTeams.push(teamId);
                                }
                                
                                const updateResponse = await fetch(`${WORKER_API_URL}/api/v1/users/${existingUser.id}`, {
                                    method: 'PATCH',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${sessionStorage.getItem('token') || 'dev-token'}`
                                    },
                                    body: JSON.stringify({ teams: updatedTeams })
                                });
                                
                                if (updateResponse.ok) {
                                    console.log('User teams updated in engineering management');
                                }
                            } else if (checkUserResponse.status === 404) {
                                // User doesn't exist in engineering management, create them
                                const password = phone.slice(-3);
                                const userData = {
                                    name: existingWorker.name,
                                    phone: phone,
                                    password: password,
                                    role: 'worker',
                                    teams: [teamId]
                                };
                                
                                const userResponse = await fetch(`${WORKER_API_URL}/api/v1/users`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${sessionStorage.getItem('token') || 'dev-token'}`
                                    },
                                    body: JSON.stringify(userData)
                                });
                                
                                if (userResponse.ok) {
                                    console.log('User created in engineering management for existing CRM worker');
                                }
                            }
                        } catch (userError) {
                            console.warn('Error updating/creating user in engineering management:', userError);
                            // Don't fail the whole operation
                        }
                        
                        // Return the existing worker info
                        return {
                            id: existingWorker._id,
                            existing: true,
                            name: existingWorker.name
                        };
                    }
                }
                
                // No existing worker, create new one
                const password = phone.slice(-3);
                
                // Generate a MongoDB ObjectId-like string for _id
                // Format: 8 hex chars (timestamp) + 16 hex chars (random)
                const timestamp = Math.floor(Date.now() / 1000).toString(16).padStart(8, '0');
                const randomHex = Array.from({length: 16}, () => Math.floor(Math.random() * 16).toString(16)).join('');
                const generatedId = timestamp + randomHex;
                
                const workerData = {
                    _id: generatedId,  // Add the generated ID
                    name: name,
                    phone_number__c: phone,
                    account__c: phone,
                    password__c: password,
                    abbreviation__c: abbreviation || name.slice(0, 1),
                    shift_type_multi_select__c: JSON.stringify([window.currentTeam?.id || teamId]), // Use team ID (not URL-encoded) for shift_type field as JSON string
                    record_type: 'default__c',
                    life_status: 'normal'
                };
                
                console.log('Creating new worker:', workerData);
                
                const response = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(workerData)
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    console.error('Failed to create worker:', error);
                    throw new Error('Failed to create worker');
                }
                
                const result = await response.json();
                console.log('Worker created:', result);
                
                // Also create user in engineering management users table
                try {
                    const userData = {
                        name: name,
                        phone: phone,
                        password: password,
                        role: 'worker',
                        teams: [teamId]
                    };
                    
                    const userResponse = await fetch(`${WORKER_API_URL}/api/v1/users`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionStorage.getItem('token') || 'dev-token'}`
                        },
                        body: JSON.stringify(userData)
                    });
                    
                    if (userResponse.ok) {
                        const userResult = await userResponse.json();
                        console.log('User also created in engineering management:', userResult);
                    } else {
                        console.warn('Failed to create user in engineering management, but worker was created in CRM');
                    }
                } catch (userError) {
                    console.warn('Error creating user in engineering management:', userError);
                    // Don't fail the whole operation if engineering management user creation fails
                }
                
                // Return the new worker ID
                return result._id || result.id || result.insertId;
                
            } catch (error) {
                console.error('Error creating worker:', error);
                return null;
            }
        }
        
        // Update worker's shift_type_multi_select__c to add team
        async function updateWorkerTeamField(workerId, teamId) {
            try {
                // First get existing worker data
                const getResponse = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c?_id=${workerId}`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                if (!getResponse.ok) {
                    console.error('Failed to get worker data');
                    return;
                }
                
                const data = await getResponse.json();
                const worker = data.results?.[0] || data[0];
                
                if (!worker) {
                    console.error('Worker not found');
                    return;
                }
                
                // Get existing teams or initialize empty array
                let existingTeams = worker.shift_type_multi_select__c || [];
                if (typeof existingTeams === 'string') {
                    try {
                        existingTeams = JSON.parse(existingTeams);
                    } catch {
                        existingTeams = [existingTeams];
                    }
                }
                if (!Array.isArray(existingTeams)) {
                    existingTeams = [];
                }
                
                // Use team ID for consistency (not URL-encoded, just the actual ID)
                const teamIdToUse = window.currentTeam?.id || teamId;
                
                // Add new team if not already present
                if (!existingTeams.includes(teamIdToUse)) {
                    existingTeams.push(teamIdToUse);
                }
                
                // Update worker with new team list
                const updateResponse = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c/${workerId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        shift_type_multi_select__c: JSON.stringify(existingTeams)
                    })
                });
                
                if (!updateResponse.ok) {
                    console.error('Failed to update worker team field');
                }
                
            } catch (error) {
                console.error('Error updating worker team field:', error);
            }
        }
        
        // Edit member (placeholder)
        function editMember(userId) {
            alert('Á∑®ËºØÊàêÂì°ÂäüËÉΩÈñãÁôº‰∏≠...');
            // TODO: Implement edit member form
        }

        // Load project data
        async function loadProject(projectId) {
            try {
                isDataLoading = true;
                console.log('[DEBUG] Starting project load:', projectId);
                // Fetch project data from engineering management API
                const response = await fetch(
                    `${CONFIG.API.WORKER_API_URL}/api/v1/projects/${projectId}`,
                    {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('[DEBUG] Project API response:', result);
                
                if (result.success && result.project) {
                    currentProject = result.project;
                    window.currentProject = result.project; // Save globally for team functions
                    console.log('[DEBUG] Project loaded successfully:', window.currentProject);
                    updateProjectInfo();
                    await loadSites();
                } else {
                    showError('Â∞àÊ°à‰∏çÂ≠òÂú®');
                }
            } catch (error) {
                console.error('Error loading project:', error);
                showError('ËºâÂÖ•Â∞àÊ°àÂ§±Êïó: ' + error.message);
            } finally {
                isDataLoading = false;
                console.log('[DEBUG] Project loading complete. isDataLoading:', isDataLoading);
            }
        }

        // Update project info in header
        function updateProjectInfo() {
            if (!currentProject) return;
            
            document.getElementById('projectName').textContent = currentProject.name || 'Êú™ÂëΩÂêçÂ∞àÊ°à';
            document.getElementById('projectDescription').textContent = 
                currentProject.field_tOYE1__c || 'Êö´ÁÑ°ÊèèËø∞'; // ÂÅáË®≠ÊúâÊèèËø∞Ê¨Ñ‰Ωç
        }

        // Load sites for the project
        async function loadSites() {
            try {
                // Ensure team mappings are loaded first
                if (Object.keys(teamNameToIdMap).length === 0) {
                    console.log('Â∑•Áè≠Êò†Â∞ÑÂ∞öÊú™ËºâÂÖ•ÔºåÂÖàËºâÂÖ•Êò†Â∞Ñ...');
                    await loadTeamMappings();
                }
                
                // Use opportunity_id to fetch related sites
                const opportunityId = currentProject.opportunity_id;
                
                if (!opportunityId) {
                    console.warn('No opportunity_id found for project');
                    showError('ÁÑ°Ê≥ïËºâÂÖ•Ê°àÂ†¥Ë≥áÊñôÔºöÁº∫Â∞ëÂïÜÊ©üÈóúËÅØ');
                    return;
                }
                
                console.log('[DEBUG] Loading sites for opportunity:', opportunityId);
                console.log('[DEBUG] Team mappings loaded:', Object.keys(teamNameToIdMap).length, 'ÂÄãÂ∑•Áè≠');
                
                // Show loading state
                const gridContent = document.getElementById('gridContent');
                gridContent.innerHTML = '<div class="loading">ËºâÂÖ•Ê°àÂ†¥Ë≥áÊñô‰∏≠...</div>';
                
                // Fetch sites data
                const response = await fetch(
                    `${API_BASE_URL}/rest/object_8W9cb__c?field_1P96q__c=${opportunityId}&limit=500`,
                    {
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to load sites');
                }

                const result = await response.json();
                // Handle both dataList and results format
                currentSites = result.dataList || result.results || [];
                
                // Process and display sites
                processSitesData();
                renderBuildingTabs();
                renderFloorGrid();
                updateStatistics();
                
                // Clear error state if successful
                gridContent.classList.remove('loading');
            } catch (error) {
                console.error('Error loading sites:', error);
                showError('ËºâÂÖ•Ê°àÂ†¥Ë≥áÊñôÂ§±Êïó');
            }
        }

        // Process sites data
        function processSitesData() {
            // Group sites by building
            const buildings = {};
            const teamsMap = new Map(); // Êî∂ÈõÜÊâÄÊúâÂ∑•Áè≠ÂèäÂÖ∂Ê°àÂ†¥Êï∏
            const buildingTeams = {}; // Ë®òÈåÑÊØèÂÄãÊ£üÂà•ÁöÑÂ∑•Áè≠
            
            currentSites.forEach(site => {
                const building = site[fieldMapping.building] || 'A';
                if (!buildings[building]) {
                    buildings[building] = [];
                    buildingTeams[building] = new Set(); // Ë®òÈåÑË©≤Ê£üÁöÑÂ∑•Áè≠
                }
                buildings[building].push(site);
                
                // Êî∂ÈõÜÂ∑•Áè≠Ë≥áË®äÂèäÁµ±Ë®àÊ°àÂ†¥Êï∏
                const teamNameFromSite = site[fieldMapping.team];  // shift_time__c ‰∏ÄÂÆöÂÑ≤Â≠òÂ∑•Áè≠ÂêçÁ®±
                
                if (teamNameFromSite && teamNameFromSite !== '-') {
                    // ÂæûÂêçÁ®±Áç≤ÂèñÂ∞çÊáâÁöÑÂ∑•Áè≠ ID
                    const teamId = teamNameToIdMap[teamNameFromSite];
                    
                    if (!teamId) {
                        console.warn(`Êâæ‰∏çÂà∞Â∑•Áè≠ "${teamNameFromSite}" ÁöÑ ID Êò†Â∞ÑÔºåË∑≥ÈÅéÊ≠§Â∑•Áè≠`);
                        // Âú® forEach ‰∏≠‰ΩøÁî® return Âè™ÊúÉË∑≥ÈÅéÁï∂ÂâçËø≠‰ª£Ôºå‰∏çÊòØÊï¥ÂÄãÂáΩÊï∏
                    } else {
                        // ‰ΩøÁî® teamId ‰ΩúÁÇ∫ÂîØ‰∏ÄÁöÑ key
                        if (!teamsMap.has(teamId)) {
                            teamsMap.set(teamId, {
                                id: teamId,
                                name: teamNameFromSite, // ‰ΩøÁî®ÂéüÂßãÂêçÁ®±
                                siteCount: 0,
                                sites: []
                            });
                        }
                        const teamData = teamsMap.get(teamId);
                        teamData.siteCount++;
                        teamData.sites.push(site._id);
                        
                        // Ë®òÈåÑÊ≠§Ê£üÂà•ÊúâÊ≠§Â∑•Áè≠Ôºà‰ΩøÁî® IDÔºâ
                        buildingTeams[building].add(teamId);
                    }
                }
            });
            
            // Store processed data
            window.sitesGroupedByBuilding = buildings;
            window.projectTeamsFromSites = teamsMap; // ÂÑ≤Â≠òÂæûÊ°àÂ†¥ÊèêÂèñÁöÑÂ∑•Áè≠Ë≥áË®ä
            window.buildingTeamsMap = buildingTeams; // ÂÑ≤Â≠òÊØèÂÄãÊ£üÂà•ÁöÑÂ∑•Áè≠ÂàóË°®
            
            // Ëá™ÂãïÈÅ∏ÊìáÁ¨¨‰∏ÄÂÄãÊúâË≥áÊñôÁöÑÊ£üÂà•‰ΩúÁÇ∫È†êË®≠
            const sortedBuildings = Object.keys(buildings).sort();
            if (sortedBuildings.length > 0) {
                currentBuilding = sortedBuildings[0];
            }
            
            // Êõ¥Êñ∞Â∑•Áè≠Âúñ‰æãÔºàÂÇ≥ÈÅûÂåÖÂê´Ê°àÂ†¥Êï∏ÁöÑÂ∑•Áè≠Ë≥áË®äÔºâ
            updateTeamLegend(teamsMap);
            
            // Now load team members from users table
            const projectId = new URLSearchParams(window.location.search).get('id');
            if (projectId) {
                loadProjectTeams(projectId);
            }
        }
        
        // Update team legend
        async function updateTeamLegend(teams) {
            const legendTeams = document.getElementById('legendTeams');
            if (!legendTeams) return;
            
            if (teams.size === 0) {
                legendTeams.innerHTML = '<span style="color: #9ca3af;">ÁÑ°Â∑•Áè≠Ë≥áÊñô</span>';
                return;
            }
            
            // Ê™¢Êü•Áï∂ÂâçÁî®Êà∂Ê¨äÈôê - ‰ΩøÁî®Áµ±‰∏ÄÊ¨äÈôêÁ≥ªÁµ±
            let isAdmin = false;
            let userTeams = new Set(); // Áî®Êà∂Ë≤†Ë≤¨ÁöÑÂ∑•Áè≠
            
            try {
                // ‰ΩøÁî®Áµ±‰∏ÄÊ¨äÈôêÁ≥ªÁµ±Ê™¢Êü•ÁÆ°ÁêÜÂì°Ê¨äÈôê
                if (window.permissions) {
                    await window.permissions.init();
                    isAdmin = await window.permissions.isAdmin();
                }
                
                // Â¶ÇÊûú‰∏çÊòØÁÆ°ÁêÜÂì°ÔºåÁç≤ÂèñÁî®Êà∂Ë≤†Ë≤¨ÁöÑÂ∑•Áè≠
                if (!isAdmin && currentProject) {
                    try {
                        const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${currentProject.id}/permissions`, {
                            headers: AuthUtils.getRequestHeaders()
                        });
                        
                        if (response.ok) {
                            const permissions = await response.json();
                            const currentUserPhone = AuthUtils.getUser()?.phone;
                            
                            // ÊâæÂà∞Áî®Êà∂Ë≤†Ë≤¨ÁöÑÂ∑•Áè≠
                            permissions.forEach(perm => {
                                if (perm.phone === currentUserPhone && perm.role === 'foreman') {
                                    // ÈÄöÈÅéÂ∑•Áè≠ API Áç≤ÂèñÂ∑•Áè≠ÂêçÁ®±
                                    userTeams.add(perm.name); // Êö´ÊôÇ‰ΩøÁî®Áî®Êà∂Âêç‰ΩúÁÇ∫Â∑•Áè≠Ê®ôË≠ò
                                }
                            });
                        }
                    } catch (error) {
                        console.log('Áç≤ÂèñÁî®Êà∂Â∑•Áè≠Â§±Êïó:', error);
                    }
                }
            } catch (error) {
                console.log('Ê¨äÈôêÊ™¢Êü•ÈåØË™§:', error);
            }
            
            let items = [];
            teams.forEach((abbr, name) => {
                // Ê™¢Êü•ÊòØÂê¶È°ØÁ§∫ÊàêÂì°ÁÆ°ÁêÜÊåâÈàï - ËÄÉÊÖÆÊ®°Êì¨Áî®Êà∂Ê¨äÈôê
                const currentPermissions = getCurrentUserPermissions();
                const showManageButton = currentPermissions.isAdmin || 
                                       (currentPermissions.can_manage_members && userTeams.has(name));
                
                items.push(`
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="team-icon">${abbr}</span>
                        <span>${name}</span>
                        ${showManageButton ? `
                            <button onclick="openTeamMemberManagement('${name}')" 
                                    style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; 
                                           background: #10b981; color: white; 
                                           border: none; border-radius: 4px; 
                                           font-size: 0.75rem; cursor: pointer;"
                                    title="ÁÆ°ÁêÜ ${name} ÊàêÂì°">
                                ÁÆ°ÁêÜÊàêÂì°
                            </button>
                        ` : ''}
                    </div>
                `);
            });
            
            // Â∞áÂ∑•Áè≠ÂàÜÈñãÈ°ØÁ§∫ÁÇ∫Â§öÂÄã legend-item
            legendTeams.innerHTML = items.map(item => `<div class="legend-item">${item}</div>`).join('');
        }
        
        // ÈñãÂïüÂ∑•Áè≠ÊàêÂì°ÁÆ°ÁêÜÈ†ÅÈù¢
        async function openTeamMemberManagement(teamName) {
            if (!currentProject) {
                alert('Â∞àÊ°àË≥áÊñôÂ∞öÊú™ËºâÂÖ•');
                return;
            }
            
            try {
                // Ê†πÊìöÂ∑•Áè≠ÂêçÁ®±Áç≤ÂèñÂ∑•Áè≠ID
                const { data: team } = await window.supabase
                    .from('teams')
                    .select('id')
                    .eq('project_id', currentProject.id)
                    .eq('name', teamName)
                    .single();
                
                if (team) {
                    // Â∞éÂêëÂ∑•Áè≠ÊàêÂì°ÁÆ°ÁêÜÈ†ÅÈù¢
                    window.location.href = `team-member-management.html?teamId=${team.id}&projectId=${currentProject.id}`;
                } else {
                    alert('Êâæ‰∏çÂà∞Â∑•Áè≠Ë≥áÊñô');
                }
            } catch (error) {
                console.error('ÈñãÂïüÊàêÂì°ÁÆ°ÁêÜÂ§±Êïó:', error);
                alert('ÈñãÂïüÊàêÂì°ÁÆ°ÁêÜÂ§±Êïó');
            }
        }

        // Render building tabs
        function renderBuildingTabs() {
            const tabsContainer = document.getElementById('buildingTabs');
            const buildings = Object.keys(window.sitesGroupedByBuilding || {}).sort();
            const buildingTeams = window.buildingTeamsMap || {};
            
            tabsContainer.innerHTML = buildings.map(building => {
                // ÂèñÂæóÊ≠§Ê£üÁöÑÂ∑•Áè≠ÂàóË°®
                const teams = buildingTeams[building] ? Array.from(buildingTeams[building]) : [];
                let teamDisplay = '';
                
                if (teams.length > 0) {
                    // ÂèñÊØèÂÄãÂ∑•Áè≠ÂêçÁ®±ÁöÑÁ¨¨‰∏ÄÂÄãÂ≠ó
                    const teamAbbrs = teams.map(team => {
                        // Â¶ÇÊûúÊòØÊï∏Â≠ó IDÔºåÈ°ØÁ§∫ "Â∑•Áè≠"ÔºõÂê¶ÂâáÈ°ØÁ§∫Á¨¨‰∏ÄÂÄãÂ≠ó
                        return isNaN(team) ? team.charAt(0) : 'Áè≠';
                    });
                    teamDisplay = ' | ' + teamAbbrs.join(' ');
                }
                
                return `
                    <button class="building-btn ${building === currentBuilding ? 'active' : ''}" 
                            data-building="${building}"
                            style="padding: 0.75rem 1.25rem;">
                        <span>${building}Ê£ü${teamDisplay}</span>
                    </button>
                `;
            }).join('');
        }

        // Render floor grid
        function renderFloorGrid() {
            const gridContent = document.getElementById('gridContent');
            
            // Show loading state immediately
            gridContent.style.opacity = '0.5';
            gridContent.style.pointerEvents = 'none';
            
            // Use requestAnimationFrame to ensure smooth transition
            requestAnimationFrame(() => {
                const sites = window.sitesGroupedByBuilding[currentBuilding] || [];
                
                if (sites.length === 0) {
                    gridContent.innerHTML = '<div class="error-message">Ê≠§Ê£üÂà•Êö´ÁÑ°Ê°àÂ†¥Ë≥áÊñô</div>';
                    gridContent.style.opacity = '1';
                    gridContent.style.pointerEvents = 'auto';
                    return;
                }

            // Group by floor and unit
            const floorMap = {};
            const units = new Set();
            
            sites.forEach(site => {
                const floor = site[fieldMapping.floor] || 0;
                const unit = site[fieldMapping.unit] || '';
                
                if (!floorMap[floor]) {
                    floorMap[floor] = {};
                }
                floorMap[floor][unit] = site;
                units.add(unit);
            });

            // Sort floors and units
            const sortedFloors = Object.keys(floorMap).sort((a, b) => b - a);
            const sortedUnits = Array.from(units).sort();

            // Generate table HTML
            let html = '<table class="floor-grid"><thead><tr><th></th>';
            sortedUnits.forEach(unit => {
                html += `<th>${unit}</th>`;
            });
            html += '</tr></thead><tbody>';

            sortedFloors.forEach(floor => {
                // Convert to integer for display
                const floorInt = Math.floor(parseFloat(floor));
                html += `<tr><th>${floorInt}F</th>`;
                sortedUnits.forEach(unit => {
                    const site = floorMap[floor][unit];
                    if (site) {
                        const isCompleted = site[fieldMapping.completed];
                        const team = site[fieldMapping.team] || '-';
                        const area = site[fieldMapping.area] || site[fieldMapping.siteArea] || '-';
                        const worker = site[fieldMapping.worker] || '';
                        const date = site[fieldMapping.date] || '';
                        
                        // Get team abbreviation (first character of team name if no abbreviation field exists)
                        const teamAbbr = site.team_abbreviation || (team && team !== '-' ? team.charAt(0) : team);
                        
                        // Get worker abbreviation (last character of name if abbreviation field is empty)
                        const workerAbbr = site.worker_abbreviation || (worker ? worker.charAt(worker.length - 1) : worker);
                        
                        html += `
                            <td class="grid-cell ${isCompleted ? 'completed' : ''}" 
                                onclick="openSiteModal('${site._id}')">
                                <div class="cell-content">
                                    ${isCompleted ? 
                                        `<div class="cell-line1">${date} | ${workerAbbr}</div>
                                         <div class="cell-line2">${area}Âù™<span class="cell-team">${teamAbbr}</span></div>` :
                                        `<div class="cell-line1">${area}Âù™<span class="cell-team">${teamAbbr}</span></div>`
                                    }
                                </div>
                            </td>
                        `;
                    } else {
                        html += '<td class="grid-cell no-unit"></td>';
                    }
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            
            // Update DOM and restore opacity
            gridContent.innerHTML = html;
            
            // Restore opacity after render
            requestAnimationFrame(() => {
                gridContent.style.opacity = '1';
                gridContent.style.pointerEvents = 'auto';
            });
        });
        }

        // Update statistics
        function updateStatistics() {
            const buildings = Object.keys(window.sitesGroupedByBuilding || {});
            const totalSites = currentSites.length;
            const completedSites = currentSites.filter(site => site[fieldMapping.completed]).length;
            const pendingSites = totalSites - completedSites;
            const completionRate = totalSites > 0 ? Math.round((completedSites / totalSites) * 100) : 0;
            
            // Update stat cards
            document.getElementById('statTotalSites').textContent = totalSites;
            document.getElementById('statCompleted').textContent = completedSites;
            document.getElementById('statPending').textContent = pendingSites;
            document.getElementById('statMaintenance').textContent = 0; // TODO: Get actual maintenance count
            
            // Store stats globally for later use
            window.projectStats = {
                buildingCount: buildings.length,
                unitCount: totalSites,
                completedCount: completedSites,
                pendingCount: pendingSites,
                completionRate: completionRate
            };
        }

        // Open site modal
        async function openSiteModal(siteId) {
            currentSiteId = siteId;
            
            // Find site data
            const site = currentSites.find(s => s._id === siteId);
            if (!site) {
                // Try to fetch from API
                await fetchSiteData(siteId);
                return;
            }
            
            // Update modal with site data
            updateModalWithSiteData(site);
            
            // Show modal
            const modal = document.getElementById('siteModal');
            modal.classList.add('active');
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('site_id', siteId);
            window.history.pushState({}, '', url);
        }

        // Fetch site data from API
        async function fetchSiteData(siteId) {
            try {
                const response = await fetch(
                    `${API_BASE_URL}/rest/object_8W9cb__c?_id=${siteId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch site data');
                }

                const result = await response.json();
                // Handle both dataList and results format
                const sites = result.dataList || result.results;
                if (sites && sites.length > 0) {
                    updateModalWithSiteData(sites[0]);
                    
                    // Show modal
                    const modal = document.getElementById('siteModal');
                    modal.classList.add('active');
                }
            } catch (error) {
                console.error('Error fetching site:', error);
                alert('ËºâÂÖ•Ê°àÂ†¥Ë≥áÊñôÂ§±Êïó');
            }
        }

        // Update modal with site data
        function updateModalWithSiteData(site) {
            // Basic info
            document.getElementById('modalBuilding').textContent = 
                (site[fieldMapping.building] || 'A') + 'Ê£ü';
            // Convert floor to integer for display
            const floor = Math.floor(parseFloat(site[fieldMapping.floor] || '1'));
            document.getElementById('modalFloor').textContent = floor + 'F';
            document.getElementById('modalUnit').textContent = 
                site[fieldMapping.unit] || '-';
            document.getElementById('modalTeam').textContent = 
                site[fieldMapping.team] || '-';
            
            // Notes
            const notes = site[fieldMapping.beforeNotes] || '';
            document.getElementById('notesInput').value = notes;
            checkNotesValue();
            
            // Completion status
            const isCompleted = site[fieldMapping.completed];
            const checkbox = document.getElementById('completionCheck');
            checkbox.checked = isCompleted;
            
            if (isCompleted) {
                document.getElementById('areaInput').value = site[fieldMapping.area] || '';
                document.getElementById('workerInput').value = site[fieldMapping.worker] || '';
                document.getElementById('dateInput').value = site[fieldMapping.date] || '';
                
                document.getElementById('completionFields').classList.add('active');
                document.getElementById('completionFields2').classList.add('active');
                document.getElementById('completionPhotos').classList.add('active');
                document.getElementById('completionPhotos').style.opacity = '1';
                document.getElementById('completionPhotos').style.pointerEvents = 'auto';
                document.getElementById('workerName').textContent = `- ${site[fieldMapping.worker] || ''}`;
            } else {
                // Êú™ÂÆåÊàêÊôÇÔºåÈ†êË®≠Â°´ÂÖ•‰ªäÂ§©Êó•Êúü„ÄÅÂ∑•Âú∞Âù™Êï∏ÂíåÁï∂ÂâçÁî®Êà∂
                document.getElementById('areaInput').value = site[fieldMapping.siteArea] || '';
                document.getElementById('workerInput').value = currentUser ? currentUser.name : '';
                setToday();
                
                document.getElementById('completionFields').classList.remove('active');
                document.getElementById('completionFields2').classList.remove('active');
                document.getElementById('completionPhotos').classList.remove('active');
                document.getElementById('completionPhotos').style.opacity = '0.5';
                document.getElementById('completionPhotos').style.pointerEvents = 'none';
                document.getElementById('workerName').textContent = '';
            }
            
            // Load photos if any
            loadExistingPhotos(site);
        }

        // Load existing photos
        function loadExistingPhotos(site) {
            // Clear existing photos (except add buttons)
            ['floorPlanPhotos', 'beforePhotos', 'afterPhotos'].forEach(containerId => {
                const container = document.getElementById(containerId);
                const addButton = container.querySelector('.add-photo');
                container.innerHTML = '';
                if (addButton) {
                    container.appendChild(addButton);
                }
            });
            
            // Load floor plan
            if (site[fieldMapping.floorPlan]) {
                addPhotoToContainer('floorPlanPhotos', site[fieldMapping.floorPlan]);
            }
            
            // Load before photos
            if (site[fieldMapping.beforePhotos]) {
                const photos = site[fieldMapping.beforePhotos].split(',');
                photos.forEach(photo => addPhotoToContainer('beforePhotos', photo));
            }
            
            // Load after photos
            if (site[fieldMapping.afterPhotos]) {
                const photos = site[fieldMapping.afterPhotos].split(',');
                photos.forEach(photo => addPhotoToContainer('afterPhotos', photo));
            }
        }

        // Add photo to container
        function addPhotoToContainer(containerId, photoUrl) {
            const container = document.getElementById(containerId);
            const photoBox = document.createElement('div');
            photoBox.className = 'photo-box has-image';
            
            const img = document.createElement('img');
            img.src = photoUrl;
            img.alt = 'ÁÖßÁâá';
            img.style.cursor = 'zoom-in';
            img.onclick = () => openLightbox(photoUrl);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'photo-remove-btn';
            removeBtn.innerHTML = '√ó';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removePhoto(removeBtn);
            };
            
            photoBox.appendChild(img);
            photoBox.appendChild(removeBtn);
            
            // Insert before add button
            const addButton = container.querySelector('.add-photo');
            if (addButton) {
                container.insertBefore(photoBox, addButton);
            } else {
                container.appendChild(photoBox);
            }
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('siteModal');
            modal.classList.remove('active');
            
            // Remove site_id from URL
            const url = new URL(window.location);
            url.searchParams.delete('site_id');
            window.history.pushState({}, '', url);
            
            currentSiteId = null;
        }

        // Handle completion checkbox change
        function handleCompletionChange() {
            const checkbox = document.getElementById('completionCheck');
            const fields = document.getElementById('completionFields');
            const fields2 = document.getElementById('completionFields2');
            const completionPhotos = document.getElementById('completionPhotos');
            const workerName = document.getElementById('workerName');
            const workerInput = document.getElementById('workerInput');
            
            // Don't toggle here - checkbox state is already changed by user click
            
            if (checkbox.checked) {
                fields.classList.add('active');
                fields2.classList.add('active');
                completionPhotos.classList.add('active');
                completionPhotos.style.opacity = '1';
                completionPhotos.style.pointerEvents = 'auto';
                
                // Auto-fill values
                if (!document.getElementById('dateInput').value) {
                    setToday();
                }
                
                // Auto-fill area from site data (Â∑•Âú∞Âù™Êï∏)
                if (currentSiteId && currentSites.length > 0) {
                    const site = currentSites.find(s => s._id === currentSiteId);
                    if (site && site[fieldMapping.siteArea]) {
                        document.getElementById('areaInput').value = site[fieldMapping.siteArea];
                    }
                }
                
                // Auto-fill worker name from current user
                if (currentUser && currentUser.name) {
                    workerInput.value = currentUser.name;
                    workerInput.setAttribute('value', currentUser.name);
                    // Show worker name in label
                    workerName.textContent = `- ${currentUser.name}`;
                }
                
                // Vibration feedback
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            } else {
                fields.classList.remove('active');
                fields2.classList.remove('active');
                completionPhotos.classList.remove('active');
                completionPhotos.style.opacity = '0.5';
                completionPhotos.style.pointerEvents = 'none';
                workerName.textContent = '';
                workerInput.value = '';
                workerInput.removeAttribute('value');
            }
        }

        // Set today's date
        function setToday() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('dateInput').value = `${yyyy}-${mm}-${dd}`;
        }

        // Toggle notes
        function toggleNotes() {
            const section = document.getElementById('notesSection');
            section.classList.toggle('collapsed');
        }

        // Check notes value
        function checkNotesValue() {
            const section = document.getElementById('notesSection');
            const input = document.getElementById('notesInput');
            
            if (input.value && input.value.trim() !== '') {
                section.classList.remove('collapsed');
            } else {
                section.classList.add('collapsed');
            }
        }

        // Upload photo
        function uploadPhoto(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = async (e) => {
                const files = e.target.files;
                
                for (let file of files) {
                    // Upload to R2
                    const photoUrl = await uploadToR2(file);
                    if (photoUrl) {
                        // Add to UI
                        let containerId;
                        switch(type) {
                            case 'floorPlan':
                                containerId = 'floorPlanPhotos';
                                break;
                            case 'before':
                                containerId = 'beforePhotos';
                                break;
                            case 'after':
                                containerId = 'afterPhotos';
                                break;
                        }
                        addPhotoToContainer(containerId, photoUrl);
                    }
                }
            };
            input.click();
        }

        // Upload to R2
        async function uploadToR2(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${WORKER_API_URL}/api/v1/files/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const result = await response.json();
                return result.url;
            } catch (error) {
                console.error('Upload error:', error);
                alert('‰∏äÂÇ≥Â§±Êïó');
                return null;
            }
        }

        // Remove photo
        function removePhoto(btn) {
            btn.parentElement.remove();
        }

        // Open lightbox
        function openLightbox(src) {
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightboxImg');
            img.src = src;
            lightbox.style.display = 'block';
        }

        // Close lightbox
        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
        }

        // Share link
        function shareLink() {
            const url = window.location.href;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÔºÅ\n' + url);
                });
            }
        }

        // Submit form
        async function submitForm() {
            if (!currentSiteId) return;
            
            const isCompleted = document.getElementById('completionCheck').checked;
            
            // Prepare update data
            const updateData = {
                [fieldMapping.beforeNotes]: document.getElementById('notesInput').value,
                [fieldMapping.completed]: isCompleted
            };
            
            if (isCompleted) {
                const area = document.getElementById('areaInput').value;
                const date = document.getElementById('dateInput').value;
                const worker = document.getElementById('workerInput').value;
                
                if (!area || !date) {
                    alert('Ë´ãÂ°´ÂØ´Èã™Ë®≠Âù™Êï∏ÂíåÊñΩÂ∑•Êó•ÊúüÔºÅ');
                    return;
                }
                
                updateData[fieldMapping.area] = area;
                updateData[fieldMapping.date] = date;
                updateData[fieldMapping.worker] = worker;
                
                // Update stage if completed
                updateData[fieldMapping.stage] = 'È©óÊî∂';
                updateData[fieldMapping.label] = 'Â∑≤ÂÆåÂ∑•';
            }
            
            // Collect photo URLs
            const floorPlanPhotos = collectPhotoUrls('floorPlanPhotos');
            const beforePhotos = collectPhotoUrls('beforePhotos');
            const afterPhotos = collectPhotoUrls('afterPhotos');
            
            if (floorPlanPhotos.length > 0) {
                updateData[fieldMapping.floorPlan] = floorPlanPhotos[0]; // Only one floor plan
            }
            if (beforePhotos.length > 0) {
                updateData[fieldMapping.beforePhotos] = beforePhotos.join(',');
            }
            if (afterPhotos.length > 0) {
                updateData[fieldMapping.afterPhotos] = afterPhotos.join(',');
            }
            
            try {
                // Update site data
                const response = await fetch(
                    `${API_BASE_URL}/rest/object_8W9cb__c/${currentSiteId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    }
                );
                
                if (!response.ok) {
                    throw new Error('Update failed');
                }
                
                // Vibration feedback
                if (navigator.vibrate) {
                    navigator.vibrate([50, 30, 50]);
                }
                
                alert('Êèê‰∫§ÊàêÂäüÔºÅ');
                
                // Reload sites to refresh grid
                await loadSites();
                
                // Close modal
                closeModal();
            } catch (error) {
                console.error('Submit error:', error);
                alert('Êèê‰∫§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶');
            }
        }

        // Collect photo URLs from container
        function collectPhotoUrls(containerId) {
            const container = document.getElementById(containerId);
            const images = container.querySelectorAll('.has-image img');
            return Array.from(images).map(img => img.src);
        }

        // Load progress announcements from database
        async function loadProgressAnnouncements() {
            const gridContent = document.getElementById('gridContent');
            
            // Show loading
            gridContent.innerHTML = `
                <div style="padding: 2rem; text-align: center;">
                    <div class="loading">ËºâÂÖ•ÈÄ≤Â∫¶ÂÖ¨Âëä‰∏≠...</div>
                </div>
            `;
            
            try {
                // Use opportunity_id to fetch related announcements
                const opportunityId = currentProject.opportunity_id;
                
                if (!opportunityId) {
                    console.warn('No opportunity_id found for project');
                    gridContent.innerHTML = `
                        <div style="padding: 2rem;">
                            <div style="background: #fee; color: #c00; padding: 1rem; border-radius: 8px;">
                                ÁÑ°Ê≥ïËºâÂÖ•ÈÄ≤Â∫¶ÂÖ¨ÂëäÔºöÁº∫Â∞ëÂïÜÊ©üÈóúËÅØ
                            </div>
                        </div>
                    `;
                    return;
                }
                
                console.log('[DEBUG] Loading announcements for opportunity:', opportunityId);
                
                // Fetch announcements from API
                const response = await fetch(
                    `${API_BASE_URL}/rest/progress_management_announ__c?field_RFr42__c=${opportunityId}&order_by=order_by&limit=50`,
                    {
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to load announcements');
                }

                const result = await response.json();
                const announcements = result.dataList || result.results || [];
                
                // Display announcements
                if (announcements.length > 0) {
                    let html = `
                        <div style="padding: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="color: var(--heading);">ÈÄ≤Â∫¶ÂÖ¨Âëä</h2>
                                <button onclick="addAnnouncement()" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Êñ∞Â¢ûÂÖ¨Âëä
                                </button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                    `;
                    
                    announcements.forEach(announcement => {
                        const content = announcement.announcement_content__c || 'ÁÑ°ÂÖßÂÆπ';
                        const createTime = announcement.create_time ? 
                            new Date(announcement.create_time).toLocaleDateString('zh-TW') : 
                            'Êú™Áü•Êó•Êúü';
                        const showToTeam = announcement.field_q97ij__c ? '‚úì Â∑•Áè≠ÂèØË¶ã' : '';
                        const showToOwner = announcement.field_uO778__c ? '‚úì Ê•≠‰∏ªÂèØË¶ã' : '';
                        const announcementNumber = announcement.name || '';
                        
                        // Check if there's an image
                        const imageHtml = announcement.field_dvR88__c ? 
                            `<img src="${announcement.field_dvR88__c}" style="max-width: 100%; margin-top: 0.5rem; border-radius: 4px;" alt="ÂÖ¨ÂëäÂúñÁâá">` : 
                            '';
                        
                        html += `
                            <div style="padding: 1rem; background: var(--background); border-left: 4px solid var(--primary); border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong style="color: var(--heading);">ÂÖ¨Âëä #${announcementNumber}</strong>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        ${showToTeam ? `<span style="color: var(--primary); font-size: 0.75rem;">${showToTeam}</span>` : ''}
                                        ${showToOwner ? `<span style="color: var(--primary); font-size: 0.75rem;">${showToOwner}</span>` : ''}
                                        <span style="color: var(--body-text); font-size: 0.875rem;">${createTime}</span>
                                    </div>
                                </div>
                                <p style="color: var(--body-text); white-space: pre-wrap;">${content}</p>
                                ${imageHtml}
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    gridContent.innerHTML = html;
                } else {
                    // No announcements
                    gridContent.innerHTML = `
                        <div style="padding: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="color: var(--heading);">ÈÄ≤Â∫¶ÂÖ¨Âëä</h2>
                                <button onclick="addAnnouncement()" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Êñ∞Â¢ûÂÖ¨Âëä
                                </button>
                            </div>
                            <div style="background: var(--background); padding: 2rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üì¢</div>
                                <p style="color: var(--body-text);">ÁõÆÂâçÊ≤íÊúâÈÄ≤Â∫¶ÂÖ¨Âëä</p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                gridContent.innerHTML = `
                    <div style="padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 style="color: var(--heading);">ÈÄ≤Â∫¶ÂÖ¨Âëä</h2>
                            <button onclick="addAnnouncement()" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Êñ∞Â¢ûÂÖ¨Âëä
                            </button>
                        </div>
                        <div style="background: #fee; color: #c00; padding: 1rem; border-radius: 8px;">
                            ËºâÂÖ•ÈÄ≤Â∫¶ÂÖ¨ÂëäÂ§±ÊïóÔºö${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Add new announcement (placeholder function)
        function addAnnouncement() {
            alert('Êñ∞Â¢ûÂÖ¨ÂëäÂäüËÉΩÈñãÁôº‰∏≠...');
        }

        // Toggle collapsible sections
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const button = section.previousElementSibling;
            
            if (section && button && button.classList.contains('section-toggle')) {
                section.classList.toggle('collapsed');
                button.classList.toggle('collapsed');
            }
        }

        // Toggle construction team info
        function toggleTeamInfo() {
            const teamInfo = document.getElementById('constructionTeamInfo');
            if (teamInfo) {
                teamInfo.classList.toggle('collapsed');
            }
        }

        // Initialize collapsible sections on mobile
        function initCollapsibleSections() {
            if (window.innerWidth <= 768) {
                // Collapse sections by default on mobile
                const statsSection = document.getElementById('statsSection');
                const constructionTeamInfo = document.getElementById('constructionTeamInfo');
                const statsToggle = statsSection?.previousElementSibling;
                
                if (statsSection && statsToggle && statsToggle.classList.contains('section-toggle')) {
                    statsSection.classList.add('collapsed');
                    statsToggle.classList.add('collapsed');
                }
                
                // Collapse construction team info by default on mobile
                if (constructionTeamInfo) {
                    constructionTeamInfo.classList.add('collapsed');
                }
            }
        }

        // Call on page load and resize
        window.addEventListener('DOMContentLoaded', initCollapsibleSections);
        window.addEventListener('resize', () => {
            // Remove collapsed state when switching to desktop
            if (window.innerWidth > 768) {
                const sections = document.querySelectorAll('.stats-section, .construction-team-info');
                const toggles = document.querySelectorAll('.section-toggle');
                
                sections.forEach(section => section.classList.remove('collapsed'));
                toggles.forEach(toggle => toggle.classList.remove('collapsed'));
            }
        });

        // Handle tab switching
        function handleTabSwitch(tabName) {
            const gridWrapper = document.querySelector('.building-grid-wrapper');
            const gridContent = document.getElementById('gridContent');
            const legend = document.getElementById('gridLegend');
            const buildingTabs = document.getElementById('buildingTabs');
            
            // Update URL with the new tab parameter
            const url = new URL(window.location);
            url.searchParams.set('tab', tabName);
            window.history.pushState({}, '', url);
            
            switch(tabName) {
                case 'spc':
                    // Show SPC engineering grid (current view)
                    gridWrapper.style.display = 'block';
                    buildingTabs.style.display = 'flex';
                    legend.style.display = 'flex';
                    renderFloorGrid();
                    break;
                    
                case 'cabinet':
                    // Show cabinet engineering message
                    gridWrapper.style.display = 'block';
                    buildingTabs.style.display = 'none';
                    legend.style.display = 'none';
                    gridContent.innerHTML = `
                        <div style="padding: 3rem; text-align: center;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üö´</div>
                            <h2 style="color: var(--heading); margin-bottom: 0.5rem;">Êú¨Â∞àÊ°àÊú™ÂåÖÂê´Êµ¥Ê´ÉÂ∑•Á®ãÊúçÂãô</h2>
                            <p style="color: var(--body-text);">Ê≠§Â∞àÊ°àÂÉÖÊèê‰æõ SPC Â∑•Á®ãÊúçÂãô</p>
                        </div>
                    `;
                    break;
                    
                case 'maintenance':
                    // Show maintenance orders
                    gridWrapper.style.display = 'block';
                    buildingTabs.style.display = 'none';
                    legend.style.display = 'none';
                    gridContent.innerHTML = `
                        <div style="padding: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="color: var(--heading);">Á∂≠‰øÆÂñÆÁÆ°ÁêÜ</h2>
                                <button style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Êñ∞Â¢ûÁ∂≠‰øÆÂñÆ
                                </button>
                            </div>
                            <div style="background: var(--background); padding: 2rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üîß</div>
                                <p style="color: var(--body-text);">ÁõÆÂâçÊ≤íÊúâÁ∂≠‰øÆÂñÆ</p>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'announcements':
                    // Show progress announcements
                    gridWrapper.style.display = 'block';
                    buildingTabs.style.display = 'none';
                    legend.style.display = 'none';
                    loadProgressAnnouncements();
                    break;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const tabName = this.dataset.tab;
                    handleTabSwitch(tabName);
                });
            });

            // Building switching - use event delegation properly
            document.getElementById('buildingTabs').addEventListener('click', (e) => {
                // Find the actual button element (could be the target or its parent)
                let button = e.target.closest('.building-btn');
                
                if (button) {
                    // Prevent multiple rapid clicks
                    if (button.dataset.switching === 'true') return;
                    button.dataset.switching = 'true';
                    
                    // Update active state
                    document.querySelectorAll('.building-btn').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Update current building
                    const newBuilding = button.dataset.building;
                    if (currentBuilding !== newBuilding) {
                        currentBuilding = newBuilding;
                        console.log('Switching to building:', currentBuilding);
                        renderFloorGrid();
                    }
                    
                    // Allow clicking again after a short delay
                    setTimeout(() => {
                        button.dataset.switching = 'false';
                    }, 300);
                }
            });

            // Modal background click to close
            document.getElementById('siteModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeModal();
                }
            });

            // ESC key to close modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });

            // Report button
            const reportBtn = document.querySelector('.btn-report');
            if (reportBtn) {
                reportBtn.addEventListener('click', () => {
                    showPermissionAlert('Â†±Ë°®ÂäüËÉΩ');
                });
            }

            // Export button
            const exportBtn = document.querySelector('.btn-export');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    showPermissionAlert('ÂåØÂá∫ÂäüËÉΩ');
                });
            }

            // Settings button (Edit)
            const settingsBtn = document.querySelector('.btn-settings');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => {
                    // Áõ¥Êé•Â∞éËà™Âà∞Á∑®ËºØÈ†ÅÈù¢
                    const projectId = new URLSearchParams(window.location.search).get('id');
                    if (projectId) {
                        // ‰ΩøÁî®Ê®ôÊ∫ñÁöÑÁ∑®ËºØÊ®°Âºè URL
                        window.location.href = `project-create.html?id=${projectId}`;
                    }
                });
            }

            // Delete button
            const deleteBtn = document.querySelector('.btn-delete');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async () => {
                    const projectId = new URLSearchParams(window.location.search).get('id');
                    const projectName = document.getElementById('projectName').textContent;
                    
                    if (projectId && confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Â∞àÊ°à„Äå${projectName}„ÄçÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`)) {
                        try {
                            const response = await fetch(
                                `${CONFIG?.API?.WORKER_API_URL || 'https://construction-management-api.lai-jameslai.workers.dev'}/api/v1/projects/${projectId}`,
                                {
                                    method: 'DELETE',
                                    headers: AuthUtils.getRequestHeaders()
                                }
                            );

                            if (response.ok) {
                                alert('Â∞àÊ°àÂ∑≤ÊàêÂäüÂà™Èô§');
                                window.location.href = 'project-list.html';
                            } else {
                                const error = await response.json();
                                throw new Error(error.error || 'Âà™Èô§Â§±Êïó');
                            }
                        } catch (error) {
                            console.error('Âà™Èô§Â∞àÊ°àÂ§±Êïó:', error);
                            alert('Âà™Èô§Â∞àÊ°àÊôÇÁôºÁîüÈåØË™§Ôºö' + error.message);
                        }
                    }
                });
            }
        }

        // Go back
        function goBack() {
            window.location.href = 'project-list.html';
        }

        // Show error
        function showError(message) {
            const gridContent = document.getElementById('gridContent');
            gridContent.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // Show permission alert
        function showPermissionAlert(feature) {
            // Create alert modal if it doesn't exist
            let alertModal = document.getElementById('permissionAlertModal');
            if (!alertModal) {
                alertModal = document.createElement('div');
                alertModal.id = 'permissionAlertModal';
                alertModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: none;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                const alertContent = document.createElement('div');
                alertContent.style.cssText = `
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 400px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                `;
                
                alertContent.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üîí</div>
                    <h2 style="color: #1e293b; margin-bottom: 1rem; font-size: 1.5rem;">Ê¨äÈôê‰∏çË∂≥</h2>
                    <p id="permissionMessage" style="color: #64748b; margin-bottom: 1.5rem;">ÊÇ®Ê≤íÊúâÊ¨äÈôê‰ΩøÁî®Ê≠§ÂäüËÉΩ</p>
                    <button onclick="document.getElementById('permissionAlertModal').style.display='none'" 
                            style="padding: 0.75rem 2rem; background: #84C7D0; color: white; border: none; 
                                   border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 500;">
                        Á¢∫ÂÆö
                    </button>
                `;
                
                alertModal.appendChild(alertContent);
                document.body.appendChild(alertModal);
                
                // Close on background click
                alertModal.addEventListener('click', (e) => {
                    if (e.target === alertModal) {
                        alertModal.style.display = 'none';
                    }
                });
            }
            
            // Update message and show
            const message = document.getElementById('permissionMessage');
            if (message) {
                message.textContent = `ÊÇ®Ê≤íÊúâÊ¨äÈôê‰ΩøÁî®${feature}„ÄÇË´ãËÅØÁπ´ÁÆ°ÁêÜÂì°ÈñãÈÄöÊ¨äÈôê„ÄÇ`;
            }
            alertModal.style.display = 'flex';
        }

        // ============================
        // Ë¶ñËßíÂàáÊèõÂäüËÉΩÂØ¶Áèæ
        // ============================

        // ÂàùÂßãÂåñË¶ñËßíÂàáÊèõÂô®
        async function initializePerspectiveSwitcher(projectId) {
            try {
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÁÆ°ÁêÜÂì°
                if (window.permissions) {
                    await window.permissions.init();
                    const isAdmin = await window.permissions.isAdmin();
                    
                    if (isAdmin) {
                        // È°ØÁ§∫Ë¶ñËßíÂàáÊèõÂô®
                        document.getElementById('perspectiveSwitcher').classList.add('show');
                        
                        // ËºâÂÖ•Â∞àÊ°àÊâÄÊúâÁî®Êà∂
                        await loadProjectUsers(projectId);
                        
                        // ‰∏çÈúÄË¶Å‰øùÂ≠òÂéüÂßãÁî®Êà∂ÔºåUnifiedPermissions ÊúÉËôïÁêÜ
                    }
                }
            } catch (error) {
                console.error('ÂàùÂßãÂåñË¶ñËßíÂàáÊèõÂô®Â§±Êïó:', error);
            }
        }

        // ËºâÂÖ•Â∞àÊ°àÊâÄÊúâÁî®Êà∂
        async function loadProjectUsers(projectId) {
            try {
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/permissions`, {
                    headers: AuthUtils.getRequestHeaders()
                });
                
                if (response.ok) {
                    allProjectUsers = await response.json();
                    renderPerspectiveUsersList();
                } else {
                    console.error('ËºâÂÖ•Â∞àÊ°àÁî®Êà∂Â§±Êïó:', response.status);
                }
            } catch (error) {
                console.error('ËºâÂÖ•Â∞àÊ°àÁî®Êà∂Â§±Êïó:', error);
            }
        }

        // Ê∏≤ÊüìË¶ñËßíÂàáÊèõÁî®Êà∂ÂàóË°®
        function renderPerspectiveUsersList() {
            const container = document.getElementById('perspectiveUsersList');
            container.innerHTML = '';

            // ÊåâËßíËâ≤ÂàÜÁµÑ
            const roleGroups = {
                owner: { name: 'Ê•≠‰∏ª', users: [], icon: 'üè¢' },
                foreman: { name: 'Â∑•Áè≠Ë≤†Ë≤¨‰∫∫', users: [], icon: 'üë∑‚Äç‚ôÇÔ∏è' },
                worker: { name: 'Â∑•Áè≠ÊàêÂì°', users: [], icon: 'üî®' }
            };

            allProjectUsers.forEach(user => {
                if (user.role !== 'admin' && roleGroups[user.role]) {
                    roleGroups[user.role].users.push(user);
                }
            });

            // Ê∏≤ÊüìÂêÑËßíËâ≤ÁµÑ
            Object.entries(roleGroups).forEach(([roleKey, group]) => {
                if (group.users.length > 0) {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'perspective-group';
                    
                    groupDiv.innerHTML = `
                        <div class="perspective-group-title">${group.icon} ${group.name}</div>
                        ${group.users.map(user => `
                            <div class="perspective-item" onclick="switchPerspective('${user.user_id}')">
                                <span>${group.icon}</span>
                                <div style="flex: 1;">
                                    <div>${user.name}</div>
                                    <small style="color: var(--body-text); opacity: 0.7;">${user.phone}</small>
                                </div>
                                <span class="perspective-role-badge role-${user.role}">
                                    ${getRoleName(user.role)}
                                </span>
                            </div>
                        `).join('')}
                    `;
                    
                    container.appendChild(groupDiv);
                }
            });
        }

        // ÂàáÊèõË¶ñËßí
        async function switchPerspective(userId) {
            const projectId = window.currentProject?.id;
            if (!projectId) return;
            
            if (userId === null) {
                // ËøîÂõûÁÆ°ÁêÜÂì°Ë¶ñËßí
                await exitSimulation();
            } else {
                // ‰ΩøÁî® UnifiedPermissions ÂàáÊèõË¶ñËßí
                const success = await window.permissions.switchPerspective(userId, projectId);
                if (success) {
                    const targetUser = allProjectUsers.find(u => u.user_id === userId);
                    if (targetUser) {
                        showSimulationBanner(targetUser);
                    }
                }
            }
            
            // ÈóúÈñâ‰∏ãÊãâÈÅ∏ÂñÆ
            document.getElementById('perspectiveDropdown').classList.remove('show');
            
            // ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢ÂÖßÂÆπ
            await refreshPageContent();
        }

        // È°ØÁ§∫Ê®°Êì¨Ê®°ÂºèÊèêÁ§∫
        function showSimulationBanner(user) {
            const banner = document.getElementById('simulationBanner');
            const userName = document.getElementById('simulatedUserName');
            
            // È°ØÁ§∫Áî®Êà∂Âú®ÂêÑÂ∑•Áè≠ÁöÑËßíËâ≤
            let roleText = '';
            if (user.team_contexts && user.team_contexts.length > 0) {
                roleText = user.team_contexts.map(tc => {
                    const role = tc.role === 'leader' ? 'Â∑•Áè≠Èï∑' : 'ÊàêÂì°';
                    return `${tc.team_name}(${role})`;
                }).join(', ');
            } else if (user.global_permissions) {
                roleText = user.user_type === 'owner' ? 'Ê•≠‰∏ª' : 'ÁÆ°ÁêÜÂì°';
            } else {
                roleText = getRoleName(user.role);
            }
            
            userName.textContent = `${user.name} - ${roleText}`;
            banner.classList.add('show');
            
            // Êõ¥Êñ∞Ë¶ñËßíÂàáÊèõÂô®ÁãÄÊÖã
            updatePerspectiveDropdownState();
            
            console.log('Â∑≤ÂàáÊèõÂà∞Áî®Êà∂Ë¶ñËßí:', user.name, roleText);
        }

        // ÈÄÄÂá∫Ê®°Êì¨Ê®°Âºè
        async function exitSimulation() {
            // ‰ΩøÁî® UnifiedPermissions ËøîÂõûÁúüÂØ¶Ë¶ñËßí
            await window.permissions.switchPerspective(null);
            
            // Èö±ËóèÊ®°Êì¨Ê®°ÂºèÊèêÁ§∫Ê¢ù
            document.getElementById('simulationBanner').classList.remove('show');
            
            // Êõ¥Êñ∞Ë¶ñËßíÂàáÊèõÂô®ÁãÄÊÖã
            updatePerspectiveDropdownState();
            
            console.log('Â∑≤ËøîÂõûÁÆ°ÁêÜÂì°Ë¶ñËßí');
        }

        // Êõ¥Êñ∞Ë¶ñËßíÂàáÊèõÂô®‰∏ãÊãâÈÅ∏ÂñÆÁãÄÊÖã
        function updatePerspectiveDropdownState() {
            const items = document.querySelectorAll('.perspective-item');
            const isSimulating = window.permissions?.isSimulating();
            const simulatedUser = window.permissions?.simulatedUser;
            
            items.forEach(item => {
                item.classList.remove('active');
                
                if (!isSimulating) {
                    // ÁÆ°ÁêÜÂì°Ë¶ñËßí
                    if (item.onclick && item.onclick.toString().includes('switchPerspective(null)')) {
                        item.classList.add('active');
                    }
                } else if (simulatedUser) {
                    // Ê®°Êì¨Áî®Êà∂Ë¶ñËßí
                    if (item.onclick && item.onclick.toString().includes(`'${simulatedUser.id}'`)) {
                        item.classList.add('active');
                    }
                }
            });
        }

        // ÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢ÂÖßÂÆπÔºàÊ†πÊìöÁï∂ÂâçË¶ñËßíÔºâ
        async function refreshPageContent() {
            // ÈáçÊñ∞ËºâÂÖ•Â∑•Áè≠ÂúñË°®ÂíåÁõ∏ÈóúÂÖßÂÆπ
            if (window.currentProject) {
                await loadProject(window.currentProject.id);
                console.log('È†ÅÈù¢ÂÖßÂÆπÂ∑≤Ê†πÊìöÊñ∞Ë¶ñËßíÊõ¥Êñ∞');
            }
        }

        // ÂàáÊèõË¶ñËßí‰∏ãÊãâÈÅ∏ÂñÆÈ°ØÁ§∫/Èö±Ëóè
        function togglePerspectiveDropdown() {
            const dropdown = document.getElementById('perspectiveDropdown');
            dropdown.classList.toggle('show');
        }

        // ÈªûÊìäÂÖ∂‰ªñÂú∞ÊñπÈóúÈñâ‰∏ãÊãâÈÅ∏ÂñÆ
        document.addEventListener('click', function(event) {
            const perspectiveSwitcher = document.getElementById('perspectiveSwitcher');
            const dropdown = document.getElementById('perspectiveDropdown');
            
            if (!perspectiveSwitcher.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // ÂèñÂæóËßíËâ≤‰∏≠ÊñáÂêçÁ®±
        function getRoleName(role) {
            const roleNames = {
                admin: 'ÁÆ°ÁêÜÂì°',
                owner: 'Ê•≠‰∏ª',
                foreman: 'Â∑•Áè≠Ë≤†Ë≤¨‰∫∫',
                worker: 'Â∑•Áè≠ÊàêÂì°'
            };
            return roleNames[role] || role;
        }

        // ‰øÆÊîπÊ¨äÈôêÊ™¢Êü•ÂáΩÊï∏ÔºåËÄÉÊÖÆÊ®°Êì¨Áî®Êà∂
        function getCurrentUserPermissions() {
            if (currentSimulatedUser) {
                // ËøîÂõûÊ®°Êì¨Áî®Êà∂ÁöÑÊ¨äÈôê
                return {
                    isAdmin: false,
                    role: currentSimulatedUser.role,
                    can_view: currentSimulatedUser.can_view,
                    can_edit: currentSimulatedUser.can_edit,
                    can_manage_members: currentSimulatedUser.can_manage_members,
                    can_view_other_teams: currentSimulatedUser.can_view_other_teams,
                    user_id: currentSimulatedUser.user_id,
                    phone: currentSimulatedUser.phone,
                    name: currentSimulatedUser.name
                };
            } else {
                // ËøîÂõûÂéüÂßãÁÆ°ÁêÜÂì°Ê¨äÈôê
                return {
                    isAdmin: true,
                    role: 'admin',
                    can_view: true,
                    can_edit: true,
                    can_manage_members: true,
                    can_view_other_teams: true,
                    user_id: originalUser?.id || 'admin',
                    phone: originalUser?.phone || '0900000001',
                    name: originalUser?.name || 'Á≥ªÁµ±ÁÆ°ÁêÜÂì°'
                };
            }
        }
    </script>
</body>
</html>