<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ºç«‹å·¥ç¨‹å°ˆæ¡ˆ V3 - å…ƒå¿ƒå»ºæç®¡ç†ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 1200px;
            padding: 2.5rem;
        }

        .header {
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .breadcrumb {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Progress Steps */
        .progress-container {
            margin-bottom: 3rem;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: #4f46e5;
            color: white;
            transform: scale(1.1);
        }

        .step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step-title {
            font-size: 0.9rem;
            color: #6b7280;
            text-align: center;
        }

        .step.active .step-title {
            color: #1f2937;
            font-weight: 600;
        }

        /* Content Area */
        .content-area {
            min-height: 400px;
        }

        .step-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Engineering Type Cards - Dynamic */
        .engineering-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .engineering-type-card {
            padding: 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .engineering-type-card:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }

        .engineering-type-card.selected {
            background: #eef2ff;
            border-color: #4f46e5;
        }

        .engineering-type-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .engineering-type-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .engineering-type-desc {
            font-size: 0.85rem;
            color: #6b7280;
        }

        /* Buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }

        .data-table thead {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        .data-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
        }

        .data-table tbody tr:hover {
            background: #f9fafb;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert Messages */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #86efac;
        }

        .alert-warning {
            background: #fed7aa;
            color: #92400e;
            border: 1px solid #fdba74;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å»ºç«‹å·¥ç¨‹å°ˆæ¡ˆ</h1>
            <div class="breadcrumb">é¦–é  / å°ˆæ¡ˆç®¡ç† / å»ºç«‹å°ˆæ¡ˆ</div>
        </div>

        <!-- Progress Steps -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="step active" id="step-1">
                    <div class="step-number">1</div>
                    <div class="step-title">é¸æ“‡å•†æ©Ÿ</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-number">2</div>
                    <div class="step-title">é¸æ“‡å·¥ç¨‹é¡å‹</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-number">3</div>
                    <div class="step-title">é¡¯ç¤ºçµ±è¨ˆ</div>
                </div>
                <div class="step" id="step-4">
                    <div class="step-number">4</div>
                    <div class="step-title">è¨­å®šæ¬Šé™</div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Step 1: Select Opportunity -->
            <div class="step-content active" id="step-content-1">
                <h2>é¸æ“‡å•†æ©Ÿ</h2>
                <p style="color: #6b7280; margin-bottom: 1.5rem;">è«‹é¸æ“‡è¦å‰µå»ºå°ˆæ¡ˆçš„å•†æ©Ÿ</p>
                
                <div class="form-group">
                    <input type="text" id="opportunitySearch" placeholder="æœå°‹å•†æ©Ÿåç¨±æˆ–å…¬å¸åç¨±...">
                </div>

                <div class="loading" id="opportunitiesLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">è¼‰å…¥å•†æ©Ÿä¸­...</p>
                </div>

                <table class="data-table" id="opportunitiesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>é¸æ“‡</th>
                            <th>å•†æ©Ÿåç¨±</th>
                            <th>å…¬å¸</th>
                            <th>é‡‘é¡</th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="opportunitiesTableBody">
                        <!-- Dynamic content -->
                    </tbody>
                </table>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="window.location.href='project-list.html'">å–æ¶ˆ</button>
                    <button class="btn btn-primary" id="step1-next" onclick="nextStep()" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- Step 2: Select Engineering Types -->
            <div class="step-content" id="step-content-2">
                <h2>é¸æ“‡å·¥ç¨‹é¡å‹</h2>
                <p style="color: #6b7280; margin-bottom: 1.5rem;">è«‹é¸æ“‡æ­¤å°ˆæ¡ˆè¦åŒ…å«çš„å·¥ç¨‹é¡å‹ï¼Œå¯ä»¥å¤šé¸</p>
                
                <div class="loading" id="engineeringTypesLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">è¼‰å…¥å·¥ç¨‹é¡å‹...</p>
                </div>

                <div class="engineering-types-grid" id="engineeringTypesGrid">
                    <!-- Dynamic content -->
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-primary" id="step2-next" onclick="nextStep()" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- Step 3: Display Statistics -->
            <div class="step-content" id="step-content-3">
                <h2>å·¥ç¨‹çµ±è¨ˆè³‡æ–™</h2>
                
                <div class="loading" id="statisticsLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">è¼‰å…¥çµ±è¨ˆè³‡æ–™...</p>
                </div>

                <div id="statisticsContent">
                    <!-- Dynamic content -->
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- Step 4: Set Permissions -->
            <div class="step-content" id="step-content-4">
                <h2>è¨­å®šæ¬Šé™</h2>
                
                <div id="permissionsContent">
                    <!-- Dynamic content -->
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-success" onclick="createProject()">å»ºç«‹å°ˆæ¡ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load configuration -->
    <script src="config.js"></script>
    <script src="js/unified-auth.js"></script>
    
    <script>
        // ========================================
        // Global Variables
        // ========================================
        let currentStep = 1;
        let selectedOpportunity = null;
        let selectedEngineeringTypes = [];
        let availableEngineeringTypes = [];
        let availableTeams = [];
        let projectData = {};
        let engineeringStats = {};

        // API Configuration
        const API_BASE_URL = CONFIG?.API?.D1_REST_API_URL || 'https://fx-d1-rest-api.lai-jameslai.workers.dev';
        const WORKER_API_URL = CONFIG?.API?.WORKER_API_URL || 'https://construction-management-api-clerk.lai-jameslai.workers.dev';
        const API_TOKEN = CONFIG?.API?.REST_API_TOKEN || 'fx-crm-api-secret-2025';
        const USE_V2_API = true; // Use new V2 API

        // ========================================
        // Initialization
        // ========================================
        // Global variables for edit mode
        let isEditMode = false;
        let editProjectId = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if we're in edit mode
            const urlParams = new URLSearchParams(window.location.search);
            editProjectId = urlParams.get('id');
            isEditMode = !!editProjectId;
            
            if (isEditMode) {
                // Update UI for edit mode
                document.querySelector('.header h1').textContent = 'ç·¨è¼¯å·¥ç¨‹å°ˆæ¡ˆ';
                document.querySelector('.breadcrumb').textContent = 'å°ˆæ¡ˆç®¡ç† > å°ˆæ¡ˆåˆ—è¡¨ > ç·¨è¼¯å°ˆæ¡ˆ';
                document.querySelector('.btn-primary').textContent = 'æ›´æ–°å°ˆæ¡ˆ';
                
                // Load existing project data
                await loadProjectForEdit(editProjectId);
            }
            
            await loadEngineeringTypes();
            await loadTeams();
            await loadOpportunities();
            setupEventListeners();
        });

        // ========================================
        // Step Navigation
        // ========================================
        function nextStep() {
            if (currentStep < 4) {
                // Mark current step as completed
                document.getElementById(`step-${currentStep}`).classList.add('completed');
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                document.getElementById(`step-content-${currentStep}`).classList.remove('active');
                
                // Move to next step
                currentStep++;
                document.getElementById(`step-${currentStep}`).classList.add('active');
                document.getElementById(`step-content-${currentStep}`).classList.add('active');
                
                // Load data for the new step
                if (currentStep === 3) {
                    loadStatistics();
                } else if (currentStep === 4) {
                    loadPermissions();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                document.getElementById(`step-content-${currentStep}`).classList.remove('active');
                
                currentStep--;
                document.getElementById(`step-${currentStep}`).classList.remove('completed');
                document.getElementById(`step-${currentStep}`).classList.add('active');
                document.getElementById(`step-content-${currentStep}`).classList.add('active');
            }
        }

        // ========================================
        // Data Loading Functions
        // ========================================
        async function loadEngineeringTypes() {
            const loading = document.getElementById('engineeringTypesLoading');
            const grid = document.getElementById('engineeringTypesGrid');
            
            loading.classList.add('active');
            
            try {
                if (USE_V2_API) {
                    const response = await fetch(`${WORKER_API_URL}/api/v2/engineering-types`);
                    const result = await response.json();
                    availableEngineeringTypes = result.data || [];
                } else {
                    // Fallback to hardcoded types
                    availableEngineeringTypes = [
                        { code: 'SPC', name: 'SPC çŸ³å¡‘åœ°æ¿', description: 'çŸ³å¡‘è¤‡åˆåœ°æ¿å·¥ç¨‹', icon: 'ğŸ—ï¸' },
                        { code: 'CABINET', name: 'æµ´æ«ƒå·¥ç¨‹', description: 'æµ´å®¤æ«ƒé«”å®‰è£å·¥ç¨‹', icon: 'ğŸš¿' }
                    ];
                }
                
                // Render engineering type cards
                grid.innerHTML = availableEngineeringTypes.map(type => `
                    <div class="engineering-type-card" data-type="${type.code}">
                        <div class="engineering-type-icon">${type.icon || 'ğŸ“¦'}</div>
                        <div class="engineering-type-name">${type.name}</div>
                        <div class="engineering-type-desc">${type.description || ''}</div>
                    </div>
                `).join('');
                
                // Add click handlers
                document.querySelectorAll('.engineering-type-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const type = this.dataset.type;
                        
                        if (this.classList.contains('selected')) {
                            this.classList.remove('selected');
                            selectedEngineeringTypes = selectedEngineeringTypes.filter(t => t !== type);
                        } else {
                            this.classList.add('selected');
                            selectedEngineeringTypes.push(type);
                        }
                        
                        document.getElementById('step2-next').disabled = selectedEngineeringTypes.length === 0;
                    });
                });
                
            } catch (error) {
                console.error('Failed to load engineering types:', error);
                // Use fallback types
                availableEngineeringTypes = [
                    { code: 'SPC', name: 'SPC çŸ³å¡‘åœ°æ¿', description: 'çŸ³å¡‘è¤‡åˆåœ°æ¿å·¥ç¨‹', icon: 'ğŸ—ï¸' },
                    { code: 'CABINET', name: 'æµ´æ«ƒå·¥ç¨‹', description: 'æµ´å®¤æ«ƒé«”å®‰è£å·¥ç¨‹', icon: 'ğŸš¿' }
                ];
            } finally {
                loading.classList.remove('active');
            }
        }

        async function loadTeams() {
            try {
                if (USE_V2_API) {
                    const response = await fetch(`${WORKER_API_URL}/api/v2/teams`);
                    const result = await response.json();
                    availableTeams = result.data || [];
                }
            } catch (error) {
                console.error('Failed to load teams:', error);
                availableTeams = [];
            }
        }

        async function loadOpportunities() {
            const loading = document.getElementById('opportunitiesLoading');
            const table = document.getElementById('opportunitiesTable');
            const tbody = document.getElementById('opportunitiesTableBody');
            
            loading.classList.add('active');
            table.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/rest/newopportunityobj?limit=500&filter[stage__c]=è´å–®`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                const result = await response.json();
                const opportunities = result.results || [];
                
                // Render opportunities
                tbody.innerHTML = opportunities.map(opp => `
                    <tr onclick="selectOpportunity('${opp._id}', '${(opp.opportunity_name || '').replace(/'/g, "\\'")}', '${(opp.customer_name || '').replace(/'/g, "\\'")}')">
                        <td><input type="radio" name="opportunity" value="${opp._id}"></td>
                        <td>${opp.opportunity_name || ''}</td>
                        <td>${opp.customer_name || ''}</td>
                        <td>${formatCurrency(opp.expected_amount || 0)}</td>
                        <td><span class="badge">${opp.stage__c || ''}</span></td>
                    </tr>
                `).join('');
                
                table.style.display = 'table';
                
            } catch (error) {
                console.error('Failed to load opportunities:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc2626;">è¼‰å…¥å¤±æ•—</td></tr>';
                table.style.display = 'table';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function loadStatistics() {
            const loading = document.getElementById('statisticsLoading');
            const content = document.getElementById('statisticsContent');
            
            loading.classList.add('active');
            content.innerHTML = '';
            
            try {
                // Load statistics for each selected engineering type
                for (const type of selectedEngineeringTypes) {
                    const stats = await loadEngineeringStats(type);
                    engineeringStats[type] = stats;
                    
                    // Render statistics
                    const typeInfo = availableEngineeringTypes.find(t => t.code === type);
                    content.innerHTML += `
                        <div class="stats-section">
                            <h3>${typeInfo?.icon || ''} ${typeInfo?.name || type}</h3>
                            <table class="data-table">
                                <tr>
                                    <td>æ¡ˆå ´ç¸½æ•¸</td>
                                    <td><span class="stat-value">${stats.siteCount || 0}</span></td>
                                </tr>
                                <tr>
                                    <td>å·¥ç­æ•¸é‡</td>
                                    <td><span class="stat-value">${stats.teamCount || 0}</span></td>
                                </tr>
                                <tr>
                                    <td>å·²å®Œæˆæ•¸</td>
                                    <td><span class="stat-value">${stats.completedCount || 0}</span></td>
                                </tr>
                            </table>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
                content.innerHTML = '<div class="alert alert-error">è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—</div>';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function loadEngineeringStats(type) {
            // TODO: Load actual statistics from API
            // For now, return mock data
            if (type === 'SPC') {
                return { siteCount: 224, teamCount: 4, completedCount: 0 };
            } else if (type === 'CABINET') {
                return { siteCount: 56, teamCount: 2, completedCount: 0 };
            }
            return { siteCount: 0, teamCount: 0, completedCount: 0 };
        }

        function loadPermissions() {
            const content = document.getElementById('permissionsContent');
            
            // TODO: Load and render permissions UI
            content.innerHTML = `
                <div class="alert alert-info">
                    æ¬Šé™è¨­å®šå°‡æ ¹æ“šé¸æ“‡çš„å·¥ç¨‹é¡å‹å’Œå·¥ç­è‡ªå‹•é…ç½®
                </div>
            `;
        }

        // ========================================
        // Event Handlers
        // ========================================
        function setupEventListeners() {
            // Search functionality
            document.getElementById('opportunitySearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#opportunitiesTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        function selectOpportunity(id, name, company) {
            selectedOpportunity = { id, name, company };
            
            // Update UI
            document.querySelectorAll('input[name="opportunity"]').forEach(radio => {
                radio.checked = radio.value === id;
            });
            
            // Enable next button
            document.getElementById('step1-next').disabled = false;
        }

        // ========================================
        // Project Creation
        // ========================================
        async function createProject() {
            const confirmMessage = isEditMode ? 'ç¢ºå®šè¦æ›´æ–°æ­¤å°ˆæ¡ˆå—ï¼Ÿ' : 'ç¢ºå®šè¦å»ºç«‹æ­¤å°ˆæ¡ˆå—ï¼Ÿ';
            if (!confirm(confirmMessage)) return;
            
            // Prepare project data in V2 format
            const projectDataV2 = {
                project: {
                    id: selectedOpportunity.id,
                    opportunity_id: selectedOpportunity.id,
                    name: selectedOpportunity.name,
                    company_name: selectedOpportunity.company,
                    cross_view_enabled: false // TODO: Get from UI
                },
                engineering_types: selectedEngineeringTypes.map(type => ({
                    engineering_type_code: type,
                    is_enabled: true,
                    site_count: engineeringStats[type]?.siteCount || 0,
                    team_count: engineeringStats[type]?.teamCount || 0
                })),
                team_assignments: [], // TODO: Get from UI
                owners: [], // TODO: Get from UI
                field_permissions: [] // TODO: Get from UI
            };
            
            try {
                const token = localStorage.getItem('auth_token');
                
                if (!token) {
                    alert('è«‹å…ˆç™»å…¥');
                    window.location.href = 'login-simple.html';
                    return;
                }
                let apiUrl, method;
                if (isEditMode) {
                    apiUrl = USE_V2_API ? `/api/v2/projects/${editProjectId}` : `/api/v1/projects/${editProjectId}`;
                    method = 'PUT';
                } else {
                    apiUrl = USE_V2_API ? '/api/v2/projects' : '/api/v1/projects';
                    method = 'POST';
                }
                
                const response = await fetch(`${WORKER_API_URL}${apiUrl}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(projectDataV2)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Project created:', result);
                    
                    // Save to localStorage for demo
                    const demoProject = {
                        id: selectedOpportunity.id,
                        name: selectedOpportunity.name,
                        company: selectedOpportunity.company,
                        company_name: selectedOpportunity.company, // ç¢ºä¿å…©å€‹æ¬„ä½éƒ½æœ‰å€¼
                        status: 'active',
                        project_status: 'not_started', // æ–°å°ˆæ¡ˆé è¨­ç‚ºã€Œå°šæœªé–‹å§‹ã€
                        engineeringTypes: selectedEngineeringTypes,
                        progress: 0,
                        unit_count: Object.values(engineeringStats).reduce((sum, s) => sum + (s.siteCount || 0), 0),
                        completed_count: 0,
                        lastUpdate: new Date().toLocaleDateString('zh-TW'),
                        created_at: new Date().toISOString(),
                        start_date: null,
                        end_date: null
                    };
                    localStorage.setItem('demo_created_project', JSON.stringify(demoProject));
                    
                    const successMessage = isEditMode ? 'å°ˆæ¡ˆæ›´æ–°æˆåŠŸï¼' : 'å°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼';
                    alert(successMessage);
                    window.location.href = 'project-list.html';
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'API error');
                }
            } catch (error) {
                console.error('Failed to save project:', error);
                const errorMessage = isEditMode ? 'å°ˆæ¡ˆæ›´æ–°å¤±æ•—ï¼š' : 'å°ˆæ¡ˆå»ºç«‹å¤±æ•—ï¼š';
                alert(errorMessage + error.message);
            }
        }

        // ========================================
        // Edit Mode Functions
        // ========================================
        async function loadProjectForEdit(projectId) {
            try {
                // å…ˆå˜—è©¦å¾ localStorage è¼‰å…¥ï¼ˆç”¨æ–¼ç¤ºç¯„ï¼‰
                const savedProject = localStorage.getItem('demo_created_project');
                if (savedProject) {
                    const localProject = JSON.parse(savedProject);
                    if (localProject.id === projectId) {
                        fillFormWithProjectData(localProject);
                        return;
                    }
                }
                
                // å˜—è©¦å¾ API è¼‰å…¥
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}`, {
                    headers: window.UnifiedAuth.getRequestHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('ç„¡æ³•è¼‰å…¥å°ˆæ¡ˆè³‡æ–™');
                }
                
                const data = await response.json();
                const project = data.project || data.data || data;
                
                // Fill form fields with existing data
                fillFormWithProjectData(project);
                
            } catch (error) {
                console.error('Failed to load project for edit:', error);
                // ä¸è¦ç«‹å³è·³è½‰ï¼Œè®“ç”¨æˆ¶å¯ä»¥æ‰‹å‹•å¡«å¯«
                alert('ç„¡æ³•å¾ä¼ºæœå™¨è¼‰å…¥å°ˆæ¡ˆè³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥');
            }
        }
        
        function fillFormWithProjectData(project) {
            // Step 1: Opportunity Selection
            if (project.id || project.opportunity_id) {
                const oppId = project.opportunity_id || project.id;
                const oppName = project.opportunity_name || project.name || '';
                const company = project.company || project.company_name || '';
                selectOpportunity(oppId, oppName, company);
            }
            
            // Step 2: Engineering Types
            if (project.engineeringTypes && Array.isArray(project.engineeringTypes)) {
                selectedEngineeringTypes = project.engineeringTypes;
                // ç­‰å¾…å·¥ç¨‹é¡å‹è¼‰å…¥å¾Œå†é¸ä¸­
                setTimeout(() => {
                    project.engineeringTypes.forEach(type => {
                        const card = document.querySelector(`.engineering-type-card[data-type="${type}"]`);
                        if (card) {
                            card.classList.add('selected');
                        }
                    });
                    document.getElementById('step2-next').disabled = selectedEngineeringTypes.length === 0;
                }, 500);
            }
            
            // Sites data
            if (project.sites && Array.isArray(project.sites)) {
                // Clear existing sites first
                document.getElementById('sitesContainer').innerHTML = '';
                
                project.sites.forEach(site => {
                    addSiteToContainer(site);
                });
            }
            
            // Permissions
            if (project.permissions && Array.isArray(project.permissions)) {
                project.permissions.forEach(permission => {
                    const row = document.querySelector(`tr[data-user-id="${permission.user_id}"]`);
                    if (row) {
                        const select = row.querySelector('select');
                        if (select) {
                            select.value = permission.role;
                        }
                    }
                });
            }
        }
        
        function addSiteToContainer(site) {
            const sitesContainer = document.getElementById('sitesContainer');
            const siteDiv = document.createElement('div');
            siteDiv.className = 'site-item';
            siteDiv.innerHTML = `
                <div class="site-info">
                    <h4>${site.name || site.site_name}</h4>
                    <p>${site.address || site.site_address || ''}</p>
                    <div class="site-stats">
                        <span>SPC: ${site.spc_count || 0}</span>
                        <span>æµ´æ«ƒ: ${site.cabinet_count || 0}</span>
                    </div>
                </div>
                <button type="button" class="btn-remove" onclick="removeSite(this, '${site.id}')">ç§»é™¤</button>
            `;
            sitesContainer.appendChild(siteDiv);
        }

        // ========================================
        // Helper Functions
        // ========================================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0
            }).format(amount);
        }
    </script>
</body>
</html>