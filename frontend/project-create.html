<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建立工程專案 - 元心建材工程管理系統 v1.2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 1200px;
            padding: 2.5rem;
        }

        .header {
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .breadcrumb {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Progress Steps */
        .progress-container {
            margin-bottom: 3rem;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: #4f46e5;
            color: white;
            transform: scale(1.1);
        }

        .step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step-title {
            font-size: 0.9rem;
            color: #6b7280;
            text-align: center;
        }

        .step.active .step-title {
            color: #1f2937;
            font-weight: 600;
        }

        /* Content Area */
        .content-area {
            min-height: 400px;
        }

        .step-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Engineering Type Cards - Dynamic */
        .engineering-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .engineering-type-card {
            padding: 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .engineering-type-card:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
        }

        .engineering-type-card.selected,
        .engineering-type-card.active {
            background: #eef2ff;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            position: relative;
        }
        
        .engineering-type-card.selected::after,
        .engineering-type-card.active::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: #4f46e5;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .engineering-type-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .engineering-type-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .engineering-type-desc {
            font-size: 0.85rem;
            color: #6b7280;
        }

        /* Buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }

        .data-table thead {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        .data-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
        }

        .data-table tbody tr:hover {
            background: #f9fafb;
        }

        /* Permissions Section */
        .permissions-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .permissions-section h3 {
            margin-bottom: 1rem;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .permissions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .permissions-table th {
            background: #f9fafb;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .permissions-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .team-leader-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .switch input:checked + .slider {
            background-color: #4f46e5;
        }

        .switch input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert Messages */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #86efac;
        }

        .alert-warning {
            background: #fed7aa;
            color: #92400e;
            border: 1px solid #fdba74;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
    </style>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        // Supabase configuration (optional - only if available)
        if (typeof window !== 'undefined') {
            try {
                const supabaseUrl = 'https://pbecqosbkuyypsgwxnmq.supabase.co';
                const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBiZWNxb3Nia3V5eXBzZ3d4bm1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDgyOTcsImV4cCI6MjA3MDIyNDI5N30.RxgJZpII8Fm1ym6UtMEdmw87DExR1MxtJXISag9vszQ';
                
                const supabase = createClient(supabaseUrl, supabaseAnonKey);
                window.supabase = supabase;
                
                console.log('Supabase 已初始化（可選）');
            } catch (error) {
                console.log('Supabase 未配置，使用 D1 認證');
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>建立工程專案</h1>
            <div class="breadcrumb">首頁 / 專案管理 / 建立專案</div>
        </div>

        <!-- Progress Steps -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="step active" id="step-1">
                    <div class="step-number">1</div>
                    <div class="step-title">選擇商機</div>
                </div>
                <div class="step" id="step-2">
                    <div class="step-number">2</div>
                    <div class="step-title">選擇工程類型</div>
                </div>
                <div class="step" id="step-3">
                    <div class="step-number">3</div>
                    <div class="step-title">顯示統計</div>
                </div>
                <div class="step" id="step-4">
                    <div class="step-number">4</div>
                    <div class="step-title">設定權限</div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Step 1: Select Opportunity -->
            <div class="step-content active" id="step-content-1">
                <h2>選擇商機</h2>
                <p style="color: #6b7280; margin-bottom: 1.5rem;">請選擇要創建專案的商機</p>
                
                <div class="form-group">
                    <input type="text" id="opportunitySearch" placeholder="搜尋商機名稱或公司名稱...">
                </div>

                <div class="loading" id="opportunitiesLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">載入商機中...</p>
                </div>

                <table class="data-table" id="opportunitiesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>選擇</th>
                            <th>商機名稱</th>
                            <th>公司</th>
                            <th>金額</th>
                            <th>狀態</th>
                        </tr>
                    </thead>
                    <tbody id="opportunitiesTableBody">
                        <!-- Dynamic content -->
                    </tbody>
                </table>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="window.location.href='project-list.html'">取消</button>
                    <button class="btn btn-primary" id="step1-next" onclick="nextStep()" disabled>下一步</button>
                </div>
            </div>

            <!-- Step 2: Select Engineering Types -->
            <div class="step-content" id="step-content-2">
                <h2>選擇工程類型</h2>
                <p style="color: #6b7280; margin-bottom: 1.5rem;">請選擇此專案要包含的工程類型（單選）</p>
                
                <div class="loading" id="engineeringTypesLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">載入工程類型...</p>
                </div>

                <div class="engineering-types-grid" id="engineeringTypesGrid">
                    <!-- Dynamic content -->
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()">上一步</button>
                    <button class="btn btn-primary" id="step2-next" onclick="nextStep()" disabled>下一步</button>
                </div>
            </div>

            <!-- Step 3: Display Statistics -->
            <div class="step-content" id="step-content-3">
                <h2>工程統計資料</h2>
                
                <div class="loading" id="statisticsLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">載入統計資料...</p>
                </div>

                <div id="statisticsContent">
                    <!-- Dynamic content -->
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()">上一步</button>
                    <button class="btn btn-primary" onclick="nextStep()">下一步</button>
                </div>
            </div>

            <!-- Step 4: Set Permissions -->
            <div class="step-content" id="step-content-4">
                <h2>設定權限</h2>
                
                <div class="loading" id="permissionsLoading">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem; color: #6b7280;">載入權限設定...</p>
                </div>
                
                <div id="permissionsContent">
                    <!-- Dynamic content -->
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()" id="step4-prev">上一步</button>
                    <button class="btn btn-success" onclick="createProject()" id="step4-submit">建立專案</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load configuration -->
    <script src="config.js"></script>
    <script src="js/unified-auth.js"></script>
    
    <script>
        // ========================================
        // Global Variables
        // ========================================
        let currentStep = 1;
        let selectedOpportunity = null;
        let selectedEngineeringTypes = [];
        let availableEngineeringTypes = [];
        let contacts = []; // 商機連絡人（全域變數）
        let masters = []; // 工地師傅（全域變數）
        let availableTeams = [];
        let projectData = {};
        let engineeringStats = {};

        // API Configuration
        const API_BASE_URL = CONFIG?.API?.CRM_API_URL || 'https://fx-d1-rest-api.lai-jameslai.workers.dev';
        // 使用統一配置的 API URL，無 hardcode fallback
        const WORKER_API_URL = CONFIG?.API?.WORKER_API_URL || (
            console.error('CONFIG.API.WORKER_API_URL not found! Please check config.js is loaded.'),
            'ERROR_NO_API_CONFIG'
        );
        const API_TOKEN = CONFIG?.API?.CRM_API_TOKEN || 'fx-crm-api-secret-2025';
        const USE_V2_API = false; // Use fallback data since V2 API endpoints don't exist

        // ========================================
        // Initialization
        // ========================================
        // Global variables for edit mode
        let isEditMode = false;
        let editProjectId = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if we're in edit mode
            const urlParams = new URLSearchParams(window.location.search);
            editProjectId = urlParams.get('id');
            isEditMode = !!editProjectId;
            
            if (isEditMode) {
                // Update UI for edit mode
                document.querySelector('.header h1').textContent = '編輯工程專案';
                document.querySelector('.breadcrumb').textContent = '專案管理 > 專案列表 > 編輯專案';
                
                // Load existing project data
                await loadProjectForEdit(editProjectId);
                
                // 直接跳到第 4 步（設定權限）
                jumpToStep(4);
                
                // 更新按鈕文字和行為
                const submitButton = document.getElementById('step4-submit');
                if (submitButton) {
                    submitButton.textContent = '更新專案';
                    submitButton.onclick = updateProject;
                }
                
                // 隱藏上一步按鈕（編輯模式不需要）
                const prevButton = document.getElementById('step4-prev');
                if (prevButton) {
                    prevButton.style.display = 'none';
                }
            }
            
            await loadEngineeringTypes();
            await loadTeams();
            await loadOpportunities();
            setupEventListeners();
        });

        // ========================================
        // Step Navigation
        // ========================================
        function jumpToStep(stepNumber) {
            // 隱藏所有步驟
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step-${i}`).classList.remove('active', 'completed');
                document.getElementById(`step-content-${i}`).classList.remove('active');
            }
            
            // 標記之前的步驟為完成
            for (let i = 1; i < stepNumber; i++) {
                document.getElementById(`step-${i}`).classList.add('completed');
            }
            
            // 顯示目標步驟
            currentStep = stepNumber;
            document.getElementById(`step-${stepNumber}`).classList.add('active');
            document.getElementById(`step-content-${stepNumber}`).classList.add('active');
            
            // 載入該步驟的資料
            if (stepNumber === 3) {
                loadStatistics();
            } else if (stepNumber === 4) {
                loadPermissions();
            }
        }
        
        function nextStep() {
            if (currentStep < 4) {
                // Mark current step as completed
                document.getElementById(`step-${currentStep}`).classList.add('completed');
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                document.getElementById(`step-content-${currentStep}`).classList.remove('active');
                
                // Move to next step
                currentStep++;
                document.getElementById(`step-${currentStep}`).classList.add('active');
                document.getElementById(`step-content-${currentStep}`).classList.add('active');
                
                // Load data for the new step
                if (currentStep === 3) {
                    loadStatistics();
                } else if (currentStep === 4) {
                    loadPermissions();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                document.getElementById(`step-content-${currentStep}`).classList.remove('active');
                
                currentStep--;
                document.getElementById(`step-${currentStep}`).classList.remove('completed');
                document.getElementById(`step-${currentStep}`).classList.add('active');
                document.getElementById(`step-content-${currentStep}`).classList.add('active');
            }
        }

        // ========================================
        // Data Loading Functions
        // ========================================
        async function loadEngineeringTypes() {
            const loading = document.getElementById('engineeringTypesLoading');
            const grid = document.getElementById('engineeringTypesGrid');
            
            loading.classList.add('active');
            
            try {
                if (USE_V2_API) {
                    const response = await fetch(`${WORKER_API_URL}/api/v2/engineering-types`);
                    const result = await response.json();
                    availableEngineeringTypes = result.data || [];
                } else {
                    // Fallback to hardcoded types
                    availableEngineeringTypes = [
                        { code: 'SPC', name: 'SPC 石塑地板', description: '石塑複合地板工程', icon: '🏗️' },
                        { code: 'CABINET', name: '浴櫃工程', description: '浴室櫃體安裝工程', icon: '🚿' }
                    ];
                }
                
                // Render engineering type cards
                grid.innerHTML = availableEngineeringTypes.map(type => `
                    <div class="engineering-type-card" data-type="${type.code}">
                        <div class="engineering-type-icon">${type.icon || '📦'}</div>
                        <div class="engineering-type-name">${type.name}</div>
                        <div class="engineering-type-desc">${type.description || ''}</div>
                    </div>
                `).join('');
                
                // Add click handlers
                document.querySelectorAll('.engineering-type-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const type = this.dataset.type;
                        
                        // 單選模式：先清除其他選擇
                        document.querySelectorAll('.engineering-type-card').forEach(card => {
                            card.classList.remove('active');
                        });
                        selectedEngineeringTypes = [];
                        
                        // 選中當前項目
                        this.classList.add('active');
                        selectedEngineeringTypes = [type];
                        
                        // 儲存選擇的工程類型（確保變數能夠保持）
                        window.selectedEngineeringTypes = selectedEngineeringTypes;
                        
                        document.getElementById('step2-next').disabled = selectedEngineeringTypes.length === 0;
                    });
                });
                
            } catch (error) {
                console.error('Failed to load engineering types:', error);
                // Use fallback types
                availableEngineeringTypes = [
                    { code: 'SPC', name: 'SPC 石塑地板', description: '石塑複合地板工程', icon: '🏗️' },
                    { code: 'CABINET', name: '浴櫃工程', description: '浴室櫃體安裝工程', icon: '🚿' }
                ];
                
                // 還是要渲染 fallback 資料
                grid.innerHTML = availableEngineeringTypes.map(type => `
                    <div class="engineering-type-card" data-type="${type.code}">
                        <div class="engineering-type-icon">${type.icon || '📦'}</div>
                        <div class="engineering-type-name">${type.name}</div>
                        <div class="engineering-type-desc">${type.description || ''}</div>
                    </div>
                `).join('');
                
                // Add click handlers
                document.querySelectorAll('.engineering-type-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const type = this.dataset.type;
                        
                        // 單選模式：先清除其他選擇
                        document.querySelectorAll('.engineering-type-card').forEach(card => {
                            card.classList.remove('active');
                        });
                        selectedEngineeringTypes = [];
                        
                        // 選中當前項目
                        this.classList.add('active');
                        selectedEngineeringTypes = [type];
                        
                        // 儲存選擇的工程類型（確保變數能夠保持）
                        window.selectedEngineeringTypes = selectedEngineeringTypes;
                        
                        document.getElementById('step2-next').disabled = selectedEngineeringTypes.length === 0;
                    });
                });
            } finally {
                loading.classList.remove('active');
            }
        }

        async function loadTeams() {
            try {
                if (USE_V2_API) {
                    const response = await fetch(`${WORKER_API_URL}/api/v2/teams`);
                    const result = await response.json();
                    availableTeams = result.data || [];
                }
            } catch (error) {
                console.error('Failed to load teams:', error);
                availableTeams = [];
            }
        }

        async function loadOpportunities() {
            // 如果是編輯模式，跳過載入商機
            if (isEditMode) {
                console.log('Edit mode - skipping opportunities loading');
                return;
            }
            
            const loading = document.getElementById('opportunitiesLoading');
            const table = document.getElementById('opportunitiesTable');
            const tbody = document.getElementById('opportunitiesTableBody');
            
            // 檢查 DOM 元素是否存在
            if (!loading || !table || !tbody) {
                console.warn('Opportunities elements not found - skipping load');
                return;
            }
            
            loading.classList.add('active');
            table.style.display = 'none';
            
            try {
                // 直接獲取所有商機，不使用 filter（filter 參數格式有問題）
                const response = await fetch(`${API_BASE_URL}/rest/newopportunityobj?limit=500`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });
                
                const result = await response.json();
                // 在前端過濾出贏單的商機
                const opportunities = (result.results || []).filter(opp => 
                    opp.sales_status__r === '贏單' || opp.sales_status === '2'
                );
                
                console.log(`Loaded ${opportunities.length} winning opportunities`);
                
                // Render opportunities
                tbody.innerHTML = opportunities.map(opp => `
                    <tr onclick="selectOpportunity('${opp._id}', '${(opp.name || '').replace(/'/g, "\\'")}', '${(opp.account_id__r || '').replace(/'/g, "\\'")}')">
                        <td><input type="radio" name="opportunity" value="${opp._id}"></td>
                        <td>${opp.name || ''}</td>
                        <td>${opp.account_id__r || ''}</td>
                        <td>${formatCurrency(opp.amount || 0)}</td>
                        <td><span class="badge">${opp.sales_status__r || ''}</span></td>
                    </tr>
                `).join('');
                
                table.style.display = 'table';
                
            } catch (error) {
                console.error('Failed to load opportunities:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc2626;">載入失敗</td></tr>';
                table.style.display = 'table';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function loadStatistics() {
            const loading = document.getElementById('statisticsLoading');
            const content = document.getElementById('statisticsContent');
            
            loading.classList.add('active');
            content.innerHTML = '';
            
            try {
                // Load statistics for each selected engineering type
                for (const type of selectedEngineeringTypes) {
                    const stats = await loadEngineeringStats(type);
                    engineeringStats[type] = stats;
                    
                    // 儲存統計資料（確保變數能夠保持）
                    window.engineeringStats = engineeringStats;
                    
                    // Render statistics
                    const typeInfo = availableEngineeringTypes.find(t => t.code === type);
                    content.innerHTML += `
                        <div class="stats-section">
                            <h3>${typeInfo?.icon || ''} ${typeInfo?.name || type}</h3>
                            <table class="data-table">
                                <tr>
                                    <td>案場總數</td>
                                    <td><span class="stat-value">${stats.siteCount || 0}</span></td>
                                </tr>
                                <tr>
                                    <td>工班數量</td>
                                    <td><span class="stat-value">${stats.teamCount || 0}</span></td>
                                </tr>
                                <tr>
                                    <td>維修單數量</td>
                                    <td><span class="stat-value">${stats.maintenanceCount || 0}</span></td>
                                </tr>
                                <tr>
                                    <td>進度管理公告</td>
                                    <td><span class="stat-value">${stats.announcementCount || 0}</span></td>
                                </tr>
                            </table>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
                content.innerHTML = '<div class="alert alert-error">載入統計資料失敗</div>';
            } finally {
                loading.classList.remove('active');
            }
        }

        async function loadEngineeringStats(type) {
            // 從 CRM API 載入實際的案場統計資料
            if (!selectedOpportunity || !selectedOpportunity.id) {
                return { siteCount: 0, teamCount: 0, maintenanceCount: 0, announcementCount: 0 };
            }
            
            try {
                let siteCount = 0;
                let teamCount = 0;
                let maintenanceCount = 0;
                let announcementCount = 0;
                
                if (type === 'SPC') {
                    // 查詢 SPC 案場數量 (object_8w9cb__c)
                    const spcResponse = await fetch(
                        `${API_BASE_URL}/rest/object_8w9cb__c?field_1P96q__c=${selectedOpportunity.id}&limit=1000`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        }
                    );
                    
                    if (spcResponse.ok) {
                        const spcData = await spcResponse.json();
                        const sites = spcData.results || [];
                        siteCount = sites.length;
                        
                        // 計算不重複的工班數量（從 shift_time__c 欄位）
                        const uniqueTeams = new Set();
                        sites.forEach(site => {
                            if (site.shift_time__c) {
                                uniqueTeams.add(site.shift_time__c);
                            }
                        });
                        teamCount = uniqueTeams.size;
                    }
                    
                    // 查詢維修單數量 (object_k1XqG__c)
                    const maintenanceResponse = await fetch(
                        `${API_BASE_URL}/rest/object_k1XqG__c?field_1P96q__c=${selectedOpportunity.id}&limit=1000`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        }
                    );
                    
                    if (maintenanceResponse.ok) {
                        const maintenanceData = await maintenanceResponse.json();
                        maintenanceCount = maintenanceData.results ? maintenanceData.results.length : 0;
                    }
                    
                } else if (type === 'CABINET') {
                    // 查詢浴櫃案場數量 (site_cabinet__c)
                    const cabinetResponse = await fetch(
                        `${API_BASE_URL}/rest/site_cabinet__c?field_1P96q__c=${selectedOpportunity.id}&limit=1000`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        }
                    );
                    
                    if (cabinetResponse.ok) {
                        const cabinetData = await cabinetResponse.json();
                        const sites = cabinetData.results || [];
                        siteCount = sites.length;
                        
                        // 計算不重複的工班數量（從 shift_time__c 欄位）
                        const uniqueTeams = new Set();
                        sites.forEach(site => {
                            if (site.shift_time__c) {
                                uniqueTeams.add(site.shift_time__c);
                            }
                        });
                        teamCount = uniqueTeams.size;
                    }
                    
                    // 浴櫃也可能有維修單
                    const maintenanceResponse = await fetch(
                        `${API_BASE_URL}/rest/object_k1XqG__c?field_1P96q__c=${selectedOpportunity.id}&limit=1000`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        }
                    );
                    
                    if (maintenanceResponse.ok) {
                        const maintenanceData = await maintenanceResponse.json();
                        maintenanceCount = maintenanceData.results ? maintenanceData.results.length : 0;
                    }
                }
                
                // 查詢進度管理公告數量 (progress_management_announ__c)
                const announcementResponse = await fetch(
                    `${API_BASE_URL}/rest/progress_management_announ__c?field_1P96q__c=${selectedOpportunity.id}&limit=1000`,
                    {
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    }
                );
                
                if (announcementResponse.ok) {
                    const announcementData = await announcementResponse.json();
                    announcementCount = announcementData.results ? announcementData.results.length : 0;
                }
                
                console.log(`Loaded stats for ${type}: sites=${siteCount}, teams=${teamCount}, maintenance=${maintenanceCount}, announcements=${announcementCount}`);
                return { siteCount, teamCount, maintenanceCount, announcementCount };
                
            } catch (error) {
                console.error(`Failed to load engineering stats for ${type}:`, error);
                // API 失敗時返回 0
                return { siteCount: 0, teamCount: 0, maintenanceCount: 0, announcementCount: 0 };
            }
        }

        async function loadPermissions() {
            const content = document.getElementById('permissionsContent');
            const loading = document.getElementById('permissionsLoading');
            
            console.log('Loading permissions...');
            
            if (loading) {
                loading.classList.add('active');
            }
            content.innerHTML = '';
            
            try {
                // 獲取工班負責人列表（從工地師父 object_50HJ8__c）
                const mastersResponse = await fetch(
                    `${API_BASE_URL}/rest/object_50HJ8__c?limit=100`,
                    {
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    }
                );
                
                // 使用全域變數 masters
                if (mastersResponse.ok) {
                    const mastersData = await mastersResponse.json();
                    masters = mastersData.results || [];
                }
                
                // 獲取商機連絡人（從 NewOpportunityContactsObj）
                contacts = []; // 使用全域變數
                if (selectedOpportunity) {
                    console.log('Fetching contacts for opportunity:', selectedOpportunity.id);
                    const contactsResponse = await fetch(
                        `${API_BASE_URL}/rest/NewOpportunityContactsObj?new_opportunity_id=${selectedOpportunity.id}&limit=100`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        }
                    );
                    
                    if (contactsResponse.ok) {
                        const contactsData = await contactsResponse.json();
                        contacts = contactsData.results || [];
                        console.log(`Found ${contacts.length} contacts for opportunity`);
                        
                        // 如果沒有聯絡人，嘗試從商機本身獲取
                        if (contacts.length === 0 && selectedOpportunity) {
                            console.log('No contacts found, checking opportunity details');
                            // 可以從商機本身的聯絡人欄位獲取
                            if (selectedOpportunity.contact_name || selectedOpportunity.contact_phone) {
                                contacts.push({
                                    _id: `opp_contact_${selectedOpportunity.id}`,
                                    name: selectedOpportunity.contact_name || selectedOpportunity.company,
                                    phone: selectedOpportunity.contact_phone || '',
                                    title: '業主'
                                });
                            }
                        }
                    } else {
                        console.error('Failed to fetch contacts:', contactsResponse.status);
                    }
                }
                
                // 從統計資料中獲取工班列表
                const teams = new Set();
                for (const type of selectedEngineeringTypes) {
                    if (engineeringStats[type]) {
                        // 重新查詢以獲取詳細的工班資訊
                        const tableName = type === 'SPC' ? 'object_8w9cb__c' : 'site_cabinet__c';
                        const siteResponse = await fetch(
                            `${API_BASE_URL}/rest/${tableName}?field_1P96q__c=${selectedOpportunity.id}&limit=1000`,
                            {
                                headers: {
                                    'Authorization': `Bearer ${API_TOKEN}`
                                }
                            }
                        );
                        
                        if (siteResponse.ok) {
                            const siteData = await siteResponse.json();
                            const sites = siteData.results || [];
                            sites.forEach(site => {
                                if (site.shift_time__c) {
                                    teams.add(site.shift_time__c);
                                }
                            });
                        }
                    }
                }
                
                const teamList = Array.from(teams);
                
                // 建立權限設置介面
                let permissionsHTML = '';
                
                // 編輯模式下的狀態設置
                if (isEditMode) {
                    const savedProject = localStorage.getItem('demo_created_project');
                    let currentStatus = 'not_started';
                    let currentStartDate = '';
                    let currentEndDate = '';
                    
                    if (savedProject) {
                        const project = JSON.parse(savedProject);
                        currentStatus = project.project_status || 'not_started';
                        currentStartDate = project.start_date || '';
                        currentEndDate = project.end_date || '';
                    }
                    
                    permissionsHTML += `
                        <div class="permissions-section">
                            <h3>專案設定</h3>
                            <div class="form-group">
                                <label>專案狀態</label>
                                <select id="projectStatus" class="filter-select">
                                    <option value="not_started" ${currentStatus === 'not_started' ? 'selected' : ''}>尚未開始</option>
                                    <option value="in_progress" ${currentStatus === 'in_progress' ? 'selected' : ''}>進行中</option>
                                    <option value="maintenance" ${currentStatus === 'maintenance' ? 'selected' : ''}>維修中</option>
                                    <option value="warranty" ${currentStatus === 'warranty' ? 'selected' : ''}>保固中</option>
                                    <option value="completed" ${currentStatus === 'completed' ? 'selected' : ''}>已完工</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>開始日期</label>
                                <input type="date" id="startDate" value="${currentStartDate}">
                            </div>
                            
                            <div class="form-group">
                                <label>結束日期</label>
                                <input type="date" id="endDate" value="${currentEndDate}">
                            </div>
                        </div>
                    `;
                }
                
                // 業主設定
                permissionsHTML += `
                    <div class="permissions-section">
                        <h3>業主設定</h3>
                        <div class="form-group">
                            <label>選擇業主（從商機連絡人）</label>
                            <select id="projectOwner" class="filter-select" multiple style="height: 120px;">
                                ${contacts.length > 0 ? 
                                    contacts.map(contact => {
                                        // 顯示更多聯絡人資訊
                                        const displayName = contact.name || contact.contact_name || '未命名';
                                        const phone = contact.phone || contact.contact_phone__c || '';
                                        const title = contact.title || contact.contact_title__c || '';
                                        const label = `${displayName}${title ? ` (${title})` : ''}${phone ? ` - ${phone}` : ''}`;
                                        return `<option value="${contact._id}" data-phone="${phone}" data-name="${displayName}" data-title="${title}">${label}</option>`;
                                    }).join('') : 
                                    '<option value="" disabled>無商機聯絡人資料</option>'
                                }
                            </select>
                            <small style="color: #6b7280;">按住 Ctrl/Cmd 可多選業主</small>
                        </div>
                    </div>
                `;
                
                // 工班權限設定
                if (teamList.length > 0) {
                    permissionsHTML += `
                        <div class="permissions-section">
                            <h3>工班權限設定</h3>
                            <p style="color: #6b7280; margin-bottom: 1rem;">為每個工班設定負責人和查看權限</p>
                            
                            <table class="permissions-table">
                                <thead>
                                    <tr>
                                        <th>工班</th>
                                        <th>工班負責人</th>
                                        <th>可查看其他工班進度</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${teamList.map((team, index) => `
                                        <tr>
                                            <td>${team}</td>
                                            <td>
                                                <div style="position: relative;">
                                                    <input type="text" 
                                                           class="team-leader-search" 
                                                           data-team="${team}"
                                                           placeholder="搜尋並選擇負責人..."
                                                           style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;"
                                                           onclick="toggleLeaderDropdown('${team}')">
                                                    <div class="team-leader-dropdown" 
                                                         id="dropdown-${team}"
                                                         data-team="${team}"
                                                         style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-radius: 4px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                                        ${masters.map(master => {
                                                            const name = master.name || master.field_name__c || '未命名';
                                                            const phone = master.phone || master.field_phone__c || '';
                                                            return `
                                                                <div class="team-leader-option" 
                                                                     data-team="${team}"
                                                                     data-id="${master._id}"
                                                                     data-name="${name}"
                                                                     data-phone="${phone}"
                                                                     style="padding: 8px; cursor: pointer; border-bottom: 1px solid #f3f4f6;"
                                                                     onmouseover="this.style.backgroundColor='#f3f4f6'"
                                                                     onmouseout="this.style.backgroundColor='white'">
                                                                    <input type="checkbox" 
                                                                           class="team-leader-checkbox"
                                                                           data-team="${team}"
                                                                           value="${master._id}"
                                                                           style="margin-right: 8px;"
                                                                           onchange="updateSelectedLeaders('${team}')">
                                                                    ${name}${phone ? ` (${phone})` : ''}
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                    </div>
                                                    <div class="selected-leaders" id="selected-${team}" data-team="${team}" style="margin-top: 8px; color: #4f46e5; font-size: 0.9rem;"></div>
                                                </div>
                                            </td>
                                            <td>
                                                <label class="switch">
                                                    <input type="checkbox" class="team-view-others" data-team="${team}">
                                                    <span class="slider"></span>
                                                </label>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    permissionsHTML += `
                        <div class="alert alert-info">
                            <p>尚無工班資料，權限將在建立專案後自動配置</p>
                        </div>
                    `;
                }
                
                content.innerHTML = permissionsHTML;
                
            } catch (error) {
                console.error('Failed to load permissions data:', error);
                content.innerHTML = `
                    <div class="alert alert-error">
                        載入權限設定失敗，將使用預設權限
                    </div>
                `;
            } finally {
                if (loading) {
                    loading.classList.remove('active');
                }
            }
        }

        // ========================================
        // Event Handlers
        // ========================================
        function setupEventListeners() {
            // Search functionality
            document.getElementById('opportunitySearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#opportunitiesTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        function selectOpportunity(id, name, company) {
            selectedOpportunity = { id, name, company };
            
            // 儲存選擇的商機（確保變數能夠保持）
            window.selectedOpportunity = selectedOpportunity;
            
            // Update UI
            document.querySelectorAll('input[name="opportunity"]').forEach(radio => {
                radio.checked = radio.value === id;
            });
            
            // Enable next button
            document.getElementById('step1-next').disabled = false;
        }

        // ========================================
        // Project Creation and Update
        // ========================================
        async function updateProject() {
            // 編輯模式專用的更新函數
            if (!confirm('確定要更新此專案嗎？')) return;
            
            try {
                // 獲取當前儲存的專案資料
                const savedProject = localStorage.getItem('demo_created_project');
                if (savedProject) {
                    const project = JSON.parse(savedProject);
                    
                    // 更新專案狀態和日期
                    const statusSelect = document.getElementById('projectStatus');
                    const startDateInput = document.getElementById('startDate');
                    const endDateInput = document.getElementById('endDate');
                    
                    if (statusSelect) {
                        project.project_status = statusSelect.value;
                    }
                    if (startDateInput) {
                        project.start_date = startDateInput.value;
                    }
                    if (endDateInput) {
                        project.end_date = endDateInput.value;
                    }
                    
                    // 更新時間戳記
                    project.lastUpdate = new Date().toLocaleDateString('zh-TW');
                    project.updated_at = new Date().toISOString();
                    
                    // 不再儲存到 localStorage，避免重複顯示
                    // localStorage.setItem('demo_created_project', JSON.stringify(project));
                    
                    alert('專案更新成功！');
                    window.location.href = 'project-list.html';
                } else {
                    throw new Error('無法找到專案資料');
                }
            } catch (error) {
                console.error('Failed to update project:', error);
                alert('專案更新失敗：' + error.message);
            }
        }
        
        // 同步建立 Supabase 認證帳號
        async function syncAuthAccounts(permissions) {
            if (!window.supabase) return;
            
            try {
                const authPromises = [];
                
                // 為業主建立帳號（如果有選擇）
                if (permissions.owner) {
                    // 從連絡人資料中獲取詳細資訊
                    const ownerContact = contacts.find(c => c._id === permissions.owner);
                    if (ownerContact && ownerContact.phone) {
                        authPromises.push(createSupabaseUser({
                            phone: ownerContact.phone,
                            name: ownerContact.name || ownerContact.contact_name,
                            role: 'owner',
                            d1_user_id: permissions.owner
                        }));
                    }
                }
                
                // 為工班負責人建立帳號
                for (const team of permissions.teams) {
                    if (team.leaderId) {
                        const leader = masters.find(m => m._id === team.leaderId);
                        if (leader && leader.phone) {
                            authPromises.push(createSupabaseUser({
                                phone: leader.phone,
                                name: leader.name || leader.field_name__c,
                                role: 'foreman',
                                d1_user_id: team.leaderId
                            }));
                        }
                    }
                }
                
                // 等待所有帳號建立完成
                const results = await Promise.allSettled(authPromises);
                
                // 記錄結果
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled') {
                        console.log(`認證帳號建立成功: ${result.value}`);
                    } else {
                        console.warn(`認證帳號建立失敗: ${result.reason}`);
                    }
                });
                
            } catch (error) {
                console.error('同步認證帳號時發生錯誤:', error);
                // 不中斷專案建立流程
            }
        }
        
        // 建立單個 Supabase 用戶
        async function createSupabaseUser(userData) {
            const { phone, name, role, d1_user_id } = userData;
            const password = phone.slice(-3); // 密碼為電話末3碼
            
            try {
                // 建立或更新 Supabase 用戶
                const { data, error } = await window.supabase.auth.signUp({
                    email: `${phone}@construction.local`, // 使用虛擬 email
                    password: password,
                    options: {
                        data: {
                            phone: phone,
                            full_name: name,
                            role: role,
                            d1_user_id: d1_user_id
                        }
                    }
                });
                
                if (error && !error.message.includes('already registered')) {
                    throw error;
                }
                
                // 建立映射關係（通過 API 或直接寫入）
                if (data?.user) {
                    await createAuthMapping(data.user.id, d1_user_id, phone);
                }
                
                return `${name} (${phone})`;
            } catch (error) {
                console.error(`建立用戶 ${phone} 失敗:`, error);
                throw error;
            }
        }
        
        // 建立認證映射
        async function createAuthMapping(authUserId, d1UserId, phone) {
            // 這裡可以呼叫後端 API 來建立映射關係
            // 或者直接寫入 Supabase 的 auth_mapping 表
            if (window.supabase) {
                const { error } = await window.supabase
                    .from('auth_mapping')
                    .upsert({
                        auth_user_id: authUserId,
                        d1_user_id: d1UserId,
                        d1_user_phone: phone,
                        last_synced_at: new Date().toISOString()
                    });
                
                if (error) {
                    console.error('建立認證映射失敗:', error);
                }
            }
        }
        
        async function createProject() {
            const confirmMessage = isEditMode ? '確定要更新此專案嗎？' : '確定要建立此專案嗎？';
            if (!confirm(confirmMessage)) return;
            
            // 收集權限設置
            const ownerSelect = document.getElementById('projectOwner');
            const selectedOwners = ownerSelect ? Array.from(ownerSelect.selectedOptions).map(opt => ({
                userId: opt.value,
                name: opt.getAttribute('data-name'),
                phone: opt.getAttribute('data-phone'),
                role: 'owner'
            })) : [];
            
            const permissions = {
                owners: selectedOwners,
                teamLeaders: [],
                teamMembers: [],
                teams: []
            };
            
            // 如果有 Supabase 整合，同步建立認證帳號
            if (window.supabase && !isEditMode) {
                await syncAuthAccounts(permissions);
            }
            
            // 收集每個工班的權限設置
            const teamLeaderSelects = document.querySelectorAll('.team-leader-select');
            const teamViewOthersCheckboxes = document.querySelectorAll('.team-view-others');
            
            // 收集每個工班的多個負責人
            const teams = new Set();
            document.querySelectorAll('[data-team]').forEach(elem => {
                const teamName = elem.getAttribute('data-team');
                if (teamName) teams.add(teamName);
            });
            
            teams.forEach(teamName => {
                // 獲取該工班選中的所有負責人
                const checkboxes = document.querySelectorAll(`.team-leader-checkbox[data-team="${teamName}"]:checked`);
                const leaders = Array.from(checkboxes).map(cb => {
                    const option = cb.closest('.team-leader-option');
                    return {
                        userId: cb.value,
                        name: option.getAttribute('data-name'),
                        phone: option.getAttribute('data-phone'),
                        role: 'team_leader',
                        teamId: teamName
                    };
                });
                
                // 將負責人加入 teamLeaders 陣列
                permissions.teamLeaders.push(...leaders);
                
                const canViewOthers = document.querySelector(`.team-view-others[data-team="${teamName}"]`)?.checked || false;
                
                permissions.teams.push({
                    name: teamName,
                    leaders: leaders.map(l => l.userId),
                    canViewOthers: canViewOthers
                });
            });
            
            // Prepare project data in V1 format (compatible with current backend)
            const projectData = {
                opportunityId: selectedOpportunity.id,
                name: selectedOpportunity.name,
                spcEngineering: selectedEngineeringTypes.includes('SPC') ? {
                    enabled: true,
                    siteCount: (engineeringStats && engineeringStats['SPC'] && engineeringStats['SPC'].siteCount) || 0,
                    teamCount: (engineeringStats && engineeringStats['SPC'] && engineeringStats['SPC'].teamCount) || 0,
                    maintenanceCount: (engineeringStats && engineeringStats['SPC'] && engineeringStats['SPC'].maintenanceCount) || 0,
                    announcementCount: (engineeringStats && engineeringStats['SPC'] && engineeringStats['SPC'].announcementCount) || 0
                } : {},
                cabinetEngineering: selectedEngineeringTypes.includes('CABINET') ? {
                    enabled: true,
                    siteCount: (engineeringStats && engineeringStats['CABINET'] && engineeringStats['CABINET'].siteCount) || 0,
                    teamCount: (engineeringStats && engineeringStats['CABINET'] && engineeringStats['CABINET'].teamCount) || 0,
                    maintenanceCount: (engineeringStats && engineeringStats['CABINET'] && engineeringStats['CABINET'].maintenanceCount) || 0,
                    announcementCount: (engineeringStats && engineeringStats['CABINET'] && engineeringStats['CABINET'].announcementCount) || 0
                } : {},
                permissions: permissions,
                projectStatus: isEditMode ? (document.getElementById('projectStatus')?.value || 'not_started') : 'not_started',
                startDate: isEditMode ? document.getElementById('startDate')?.value : null,
                endDate: isEditMode ? document.getElementById('endDate')?.value : null,
                createdBy: 'system',
                teams: permissions.teams
            };
            
            try {
                const token = localStorage.getItem('auth_token');
                
                if (!token) {
                    alert('請先登入');
                    window.location.href = 'login-simple.html';
                    return;
                }
                let apiUrl, method;
                if (isEditMode) {
                    apiUrl = USE_V2_API ? `/api/v2/projects/${editProjectId}` : `/api/v1/projects/${editProjectId}`;
                    method = 'PUT';
                } else {
                    apiUrl = USE_V2_API ? '/api/v2/projects' : '/api/v1/projects';
                    method = 'POST';
                }
                
                const response = await fetch(`${WORKER_API_URL}${apiUrl}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(projectData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Project created:', result);
                    
                    // Save to localStorage for demo
                    const demoProject = {
                        id: selectedOpportunity.id,
                        name: selectedOpportunity.name,
                        company: selectedOpportunity.company,
                        company_name: selectedOpportunity.company, // 確保兩個欄位都有值
                        status: 'active',
                        project_status: 'not_started', // 新專案預設為「尚未開始」
                        engineeringTypes: selectedEngineeringTypes,
                        progress: 0,
                        unit_count: Object.values(engineeringStats).reduce((sum, s) => sum + (s.siteCount || 0), 0),
                        completed_count: 0,
                        lastUpdate: new Date().toLocaleDateString('zh-TW'),
                        created_at: new Date().toISOString(),
                        start_date: null,
                        end_date: null
                    };
                    // 不再儲存到 localStorage，避免重複顯示
                    // localStorage.setItem('demo_created_project', JSON.stringify(demoProject));
                    
                    const successMessage = isEditMode ? '專案更新成功！' : '專案建立成功！';
                    alert(successMessage);
                    window.location.href = 'project-list.html';
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'API error');
                }
            } catch (error) {
                console.error('Failed to save project:', error);
                const errorMessage = isEditMode ? '專案更新失敗：' : '專案建立失敗：';
                alert(errorMessage + error.message);
            }
        }

        // ========================================
        // Edit Mode Functions
        // ========================================
        async function loadProjectForEdit(projectId) {
            try {
                // 先嘗試從 localStorage 載入（用於示範）
                const savedProject = localStorage.getItem('demo_created_project');
                if (savedProject) {
                    const localProject = JSON.parse(savedProject);
                    if (localProject.id === projectId) {
                        fillFormWithProjectData(localProject);
                        return;
                    }
                }
                
                // 嘗試從 API 載入
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}`, {
                    headers: window.UnifiedAuth.getRequestHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('無法載入專案資料');
                }
                
                const data = await response.json();
                const project = data.project || data.data || data;
                
                // Fill form fields with existing data
                fillFormWithProjectData(project);
                
            } catch (error) {
                console.error('Failed to load project for edit:', error);
                // 不要立即跳轉，讓用戶可以手動填寫
                alert('無法從伺服器載入專案資料，請手動輸入');
            }
        }
        
        function fillFormWithProjectData(project) {
            // Step 1: Opportunity Selection
            if (project.id || project.opportunity_id) {
                const oppId = project.opportunity_id || project.id;
                const oppName = project.opportunity_name || project.name || '';
                const company = project.company || project.company_name || '';
                selectOpportunity(oppId, oppName, company);
            }
            
            // Step 2: Engineering Types
            if (project.engineeringTypes && Array.isArray(project.engineeringTypes)) {
                selectedEngineeringTypes = project.engineeringTypes;
                // 等待工程類型載入後再選中
                setTimeout(() => {
                    project.engineeringTypes.forEach(type => {
                        const card = document.querySelector(`.engineering-type-card[data-type="${type}"]`);
                        if (card) {
                            card.classList.add('selected');
                        }
                    });
                    document.getElementById('step2-next').disabled = selectedEngineeringTypes.length === 0;
                }, 500);
            }
            
            // Sites data
            if (project.sites && Array.isArray(project.sites)) {
                // Clear existing sites first
                document.getElementById('sitesContainer').innerHTML = '';
                
                project.sites.forEach(site => {
                    addSiteToContainer(site);
                });
            }
            
            // Permissions
            if (project.permissions && Array.isArray(project.permissions)) {
                project.permissions.forEach(permission => {
                    const row = document.querySelector(`tr[data-user-id="${permission.user_id}"]`);
                    if (row) {
                        const select = row.querySelector('select');
                        if (select) {
                            select.value = permission.role;
                        }
                    }
                });
            }
        }
        
        function addSiteToContainer(site) {
            const sitesContainer = document.getElementById('sitesContainer');
            const siteDiv = document.createElement('div');
            siteDiv.className = 'site-item';
            siteDiv.innerHTML = `
                <div class="site-info">
                    <h4>${site.name || site.site_name}</h4>
                    <p>${site.address || site.site_address || ''}</p>
                    <div class="site-stats">
                        <span>SPC: ${site.spc_count || 0}</span>
                        <span>浴櫃: ${site.cabinet_count || 0}</span>
                    </div>
                </div>
                <button type="button" class="btn-remove" onclick="removeSite(this, '${site.id}')">移除</button>
            `;
            sitesContainer.appendChild(siteDiv);
        }

        // ========================================
        // Helper Functions
        // ========================================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        // 切換工班負責人下拉選單
        function toggleLeaderDropdown(teamName) {
            const dropdown = document.getElementById(`dropdown-${teamName}`);
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }
            
            // 關閉其他下拉選單
            document.querySelectorAll('.team-leader-dropdown').forEach(dd => {
                if (dd.id !== `dropdown-${teamName}`) {
                    dd.style.display = 'none';
                }
            });
        }
        
        // 更新選中的負責人顯示
        function updateSelectedLeaders(teamName) {
            const checkboxes = document.querySelectorAll(`.team-leader-checkbox[data-team="${teamName}"]:checked`);
            const selectedDiv = document.getElementById(`selected-${teamName}`);
            
            if (selectedDiv) {
                const names = Array.from(checkboxes).map(cb => {
                    const option = cb.closest('.team-leader-option');
                    return option.getAttribute('data-name');
                });
                
                if (names.length > 0) {
                    selectedDiv.textContent = `已選擇: ${names.join(', ')}`;
                } else {
                    selectedDiv.textContent = '';
                }
            }
            
            // 更新搜尋框顯示
            const searchInput = document.querySelector(`.team-leader-search[data-team="${teamName}"]`);
            if (searchInput) {
                searchInput.value = `已選擇 ${checkboxes.length} 位負責人`;
            }
        }
        
        // 搜尋工班負責人
        document.addEventListener('DOMContentLoaded', () => {
            // 為每個搜尋框添加事件
            document.querySelectorAll('.team-leader-search').forEach(input => {
                input.addEventListener('input', function() {
                    const teamName = this.getAttribute('data-team');
                    const searchText = this.value.toLowerCase();
                    const options = document.querySelectorAll(`.team-leader-option[data-team="${teamName}"]`);
                    
                    options.forEach(option => {
                        const name = option.getAttribute('data-name').toLowerCase();
                        if (name.includes(searchText) || searchText === '') {
                            option.style.display = 'block';
                        } else {
                            option.style.display = 'none';
                        }
                    });
                });
            });
            
            // 點擊外部關閉下拉選單
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.team-leader-search') && !e.target.closest('.team-leader-dropdown')) {
                    document.querySelectorAll('.team-leader-dropdown').forEach(dd => {
                        dd.style.display = 'none';
                    });
                }
            });
        });
    </script>
</body>
</html>