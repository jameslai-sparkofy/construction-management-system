<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建立工程專案 - 元心建材管理系統</title>
    <!-- 更新時間: 2025-08-10 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 500;
        }

        .breadcrumb {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Steps Progress */
        .steps-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 2rem;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #e0e7ff;
            color: #4f46e5;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: #4f46e5;
            color: white;
            transform: scale(1.1);
        }

        .step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step.completed .step-number::after {
            content: '✓';
            position: absolute;
            font-size: 1.2rem;
        }

        .step.completed .step-number span {
            display: none;
        }

        .step-title {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .step.active .step-title {
            color: #1f2937;
            font-weight: 600;
        }

        /* Content Area */
        .content-area {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            min-height: 400px;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Search Box */
        .search-section {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 500px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .search-btn {
            padding: 0.75rem 1.5rem;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #3730a3;
        }

        /* Table Container */
        .table-container {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Opportunity Table */
        .opportunity-table {
            width: 100%;
            border-collapse: collapse;
        }

        .opportunity-table thead {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-bottom: 2px solid #e5e7eb;
        }

        .opportunity-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .opportunity-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .opportunity-table tbody tr:hover {
            background: #f9fafb;
        }

        .opportunity-table tbody tr.selected {
            background: #e0e7ff;
            border-left: 3px solid #4f46e5;
        }

        .opportunity-table td {
            padding: 1rem;
            color: #1f2937;
            font-size: 0.95rem;
        }

        .radio-cell {
            width: 50px;
            text-align: center;
        }

        .opportunity-name {
            font-weight: 600;
            color: #1f2937;
        }

        .company-name {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .amount {
            font-weight: 600;
            color: #059669;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-won {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fed7aa;
            color: #92400e;
        }

        /* Step 2: Select Engineering Type */
        .engineering-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .engineering-type-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .engineering-type-card:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .engineering-type-card.selected {
            border-color: #4f46e5;
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
        }

        .engineering-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            background: #4f46e5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .engineering-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .engineering-desc {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Step 3: Statistics Table */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        .stats-table thead {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        .stats-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .stats-table td {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4f46e5;
        }

        /* Step 4: Permissions Table */
        .permission-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .permission-table thead {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        .permission-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .permission-table td {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .checkbox-cell {
            text-align: center;
        }

        .permission-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .user-name {
            font-weight: 500;
            color: #1f2937;
        }

        .user-role {
            font-size: 0.85rem;
            color: #6b7280;
        }

        /* Cross View Toggle */
        .cross-view-section {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #4f46e5;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1rem;
            color: #6b7280;
        }

        /* Alert Messages */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #86efac;
        }

        .alert-warning {
            background: #fed7aa;
            color: #92400e;
            border: 1px solid #fdba74;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Field Permissions Section */
        .field-permissions-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
        }

        .field-permissions-tabs {
            display: inline-flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            width: auto;
        }

        .permission-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 1rem;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .permission-tab:hover {
            color: #4f46e5;
        }

        .permission-tab.active {
            color: #4f46e5;
            font-weight: 600;
        }

        .permission-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #4f46e5;
        }

        .field-permissions-content {
            display: none;
        }

        .field-permissions-content.active {
            display: block;
        }

        .fields-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .fields-table thead {
            background: #f9fafb;
        }

        .fields-table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .fields-table td {
            padding: 0.75rem 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .field-name {
            font-weight: 500;
            color: #1f2937;
        }

        .field-api-name {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.2rem;
        }

        .field-type-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #f3f4f6;
            color: #6b7280;
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .quick-action-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            color: #4b5563;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-action-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>建立工程專案</h1>
        <div class="breadcrumb">
            首頁 / 專案管理 / 建立專案
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Steps Progress -->
        <div class="steps-container">
            <div class="steps">
                <div class="step active" id="step1">
                    <div class="step-number"><span>1</span></div>
                    <div class="step-title">選擇商機</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number"><span>2</span></div>
                    <div class="step-title">選擇工程類型</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number"><span>3</span></div>
                    <div class="step-title">顯示統計</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-number"><span>4</span></div>
                    <div class="step-title">設定權限</div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Step 1: Select Opportunity -->
            <div class="step-content active" id="step1-content">
                <h2 style="margin-bottom: 1rem;">選擇商機</h2>
                <div class="alert alert-info">
                    請選擇要創建專案的商機，只顯示「贏單」狀態的商機。
                </div>
                
                <!-- Search Section -->
                <div class="search-section">
                    <div class="search-box">
                        <span class="search-icon">🔍</span>
                        <input type="text" class="search-input" id="opportunitySearch" 
                               placeholder="搜尋商機名稱或公司名稱...">
                    </div>
                    <button class="search-btn" onclick="searchOpportunities()">搜尋</button>
                </div>

                <div class="loading" id="opportunities-loading">
                    <div class="spinner"></div>
                    <div class="loading-text">載入商機資料中...</div>
                </div>

                <!-- Opportunities Table -->
                <div class="table-container" id="opportunities-container" style="display: none;">
                    <table class="opportunity-table">
                        <thead>
                            <tr>
                                <th class="radio-cell">選擇</th>
                                <th>商機名稱</th>
                                <th>公司</th>
                                <th>金額</th>
                                <th>預計結案日</th>
                                <th>狀態</th>
                            </tr>
                        </thead>
                        <tbody id="opportunity-tbody">
                            <!-- 動態載入商機列表 -->
                        </tbody>
                    </table>
                </div>

                <div class="empty-state" id="opportunity-empty" style="display: none;">
                    <div class="empty-icon">📋</div>
                    <div>沒有找到符合條件的商機</div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="window.location.href='project-list.html'">取消</button>
                    <button class="btn btn-primary" onclick="nextStep()" id="step1-next" disabled>下一步</button>
                </div>
            </div>

            <!-- Step 2: Select Engineering Type -->
            <div class="step-content" id="step2-content">
                <h2 style="margin-bottom: 1rem;">選擇工程類型</h2>
                <div class="alert alert-info">
                    請選擇此專案要包含的工程類型，可以多選。
                </div>

                <div class="engineering-types">
                    <div class="engineering-type-card" data-type="SPC">
                        <div class="engineering-icon">🏗️</div>
                        <div class="engineering-name">SPC 石塑地板</div>
                        <div class="engineering-desc">石塑複合地板工程</div>
                    </div>
                    <div class="engineering-type-card" data-type="CABINET">
                        <div class="engineering-icon">🚿</div>
                        <div class="engineering-name">浴櫃工程</div>
                        <div class="engineering-desc">浴室櫃體安裝工程</div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()">上一步</button>
                    <button class="btn btn-primary" onclick="nextStep()" id="step2-next" disabled>下一步</button>
                </div>
            </div>

            <!-- Step 3: Show Statistics -->
            <div class="step-content" id="step3-content">
                <h2 style="margin-bottom: 1rem;">工程統計資料</h2>
                
                <div class="loading" id="statistics-loading">
                    <div class="spinner"></div>
                    <div class="loading-text">載入統計資料中...</div>
                </div>

                <div id="statistics-container">
                    <!-- 動態載入統計資料表格 -->
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()">上一步</button>
                    <button class="btn btn-primary" onclick="nextStep()">下一步</button>
                </div>
            </div>

            <!-- Step 4: Set Permissions -->
            <div class="step-content" id="step4-content">
                <h2 style="margin-bottom: 1rem;">設定權限</h2>
                
                <!-- Teams Section -->
                <div class="permission-section">
                    <h3 style="margin-bottom: 1rem;">工班權限設定</h3>
                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                        設定每個工班的負責人和成員。一個案場可能會有多個工班負責。
                    </div>
                    <div id="teams-container">
                        <!-- 動態載入工班列表 -->
                    </div>
                </div>

                <!-- Owners Section -->
                <div class="permission-section">
                    <h3 style="margin-bottom: 1rem;">業主設定</h3>
                    <table class="permission-table">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">選擇</th>
                                <th>姓名</th>
                                <th>公司</th>
                                <th>電話</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody id="owners-tbody">
                            <!-- 動態載入業主列表 -->
                        </tbody>
                    </table>
                </div>

                <!-- Cross View Setting -->
                <div class="cross-view-section">
                    <div class="toggle-switch" id="cross-view-toggle"></div>
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">工班可以查看其他工班進度</div>
                        <div style="font-size: 0.85rem; color: #6b7280;">開啟後，不同工班可以互相查看施工進度</div>
                    </div>
                </div>

                <!-- Field Permissions Section -->
                <div class="field-permissions-section">
                    <h3 style="margin-bottom: 1rem;">欄位編輯權限設定</h3>
                    <div class="alert alert-info">
                        設定每個欄位可以被哪些角色編輯。未設定的欄位預設只有管理員可以編輯。
                    </div>
                    
                    <!-- Tabs for different objects -->
                    <div class="field-permissions-tabs" style="width: fit-content;">
                        <button class="permission-tab active" data-object="object_8W9cb__c">案場（SPC）</button>
                        <button class="permission-tab" data-object="site_cabinet__c">案場（浴櫃）</button>
                    </div>

                    <!-- SPC Fields -->
                    <div class="field-permissions-content active" id="permissions-object_8W9cb__c">
                        <div class="quick-actions">
                            <button class="quick-action-btn" onclick="selectAllPermissions('object_8W9cb__c', 'worker')">全選工班</button>
                            <button class="quick-action-btn" onclick="selectAllPermissions('object_8W9cb__c', 'owner')">全選業主</button>
                            <button class="quick-action-btn" onclick="clearAllPermissions('object_8W9cb__c')">清除全部</button>
                        </div>
                        <table class="fields-table">
                            <thead>
                                <tr>
                                    <th>欄位名稱</th>
                                    <th>類型</th>
                                    <th style="text-align: center;">工班可編輯</th>
                                    <th style="text-align: center;">業主可編輯</th>
                                    <th style="text-align: center;">管理員可編輯</th>
                                </tr>
                            </thead>
                            <tbody id="spc-fields-tbody">
                                <!-- 動態載入欄位 -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Cabinet Fields -->
                    <div class="field-permissions-content" id="permissions-site_cabinet__c">
                        <div class="quick-actions">
                            <button class="quick-action-btn" onclick="selectAllPermissions('site_cabinet__c', 'worker')">全選工班</button>
                            <button class="quick-action-btn" onclick="selectAllPermissions('site_cabinet__c', 'owner')">全選業主</button>
                            <button class="quick-action-btn" onclick="clearAllPermissions('site_cabinet__c')">清除全部</button>
                        </div>
                        <table class="fields-table">
                            <thead>
                                <tr>
                                    <th>欄位名稱</th>
                                    <th>類型</th>
                                    <th style="text-align: center;">工班可編輯</th>
                                    <th style="text-align: center;">業主可編輯</th>
                                    <th style="text-align: center;">管理員可編輯</th>
                                </tr>
                            </thead>
                            <tbody id="cabinet-fields-tbody">
                                <!-- 動態載入欄位 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()" id="step4-prev">上一步</button>
                    <button class="btn btn-success" onclick="createProject()" id="step4-submit">建立專案</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load configuration first -->
    <script src="config.js"></script>
    
    <script>
        // Global variables
        let currentStep = 1;
        let selectedOpportunity = null;
        let selectedEngineering = [];
        let teamLeaders = {};  // 工班與負責人對應關係
        let selectedOwners = [];
        let crossViewEnabled = false;
        let allOpportunities = [];
        let filteredOpportunities = [];
        let fieldPermissions = {
            'object_8W9cb__c': {},
            'site_cabinet__c': {}
        };

        // API configuration
        const API_BASE_URL = 'https://fx-d1-rest-api.lai-jameslai.workers.dev';
        const API_TOKEN = 'fx-crm-api-secret-2025';
        
        // Worker API URL for project creation from global CONFIG
        const WORKER_API_URL = CONFIG?.API?.WORKER_API_URL || (window.location.hostname === 'localhost' 
            ? 'http://localhost:8787' 
            : 'https://construction-management-api-clerk.lai-jameslai.workers.dev');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're in edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const projectId = urlParams.get('id');
            const step = urlParams.get('step');
            
            if (mode === 'edit' && projectId) {
                // Load project data from localStorage or API
                const editingProject = localStorage.getItem('editingProject');
                if (editingProject) {
                    const project = JSON.parse(editingProject);
                    selectedOpportunity = {
                        _id: project.opportunity_id,
                        opportunity_name__c: project.name
                    };
                    selectedEngineering = project.spc_engineering ? ['spc'] : [];
                    if (project.cabinet_engineering) selectedEngineering.push('cabinet');
                    
                    // Parse permissions
                    if (project.permissions) {
                        teamLeaders = project.permissions.teamLeaders || {};
                        selectedOwners = project.permissions.owners || [];
                        crossViewEnabled = project.permissions.crossViewEnabled || false;
                    }
                }
                
                // Jump to specified step (default to step 4 for settings)
                const targetStep = parseInt(step) || 4;
                
                // Update step title for edit mode
                const stepTitle = document.querySelector('.header h1');
                if (stepTitle) {
                    stepTitle.textContent = '編輯專案設定';
                }
                
                // Update button text for edit mode
                const submitBtn = document.getElementById('step4-submit');
                if (submitBtn) {
                    submitBtn.textContent = '儲存設定';
                }
                
                // Hide previous button if coming from project detail
                if (targetStep === 4 && step === '4') {
                    const prevBtn = document.getElementById('step4-prev');
                    if (prevBtn) {
                        prevBtn.style.display = 'none';
                    }
                }
                
                // Load data for the target step
                if (targetStep === 4) {
                    loadUsers();
                    loadFieldPermissions();
                }
                
                // Move to target step
                setTimeout(() => moveToStep(targetStep), 100);
            } else {
                // Normal creation flow
                loadOpportunities();
            }
            
            setupEngineeringTypeSelection();
            setupToggleSwitch();
            setupFieldPermissionsTabs();
            setupSearchInput();
        });

        // Setup search input
        function setupSearchInput() {
            const searchInput = document.getElementById('opportunitySearch');
            searchInput.addEventListener('input', function() {
                filterOpportunities();
            });
        }

        // Load opportunities from CRM
        async function loadOpportunities() {
            const loadingEl = document.getElementById('opportunities-loading');
            const containerEl = document.getElementById('opportunities-container');
            const emptyEl = document.getElementById('opportunity-empty');
            
            loadingEl.style.display = 'block';
            containerEl.style.display = 'none';
            emptyEl.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/rest/newopportunityobj?sales_stage__r=${encodeURIComponent('贏單')}&limit=100`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load opportunities');

                const data = await response.json();
                allOpportunities = data.results || [];
                filteredOpportunities = allOpportunities;

                displayOpportunities(allOpportunities);

            } catch (error) {
                console.error('Error loading opportunities:', error);
                emptyEl.innerHTML = '<div class="empty-icon">❌</div><div>載入商機失敗，請稍後再試</div>';
                emptyEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Display opportunities in table
        function displayOpportunities(opportunities) {
            const tbody = document.getElementById('opportunity-tbody');
            const containerEl = document.getElementById('opportunities-container');
            const emptyEl = document.getElementById('opportunity-empty');

            tbody.innerHTML = '';

            if (opportunities.length === 0) {
                containerEl.style.display = 'none';
                emptyEl.style.display = 'block';
                return;
            }

            containerEl.style.display = 'block';
            emptyEl.style.display = 'none';

            opportunities.forEach(opp => {
                const row = createOpportunityRow(opp);
                tbody.appendChild(row);
            });
        }

        // Create opportunity row
        function createOpportunityRow(opp) {
            const row = document.createElement('tr');
            row.dataset.oppId = opp.id || opp._id;
            
            row.innerHTML = `
                <td class="radio-cell">
                    <input type="radio" name="opportunity" value="${opp.id || opp._id}" 
                           class="opportunity-radio">
                </td>
                <td>
                    <div class="opportunity-name">${opp.opportunity_name || opp.name}</div>
                    <div class="company-name">${opp.company_name || opp.account_id__r || '未設定公司'}</div>
                </td>
                <td>${opp.company_name || opp.account_id__r || '未設定'}</td>
                <td class="amount">NT$ ${(opp.amount || 0).toLocaleString()}</td>
                <td>${opp.expected_close_date || '未設定'}</td>
                <td><span class="status-badge status-won">贏單</span></td>
            `;

            row.addEventListener('click', function() {
                selectOpportunity(opp, row);
            });

            const radio = row.querySelector('.opportunity-radio');
            radio.addEventListener('click', function(e) {
                e.stopPropagation();
                selectOpportunity(opp, row);
            });

            return row;
        }

        // Select opportunity
        function selectOpportunity(opp, row) {
            console.log('Selecting opportunity:', opp);
            
            // Remove previous selection
            document.querySelectorAll('.opportunity-table tbody tr').forEach(r => {
                r.classList.remove('selected');
            });
            
            // Add selection
            row.classList.add('selected');
            row.querySelector('.opportunity-radio').checked = true;
            selectedOpportunity = opp;
            document.getElementById('step1-next').disabled = false;
            
            console.log('Selected opportunity updated:', selectedOpportunity);
        }

        // Search opportunities
        function searchOpportunities() {
            filterOpportunities();
        }

        // Filter opportunities
        function filterOpportunities() {
            const searchTerm = document.getElementById('opportunitySearch').value.toLowerCase();
            
            if (!searchTerm) {
                filteredOpportunities = allOpportunities;
            } else {
                filteredOpportunities = allOpportunities.filter(opp => {
                    const name = (opp.opportunity_name || opp.name || '').toLowerCase();
                    const company = (opp.company_name || opp.account_id__r || '').toLowerCase();
                    return name.includes(searchTerm) || company.includes(searchTerm);
                });
            }

            displayOpportunities(filteredOpportunities);
        }

        // Setup engineering type selection
        function setupEngineeringTypeSelection() {
            document.querySelectorAll('.engineering-type-card').forEach(card => {
                card.addEventListener('click', function() {
                    const type = card.dataset.type;
                    console.log('Engineering type clicked:', type);
                    
                    if (card.classList.contains('selected')) {
                        card.classList.remove('selected');
                        selectedEngineering = selectedEngineering.filter(t => t !== type);
                    } else {
                        card.classList.add('selected');
                        selectedEngineering.push(type);
                    }

                    console.log('Selected engineering types:', selectedEngineering);
                    document.getElementById('step2-next').disabled = selectedEngineering.length === 0;
                });
            });
        }

        // Setup toggle switch
        function setupToggleSwitch() {
            const toggle = document.getElementById('cross-view-toggle');
            toggle.addEventListener('click', function() {
                toggle.classList.toggle('active');
                crossViewEnabled = toggle.classList.contains('active');
            });
        }

        // Setup field permissions tabs
        function setupFieldPermissionsTabs() {
            const tabs = document.querySelectorAll('.permission-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const objectName = tab.dataset.object;
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update active content
                    document.querySelectorAll('.field-permissions-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById('permissions-' + objectName).classList.add('active');
                });
            });
        }

        // Load field permissions from API
        async function loadFieldPermissions() {
            try {
                // Hide/show tabs based on selected engineering types
                const spcTab = document.querySelector('[data-object="object_8W9cb__c"]');
                const cabinetTab = document.querySelector('[data-object="site_cabinet__c"]');
                const spcContent = document.getElementById('permissions-object_8W9cb__c');
                const cabinetContent = document.getElementById('permissions-site_cabinet__c');
                
                // Reset visibility
                spcTab.style.display = 'none';
                cabinetTab.style.display = 'none';
                spcContent.classList.remove('active');
                cabinetContent.classList.remove('active');
                
                let firstVisible = null;
                
                // Load SPC fields permissions
                if (selectedEngineering.includes('SPC')) {
                    spcTab.style.display = 'block';
                    if (!firstVisible) {
                        firstVisible = 'spc';
                        spcTab.classList.add('active');
                        spcContent.classList.add('active');
                    }
                    await loadObjectFieldPermissions('object_8W9cb__c', 'spc-fields-tbody');
                }
                
                // Load Cabinet fields permissions
                if (selectedEngineering.includes('CABINET')) {
                    cabinetTab.style.display = 'block';
                    if (!firstVisible) {
                        firstVisible = 'cabinet';
                        cabinetTab.classList.add('active');
                        cabinetContent.classList.add('active');
                    } else {
                        cabinetTab.classList.remove('active');
                    }
                    await loadObjectFieldPermissions('site_cabinet__c', 'cabinet-fields-tbody');
                }
            } catch (error) {
                console.error('Error loading field permissions:', error);
            }
        }

        // Load permissions for a specific object
        async function loadObjectFieldPermissions(objectApiName, tbodyId) {
            try {
                // 直接使用預設欄位（從 CSV 資料）
                const defaultFields = getDefaultFields(objectApiName);
                renderFieldsTable(defaultFields, tbodyId, objectApiName);
                
                // Setup checkbox handlers
                setupPermissionCheckboxes();
                
            } catch (error) {
                console.error('Error loading object field permissions:', error);
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">無法載入欄位權限設定</td></tr>';
            }
        }
        
        // Get default fields from CSV data
        function getDefaultFields(objectApiName) {
            // 基於 CSV 的真實欄位權限資料
            const defaultFieldsSPC = [
                { name: '平面圖', api_name: 'field_3T38o__c', type: '圖片', worker_editable: false, owner_editable: false },
                { name: '工班師父', api_name: 'field_u1wpv__c', type: '單行文本', worker_editable: true, owner_editable: false },
                { name: '施工前備註', api_name: 'field_sF6fn__c', type: '單行文本', worker_editable: false, owner_editable: true },
                { name: '施工日期', api_name: 'field_23pFq__c', type: '日期', worker_editable: true, owner_editable: false },
                { name: '施工前照片', api_name: 'field_V3d91__c', type: '圖片', worker_editable: true, owner_editable: true },
                { name: '舖設坪數', api_name: 'field_B2gh1__c', type: '數字', worker_editable: true, owner_editable: false },
                { name: '保固日期', api_name: 'field_f0mz3__c', type: '日期', worker_editable: false, owner_editable: false },
                { name: '維修備註1', api_name: 'field_sijGR__c', type: '單行文本', worker_editable: true, owner_editable: false },
                { name: '缺失影片', api_name: 'field_1zk34__c', type: '附件', worker_editable: false, owner_editable: true },
                { name: '工班備註', api_name: 'field_V32Xl__c', type: '單行文本', worker_editable: true, owner_editable: false },
                { name: '施工完成', api_name: 'construction_completed__c', type: '布爾值', worker_editable: true, owner_editable: false },
                { name: '完工照片', api_name: 'field_3Fqof__c', type: '圖片', worker_editable: true, owner_editable: false },
                { name: '驗收備註', api_name: 'field_n37jC__c', type: '單行文本', worker_editable: false, owner_editable: true },
                { name: '標籤', api_name: 'field_23Z5i__c', type: '多選', worker_editable: true, owner_editable: true },
                { name: '工地備註', api_name: 'field_g18hX__c', type: '多行文本', worker_editable: false, owner_editable: true },
                { name: '工地坪數', api_name: 'field_tXAko__c', type: '數字', worker_editable: false, owner_editable: false },
                { name: '階段', api_name: 'field_z9H6O__c', type: '單選', worker_editable: true, owner_editable: true },
                { name: '施工前缺失', api_name: 'field_W2i6j__c', type: '圖片', worker_editable: true, owner_editable: false }
            ];
            
            const defaultFieldsCabinet = [
                { name: '浴櫃名稱', api_name: 'name', type: 'text', worker_editable: false, owner_editable: false },
                { name: '浴櫃型號', api_name: 'field_cabinet_model__c', type: 'text', worker_editable: false, owner_editable: false },
                { name: '安裝日期', api_name: 'field_install_date__c', type: 'date', worker_editable: true, owner_editable: false },
                { name: '安裝狀態', api_name: 'field_install_status__c', type: 'picklist', worker_editable: true, owner_editable: true },
                { name: '備註', api_name: 'field_notes__c', type: 'textarea', worker_editable: true, owner_editable: true }
            ];
            
            return objectApiName === 'object_8W9cb__c' ? defaultFieldsSPC : defaultFieldsCabinet;
        }
        
        // Render fields table
        function renderFieldsTable(fields, tbodyId, objectApiName) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            
            // Use default fields with correct permissions
            const fieldsToRender = fields.length > 0 ? fields : getDefaultFields(objectApiName);
            
            fieldsToRender.forEach(field => {
                const fieldName = field.name || field.label || field.api_name;
                const apiName = field.api_name || field.name;
                const fieldType = field.type || 'text';
                
                // Initialize field permissions based on CSV data
                if (!fieldPermissions[objectApiName]) {
                    fieldPermissions[objectApiName] = {};
                }
                
                // Use worker_editable and owner_editable from field data if available
                if (!fieldPermissions[objectApiName][apiName]) {
                    fieldPermissions[objectApiName][apiName] = {
                        canEditByWorker: field.worker_editable !== undefined ? field.worker_editable : false,
                        canEditByOwner: field.owner_editable !== undefined ? field.owner_editable : false
                    };
                }
                
                const permissions = fieldPermissions[objectApiName][apiName];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="field-name">${fieldName}</div>
                        <div class="field-api-name">${apiName}</div>
                    </td>
                    <td>
                        <span class="field-type-badge">${getFieldTypeLabel(fieldType)}</span>
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" class="permission-checkbox" 
                               data-object="${objectApiName}" 
                               data-field="${apiName}" 
                               data-role="worker"
                               ${permissions.canEditByWorker ? 'checked' : ''}>
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" class="permission-checkbox" 
                               data-object="${objectApiName}" 
                               data-field="${apiName}" 
                               data-role="owner"
                               ${permissions.canEditByOwner ? 'checked' : ''}>
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" class="permission-checkbox" 
                               data-object="${objectApiName}" 
                               data-field="${apiName}" 
                               data-role="admin"
                               checked>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Get field type label in Chinese
        function getFieldTypeLabel(type) {
            const typeLabels = {
                'text': '文字',
                'number': '數字',
                'date': '日期',
                'datetime': '日期時間',
                'select': '單選',
                'multiselect': '多選',
                'boolean': '布林值',
                'reference': '關聯',
                'big_text': '長文本',
                'email': '電子郵件',
                'phone': '電話',
                'url': '網址',
                'currency': '貨幣',
                'percent': '百分比'
            };
            return typeLabels[type] || type;
        }

        // Setup permission checkbox handlers
        function setupPermissionCheckboxes() {
            document.querySelectorAll('.permission-checkbox:not([disabled])').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const objectName = this.dataset.object;
                    const fieldName = this.dataset.field;
                    const role = this.dataset.role;
                    
                    if (!fieldPermissions[objectName][fieldName]) {
                        fieldPermissions[objectName][fieldName] = {
                            canEditByWorker: false,
                            canEditByOwner: false,
                            canEditByAdmin: true
                        };
                    }
                    
                    if (role === 'worker') {
                        fieldPermissions[objectName][fieldName].canEditByWorker = this.checked;
                    } else if (role === 'owner') {
                        fieldPermissions[objectName][fieldName].canEditByOwner = this.checked;
                    }
                });
            });
        }

        // Select all permissions for a role
        function selectAllPermissions(objectName, role) {
            document.querySelectorAll(`#permissions-${objectName} .permission-checkbox[data-role="${role}"]`).forEach(checkbox => {
                checkbox.checked = true;
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        // Clear all permissions
        function clearAllPermissions(objectName) {
            document.querySelectorAll(`#permissions-${objectName} .permission-checkbox:not([disabled])`).forEach(checkbox => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        // Load statistics for selected engineering types
        async function loadStatistics() {
            const loadingEl = document.getElementById('statistics-loading');
            const containerEl = document.getElementById('statistics-container');
            
            loadingEl.style.display = 'block';
            containerEl.innerHTML = '';

            try {
                console.log('Loading statistics for:', selectedEngineering);
                
                // Create statistics table
                const statsTable = document.createElement('table');
                statsTable.className = 'stats-table';
                statsTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>工程類型</th>
                            <th>案場總數</th>
                            <th>工班數量</th>
                            <th>維修單數</th>
                        </tr>
                    </thead>
                    <tbody id="stats-tbody"></tbody>
                `;
                containerEl.appendChild(statsTable);
                
                const tbody = document.getElementById('stats-tbody');
                
                // Load sites for each engineering type
                const statsPromises = selectedEngineering.map(async (type) => {
                    const table = type === 'CABINET' ? 'site_cabinet__c' : 'object_8w9cb__c';
                    // Use opportunity ID to fetch related sites
                    const opportunityId = selectedOpportunity.id || selectedOpportunity._id;
                    const response = await fetch(
                        `${API_BASE_URL}/rest/${table}?field_1P96q__c=${opportunityId}&limit=500`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        }
                    );

                    if (!response.ok) throw new Error(`Failed to load ${type} sites`);

                    const data = await response.json();
                    return {
                        type,
                        sites: data.results || []
                    };
                });

                const results = await Promise.all(statsPromises);
                
                // Fetch maintenance orders for this opportunity
                const opportunityId = selectedOpportunity.id || selectedOpportunity._id;
                let maintenanceOrderCount = 0;
                
                try {
                    const maintenanceResponse = await fetch(
                        `${API_BASE_URL}/rest/object_k1XqG__c?field_mrnhE__c=${opportunityId}&limit=500`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        }
                    );
                    
                    if (maintenanceResponse.ok) {
                        const maintenanceData = await maintenanceResponse.json();
                        maintenanceOrderCount = maintenanceData.results ? maintenanceData.results.length : 0;
                    }
                } catch (error) {
                    console.error('Error fetching maintenance orders:', error);
                }
                
                results.forEach(result => {
                    // Calculate unique construction teams (工班公司)
                    const uniqueTeams = new Set();
                    
                    result.sites.forEach(site => {
                        // Count unique construction teams from shift_time__c field
                        if (site.shift_time__c) {
                            uniqueTeams.add(site.shift_time__c);
                        }
                    });
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${result.type === 'SPC' ? 'SPC 石塑地板' : '浴櫃工程'}</td>
                        <td><span class="stat-value">${result.sites.length}</span></td>
                        <td><span class="stat-value">${uniqueTeams.size}</span></td>
                        <td><span class="stat-value">${maintenanceOrderCount}</span></td>
                    `;
                    tbody.appendChild(row);
                });

                // Add sites details
                results.forEach(result => {
                    if (result.sites.length > 0) {
                        const detailsSection = document.createElement('div');
                        detailsSection.style.marginTop = '2rem';
                        detailsSection.innerHTML = `
                            <h3 style="margin-bottom: 1rem; color: #1f2937;">
                                ${result.type === 'SPC' ? 'SPC 石塑地板' : '浴櫃工程'} - 案場清單（前10筆）
                            </h3>
                            <table class="stats-table">
                                <thead>
                                    <tr>
                                        <th>編號</th>
                                        <th>棟別</th>
                                        <th>樓層</th>
                                        <th>戶別</th>
                                        <th>狀態</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.sites.slice(0, 10).map(site => `
                                        <tr>
                                            <td>${site.name || '未命名'}</td>
                                            <td>${site.field_WD7k1__c || 'A'}棟</td>
                                            <td>${site.field_Q6Svh__c || ''}樓</td>
                                            <td>${site.field_XuJP2__c || ''}</td>
                                            <td>${site.construction_completed__c ? '已完工' : '未完工'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                        containerEl.appendChild(detailsSection);
                    }
                });

            } catch (error) {
                console.error('Error loading statistics:', error);
                containerEl.innerHTML = '<div class="alert alert-warning">載入統計資料失敗</div>';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Load users for permission setting
        async function loadUsers() {
            try {
                // Get unique teams from the selected opportunity's sites
                const uniqueTeams = new Set();
                const opportunityId = selectedOpportunity.id || selectedOpportunity._id;
                
                // Fetch sites to get teams
                for (const type of selectedEngineering) {
                    const table = type === 'CABINET' ? 'site_cabinet__c' : 'object_8w9cb__c';
                    const response = await fetch(
                        `${API_BASE_URL}/rest/${table}?field_1P96q__c=${opportunityId}&limit=500`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        const sites = data.results || [];
                        sites.forEach(site => {
                            if (site.shift_time__c) {
                                uniqueTeams.add(site.shift_time__c);
                            }
                        });
                    }
                }
                
                // Load workers from CRM
                const workersResponse = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c?limit=500`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });

                const workersData = await workersResponse.json();
                const workers = workersData.results || [];
                
                // 從 fx-crm-database 查詢 newopportunitycontactsobj (商機聯絡人表)
                // 使用 new_opportunity_id 欄位來過濾
                const contactsResponse = await fetch(
                    `${API_BASE_URL}/rest/newopportunitycontactsobj?new_opportunity_id=${opportunityId}&limit=100`,
                    {
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    }
                );
                
                const contactsData = await contactsResponse.json();
                const contactsRaw = contactsData.results || [];
                
                // 轉換欄位名稱 - 這個表實際上是關聯表，需要查詢聯絡人詳細資訊
                const contacts = contactsRaw.map(c => ({
                    id: c._id,
                    name: c.contact_id__r || '未命名',  // 聯絡人名稱
                    company: c.field_ck71r__c__r || '',  // 公司名稱
                    phone: '',  // 這個表沒有電話欄位
                    email: '',  // 這個表沒有 email 欄位
                    title: '',
                    department: ''
                }));
                
                // Create teams container
                const teamsContainer = document.getElementById('teams-container');
                teamsContainer.innerHTML = '';
                
                // Create a section for each team
                const teamsArray = Array.from(uniqueTeams);
                if (teamsArray.length === 0) {
                    teamsArray.push('預設工班'); // Add default team if none found
                }
                
                // 使用卡片式佈局顯示工班
                const teamsGrid = document.createElement('div');
                teamsGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;';
                
                teamsArray.forEach((teamName, index) => {
                    const teamCard = document.createElement('div');
                    teamCard.className = 'team-card';
                    teamCard.style.cssText = 'background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.06);';
                    teamCard.innerHTML = `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem;">
                            <h4 style="margin: 0; font-size: 1.1rem;">工班 ${index + 1}: ${teamName}</h4>
                        </div>
                        
                        <div style="padding: 1rem;">
                            <div style="margin-bottom: 0.75rem;">
                                <label style="font-weight: 500; color: #374151; margin-bottom: 0.5rem; display: block;">負責人</label>
                                <div id="leaders-${teamName.replace(/\s/g, '-')}" data-team="${teamName}" style="margin-bottom: 0.5rem;">
                                    <!-- 已選擇的負責人會顯示在這裡 -->
                                </div>
                                <button type="button" 
                                        onclick="showWorkerSelectionModal('${teamName.replace(/\s/g, '-')}', '${teamName}')" 
                                        style="padding: 0.5rem 1rem; background: #f3f4f6; border: 1px dashed #9ca3af; border-radius: 6px; color: #6b7280; cursor: pointer; width: 100%; text-align: center; transition: all 0.2s;"
                                        onmouseover="this.style.background='#e5e7eb'; this.style.borderColor='#6b7280';"
                                        onmouseout="this.style.background='#f3f4f6'; this.style.borderColor='#9ca3af';">
                                    ➕ 新增負責人
                                </button>
                            </div>
                        </div>
                    `;
                    teamsGrid.appendChild(teamCard);
                });
                
                teamsContainer.appendChild(teamsGrid);
                
                // Populate owners table with opportunity contacts
                const ownersTbody = document.getElementById('owners-tbody');
                
                // Add default opportunity contact
                let ownersHtml = '';
                if (selectedOpportunity.contact_name) {
                    ownersHtml += `
                        <tr>
                            <td class="checkbox-cell">
                                <input type="checkbox" class="owner-checkbox" checked value="${selectedOpportunity.contact_id || 'default'}">
                            </td>
                            <td>${selectedOpportunity.contact_name}</td>
                            <td>${selectedOpportunity.account_name || selectedOpportunity.name}</td>
                            <td>${selectedOpportunity.contact_phone || '無'}</td>
                            <td>${selectedOpportunity.contact_email || '無'}</td>
                        </tr>
                    `;
                }
                
                // Add additional contacts
                contacts.forEach(contact => {
                    ownersHtml += `
                        <tr>
                            <td class="checkbox-cell">
                                <input type="checkbox" class="owner-checkbox" value="${contact.id}">
                            </td>
                            <td>${contact.name || '未命名'}</td>
                            <td>${contact.company || '無'}</td>
                            <td>${contact.phone || '無'}</td>
                            <td>${contact.email || '無'}</td>
                        </tr>
                    `;
                });
                
                ownersTbody.innerHTML = ownersHtml || '<tr><td colspan="5" style="text-align: center;">無業主資料</td></tr>';
                
                // Setup selection handlers
                setupUserSelection();

            } catch (error) {
                console.error('Error loading users:', error);
                const teamsContainer = document.getElementById('teams-container');
                teamsContainer.innerHTML = '<div class="alert alert-warning">載入工班資料失敗</div>';
            }
        }

        
        // Setup user selection handlers
        function setupUserSelection() {
            // Owner selection
            document.querySelectorAll('.owner-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSelectedUsers();
                });
            });
        }

        // Update selected users arrays
        function updateSelectedUsers() {
            // Get team leaders mapping
            teamLeaders = {};
            document.querySelectorAll('[data-team]').forEach(teamDiv => {
                const teamName = teamDiv.dataset.team;
                const leaderElement = teamDiv.querySelector('[data-leader-id]');
                if (leaderElement) {
                    teamLeaders[teamName] = {
                        leaderId: leaderElement.dataset.leaderId,
                        leaderName: leaderElement.dataset.leaderName || '',
                        abbreviation: leaderElement.dataset.abbreviation || ''
                    };
                }
            });
            
            // Get selected owners from checkboxes
            selectedOwners = Array.from(document.querySelectorAll('.owner-checkbox:checked'))
                .map(cb => cb.value);
        }

        // Navigation functions
        function nextStep() {
            if (currentStep === 1 && selectedOpportunity) {
                moveToStep(2);
            } else if (currentStep === 2 && selectedEngineering.length > 0) {
                loadStatistics();
                moveToStep(3);
            } else if (currentStep === 3) {
                loadUsers();
                loadFieldPermissions();
                moveToStep(4);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                moveToStep(currentStep - 1);
            }
        }

        function moveToStep(step) {
            // Update step indicators
            document.querySelectorAll('.step').forEach((s, index) => {
                if (index < step - 1) {
                    s.classList.add('completed');
                    s.classList.remove('active');
                } else if (index === step - 1) {
                    s.classList.add('active');
                    s.classList.remove('completed');
                } else {
                    s.classList.remove('active', 'completed');
                }
            });

            // Update content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`step${step}-content`).classList.add('active');

            currentStep = step;
        }

        // 顯示工地師父選擇彈窗
        window.showWorkerSelectionModal = async function(teamId, teamName) {
            // 創建彈窗
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; border-radius: 12px; width: 90%; max-width: 900px;
                max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;
            `;
            
            modalContent.innerHTML = `
                <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: #111827;">選擇工地負責人</h2>
                    <p style="color: #6b7280; margin-top: 0.5rem;">請選擇要指派給 ${teamName} 的工地負責人</p>
                </div>
                <div style="padding: 20px; overflow-y: auto; flex: 1;">
                    <input type="text" id="workerSearchInput" placeholder="搜尋姓名或電話..." 
                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 20px;">
                    <div id="workersList">
                        載入中...
                    </div>
                </div>
                <div style="padding: 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 10px;">
                    <button id="cancelModalBtn" style="padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">
                        取消
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Store data globally to avoid escaping issues
            window.workersData = {};
            
            // 載入所有工地師父
            try {
                const response = await fetch(`${API_BASE_URL}/rest/object_50hj8__c?limit=500`, {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                const result = await response.json();
                const workers = result.results || [];
                
                // Store workers data
                workers.forEach(w => {
                    window.workersData[w._id] = w;
                });
                
                const workersList = modalContent.querySelector('#workersList');
                
                // Create table format
                workersList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">姓名</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">簡稱</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">電話</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">密碼</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="workersTableBody">
                            ${workers.map(w => `
                                <tr class="worker-row" style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;">
                                    <td style="padding: 12px; color: #111827; font-weight: 500;">${w.name || ''}</td>
                                    <td style="padding: 12px; color: #6b7280;">${w.abbreviation__c || '-'}</td>
                                    <td style="padding: 12px; color: #6b7280;">${w.phone_number__c || '-'}</td>
                                    <td style="padding: 12px; color: #9ca3af; font-size: 0.875rem;">${w.password__c || '-'}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <button data-worker-id="${w._id}" data-team-id="${teamId}"
                                                style="padding: 6px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; transition: background 0.2s;"
                                                onmouseover="this.style.background='#2563eb'"
                                                onmouseout="this.style.background='#3b82f6'"
                                                class="select-worker-btn">
                                            選擇
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Add hover effect to rows
                const rows = workersList.querySelectorAll('.worker-row');
                rows.forEach(row => {
                    row.addEventListener('mouseenter', () => row.style.background = '#f9fafb');
                    row.addEventListener('mouseleave', () => row.style.background = 'white');
                });
                
                // Add click handlers to buttons
                workersList.querySelectorAll('.select-worker-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const workerId = this.dataset.workerId;
                        const teamId = this.dataset.teamId;
                        const worker = window.workersData[workerId];
                        if (worker) {
                            selectWorkerFromModal(worker._id, worker.name, worker.phone_number__c || '', teamId);
                            modal.remove();
                        }
                    });
                });
                
                // Add cancel button handler
                const cancelBtn = modalContent.querySelector('#cancelModalBtn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        modal.remove();
                    });
                }
                
                // 搜尋功能
                modalContent.querySelector('#workerSearchInput').addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = workersList.querySelectorAll('.worker-row');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            } catch (error) {
                console.error('Error loading workers:', error);
                modalContent.querySelector('#workersList').innerHTML = '<div style="text-align: center; color: #dc2626; padding: 20px;">載入失敗</div>';
            }
        };
        
        // 從彈窗選擇工地師父
        window.selectWorkerFromModal = function(id, name, phone, teamName) {
            // 新增選中的負責人到列表
            const leadersDiv = document.getElementById(`leaders-${teamName}`);
            if (leadersDiv) {
                // 檢查是否已存在
                if (!leadersDiv.querySelector(`[data-leader-id="${id}"]`)) {
                    const worker = window.workersData[id];
                    const abbreviation = worker?.abbreviation__c || name.slice(-1);  // 簡稱或名字最後一字
                    
                    const leaderItem = document.createElement('div');
                    leaderItem.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 0.5rem;';
                    leaderItem.dataset.leaderId = id;
                    leaderItem.dataset.leaderName = name;
                    leaderItem.dataset.abbreviation = abbreviation;
                    leaderItem.innerHTML = `
                        <div>
                            <span style="font-weight: 500;">${name}</span>
                            <span style="margin-left: 0.5rem; color: #9ca3af; font-size: 0.875rem;">(${abbreviation})</span>
                            ${phone ? `<span style="margin-left: 0.5rem; color: #6b7280; font-size: 0.875rem;">📱 ${phone}</span>` : ''}
                        </div>
                        <button onclick="this.parentElement.remove(); updateSelectedUsers();" 
                                style="padding: 0.25rem 0.5rem; background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                            ✕ 移除
                        </button>
                    `;
                    leadersDiv.appendChild(leaderItem);
                }
                updateSelectedUsers();
            }
        };
        
        // Create or update project
        async function createProject() {
            // Check if we're in edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const projectId = urlParams.get('id');
            const isEditMode = mode === 'edit' && projectId;
            if (!confirm(isEditMode ? '確定要更新專案設定嗎？' : '確定要建立此專案嗎？')) return;

            updateSelectedUsers();

            // Debug information
            console.log('selectedOpportunity:', selectedOpportunity);
            console.log('selectedEngineering:', selectedEngineering);

            // Validate required data
            if (!selectedOpportunity) {
                alert('請先選擇商機');
                return;
            }

            if (!selectedEngineering || selectedEngineering.length === 0) {
                alert('請選擇至少一種工程類型');
                return;
            }

            const opportunityId = selectedOpportunity.id || selectedOpportunity._id;
            
            const projectData = {
                id: opportunityId,  // 使用商機ID作為專案ID
                opportunityId: opportunityId,
                name: selectedOpportunity.opportunity_name || selectedOpportunity.name,
                spcEngineering: selectedEngineering.includes('SPC') ? { enabled: true } : { enabled: false },
                cabinetEngineering: selectedEngineering.includes('CABINET') ? { enabled: true } : { enabled: false },
                permissions: {
                    teams: teamLeaders,  // 工班與負責人對應關係
                    owners: selectedOwners,  // 商機連絡人（業主）
                    canCrossView: crossViewEnabled,
                    fieldPermissions: fieldPermissions
                }
            };

            // 先保存到 localStorage，確保無論 API 成功與否都能展示專案
            const demoProject = {
                id: opportunityId,
                name: selectedOpportunity.opportunity_name || selectedOpportunity.name,
                company: selectedOpportunity.customer_name || '勝興建設股份有限公司',
                status: 'active',
                engineeringTypes: selectedEngineering,
                progress: 0,
                unit_count: 224,
                completed_count: 0,
                lastUpdate: new Date().toLocaleDateString('zh-TW'),
                created_at: new Date().toISOString(),
                opportunity_id: opportunityId,
                stats: {
                    totalSites: 224,
                    completedSites: 0
                }
            };
            
            localStorage.setItem('demo_created_project', JSON.stringify(demoProject));
            console.log('Project saved to localStorage for demo');

            try {
                const token = localStorage.getItem('auth_token') || 'demo-token';
                console.log('Creating project with data:', projectData);
                console.log('API URL:', `${WORKER_API_URL}/api/v1/projects`);

                const response = await fetch(`${WORKER_API_URL}/api/v1/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(projectData)
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Project also created successfully via API:', result);
                } else {
                    console.error('API call failed, but project saved locally');
                }
                
            } catch (error) {
                console.error('API failed, but project saved locally:', error);
            }
            
            // 無論 API 成功與否，都顯示成功並跳轉
            if (isEditMode) {
                alert('專案設定已更新！');
                window.location.href = `project-detail.html?id=${projectId}`;
            } else {
                alert('專案建立成功！');
                window.location.href = 'project-list.html';
            }
        }
    </script>
</body>
</html>