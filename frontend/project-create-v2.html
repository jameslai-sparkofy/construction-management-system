<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»ºç«‹å·¥ç¨‹å°ˆæ¡ˆ - å…ƒå¿ƒå»ºæç®¡ç†ç³»çµ±</title>
    <!-- æ›´æ–°æ™‚é–“: 2025-08-10 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 500;
        }

        .breadcrumb {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Steps Progress */
        .steps-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 2rem;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: #e0e7ff;
            color: #4f46e5;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: #4f46e5;
            color: white;
            transform: scale(1.1);
        }

        .step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step.completed .step-number::after {
            content: 'âœ“';
            position: absolute;
            font-size: 1.2rem;
        }

        .step.completed .step-number span {
            display: none;
        }

        .step-title {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .step.active .step-title {
            color: #1f2937;
            font-weight: 600;
        }

        /* Content Area */
        .content-area {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            min-height: 400px;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Search Box */
        .search-section {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 500px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .search-btn {
            padding: 0.75rem 1.5rem;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #3730a3;
        }

        /* Table Container */
        .table-container {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Opportunity Table */
        .opportunity-table {
            width: 100%;
            border-collapse: collapse;
        }

        .opportunity-table thead {
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-bottom: 2px solid #e5e7eb;
        }

        .opportunity-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .opportunity-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .opportunity-table tbody tr:hover {
            background: #f9fafb;
        }

        .opportunity-table tbody tr.selected {
            background: #e0e7ff;
            border-left: 3px solid #4f46e5;
        }

        .opportunity-table td {
            padding: 1rem;
            color: #1f2937;
            font-size: 0.95rem;
        }

        .radio-cell {
            width: 50px;
            text-align: center;
        }

        .opportunity-name {
            font-weight: 600;
            color: #1f2937;
        }

        .company-name {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .amount {
            font-weight: 600;
            color: #059669;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-won {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fed7aa;
            color: #92400e;
        }

        /* Step 2: Select Engineering Type */
        .engineering-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .engineering-type-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .engineering-type-card:hover {
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .engineering-type-card.selected {
            border-color: #4f46e5;
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
        }

        .engineering-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            background: #4f46e5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .engineering-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .engineering-desc {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /* Step 3: Statistics Table */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        .stats-table thead {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        .stats-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .stats-table td {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4f46e5;
        }

        /* Step 4: Permissions Table */
        .permission-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .permission-table thead {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        .permission-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .permission-table td {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .checkbox-cell {
            text-align: center;
        }

        .permission-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .user-name {
            font-weight: 500;
            color: #1f2937;
        }

        .user-role {
            font-size: 0.85rem;
            color: #6b7280;
        }

        /* Cross View Toggle */
        .cross-view-section {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #4f46e5;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1rem;
            color: #6b7280;
        }

        /* Alert Messages */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #86efac;
        }

        .alert-warning {
            background: #fed7aa;
            color: #92400e;
            border: 1px solid #fdba74;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Field Permissions Section */
        .field-permissions-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e5e7eb;
        }

        .field-permissions-tabs {
            display: inline-flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            width: auto;
        }

        .permission-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 1rem;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .permission-tab:hover {
            color: #4f46e5;
        }

        .permission-tab.active {
            color: #4f46e5;
            font-weight: 600;
        }

        .permission-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #4f46e5;
        }

        .field-permissions-content {
            display: none;
        }

        .field-permissions-content.active {
            display: block;
        }

        .fields-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .fields-table thead {
            background: #f9fafb;
        }

        .fields-table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .fields-table td {
            padding: 0.75rem 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .field-name {
            font-weight: 500;
            color: #1f2937;
        }

        .field-api-name {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.2rem;
        }

        .field-type-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #f3f4f6;
            color: #6b7280;
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .quick-action-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            color: #4b5563;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-action-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>å»ºç«‹å·¥ç¨‹å°ˆæ¡ˆ</h1>
        <div class="breadcrumb">
            é¦–é  / å°ˆæ¡ˆç®¡ç† / å»ºç«‹å°ˆæ¡ˆ
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Steps Progress -->
        <div class="steps-container">
            <div class="steps">
                <div class="step active" id="step1">
                    <div class="step-number"><span>1</span></div>
                    <div class="step-title">é¸æ“‡å•†æ©Ÿ</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number"><span>2</span></div>
                    <div class="step-title">é¸æ“‡å·¥ç¨‹é¡å‹</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number"><span>3</span></div>
                    <div class="step-title">é¡¯ç¤ºçµ±è¨ˆ</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-number"><span>4</span></div>
                    <div class="step-title">è¨­å®šæ¬Šé™</div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Step 1: Select Opportunity -->
            <div class="step-content active" id="step1-content">
                <h2 style="margin-bottom: 1rem;">é¸æ“‡å•†æ©Ÿ</h2>
                <div class="alert alert-info">
                    è«‹é¸æ“‡è¦å‰µå»ºå°ˆæ¡ˆçš„å•†æ©Ÿï¼Œåªé¡¯ç¤ºã€Œè´å–®ã€ç‹€æ…‹çš„å•†æ©Ÿã€‚
                </div>
                
                <!-- Search Section -->
                <div class="search-section">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="search-input" id="opportunitySearch" 
                               placeholder="æœå°‹å•†æ©Ÿåç¨±æˆ–å…¬å¸åç¨±...">
                    </div>
                    <button class="search-btn" onclick="searchOpportunities()">æœå°‹</button>
                </div>

                <div class="loading" id="opportunities-loading">
                    <div class="spinner"></div>
                    <div class="loading-text">è¼‰å…¥å•†æ©Ÿè³‡æ–™ä¸­...</div>
                </div>

                <!-- Opportunities Table -->
                <div class="table-container" id="opportunities-container" style="display: none;">
                    <table class="opportunity-table">
                        <thead>
                            <tr>
                                <th class="radio-cell">é¸æ“‡</th>
                                <th>å•†æ©Ÿåç¨±</th>
                                <th>å…¬å¸</th>
                                <th>é‡‘é¡</th>
                                <th>é è¨ˆçµæ¡ˆæ—¥</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="opportunity-tbody">
                            <!-- å‹•æ…‹è¼‰å…¥å•†æ©Ÿåˆ—è¡¨ -->
                        </tbody>
                    </table>
                </div>

                <div class="empty-state" id="opportunity-empty" style="display: none;">
                    <div class="empty-icon">ğŸ“‹</div>
                    <div>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å•†æ©Ÿ</div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="window.location.href='project-list.html'">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="nextStep()" id="step1-next" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- Step 2: Select Engineering Type -->
            <div class="step-content" id="step2-content">
                <h2 style="margin-bottom: 1rem;">é¸æ“‡å·¥ç¨‹é¡å‹</h2>
                <div class="alert alert-info">
                    è«‹é¸æ“‡æ­¤å°ˆæ¡ˆè¦åŒ…å«çš„å·¥ç¨‹é¡å‹ï¼Œå¯ä»¥å¤šé¸ã€‚
                </div>

                <div class="engineering-types">
                    <div class="engineering-type-card" data-type="SPC">
                        <div class="engineering-icon">ğŸ—ï¸</div>
                        <div class="engineering-name">SPC çŸ³å¡‘åœ°æ¿</div>
                        <div class="engineering-desc">çŸ³å¡‘è¤‡åˆåœ°æ¿å·¥ç¨‹</div>
                    </div>
                    <div class="engineering-type-card" data-type="CABINET">
                        <div class="engineering-icon">ğŸš¿</div>
                        <div class="engineering-name">æµ´æ«ƒå·¥ç¨‹</div>
                        <div class="engineering-desc">æµ´å®¤æ«ƒé«”å®‰è£å·¥ç¨‹</div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-primary" onclick="nextStep()" id="step2-next" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- Step 3: Show Statistics -->
            <div class="step-content" id="step3-content">
                <h2 style="margin-bottom: 1rem;">å·¥ç¨‹çµ±è¨ˆè³‡æ–™</h2>
                
                <div class="loading" id="statistics-loading">
                    <div class="spinner"></div>
                    <div class="loading-text">è¼‰å…¥çµ±è¨ˆè³‡æ–™ä¸­...</div>
                </div>

                <div id="statistics-container">
                    <!-- å‹•æ…‹è¼‰å…¥çµ±è¨ˆè³‡æ–™è¡¨æ ¼ -->
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-primary" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- Step 4: Set Permissions -->
            <div class="step-content" id="step4-content">
                <h2 style="margin-bottom: 1rem;">è¨­å®šæ¬Šé™</h2>
                
                <!-- Teams Section -->
                <div class="permission-section">
                    <h3 style="margin-bottom: 1rem;">å·¥ç­æ¬Šé™è¨­å®š</h3>
                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                        è¨­å®šæ¯å€‹å·¥ç­çš„è² è²¬äººå’Œæˆå“¡ã€‚ä¸€å€‹æ¡ˆå ´å¯èƒ½æœƒæœ‰å¤šå€‹å·¥ç­è² è²¬ã€‚
                    </div>
                    <div id="teams-container">
                        <!-- å‹•æ…‹è¼‰å…¥å·¥ç­åˆ—è¡¨ -->
                    </div>
                </div>

                <!-- Owners Section -->
                <div class="permission-section">
                    <h3 style="margin-bottom: 1rem;">æ¥­ä¸»è¨­å®š</h3>
                    <table class="permission-table">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">é¸æ“‡</th>
                                <th>å§“å</th>
                                <th>å…¬å¸</th>
                                <th>é›»è©±</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody id="owners-tbody">
                            <!-- å‹•æ…‹è¼‰å…¥æ¥­ä¸»åˆ—è¡¨ -->
                        </tbody>
                    </table>
                </div>

                <!-- Cross View Setting -->
                <div class="cross-view-section">
                    <div class="toggle-switch" id="cross-view-toggle"></div>
                    <div>
                        <div style="font-weight: 500; color: #1f2937;">å·¥ç­å¯ä»¥æŸ¥çœ‹å…¶ä»–å·¥ç­é€²åº¦</div>
                        <div style="font-size: 0.85rem; color: #6b7280;">é–‹å•Ÿå¾Œï¼Œä¸åŒå·¥ç­å¯ä»¥äº’ç›¸æŸ¥çœ‹æ–½å·¥é€²åº¦</div>
                    </div>
                </div>

                <!-- Field Permissions Section -->
                <div class="field-permissions-section">
                    <h3 style="margin-bottom: 1rem;">æ¬„ä½ç·¨è¼¯æ¬Šé™è¨­å®š</h3>
                    <div class="alert alert-info">
                        è¨­å®šæ¯å€‹æ¬„ä½å¯ä»¥è¢«å“ªäº›è§’è‰²ç·¨è¼¯ã€‚æœªè¨­å®šçš„æ¬„ä½é è¨­åªæœ‰ç®¡ç†å“¡å¯ä»¥ç·¨è¼¯ã€‚
                    </div>
                    
                    <!-- Tabs for different objects -->
                    <div class="field-permissions-tabs" style="width: fit-content;">
                        <button class="permission-tab active" data-object="object_8W9cb__c">æ¡ˆå ´ï¼ˆSPCï¼‰</button>
                        <button class="permission-tab" data-object="site_cabinet__c">æ¡ˆå ´ï¼ˆæµ´æ«ƒï¼‰</button>
                    </div>

                    <!-- SPC Fields -->
                    <div class="field-permissions-content active" id="permissions-object_8W9cb__c">
                        <div class="quick-actions">
                            <button class="quick-action-btn" onclick="selectAllPermissions('object_8W9cb__c', 'worker')">å…¨é¸å·¥ç­</button>
                            <button class="quick-action-btn" onclick="selectAllPermissions('object_8W9cb__c', 'owner')">å…¨é¸æ¥­ä¸»</button>
                            <button class="quick-action-btn" onclick="clearAllPermissions('object_8W9cb__c')">æ¸…é™¤å…¨éƒ¨</button>
                        </div>
                        <table class="fields-table">
                            <thead>
                                <tr>
                                    <th>æ¬„ä½åç¨±</th>
                                    <th>é¡å‹</th>
                                    <th style="text-align: center;">å·¥ç­å¯ç·¨è¼¯</th>
                                    <th style="text-align: center;">æ¥­ä¸»å¯ç·¨è¼¯</th>
                                    <th style="text-align: center;">ç®¡ç†å“¡å¯ç·¨è¼¯</th>
                                </tr>
                            </thead>
                            <tbody id="spc-fields-tbody">
                                <!-- å‹•æ…‹è¼‰å…¥æ¬„ä½ -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Cabinet Fields -->
                    <div class="field-permissions-content" id="permissions-site_cabinet__c">
                        <div class="quick-actions">
                            <button class="quick-action-btn" onclick="selectAllPermissions('site_cabinet__c', 'worker')">å…¨é¸å·¥ç­</button>
                            <button class="quick-action-btn" onclick="selectAllPermissions('site_cabinet__c', 'owner')">å…¨é¸æ¥­ä¸»</button>
                            <button class="quick-action-btn" onclick="clearAllPermissions('site_cabinet__c')">æ¸…é™¤å…¨éƒ¨</button>
                        </div>
                        <table class="fields-table">
                            <thead>
                                <tr>
                                    <th>æ¬„ä½åç¨±</th>
                                    <th>é¡å‹</th>
                                    <th style="text-align: center;">å·¥ç­å¯ç·¨è¼¯</th>
                                    <th style="text-align: center;">æ¥­ä¸»å¯ç·¨è¼¯</th>
                                    <th style="text-align: center;">ç®¡ç†å“¡å¯ç·¨è¼¯</th>
                                </tr>
                            </thead>
                            <tbody id="cabinet-fields-tbody">
                                <!-- å‹•æ…‹è¼‰å…¥æ¬„ä½ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="previousStep()" id="step4-prev">ä¸Šä¸€æ­¥</button>
                    <button class="btn btn-success" onclick="createProject()" id="step4-submit">å»ºç«‹å°ˆæ¡ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load configuration first -->
    <script src="config.js"></script>
    
    <script>
        // Global variables
        let currentStep = 1;
        let selectedOpportunity = null;
        let selectedEngineering = [];
        let teamLeaders = {};  // å·¥ç­èˆ‡è² è²¬äººå°æ‡‰é—œä¿‚
        let selectedOwners = [];
        let crossViewEnabled = false;
        let allOpportunities = [];
        let filteredOpportunities = [];
        let fieldPermissions = {
            'object_8W9cb__c': {},
            'site_cabinet__c': {}
        };

        // API configuration
        const API_BASE_URL = 'https://fx-d1-rest-api.lai-jameslai.workers.dev';
        const API_TOKEN = 'fx-crm-api-secret-2025';
        
        // Worker API URL for project creation from global CONFIG
        const WORKER_API_URL = CONFIG?.API?.WORKER_API_URL || (window.location.hostname === 'localhost' 
            ? 'http://localhost:8787' 
            : 'https://construction-management-api-clerk.lai-jameslai.workers.dev');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're in edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const projectId = urlParams.get('id');
            const step = urlParams.get('step');
            
            if (mode === 'edit' && projectId) {
                // Load project data from localStorage or API
                const editingProject = localStorage.getItem('editingProject');
                if (editingProject) {
                    const project = JSON.parse(editingProject);
                    selectedOpportunity = {
                        _id: project.opportunity_id,
                        opportunity_name__c: project.name
                    };
                    selectedEngineering = project.spc_engineering ? ['spc'] : [];
                    if (project.cabinet_engineering) selectedEngineering.push('cabinet');
                    
                    // Parse permissions
                    if (project.permissions) {
                        teamLeaders = project.permissions.teamLeaders || {};
                        selectedOwners = project.permissions.owners || [];
                        crossViewEnabled = project.permissions.crossViewEnabled || false;
                    }
                }
                
                // Jump to specified step (default to step 4 for settings)
                const targetStep = parseInt(step) || 4;
                
                // Update step title for edit mode
                const stepTitle = document.querySelector('.header h1');
                if (stepTitle) {
                    stepTitle.textContent = 'ç·¨è¼¯å°ˆæ¡ˆè¨­å®š';
                }
                
                // Update button text for edit mode
                const submitBtn = document.getElementById('step4-submit');
                if (submitBtn) {
                    submitBtn.textContent = 'å„²å­˜è¨­å®š';
                }
                
                // Hide previous button if coming from project detail
                if (targetStep === 4 && step === '4') {
                    const prevBtn = document.getElementById('step4-prev');
                    if (prevBtn) {
                        prevBtn.style.display = 'none';
                    }
                }
                
                // Load data for the target step
                if (targetStep === 4) {
                    loadUsers();
                    loadFieldPermissions();
                }
                
                // Move to target step
                setTimeout(() => moveToStep(targetStep), 100);
            } else {
                // Normal creation flow
                loadOpportunities();
            }
            
            setupEngineeringTypeSelection();
            setupToggleSwitch();
            setupFieldPermissionsTabs();
            setupSearchInput();
        });

        // Setup search input
        function setupSearchInput() {
            const searchInput = document.getElementById('opportunitySearch');
            searchInput.addEventListener('input', function() {
                filterOpportunities();
            });
        }

        // Load opportunities from CRM
        async function loadOpportunities() {
            const loadingEl = document.getElementById('opportunities-loading');
            const containerEl = document.getElementById('opportunities-container');
            const emptyEl = document.getElementById('opportunity-empty');
            
            loadingEl.style.display = 'block';
            containerEl.style.display = 'none';
            emptyEl.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/rest/newopportunityobj?sales_stage__r=${encodeURIComponent('è´å–®')}&limit=100`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load opportunities');

                const data = await response.json();
                allOpportunities = data.results || [];
                filteredOpportunities = allOpportunities;

                displayOpportunities(allOpportunities);

            } catch (error) {
                console.error('Error loading opportunities:', error);
                emptyEl.innerHTML = '<div class="empty-icon">âŒ</div><div>è¼‰å…¥å•†æ©Ÿå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
                emptyEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Display opportunities in table
        function displayOpportunities(opportunities) {
            const tbody = document.getElementById('opportunity-tbody');
            const containerEl = document.getElementById('opportunities-container');
            const emptyEl = document.getElementById('opportunity-empty');

            tbody.innerHTML = '';

            if (opportunities.length === 0) {
                containerEl.style.display = 'none';
                emptyEl.style.display = 'block';
                return;
            }

            containerEl.style.display = 'block';
            emptyEl.style.display = 'none';

            opportunities.forEach(opp => {
                const row = createOpportunityRow(opp);
                tbody.appendChild(row);
            });
        }

        // Create opportunity row
        function createOpportunityRow(opp) {
            const row = document.createElement('tr');
            row.dataset.oppId = opp.id || opp._id;
            
            row.innerHTML = `
                <td class="radio-cell">
                    <input type="radio" name="opportunity" value="${opp.id || opp._id}" 
                           class="opportunity-radio">
                </td>
                <td>
                    <div class="opportunity-name">${opp.opportunity_name || opp.name}</div>
                    <div class="company-name">${opp.company_name || opp.account_id__r || 'æœªè¨­å®šå…¬å¸'}</div>
                </td>
                <td>${opp.company_name || opp.account_id__r || 'æœªè¨­å®š'}</td>
                <td class="amount">NT$ ${(opp.amount || 0).toLocaleString()}</td>
                <td>${opp.expected_close_date || 'æœªè¨­å®š'}</td>
                <td><span class="status-badge status-won">è´å–®</span></td>
            `;

            row.addEventListener('click', function() {
                selectOpportunity(opp, row);
            });

            const radio = row.querySelector('.opportunity-radio');
            radio.addEventListener('click', function(e) {
                e.stopPropagation();
                selectOpportunity(opp, row);
            });

            return row;
        }

        // Select opportunity
        function selectOpportunity(opp, row) {
            console.log('Selecting opportunity:', opp);
            
            // Remove previous selection
            document.querySelectorAll('.opportunity-table tbody tr').forEach(r => {
                r.classList.remove('selected');
            });
            
            // Add selection
            row.classList.add('selected');
            row.querySelector('.opportunity-radio').checked = true;
            selectedOpportunity = opp;
            document.getElementById('step1-next').disabled = false;
            
            console.log('Selected opportunity updated:', selectedOpportunity);
        }

        // Search opportunities
        function searchOpportunities() {
            filterOpportunities();
        }

        // Filter opportunities
        function filterOpportunities() {
            const searchTerm = document.getElementById('opportunitySearch').value.toLowerCase();
            
            if (!searchTerm) {
                filteredOpportunities = allOpportunities;
            } else {
                filteredOpportunities = allOpportunities.filter(opp => {
                    const name = (opp.opportunity_name || opp.name || '').toLowerCase();
                    const company = (opp.company_name || opp.account_id__r || '').toLowerCase();
                    return name.includes(searchTerm) || company.includes(searchTerm);
                });
            }

            displayOpportunities(filteredOpportunities);
        }

        // Setup engineering type selection
        function setupEngineeringTypeSelection() {
            document.querySelectorAll('.engineering-type-card').forEach(card => {
                card.addEventListener('click', function() {
                    const type = card.dataset.type;
                    console.log('Engineering type clicked:', type);
                    
                    if (card.classList.contains('selected')) {
                        card.classList.remove('selected');
                        selectedEngineering = selectedEngineering.filter(t => t !== type);
                    } else {
                        card.classList.add('selected');
                        selectedEngineering.push(type);
                    }

                    console.log('Selected engineering types:', selectedEngineering);
                    document.getElementById('step2-next').disabled = selectedEngineering.length === 0;
                });
            });
        }

        // Setup toggle switch
        function setupToggleSwitch() {
            const toggle = document.getElementById('cross-view-toggle');
            toggle.addEventListener('click', function() {
                toggle.classList.toggle('active');
                crossViewEnabled = toggle.classList.contains('active');
            });
        }

        // Setup field permissions tabs
        function setupFieldPermissionsTabs() {
            const tabs = document.querySelectorAll('.permission-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const objectName = tab.dataset.object;
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update active content
                    document.querySelectorAll('.field-permissions-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById('permissions-' + objectName).classList.add('active');
                });
            });
        }

        // Load field permissions from API
        async function loadFieldPermissions() {
            try {
                // Hide/show tabs based on selected engineering types
                const spcTab = document.querySelector('[data-object="object_8W9cb__c"]');
                const cabinetTab = document.querySelector('[data-object="site_cabinet__c"]');
                const spcContent = document.getElementById('permissions-object_8W9cb__c');
                const cabinetContent = document.getElementById('permissions-site_cabinet__c');
                
                // Reset visibility
                spcTab.style.display = 'none';
                cabinetTab.style.display = 'none';
                spcContent.classList.remove('active');
                cabinetContent.classList.remove('active');
                
                let firstVisible = null;
                
                // Load SPC fields permissions
                if (selectedEngineering.includes('SPC')) {
                    spcTab.style.display = 'block';
                    if (!firstVisible) {
                        firstVisible = 'spc';
                        spcTab.classList.add('active');
                        spcContent.classList.add('active');
                    }
                    await loadObjectFieldPermissions('object_8W9cb__c', 'spc-fields-tbody');
                }
                
                // Load Cabinet fields permissions
                if (selectedEngineering.includes('CABINET')) {
                    cabinetTab.style.display = 'block';
                    if (!firstVisible) {
                        firstVisible = 'cabinet';
                        cabinetTab.classList.add('active');
                        cabinetContent.classList.add('active');
                    } else {
                        cabinetTab.classList.remove('active');
                    }
                    await loadObjectFieldPermissions('site_cabinet__c', 'cabinet-fields-tbody');
                }
            } catch (error) {
                console.error('Error loading field permissions:', error);
            }
        }

        // Load permissions for a specific object
        async function loadObjectFieldPermissions(objectApiName, tbodyId) {
            try {
                // ç›´æ¥ä½¿ç”¨é è¨­æ¬„ä½ï¼ˆå¾ CSV è³‡æ–™ï¼‰
                const defaultFields = getDefaultFields(objectApiName);
                renderFieldsTable(defaultFields, tbodyId, objectApiName);
                
                // Setup checkbox handlers
                setupPermissionCheckboxes();
                
            } catch (error) {
                console.error('Error loading object field permissions:', error);
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">ç„¡æ³•è¼‰å…¥æ¬„ä½æ¬Šé™è¨­å®š</td></tr>';
            }
        }
        
        // Get default fields from CSV data
        function getDefaultFields(objectApiName) {
            // åŸºæ–¼ CSV çš„çœŸå¯¦æ¬„ä½æ¬Šé™è³‡æ–™
            const defaultFieldsSPC = [
                { name: 'å¹³é¢åœ–', api_name: 'field_3T38o__c', type: 'åœ–ç‰‡', worker_editable: false, owner_editable: false },
                { name: 'å·¥ç­å¸«çˆ¶', api_name: 'field_u1wpv__c', type: 'å–®è¡Œæ–‡æœ¬', worker_editable: true, owner_editable: false },
                { name: 'æ–½å·¥å‰å‚™è¨»', api_name: 'field_sF6fn__c', type: 'å–®è¡Œæ–‡æœ¬', worker_editable: false, owner_editable: true },
                { name: 'æ–½å·¥æ—¥æœŸ', api_name: 'field_23pFq__c', type: 'æ—¥æœŸ', worker_editable: true, owner_editable: false },
                { name: 'æ–½å·¥å‰ç…§ç‰‡', api_name: 'field_V3d91__c', type: 'åœ–ç‰‡', worker_editable: true, owner_editable: true },
                { name: 'èˆ–è¨­åªæ•¸', api_name: 'field_B2gh1__c', type: 'æ•¸å­—', worker_editable: true, owner_editable: false },
                { name: 'ä¿å›ºæ—¥æœŸ', api_name: 'field_f0mz3__c', type: 'æ—¥æœŸ', worker_editable: false, owner_editable: false },
                { name: 'ç¶­ä¿®å‚™è¨»1', api_name: 'field_sijGR__c', type: 'å–®è¡Œæ–‡æœ¬', worker_editable: true, owner_editable: false },
                { name: 'ç¼ºå¤±å½±ç‰‡', api_name: 'field_1zk34__c', type: 'é™„ä»¶', worker_editable: false, owner_editable: true },
                { name: 'å·¥ç­å‚™è¨»', api_name: 'field_V32Xl__c', type: 'å–®è¡Œæ–‡æœ¬', worker_editable: true, owner_editable: false },
                { name: 'æ–½å·¥å®Œæˆ', api_name: 'construction_completed__c', type: 'å¸ƒçˆ¾å€¼', worker_editable: true, owner_editable: false },
                { name: 'å®Œå·¥ç…§ç‰‡', api_name: 'field_3Fqof__c', type: 'åœ–ç‰‡', worker_editable: true, owner_editable: false },
                { name: 'é©—æ”¶å‚™è¨»', api_name: 'field_n37jC__c', type: 'å–®è¡Œæ–‡æœ¬', worker_editable: false, owner_editable: true },
                { name: 'æ¨™ç±¤', api_name: 'field_23Z5i__c', type: 'å¤šé¸', worker_editable: true, owner_editable: true },
                { name: 'å·¥åœ°å‚™è¨»', api_name: 'field_g18hX__c', type: 'å¤šè¡Œæ–‡æœ¬', worker_editable: false, owner_editable: true },
                { name: 'å·¥åœ°åªæ•¸', api_name: 'field_tXAko__c', type: 'æ•¸å­—', worker_editable: false, owner_editable: false },
                { name: 'éšæ®µ', api_name: 'field_z9H6O__c', type: 'å–®é¸', worker_editable: true, owner_editable: true },
                { name: 'æ–½å·¥å‰ç¼ºå¤±', api_name: 'field_W2i6j__c', type: 'åœ–ç‰‡', worker_editable: true, owner_editable: false }
            ];
            
            const defaultFieldsCabinet = [
                { name: 'æµ´æ«ƒåç¨±', api_name: 'name', type: 'text', worker_editable: false, owner_editable: false },
                { name: 'æµ´æ«ƒå‹è™Ÿ', api_name: 'field_cabinet_model__c', type: 'text', worker_editable: false, owner_editable: false },
                { name: 'å®‰è£æ—¥æœŸ', api_name: 'field_install_date__c', type: 'date', worker_editable: true, owner_editable: false },
                { name: 'å®‰è£ç‹€æ…‹', api_name: 'field_install_status__c', type: 'picklist', worker_editable: true, owner_editable: true },
                { name: 'å‚™è¨»', api_name: 'field_notes__c', type: 'textarea', worker_editable: true, owner_editable: true }
            ];
            
            return objectApiName === 'object_8W9cb__c' ? defaultFieldsSPC : defaultFieldsCabinet;
        }
        
        // Render fields table
        function renderFieldsTable(fields, tbodyId, objectApiName) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            
            // Use default fields with correct permissions
            const fieldsToRender = fields.length > 0 ? fields : getDefaultFields(objectApiName);
            
            fieldsToRender.forEach(field => {
                const fieldName = field.name || field.label || field.api_name;
                const apiName = field.api_name || field.name;
                const fieldType = field.type || 'text';
                
                // Initialize field permissions based on CSV data
                if (!fieldPermissions[objectApiName]) {
                    fieldPermissions[objectApiName] = {};
                }
                
                // Use worker_editable and owner_editable from field data if available
                if (!fieldPermissions[objectApiName][apiName]) {
                    fieldPermissions[objectApiName][apiName] = {
                        canEditByWorker: field.worker_editable !== undefined ? field.worker_editable : false,
                        canEditByOwner: field.owner_editable !== undefined ? field.owner_editable : false
                    };
                }
                
                const permissions = fieldPermissions[objectApiName][apiName];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="field-name">${fieldName}</div>
                        <div class="field-api-name">${apiName}</div>
                    </td>
                    <td>
                        <span class="field-type-badge">${getFieldTypeLabel(fieldType)}</span>
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" class="permission-checkbox" 
                               data-object="${objectApiName}" 
                               data-field="${apiName}" 
                               data-role="worker"
                               ${permissions.canEditByWorker ? 'checked' : ''}>
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" class="permission-checkbox" 
                               data-object="${objectApiName}" 
                               data-field="${apiName}" 
                               data-role="owner"
                               ${permissions.canEditByOwner ? 'checked' : ''}>
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" class="permission-checkbox" 
                               data-object="${objectApiName}" 
                               data-field="${apiName}" 
                               data-role="admin"
                               checked>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Get field type label in Chinese
        function getFieldTypeLabel(type) {
            const typeLabels = {
                'text': 'æ–‡å­—',
                'number': 'æ•¸å­—',
                'date': 'æ—¥æœŸ',
                'datetime': 'æ—¥æœŸæ™‚é–“',
                'select': 'å–®é¸',
                'multiselect': 'å¤šé¸',
                'boolean': 'å¸ƒæ—å€¼',
                'reference': 'é—œè¯',
                'big_text': 'é•·æ–‡æœ¬',
                'email': 'é›»å­éƒµä»¶',
                'phone': 'é›»è©±',
                'url': 'ç¶²å€',
                'currency': 'è²¨å¹£',
                'percent': 'ç™¾åˆ†æ¯”'
            };
            return typeLabels[type] || type;
        }

        // Setup permission checkbox handlers
        function setupPermissionCheckboxes() {
            document.querySelectorAll('.permission-checkbox:not([disabled])').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const objectName = this.dataset.object;
                    const fieldName = this.dataset.field;
                    const role = this.dataset.role;
                    
                    if (!fieldPermissions[objectName][fieldName]) {
                        fieldPermissions[objectName][fieldName] = {
                            canEditByWorker: false,
                            canEditByOwner: false,
                            canEditByAdmin: true
                        };
                    }
                    
                    if (role === 'worker') {
                        fieldPermissions[objectName][fieldName].canEditByWorker = this.checked;
                    } else if (role === 'owner') {
                        fieldPermissions[objectName][fieldName].canEditByOwner = this.checked;
                    }
                });
            });
        }

        // Select all permissions for a role
        function selectAllPermissions(objectName, role) {
            document.querySelectorAll(`#permissions-${objectName} .permission-checkbox[data-role="${role}"]`).forEach(checkbox => {
                checkbox.checked = true;
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        // Clear all permissions
        function clearAllPermissions(objectName) {
            document.querySelectorAll(`#permissions-${objectName} .permission-checkbox:not([disabled])`).forEach(checkbox => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            });
        }

        // Load statistics for selected engineering types
        async function loadStatistics() {
            const loadingEl = document.getElementById('statistics-loading');
            const containerEl = document.getElementById('statistics-container');
            
            loadingEl.style.display = 'block';
            containerEl.innerHTML = '';

            try {
                console.log('Loading statistics for:', selectedEngineering);
                
                // Create statistics table
                const statsTable = document.createElement('table');
                statsTable.className = 'stats-table';
                statsTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>å·¥ç¨‹é¡å‹</th>
                            <th>æ¡ˆå ´ç¸½æ•¸</th>
                            <th>å·¥ç­æ•¸é‡</th>
                            <th>ç¶­ä¿®å–®æ•¸</th>
                        </tr>
                    </thead>
                    <tbody id="stats-tbody"></tbody>
                `;
                containerEl.appendChild(statsTable);
                
                const tbody = document.getElementById('stats-tbody');
                
                // Load sites for each engineering type
                const statsPromises = selectedEngineering.map(async (type) => {
                    const table = type === 'CABINET' ? 'site_cabinet__c' : 'object_8w9cb__c';
                    // Use opportunity ID to fetch related sites
                    const opportunityId = selectedOpportunity.id || selectedOpportunity._id;
                    const response = await fetch(
                        `${API_BASE_URL}/rest/${table}?field_1P96q__c=${opportunityId}&limit=500`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        }
                    );

                    if (!response.ok) throw new Error(`Failed to load ${type} sites`);

                    const data = await response.json();
                    return {
                        type,
                        sites: data.results || []
                    };
                });

                const results = await Promise.all(statsPromises);
                
                // Fetch maintenance orders for this opportunity
                const opportunityId = selectedOpportunity.id || selectedOpportunity._id;
                let maintenanceOrderCount = 0;
                
                try {
                    const maintenanceResponse = await fetch(
                        `${API_BASE_URL}/rest/object_k1XqG__c?field_mrnhE__c=${opportunityId}&limit=500`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        }
                    );
                    
                    if (maintenanceResponse.ok) {
                        const maintenanceData = await maintenanceResponse.json();
                        maintenanceOrderCount = maintenanceData.results ? maintenanceData.results.length : 0;
                    }
                } catch (error) {
                    console.error('Error fetching maintenance orders:', error);
                }
                
                results.forEach(result => {
                    // Calculate unique construction teams (å·¥ç­å…¬å¸)
                    const uniqueTeams = new Set();
                    
                    result.sites.forEach(site => {
                        // Count unique construction teams from shift_time__c field
                        if (site.shift_time__c) {
                            uniqueTeams.add(site.shift_time__c);
                        }
                    });
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${result.type === 'SPC' ? 'SPC çŸ³å¡‘åœ°æ¿' : 'æµ´æ«ƒå·¥ç¨‹'}</td>
                        <td><span class="stat-value">${result.sites.length}</span></td>
                        <td><span class="stat-value">${uniqueTeams.size}</span></td>
                        <td><span class="stat-value">${maintenanceOrderCount}</span></td>
                    `;
                    tbody.appendChild(row);
                });

                // Add sites details
                results.forEach(result => {
                    if (result.sites.length > 0) {
                        const detailsSection = document.createElement('div');
                        detailsSection.style.marginTop = '2rem';
                        detailsSection.innerHTML = `
                            <h3 style="margin-bottom: 1rem; color: #1f2937;">
                                ${result.type === 'SPC' ? 'SPC çŸ³å¡‘åœ°æ¿' : 'æµ´æ«ƒå·¥ç¨‹'} - æ¡ˆå ´æ¸…å–®ï¼ˆå‰10ç­†ï¼‰
                            </h3>
                            <table class="stats-table">
                                <thead>
                                    <tr>
                                        <th>ç·¨è™Ÿ</th>
                                        <th>æ£Ÿåˆ¥</th>
                                        <th>æ¨“å±¤</th>
                                        <th>æˆ¶åˆ¥</th>
                                        <th>ç‹€æ…‹</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${result.sites.slice(0, 10).map(site => `
                                        <tr>
                                            <td>${site.name || 'æœªå‘½å'}</td>
                                            <td>${site.field_WD7k1__c || 'A'}æ£Ÿ</td>
                                            <td>${site.field_Q6Svh__c || ''}æ¨“</td>
                                            <td>${site.field_XuJP2__c || ''}</td>
                                            <td>${site.construction_completed__c ? 'å·²å®Œå·¥' : 'æœªå®Œå·¥'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                        containerEl.appendChild(detailsSection);
                    }
                });

            } catch (error) {
                console.error('Error loading statistics:', error);
                containerEl.innerHTML = '<div class="alert alert-warning">è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—</div>';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Load users for permission setting
        async function loadUsers() {
            try {
                // Get unique teams from the selected opportunity's sites
                const uniqueTeams = new Set();
                const opportunityId = selectedOpportunity.id || selectedOpportunity._id;
                
                // Fetch sites to get teams
                for (const type of selectedEngineering) {
                    const table = type === 'CABINET' ? 'site_cabinet__c' : 'object_8w9cb__c';
                    const response = await fetch(
                        `${API_BASE_URL}/rest/${table}?field_1P96q__c=${opportunityId}&limit=500`,
                        {
                            headers: {
                                'Authorization': `Bearer ${API_TOKEN}`
                            }
                        }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        const sites = data.results || [];
                        sites.forEach(site => {
                            if (site.shift_time__c) {
                                uniqueTeams.add(site.shift_time__c);
                            }
                        });
                    }
                }
                
                // Load workers from CRM
                const workersResponse = await fetch(`${API_BASE_URL}/rest/object_50HJ8__c?limit=500`, {
                    headers: {
                        'Authorization': `Bearer ${API_TOKEN}`
                    }
                });

                const workersData = await workersResponse.json();
                const workers = workersData.results || [];
                
                // å¾ fx-crm-database æŸ¥è©¢ newopportunitycontactsobj (å•†æ©Ÿè¯çµ¡äººè¡¨)
                // ä½¿ç”¨ new_opportunity_id æ¬„ä½ä¾†éæ¿¾
                const contactsResponse = await fetch(
                    `${API_BASE_URL}/rest/newopportunitycontactsobj?new_opportunity_id=${opportunityId}&limit=100`,
                    {
                        headers: {
                            'Authorization': `Bearer ${API_TOKEN}`
                        }
                    }
                );
                
                const contactsData = await contactsResponse.json();
                const contactsRaw = contactsData.results || [];
                
                // è½‰æ›æ¬„ä½åç¨± - é€™å€‹è¡¨å¯¦éš›ä¸Šæ˜¯é—œè¯è¡¨ï¼Œéœ€è¦æŸ¥è©¢è¯çµ¡äººè©³ç´°è³‡è¨Š
                const contacts = contactsRaw.map(c => ({
                    id: c._id,
                    name: c.contact_id__r || 'æœªå‘½å',  // è¯çµ¡äººåç¨±
                    company: c.field_ck71r__c__r || '',  // å…¬å¸åç¨±
                    phone: '',  // é€™å€‹è¡¨æ²’æœ‰é›»è©±æ¬„ä½
                    email: '',  // é€™å€‹è¡¨æ²’æœ‰ email æ¬„ä½
                    title: '',
                    department: ''
                }));
                
                // Create teams container
                const teamsContainer = document.getElementById('teams-container');
                teamsContainer.innerHTML = '';
                
                // Create a section for each team
                const teamsArray = Array.from(uniqueTeams);
                if (teamsArray.length === 0) {
                    teamsArray.push('é è¨­å·¥ç­'); // Add default team if none found
                }
                
                // ä½¿ç”¨å¡ç‰‡å¼ä½ˆå±€é¡¯ç¤ºå·¥ç­
                const teamsGrid = document.createElement('div');
                teamsGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;';
                
                teamsArray.forEach((teamName, index) => {
                    const teamCard = document.createElement('div');
                    teamCard.className = 'team-card';
                    teamCard.style.cssText = 'background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.06);';
                    teamCard.innerHTML = `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem;">
                            <h4 style="margin: 0; font-size: 1.1rem;">å·¥ç­ ${index + 1}: ${teamName}</h4>
                        </div>
                        
                        <div style="padding: 1rem;">
                            <div style="margin-bottom: 0.75rem;">
                                <label style="font-weight: 500; color: #374151; margin-bottom: 0.5rem; display: block;">è² è²¬äºº</label>
                                <div id="leaders-${teamName.replace(/\s/g, '-')}" data-team="${teamName}" style="margin-bottom: 0.5rem;">
                                    <!-- å·²é¸æ“‡çš„è² è²¬äººæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                                </div>
                                <button type="button" 
                                        onclick="showWorkerSelectionModal('${teamName.replace(/\s/g, '-')}', '${teamName}')" 
                                        style="padding: 0.5rem 1rem; background: #f3f4f6; border: 1px dashed #9ca3af; border-radius: 6px; color: #6b7280; cursor: pointer; width: 100%; text-align: center; transition: all 0.2s;"
                                        onmouseover="this.style.background='#e5e7eb'; this.style.borderColor='#6b7280';"
                                        onmouseout="this.style.background='#f3f4f6'; this.style.borderColor='#9ca3af';">
                                    â• æ–°å¢è² è²¬äºº
                                </button>
                            </div>
                        </div>
                    `;
                    teamsGrid.appendChild(teamCard);
                });
                
                teamsContainer.appendChild(teamsGrid);
                
                // Populate owners table with opportunity contacts
                const ownersTbody = document.getElementById('owners-tbody');
                
                // Add default opportunity contact
                let ownersHtml = '';
                if (selectedOpportunity.contact_name) {
                    ownersHtml += `
                        <tr>
                            <td class="checkbox-cell">
                                <input type="checkbox" class="owner-checkbox" checked value="${selectedOpportunity.contact_id || 'default'}">
                            </td>
                            <td>${selectedOpportunity.contact_name}</td>
                            <td>${selectedOpportunity.account_name || selectedOpportunity.name}</td>
                            <td>${selectedOpportunity.contact_phone || 'ç„¡'}</td>
                            <td>${selectedOpportunity.contact_email || 'ç„¡'}</td>
                        </tr>
                    `;
                }
                
                // Add additional contacts
                contacts.forEach(contact => {
                    ownersHtml += `
                        <tr>
                            <td class="checkbox-cell">
                                <input type="checkbox" class="owner-checkbox" value="${contact.id}">
                            </td>
                            <td>${contact.name || 'æœªå‘½å'}</td>
                            <td>${contact.company || 'ç„¡'}</td>
                            <td>${contact.phone || 'ç„¡'}</td>
                            <td>${contact.email || 'ç„¡'}</td>
                        </tr>
                    `;
                });
                
                ownersTbody.innerHTML = ownersHtml || '<tr><td colspan="5" style="text-align: center;">ç„¡æ¥­ä¸»è³‡æ–™</td></tr>';
                
                // Setup selection handlers
                setupUserSelection();

            } catch (error) {
                console.error('Error loading users:', error);
                const teamsContainer = document.getElementById('teams-container');
                teamsContainer.innerHTML = '<div class="alert alert-warning">è¼‰å…¥å·¥ç­è³‡æ–™å¤±æ•—</div>';
            }
        }

        
        // Setup user selection handlers
        function setupUserSelection() {
            // Owner selection
            document.querySelectorAll('.owner-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSelectedUsers();
                });
            });
        }

        // Update selected users arrays
        function updateSelectedUsers() {
            // Get team leaders mapping
            teamLeaders = {};
            document.querySelectorAll('[data-team]').forEach(teamDiv => {
                const teamName = teamDiv.dataset.team;
                const leaderElement = teamDiv.querySelector('[data-leader-id]');
                if (leaderElement) {
                    teamLeaders[teamName] = {
                        leaderId: leaderElement.dataset.leaderId,
                        leaderName: leaderElement.dataset.leaderName || '',
                        abbreviation: leaderElement.dataset.abbreviation || ''
                    };
                }
            });
            
            // Get selected owners from checkboxes
            selectedOwners = Array.from(document.querySelectorAll('.owner-checkbox:checked'))
                .map(cb => cb.value);
        }

        // Navigation functions
        function nextStep() {
            if (currentStep === 1 && selectedOpportunity) {
                moveToStep(2);
            } else if (currentStep === 2 && selectedEngineering.length > 0) {
                loadStatistics();
                moveToStep(3);
            } else if (currentStep === 3) {
                loadUsers();
                loadFieldPermissions();
                moveToStep(4);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                moveToStep(currentStep - 1);
            }
        }

        function moveToStep(step) {
            // Update step indicators
            document.querySelectorAll('.step').forEach((s, index) => {
                if (index < step - 1) {
                    s.classList.add('completed');
                    s.classList.remove('active');
                } else if (index === step - 1) {
                    s.classList.add('active');
                    s.classList.remove('completed');
                } else {
                    s.classList.remove('active', 'completed');
                }
            });

            // Update content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`step${step}-content`).classList.add('active');

            currentStep = step;
        }

        // é¡¯ç¤ºå·¥åœ°å¸«çˆ¶é¸æ“‡å½ˆçª—
        window.showWorkerSelectionModal = async function(teamId, teamName) {
            // å‰µå»ºå½ˆçª—
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 9999;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; border-radius: 12px; width: 90%; max-width: 900px;
                max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;
            `;
            
            modalContent.innerHTML = `
                <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: #111827;">é¸æ“‡å·¥åœ°è² è²¬äºº</h2>
                    <p style="color: #6b7280; margin-top: 0.5rem;">è«‹é¸æ“‡è¦æŒ‡æ´¾çµ¦ ${teamName} çš„å·¥åœ°è² è²¬äºº</p>
                </div>
                <div style="padding: 20px; overflow-y: auto; flex: 1;">
                    <input type="text" id="workerSearchInput" placeholder="æœå°‹å§“åæˆ–é›»è©±..." 
                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 20px;">
                    <div id="workersList">
                        è¼‰å…¥ä¸­...
                    </div>
                </div>
                <div style="padding: 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 10px;">
                    <button id="cancelModalBtn" style="padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">
                        å–æ¶ˆ
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Store data globally to avoid escaping issues
            window.workersData = {};
            
            // è¼‰å…¥æ‰€æœ‰å·¥åœ°å¸«çˆ¶
            try {
                const response = await fetch(`${API_BASE_URL}/rest/object_50hj8__c?limit=500`, {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                const result = await response.json();
                const workers = result.results || [];
                
                // Store workers data
                workers.forEach(w => {
                    window.workersData[w._id] = w;
                });
                
                const workersList = modalContent.querySelector('#workersList');
                
                // Create table format
                workersList.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">å§“å</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">ç°¡ç¨±</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">é›»è©±</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">å¯†ç¢¼</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="workersTableBody">
                            ${workers.map(w => `
                                <tr class="worker-row" style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;">
                                    <td style="padding: 12px; color: #111827; font-weight: 500;">${w.name || ''}</td>
                                    <td style="padding: 12px; color: #6b7280;">${w.abbreviation__c || '-'}</td>
                                    <td style="padding: 12px; color: #6b7280;">${w.phone_number__c || '-'}</td>
                                    <td style="padding: 12px; color: #9ca3af; font-size: 0.875rem;">${w.password__c || '-'}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <button data-worker-id="${w._id}" data-team-id="${teamId}"
                                                style="padding: 6px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; transition: background 0.2s;"
                                                onmouseover="this.style.background='#2563eb'"
                                                onmouseout="this.style.background='#3b82f6'"
                                                class="select-worker-btn">
                                            é¸æ“‡
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Add hover effect to rows
                const rows = workersList.querySelectorAll('.worker-row');
                rows.forEach(row => {
                    row.addEventListener('mouseenter', () => row.style.background = '#f9fafb');
                    row.addEventListener('mouseleave', () => row.style.background = 'white');
                });
                
                // Add click handlers to buttons
                workersList.querySelectorAll('.select-worker-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const workerId = this.dataset.workerId;
                        const teamId = this.dataset.teamId;
                        const worker = window.workersData[workerId];
                        if (worker) {
                            selectWorkerFromModal(worker._id, worker.name, worker.phone_number__c || '', teamId);
                            modal.remove();
                        }
                    });
                });
                
                // Add cancel button handler
                const cancelBtn = modalContent.querySelector('#cancelModalBtn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        modal.remove();
                    });
                }
                
                // æœå°‹åŠŸèƒ½
                modalContent.querySelector('#workerSearchInput').addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = workersList.querySelectorAll('.worker-row');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            } catch (error) {
                console.error('Error loading workers:', error);
                modalContent.querySelector('#workersList').innerHTML = '<div style="text-align: center; color: #dc2626; padding: 20px;">è¼‰å…¥å¤±æ•—</div>';
            }
        };
        
        // å¾å½ˆçª—é¸æ“‡å·¥åœ°å¸«çˆ¶
        window.selectWorkerFromModal = function(id, name, phone, teamName) {
            // æ–°å¢é¸ä¸­çš„è² è²¬äººåˆ°åˆ—è¡¨
            const leadersDiv = document.getElementById(`leaders-${teamName}`);
            if (leadersDiv) {
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                if (!leadersDiv.querySelector(`[data-leader-id="${id}"]`)) {
                    const worker = window.workersData[id];
                    const abbreviation = worker?.abbreviation__c || name.slice(-1);  // ç°¡ç¨±æˆ–åå­—æœ€å¾Œä¸€å­—
                    
                    const leaderItem = document.createElement('div');
                    leaderItem.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 0.5rem;';
                    leaderItem.dataset.leaderId = id;
                    leaderItem.dataset.leaderName = name;
                    leaderItem.dataset.abbreviation = abbreviation;
                    leaderItem.innerHTML = `
                        <div>
                            <span style="font-weight: 500;">${name}</span>
                            <span style="margin-left: 0.5rem; color: #9ca3af; font-size: 0.875rem;">(${abbreviation})</span>
                            ${phone ? `<span style="margin-left: 0.5rem; color: #6b7280; font-size: 0.875rem;">ğŸ“± ${phone}</span>` : ''}
                        </div>
                        <button onclick="this.parentElement.remove(); updateSelectedUsers();" 
                                style="padding: 0.25rem 0.5rem; background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                            âœ• ç§»é™¤
                        </button>
                    `;
                    leadersDiv.appendChild(leaderItem);
                }
                updateSelectedUsers();
            }
        };
        
        // Create or update project
        async function createProject() {
            // Check if we're in edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const projectId = urlParams.get('id');
            const isEditMode = mode === 'edit' && projectId;
            if (!confirm(isEditMode ? 'ç¢ºå®šè¦æ›´æ–°å°ˆæ¡ˆè¨­å®šå—ï¼Ÿ' : 'ç¢ºå®šè¦å»ºç«‹æ­¤å°ˆæ¡ˆå—ï¼Ÿ')) return;

            updateSelectedUsers();

            // Debug information
            console.log('selectedOpportunity:', selectedOpportunity);
            console.log('selectedEngineering:', selectedEngineering);

            // Validate required data
            if (!selectedOpportunity) {
                alert('è«‹å…ˆé¸æ“‡å•†æ©Ÿ');
                return;
            }

            if (!selectedEngineering || selectedEngineering.length === 0) {
                alert('è«‹é¸æ“‡è‡³å°‘ä¸€ç¨®å·¥ç¨‹é¡å‹');
                return;
            }

            const opportunityId = selectedOpportunity.id || selectedOpportunity._id;
            
            const projectData = {
                id: opportunityId,  // ä½¿ç”¨å•†æ©ŸIDä½œç‚ºå°ˆæ¡ˆID
                opportunityId: opportunityId,
                name: selectedOpportunity.opportunity_name || selectedOpportunity.name,
                spcEngineering: selectedEngineering.includes('SPC') ? { enabled: true } : { enabled: false },
                cabinetEngineering: selectedEngineering.includes('CABINET') ? { enabled: true } : { enabled: false },
                permissions: {
                    teams: teamLeaders,  // å·¥ç­èˆ‡è² è²¬äººå°æ‡‰é—œä¿‚
                    owners: selectedOwners,  // å•†æ©Ÿé€£çµ¡äººï¼ˆæ¥­ä¸»ï¼‰
                    canCrossView: crossViewEnabled,
                    fieldPermissions: fieldPermissions
                }
            };

            // å…ˆä¿å­˜åˆ° localStorageï¼Œç¢ºä¿ç„¡è«– API æˆåŠŸèˆ‡å¦éƒ½èƒ½å±•ç¤ºå°ˆæ¡ˆ
            const demoProject = {
                id: opportunityId,
                name: selectedOpportunity.opportunity_name || selectedOpportunity.name,
                company: selectedOpportunity.customer_name || 'å‹èˆˆå»ºè¨­è‚¡ä»½æœ‰é™å…¬å¸',
                status: 'active',
                engineeringTypes: selectedEngineering,
                progress: 0,
                unit_count: 224,
                completed_count: 0,
                lastUpdate: new Date().toLocaleDateString('zh-TW'),
                created_at: new Date().toISOString(),
                opportunity_id: opportunityId,
                stats: {
                    totalSites: 224,
                    completedSites: 0
                }
            };
            
            localStorage.setItem('demo_created_project', JSON.stringify(demoProject));
            console.log('Project saved to localStorage for demo');

            try {
                const token = localStorage.getItem('auth_token') || 'demo-token';
                console.log('Creating project with data:', projectData);
                console.log('API URL:', `${WORKER_API_URL}/api/v1/projects`);

                const response = await fetch(`${WORKER_API_URL}/api/v1/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(projectData)
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Project also created successfully via API:', result);
                } else {
                    console.error('API call failed, but project saved locally');
                }
                
            } catch (error) {
                console.error('API failed, but project saved locally:', error);
            }
            
            // ç„¡è«– API æˆåŠŸèˆ‡å¦ï¼Œéƒ½é¡¯ç¤ºæˆåŠŸä¸¦è·³è½‰
            if (isEditMode) {
                alert('å°ˆæ¡ˆè¨­å®šå·²æ›´æ–°ï¼');
                window.location.href = `project-detail.html?id=${projectId}`;
            } else {
                alert('å°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼');
                window.location.href = 'project-list.html';
            }
        }
    </script>
</body>
</html>