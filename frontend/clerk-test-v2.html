<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clerk æ¸¬è©¦ v2</title>
    
    <!-- ä½¿ç”¨ Clerk å®˜æ–¹æ¨è–¦çš„è¼‰å…¥æ–¹å¼ -->
    <script>
        // è¨­å®šå…¨åŸŸ Clerk é…ç½®
        window.clerkSettings = {
            publishableKey: 'pk_test_YWJzb2x1dGUtY291Z2FyLTkwLmNsZXJrLmFjY291bnRzLmRldiQ'
        };
    </script>
    
    <script 
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_YWJzb2x1dGUtY291Z2FyLTkwLmNsZXJrLmFjY291bnRzLmRldiQ"
        src="https://absolute-cougar-90.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
    </script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            border-bottom: 2px solid #764ba2;
            padding-bottom: 10px;
        }
        
        .status-box {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }
        
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #81c784;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #764ba2;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5a3d7a;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .info-panel {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .info-panel h3 {
            margin-top: 0;
            color: #555;
        }
        
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .user-info {
            display: none;
            background: #f0f7ff;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .user-info.active {
            display: block;
        }
        
        .test-steps {
            background: #fffbf0;
            border: 1px solid #ffcc80;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .test-steps ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .test-steps li {
            margin: 5px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Clerk èªè­‰ç³»çµ±æ¸¬è©¦ v2</h1>
        
        <div id="status" class="status-box loading">
            â³ æ­£åœ¨è¼‰å…¥ Clerk SDK...
        </div>
        
        <div class="info-panel">
            <h3>ğŸ“‹ é…ç½®è³‡è¨Š</h3>
            <pre id="config">æ­£åœ¨è¼‰å…¥é…ç½®...</pre>
        </div>
        
        <div class="button-group">
            <button id="btnSignIn" disabled>ç™»å…¥</button>
            <button id="btnSignUp" disabled>è¨»å†Š</button>
            <button id="btnSignOut" disabled>ç™»å‡º</button>
            <button id="btnCheck" disabled>æª¢æŸ¥ç‹€æ…‹</button>
            <button id="btnGoToApp" disabled>é€²å…¥ç³»çµ±</button>
        </div>
        
        <div id="userInfo" class="user-info">
            <h3>ğŸ‘¤ ç”¨æˆ¶è³‡è¨Š</h3>
            <pre id="userData">æœªç™»å…¥</pre>
        </div>
        
        <div class="test-steps">
            <h3>ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ</h3>
            <ol>
                <li>ç­‰å¾… Clerk SDK è¼‰å…¥å®Œæˆï¼ˆç‹€æ…‹è®Šç‚ºç¶ è‰²ï¼‰</li>
                <li>é»æ“Šã€Œæª¢æŸ¥ç‹€æ…‹ã€ç¢ºèªé€£ç·š</li>
                <li>é»æ“Šã€Œç™»å…¥ã€æˆ–ã€Œè¨»å†Šã€é–‹å§‹èªè­‰</li>
                <li>å®Œæˆèªè­‰å¾Œæœƒè‡ªå‹•é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š</li>
                <li>é»æ“Šã€Œé€²å…¥ç³»çµ±ã€é€²å…¥å°ˆæ¡ˆåˆ—è¡¨</li>
            </ol>
        </div>
        
        <div class="info-panel">
            <h3>ğŸ” èª¿è©¦æ—¥èªŒ</h3>
            <pre id="logs">ç­‰å¾…åˆå§‹åŒ–...</pre>
        </div>
    </div>
    
    <script>
        // æ—¥èªŒè¼¸å‡º
        const log = (message, data = null) => {
            const logsEl = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${message}`;
            if (data) {
                logEntry += '\n' + JSON.stringify(data, null, 2);
            }
            logsEl.textContent = logEntry + '\n' + logsEl.textContent;
            console.log(message, data);
        };
        
        // æ›´æ–°ç‹€æ…‹
        const updateStatus = (message, type = 'loading') => {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status-box ${type}`;
        };
        
        // é¡¯ç¤ºé…ç½®
        const showConfig = () => {
            document.getElementById('config').textContent = JSON.stringify({
                publishableKey: 'pk_test_YWJzb2x1dGUtY291Z2FyLTkwLmNsZXJrLmFjY291bnRzLmRldiQ',
                domain: 'absolute-cougar-90.clerk.accounts.dev',
                sdkUrl: 'https://absolute-cougar-90.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js',
                environment: 'test'
            }, null, 2);
        };
        
        // å•Ÿç”¨æŒ‰éˆ•
        const enableButtons = () => {
            document.querySelectorAll('button').forEach(btn => {
                btn.disabled = false;
            });
        };
        
        // é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š
        const showUser = (user) => {
            const userInfoEl = document.getElementById('userInfo');
            const userDataEl = document.getElementById('userData');
            
            if (user) {
                userInfoEl.classList.add('active');
                userDataEl.textContent = JSON.stringify({
                    id: user.id,
                    email: user.primaryEmailAddress?.emailAddress,
                    phone: user.primaryPhoneNumber?.phoneNumber,
                    name: user.fullName || user.firstName || 'User',
                    username: user.username,
                    createdAt: user.createdAt
                }, null, 2);
                
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                document.getElementById('btnSignIn').disabled = true;
                document.getElementById('btnSignUp').disabled = true;
                document.getElementById('btnSignOut').disabled = false;
                document.getElementById('btnGoToApp').disabled = false;
            } else {
                userInfoEl.classList.remove('active');
                userDataEl.textContent = 'æœªç™»å…¥';
                
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                document.getElementById('btnSignIn').disabled = false;
                document.getElementById('btnSignUp').disabled = false;
                document.getElementById('btnSignOut').disabled = true;
                document.getElementById('btnGoToApp').disabled = true;
            }
        };
        
        // åˆå§‹åŒ– Clerk
        const initClerk = async () => {
            showConfig();
            log('é–‹å§‹åˆå§‹åŒ– Clerk...');
            
            try {
                // ç­‰å¾… Clerk ç‰©ä»¶å¯ç”¨
                let attempts = 0;
                const maxAttempts = 30; // 15 ç§’
                
                while (!window.Clerk && attempts < maxAttempts) {
                    log(`ç­‰å¾… Clerk è¼‰å…¥... (${attempts + 1}/${maxAttempts})`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    attempts++;
                }
                
                if (!window.Clerk) {
                    throw new Error('Clerk è¼‰å…¥è¶…æ™‚ï¼ˆ15ç§’ï¼‰');
                }
                
                log('Clerk ç‰©ä»¶å·²è¼‰å…¥', { Clerk: typeof window.Clerk });
                
                // ç­‰å¾… Clerk åˆå§‹åŒ–
                await window.Clerk.load();
                
                log('Clerk åˆå§‹åŒ–æˆåŠŸï¼');
                updateStatus('âœ… Clerk å·²å°±ç·’', 'success');
                enableButtons();
                
                // æª¢æŸ¥åˆå§‹ç™»å…¥ç‹€æ…‹
                if (window.Clerk.user) {
                    log('æª¢æ¸¬åˆ°å·²ç™»å…¥ç”¨æˆ¶', { userId: window.Clerk.user.id });
                    showUser(window.Clerk.user);
                }
                
                // ç›£è½ç”¨æˆ¶ç‹€æ…‹è®ŠåŒ–
                window.Clerk.addListener((resources) => {
                    log('Clerk ç‹€æ…‹è®ŠåŒ–', {
                        user: resources.user ? resources.user.id : null,
                        session: resources.session ? resources.session.id : null
                    });
                    showUser(resources.user);
                });
                
            } catch (error) {
                log('Clerk åˆå§‹åŒ–å¤±æ•—', { error: error.message });
                updateStatus(`âŒ ${error.message}`, 'error');
                
                // æä¾›å‚™ç”¨æ–¹æ¡ˆ
                setTimeout(() => {
                    if (confirm('Clerk è¼‰å…¥å¤±æ•—ï¼Œæ˜¯å¦ä½¿ç”¨å‚³çµ±ç™»å…¥ï¼Ÿ')) {
                        window.location.href = 'login-simple.html';
                    }
                }, 3000);
            }
        };
        
        // æŒ‰éˆ•äº‹ä»¶è™•ç†
        document.getElementById('btnSignIn').onclick = async () => {
            try {
                log('é–‹å•Ÿç™»å…¥è¦–çª—...');
                await window.Clerk.openSignIn({
                    afterSignInUrl: window.location.href
                });
            } catch (error) {
                log('ç™»å…¥éŒ¯èª¤', { error: error.message });
                alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
            }
        };
        
        document.getElementById('btnSignUp').onclick = async () => {
            try {
                log('é–‹å•Ÿè¨»å†Šè¦–çª—...');
                await window.Clerk.openSignUp({
                    afterSignUpUrl: window.location.href
                });
            } catch (error) {
                log('è¨»å†ŠéŒ¯èª¤', { error: error.message });
                alert('è¨»å†Šå¤±æ•—ï¼š' + error.message);
            }
        };
        
        document.getElementById('btnSignOut').onclick = async () => {
            try {
                log('åŸ·è¡Œç™»å‡º...');
                await window.Clerk.signOut();
                log('ç™»å‡ºæˆåŠŸ');
                window.location.reload();
            } catch (error) {
                log('ç™»å‡ºéŒ¯èª¤', { error: error.message });
                alert('ç™»å‡ºå¤±æ•—ï¼š' + error.message);
            }
        };
        
        document.getElementById('btnCheck').onclick = () => {
            if (!window.Clerk) {
                log('Clerk æœªè¼‰å…¥');
                alert('Clerk å°šæœªè¼‰å…¥');
                return;
            }
            
            const status = {
                isReady: window.Clerk.isReady ? window.Clerk.isReady() : false,
                user: window.Clerk.user ? {
                    id: window.Clerk.user.id,
                    email: window.Clerk.user.primaryEmailAddress?.emailAddress
                } : null,
                session: window.Clerk.session ? {
                    id: window.Clerk.session.id,
                    status: window.Clerk.session.status
                } : null,
                client: window.Clerk.client ? {
                    sessionCount: window.Clerk.client.sessions?.length || 0
                } : null
            };
            
            log('ç•¶å‰ç‹€æ…‹', status);
            alert('ç‹€æ…‹å·²è¼¸å‡ºåˆ°èª¿è©¦æ—¥èªŒ');
        };
        
        document.getElementById('btnGoToApp').onclick = () => {
            if (window.Clerk?.user) {
                log('è·³è½‰åˆ°å°ˆæ¡ˆåˆ—è¡¨...');
                
                // å„²å­˜ç”¨æˆ¶è³‡è¨Š
                localStorage.setItem('clerk_user', JSON.stringify({
                    id: window.Clerk.user.id,
                    email: window.Clerk.user.primaryEmailAddress?.emailAddress,
                    name: window.Clerk.user.fullName || window.Clerk.user.firstName || 'User'
                }));
                
                window.location.href = 'project-list.html';
            } else {
                alert('è«‹å…ˆç™»å…¥');
            }
        };
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            setTimeout(initClerk, 100);
        });
    </script>
</body>
</html>