<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人員管理 - 元心建材管理系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 500;
        }

        .btn-close {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Tabs */
        .tabs {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            display: flex;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 1.25rem;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            background: #f9fafb;
        }

        .tab.active {
            color: #4f46e5;
            background: #f0f4ff;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #4f46e5;
        }

        .tab-badge {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0.2rem 0.6rem;
            background: #e0e7ff;
            color: #4f46e5;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Content Card */
        .content-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* Actions Bar */
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .btn-primary {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        /* Team List */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .member-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .member-card:hover {
            border-color: #4f46e5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .member-phone {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .member-role {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .role-leader {
            background: #dbeafe;
            color: #1e40af;
        }

        .role-member {
            background: #e0e7ff;
            color: #4f46e5;
        }

        .role-owner {
            background: #fed7aa;
            color: #92400e;
        }

        .member-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .member-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-small:hover {
            background: #f9fafb;
            border-color: #4f46e5;
            color: #4f46e5;
        }

        .btn-danger {
            color: #dc2626;
        }

        .btn-danger:hover {
            background: #fee2e2;
            border-color: #dc2626;
        }

        /* Add Member Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #e5e7eb;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-hint {
            margin-top: 0.25rem;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn-secondary {
            padding: 0.75rem 1.5rem;
            background: white;
            color: #4b5563;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #4f46e5;
            color: #4f46e5;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            background: #f3f4f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
        }

        .empty-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .empty-desc {
            color: #6b7280;
            margin-bottom: 2rem;
        }

        /* Permission Settings */
        .permission-group {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .permission-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }

        .permission-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .permission-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .permission-label {
            color: #4b5563;
            font-size: 0.95rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>專案人員管理</h1>
            <button class="btn-close" onclick="goBack()">✕ 關閉</button>
        </div>
    </div>

    <!-- Container -->
    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('leaders')">
                工班負責人
                <span class="tab-badge" id="leadersCount">0</span>
            </button>
            <button class="tab" onclick="switchTab('members')">
                工班成員
                <span class="tab-badge" id="membersCount">0</span>
            </button>
            <button class="tab" onclick="switchTab('owners')">
                業主
                <span class="tab-badge" id="ownersCount">0</span>
            </button>
        </div>

        <!-- Content Card -->
        <div class="content-card">
            <!-- Actions Bar -->
            <div class="actions-bar">
                <div class="search-box">
                    <span class="search-icon">🔍</span>
                    <input type="text" class="search-input" placeholder="搜尋姓名或電話..." id="searchInput" onkeyup="filterMembers()">
                </div>
                <button class="btn-primary" onclick="openAddModal()">
                    <span>➕</span> 新增人員
                </button>
            </div>

            <!-- Team List -->
            <div id="teamContent">
                <!-- 動態載入人員列表 -->
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div class="modal" id="addMemberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">新增人員</h3>
                <button class="modal-close" onclick="closeAddModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="addMemberForm">
                    <div class="form-group">
                        <label class="form-label">姓名 *</label>
                        <input type="text" class="form-input" id="memberName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">手機號碼 *</label>
                        <input type="tel" class="form-input" id="memberPhone" required pattern="[0-9]{10}">
                        <div class="form-hint">密碼預設為手機末3碼</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="memberEmail">
                        <div class="form-hint">用於密碼重設</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">角色 *</label>
                        <select class="form-select" id="memberRole" onchange="updatePermissionOptions()">
                            <option value="leader">工班負責人</option>
                            <option value="member">工班成員</option>
                            <option value="owner">業主</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">工程類型權限</label>
                        <div class="permission-group">
                            <div class="permission-options">
                                <div class="permission-item">
                                    <input type="checkbox" id="permSPC" class="permission-checkbox" checked>
                                    <label for="permSPC" class="permission-label">SPC 石塑地板</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="permCabinet" class="permission-checkbox" checked>
                                    <label for="permCabinet" class="permission-label">浴櫃工程</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="permissionSettings">
                        <label class="form-label">其他權限</label>
                        <div class="permission-group">
                            <div class="permission-options">
                                <div class="permission-item">
                                    <input type="checkbox" id="canEdit" class="permission-checkbox" checked>
                                    <label for="canEdit" class="permission-label">可編輯案場資料</label>
                                </div>
                                <div class="permission-item">
                                    <input type="checkbox" id="canViewOthers" class="permission-checkbox">
                                    <label for="canViewOthers" class="permission-label">可查看其他工班進度</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAddModal()">取消</button>
                <button class="btn-primary" onclick="saveMember()">儲存</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'leaders';
        let projectId = null;
        let teamData = {
            leaders: [],
            members: [],
            owners: []
        };

        // API configuration
        const API_BASE_URL = 'https://fx-d1-rest-api.lai-jameslai.workers.dev';
        const API_TOKEN = 'fx-crm-api-secret-2025';
        const WORKER_API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:8787' 
            : 'https://construction-management-api.workers.dev';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Get project ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            projectId = urlParams.get('projectId');
            
            if (!projectId) {
                alert('專案ID無效');
                goBack();
                return;
            }

            loadTeamData();
        });

        // Load team data
        async function loadTeamData() {
            try {
                const token = localStorage.getItem('auth_token') || 'demo-token';
                
                // 從 Worker API 獲取專案權限資料
                const response = await fetch(`${WORKER_API_URL}/api/v1/projects/${projectId}/permissions`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    teamData = data.data || teamData;
                } else {
                    // 使用模擬資料
                    loadMockData();
                }

                updateDisplay();
            } catch (error) {
                console.error('Error loading team data:', error);
                loadMockData();
                updateDisplay();
            }
        }

        // Load mock data
        function loadMockData() {
            teamData = {
                leaders: [
                    { id: 'L001', name: '王大明', phone: '0912345678', email: 'wang@example.com', engineeringTypes: ['SPC', 'CABINET'] },
                    { id: 'L002', name: '李建國', phone: '0923456789', email: 'lee@example.com', engineeringTypes: ['SPC'] }
                ],
                members: [
                    { id: 'M001', name: '張小華', phone: '0934567890', email: 'zhang@example.com', engineeringTypes: ['SPC'] },
                    { id: 'M002', name: '陳志明', phone: '0945678901', email: 'chen@example.com', engineeringTypes: ['CABINET'] },
                    { id: 'M003', name: '林美玲', phone: '0956789012', email: 'lin@example.com', engineeringTypes: ['SPC', 'CABINET'] }
                ],
                owners: [
                    { id: 'O001', name: '黃總經理', phone: '0967890123', email: 'huang@company.com', engineeringTypes: ['ALL'] }
                ]
            };
        }

        // Update display
        function updateDisplay() {
            // Update counts
            document.getElementById('leadersCount').textContent = teamData.leaders.length;
            document.getElementById('membersCount').textContent = teamData.members.length;
            document.getElementById('ownersCount').textContent = teamData.owners.length;

            // Display current tab content
            displayTeamMembers();
        }

        // Display team members
        function displayTeamMembers() {
            const container = document.getElementById('teamContent');
            const members = teamData[currentTab] || [];
            
            if (members.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">👥</div>
                        <div class="empty-title">尚無${getRoleLabel(currentTab)}</div>
                        <div class="empty-desc">點擊上方「新增人員」按鈕加入${getRoleLabel(currentTab)}</div>
                    </div>
                `;
                return;
            }

            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredMembers = members.filter(member => 
                member.name.toLowerCase().includes(searchTerm) ||
                member.phone.includes(searchTerm)
            );

            const html = `
                <div class="team-grid">
                    ${filteredMembers.map(member => createMemberCard(member)).join('')}
                </div>
            `;
            container.innerHTML = html;
        }

        // Create member card
        function createMemberCard(member) {
            const roleClass = currentTab === 'leaders' ? 'role-leader' : 
                             currentTab === 'members' ? 'role-member' : 'role-owner';
            
            const engineeringLabel = member.engineeringTypes.includes('ALL') ? '全部工程' :
                member.engineeringTypes.map(type => type === 'SPC' ? 'SPC' : '浴櫃').join(', ');

            return `
                <div class="member-card">
                    <div class="member-header">
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-phone">${member.phone}</div>
                        </div>
                        <span class="member-role ${roleClass}">${getRoleLabel(currentTab)}</span>
                    </div>
                    <div class="member-details">
                        <div class="detail-item">
                            <span>📧</span> ${member.email || '未設定'}
                        </div>
                        <div class="detail-item">
                            <span>🔧</span> ${engineeringLabel}
                        </div>
                    </div>
                    <div class="member-actions">
                        <button class="btn-small" onclick="editMember('${member.id}')">編輯</button>
                        <button class="btn-small btn-danger" onclick="removeMember('${member.id}')">移除</button>
                    </div>
                </div>
            `;
        }

        // Get role label
        function getRoleLabel(role) {
            const labels = {
                leaders: '工班負責人',
                members: '工班成員',
                owners: '業主'
            };
            return labels[role] || role;
        }

        // Switch tab
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab styles
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Display content
            displayTeamMembers();
        }

        // Filter members
        function filterMembers() {
            displayTeamMembers();
        }

        // Open add modal
        function openAddModal() {
            document.getElementById('addMemberModal').classList.add('active');
            document.getElementById('memberRole').value = currentTab === 'owners' ? 'owner' : currentTab.slice(0, -1);
            updatePermissionOptions();
        }

        // Close add modal
        function closeAddModal() {
            document.getElementById('addMemberModal').classList.remove('active');
            document.getElementById('addMemberForm').reset();
        }

        // Update permission options
        function updatePermissionOptions() {
            const role = document.getElementById('memberRole').value;
            const permissionSettings = document.getElementById('permissionSettings');
            
            // 業主只能查看，不能編輯
            if (role === 'owner') {
                permissionSettings.style.display = 'none';
            } else {
                permissionSettings.style.display = 'block';
            }
        }

        // Save member
        async function saveMember() {
            const name = document.getElementById('memberName').value;
            const phone = document.getElementById('memberPhone').value;
            const email = document.getElementById('memberEmail').value;
            const role = document.getElementById('memberRole').value;
            
            if (!name || !phone) {
                alert('請填寫必要欄位');
                return;
            }

            // 檢查手機格式
            if (!/^09\d{8}$/.test(phone)) {
                alert('請輸入正確的手機號碼格式');
                return;
            }

            // 收集工程類型權限
            const engineeringTypes = [];
            if (document.getElementById('permSPC').checked) engineeringTypes.push('SPC');
            if (document.getElementById('permCabinet').checked) engineeringTypes.push('CABINET');
            
            if (engineeringTypes.length === 0) {
                alert('請至少選擇一個工程類型');
                return;
            }

            const memberData = {
                id: `${role.charAt(0).toUpperCase()}${Date.now()}`,
                name,
                phone,
                email,
                role,
                engineeringTypes,
                canEdit: document.getElementById('canEdit')?.checked || false,
                canViewOthers: document.getElementById('canViewOthers')?.checked || false
            };

            try {
                // TODO: 呼叫 API 儲存
                const token = localStorage.getItem('auth_token') || 'demo-token';
                
                // 暫時使用本地更新
                const roleKey = role === 'leader' ? 'leaders' : 
                               role === 'member' ? 'members' : 'owners';
                teamData[roleKey].push(memberData);
                
                updateDisplay();
                closeAddModal();
                alert('人員新增成功！密碼為手機末3碼');
            } catch (error) {
                console.error('Error saving member:', error);
                alert('儲存失敗，請稍後再試');
            }
        }

        // Edit member
        function editMember(memberId) {
            alert('編輯功能開發中...');
        }

        // Remove member
        async function removeMember(memberId) {
            if (!confirm('確定要移除此人員嗎？')) return;

            try {
                // TODO: 呼叫 API 移除
                
                // 暫時使用本地更新
                for (let key in teamData) {
                    teamData[key] = teamData[key].filter(m => m.id !== memberId);
                }
                
                updateDisplay();
                alert('人員已移除');
            } catch (error) {
                console.error('Error removing member:', error);
                alert('移除失敗，請稍後再試');
            }
        }

        // Go back
        function goBack() {
            if (projectId) {
                window.location.href = `project-details.html?id=${projectId}`;
            } else {
                window.location.href = 'project-list.html';
            }
        }
    </script>
</body>
</html>