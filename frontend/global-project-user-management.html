<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å±€å°ˆæ¡ˆç”¨æˆ¶ç®¡ç† - å…ƒå¿ƒå»ºæå·¥ç¨‹ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .role-admin { background: #3b82f6; }
        .role-owner { background: #059669; }
        .role-leader { background: #dc2626; }
        .role-member { background: #6b7280; }
        .role-foreman { background: #dc2626; }
        .role-worker { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">å…¨å±€å°ˆæ¡ˆç”¨æˆ¶ç®¡ç†</h1>
                        <p class="text-sm text-gray-600 mt-1">ç®¡ç†æ‰€æœ‰å°ˆæ¡ˆä¸­çš„ç”¨æˆ¶è§’è‰²åˆ†é…</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="exportData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            ğŸ“Š åŒ¯å‡ºè³‡æ–™
                        </button>
                        <a href="project-list.html" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                            â† è¿”å›é¦–é 
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex flex-wrap gap-4 items-center">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœå°‹ç”¨æˆ¶</label>
                        <input type="text" id="searchInput" placeholder="æœå°‹å§“åæˆ–æ‰‹æ©Ÿè™Ÿç¢¼..." 
                               class="w-64 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å°ˆæ¡ˆç¯©é¸</label>
                        <select id="projectFilter" class="w-48 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">æ‰€æœ‰å°ˆæ¡ˆ</option>
                            <!-- Projects will be loaded here -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è§’è‰²ç¯©é¸</label>
                        <select id="roleFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">æ‰€æœ‰è§’è‰²</option>
                            <option value="admin">ç®¡ç†å“¡</option>
                            <option value="owner">æ¥­ä¸»</option>
                            <option value="leader">å·¥ç­è² è²¬äºº</option>
                            <option value="member">å·¥ç­æˆå“¡</option>
                            <option value="foreman">å·¥ç­é•·</option>
                            <option value="worker">å·¥äºº</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å·¥ç­ç¯©é¸</label>
                        <select id="teamFilter" class="w-32 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">æ‰€æœ‰å·¥ç­</option>
                            <!-- Teams will be loaded here -->
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="applyFilters()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                            æœå°‹
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="text-2xl font-bold text-blue-600" id="totalUsers">-</div>
                    <div class="text-sm text-gray-600">ç¸½ç”¨æˆ¶æ•¸</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="text-2xl font-bold text-green-600" id="totalProjects">-</div>
                    <div class="text-sm text-gray-600">åƒèˆ‡å°ˆæ¡ˆæ•¸</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="text-2xl font-bold text-red-600" id="totalAssignments">-</div>
                    <div class="text-sm text-gray-600">è§’è‰²åˆ†é…æ•¸</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <div class="text-2xl font-bold text-purple-600" id="totalTeams">-</div>
                    <div class="text-sm text-gray-600">å·¥ç­æ•¸é‡</div>
                </div>
            </div>

            <!-- Project Users Table -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">å°ˆæ¡ˆç”¨æˆ¶åˆ†é…</h2>
                    <p class="text-sm text-gray-600" id="assignmentCount">è¼‰å…¥ä¸­...</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”¨æˆ¶è³‡è¨Š</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å°ˆæ¡ˆ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è§’è‰²</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å·¥ç­</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ†é…æ™‚é–“</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="assignmentsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Assignments will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="text-center py-8">
                    <div class="text-gray-500">è¼‰å…¥å°ˆæ¡ˆç”¨æˆ¶è³‡æ–™ä¸­...</div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-8" style="display: none;">
                    <div class="text-gray-500">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å°ˆæ¡ˆç”¨æˆ¶åˆ†é…</div>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex justify-center mt-6" style="display: none;">
                <div class="flex gap-2">
                    <button onclick="previousPage()" id="prevBtn" class="px-3 py-2 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50">
                        ä¸Šä¸€é 
                    </button>
                    <span id="pageInfo" class="px-3 py-2 text-sm text-gray-700"></span>
                    <button onclick="nextPage()" id="nextBtn" class="px-3 py-2 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50">
                        ä¸‹ä¸€é 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="js/unified-auth.js"></script>
    <script>
        let currentAssignments = [];
        let allProjects = [];
        let allTeams = [];
        let currentPage = 1;
        const pageSize = 50;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadInitialData();
            setupEventListeners();
        });

        async function checkAuth() {
            const token = localStorage.getItem('token') || localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = 'login-simple.html';
                return;
            }

            // Check if user is admin or super admin
            try {
                const response = await fetch(`${CONFIG.API.WORKER_API_URL}/api/v1/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    if (!['super_admin', 'admin'].includes(user.global_role)) {
                        alert('åªæœ‰ç®¡ç†å“¡å¯ä»¥è¨ªå•æ­¤é é¢');
                        window.location.href = 'project-list.html';
                        return;
                    }
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'login-simple.html';
            }
        }

        async function loadInitialData() {
            try {
                await Promise.all([
                    loadProjects(),
                    loadAssignments(),
                    loadTeams()
                ]);
                updateStatistics();
            } catch (error) {
                console.error('Error loading initial data:', error);
                document.getElementById('loadingState').innerHTML = '<div class="text-red-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</div>';
            }
        }

        async function loadProjects() {
            const token = localStorage.getItem('token') || localStorage.getItem('auth_token');
            const response = await fetch(`${CONFIG.API.WORKER_API_URL}/api/v1/projects`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                allProjects = await response.json();
                populateProjectFilter();
            }
        }

        async function loadAssignments() {
            try {
                const token = localStorage.getItem('token') || localStorage.getItem('auth_token');
                const response = await fetch(`${CONFIG.API.WORKER_API_URL}/api/v1/admin/project-users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    currentAssignments = await response.json();
                    renderAssignments(currentAssignments);
                    updateAssignmentCount(currentAssignments.length);
                } else {
                    throw new Error('Failed to load assignments');
                }
            } catch (error) {
                console.error('Error loading assignments:', error);
                document.getElementById('loadingState').innerHTML = '<div class="text-red-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</div>';
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        async function loadTeams() {
            const token = localStorage.getItem('token') || localStorage.getItem('auth_token');
            try {
                const response = await fetch(`${CONFIG.API.WORKER_API_URL}/api/v1/admin/teams`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    allTeams = await response.json();
                    populateTeamFilter();
                }
            } catch (error) {
                console.error('Error loading teams:', error);
            }
        }

        function populateProjectFilter() {
            const select = document.getElementById('projectFilter');
            select.innerHTML = '<option value="">æ‰€æœ‰å°ˆæ¡ˆ</option>';
            
            allProjects.forEach(project => {
                select.innerHTML += `<option value="${project.id}">${project.name}</option>`;
            });
        }

        function populateTeamFilter() {
            const select = document.getElementById('teamFilter');
            select.innerHTML = '<option value="">æ‰€æœ‰å·¥ç­</option>';
            
            // Get unique team names
            const uniqueTeams = [...new Set(allTeams.map(team => team.name).filter(Boolean))];
            uniqueTeams.forEach(teamName => {
                select.innerHTML += `<option value="${teamName}">${teamName}</option>`;
            });
        }

        function renderAssignments(assignments) {
            const tbody = document.getElementById('assignmentsTableBody');
            
            if (assignments.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            
            tbody.innerHTML = assignments.map(assignment => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div>
                            <div class="font-medium text-gray-900">${assignment.user_name || 'æœªè¨­å®š'}</div>
                            <div class="text-sm text-gray-500">${assignment.phone || assignment.user_phone || 'æœªè¨­å®š'}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">${assignment.project_name || 'æœªçŸ¥å°ˆæ¡ˆ'}</div>
                        <div class="text-sm text-gray-500">ID: ${assignment.project_id}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full text-white role-${assignment.role}">
                            ${getRoleDisplayName(assignment.role)}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${assignment.team_name || '-'}</div>
                        ${assignment.team_id ? `<div class="text-xs text-gray-500">ID: ${assignment.team_id}</div>` : ''}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        ${assignment.created_at ? new Date(assignment.created_at).toLocaleDateString('zh-TW') : 'æœªçŸ¥'}
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="removeAssignment(${assignment.project_id}, ${assignment.user_id}, '${assignment.user_name}', '${assignment.project_name}')" 
                                class="text-sm px-3 py-1 rounded bg-red-100 text-red-700 hover:bg-red-200 transition-colors">
                            ç§»é™¤
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getRoleDisplayName(role) {
            const roles = {
                'admin': 'ç®¡ç†å“¡',
                'owner': 'æ¥­ä¸»',
                'leader': 'å·¥ç­è² è²¬äºº',
                'member': 'å·¥ç­æˆå“¡',
                'foreman': 'å·¥ç­é•·',
                'worker': 'å·¥äºº'
            };
            return roles[role] || role;
        }

        function updateAssignmentCount(count) {
            document.getElementById('assignmentCount').textContent = `å…± ${count} å€‹è§’è‰²åˆ†é…`;
        }

        function updateStatistics() {
            // Unique users
            const uniqueUsers = new Set(currentAssignments.map(a => a.user_id)).size;
            document.getElementById('totalUsers').textContent = uniqueUsers;

            // Unique projects
            const uniqueProjects = new Set(currentAssignments.map(a => a.project_id)).size;
            document.getElementById('totalProjects').textContent = uniqueProjects;

            // Total assignments
            document.getElementById('totalAssignments').textContent = currentAssignments.length;

            // Unique teams
            const uniqueTeams = new Set(currentAssignments.map(a => a.team_name).filter(Boolean)).size;
            document.getElementById('totalTeams').textContent = uniqueTeams;
        }

        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('input', applyFilters);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const projectFilter = document.getElementById('projectFilter').value;
            const roleFilter = document.getElementById('roleFilter').value;
            const teamFilter = document.getElementById('teamFilter').value;

            const filtered = currentAssignments.filter(assignment => {
                const matchesSearch = !searchTerm || 
                    assignment.user_name?.toLowerCase().includes(searchTerm) || 
                    assignment.phone?.includes(searchTerm) ||
                    assignment.user_phone?.includes(searchTerm) ||
                    assignment.project_name?.toLowerCase().includes(searchTerm);
                
                const matchesProject = !projectFilter || assignment.project_id == projectFilter;
                const matchesRole = !roleFilter || assignment.role === roleFilter;
                const matchesTeam = !teamFilter || assignment.team_name === teamFilter;

                return matchesSearch && matchesProject && matchesRole && matchesTeam;
            });

            renderAssignments(filtered);
            updateAssignmentCount(filtered.length);
        }

        async function removeAssignment(projectId, userId, userName, projectName) {
            if (!confirm(`ç¢ºå®šè¦å¾å°ˆæ¡ˆã€Œ${projectName}ã€ä¸­ç§»é™¤ç”¨æˆ¶ã€Œ${userName}ã€å—ï¼Ÿ`)) return;

            try {
                const token = localStorage.getItem('token') || localStorage.getItem('auth_token');
                const response = await fetch(`${CONFIG.API.WORKER_API_URL}/api/v1/projects/${projectId}/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    alert('å·²ç§»é™¤ç”¨æˆ¶');
                    await loadAssignments();
                    updateStatistics();
                } else {
                    const error = await response.json();
                    alert(`ç§»é™¤å¤±æ•—: ${error.error || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (error) {
                console.error('Error removing assignment:', error);
                alert('ç§»é™¤å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        function exportData() {
            const csvData = [
                ['ç”¨æˆ¶å§“å', 'æ‰‹æ©Ÿè™Ÿç¢¼', 'å°ˆæ¡ˆåç¨±', 'è§’è‰²', 'å·¥ç­', 'åˆ†é…æ™‚é–“'],
                ...currentAssignments.map(assignment => [
                    assignment.user_name || '',
                    assignment.phone || assignment.user_phone || '',
                    assignment.project_name || '',
                    getRoleDisplayName(assignment.role),
                    assignment.team_name || '',
                    assignment.created_at ? new Date(assignment.created_at).toLocaleDateString('zh-TW') : ''
                ])
            ];

            const csvContent = csvData.map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å°ˆæ¡ˆç”¨æˆ¶åˆ†é…_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
    </script>
</body>
</html>