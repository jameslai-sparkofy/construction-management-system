<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clerk 測試頁面</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Clerk 認證系統測試</h1>
    
    <div id="status" class="status info">正在初始化...</div>
    
    <div id="info">
        <h2>配置資訊</h2>
        <pre id="config"></pre>
    </div>

    <div id="actions" style="display:none;">
        <h2>操作</h2>
        <button onclick="testSignIn()">測試登入</button>
        <button onclick="testSignOut()">登出</button>
        <button onclick="checkStatus()">檢查狀態</button>
        <button onclick="goToApp()">進入系統</button>
    </div>

    <div id="result">
        <h2>結果</h2>
        <pre id="output">等待操作...</pre>
    </div>

    <!-- 嘗試不同的 Clerk 載入方式 -->
    <script>
        const CLERK_PUBLISHABLE_KEY = 'pk_test_YWJzb2x1dGUtY291Z2FyLTkwLmNsZXJrLmFjY291bnRzLmRldiQ';
        
        // 顯示配置
        document.getElementById('config').textContent = JSON.stringify({
            publishableKey: CLERK_PUBLISHABLE_KEY,
            domain: 'absolute-cougar-90.clerk.accounts.dev',
            environment: 'test'
        }, null, 2);

        // 動態載入 Clerk SDK
        function loadClerkSDK() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://absolute-cougar-90.clerk.accounts.dev/npm/@clerk/clerk-js@latest/dist/clerk.browser.js';
                script.async = true;
                script.crossOrigin = 'anonymous';
                
                script.onload = () => {
                    console.log('Clerk SDK loaded');
                    resolve();
                };
                
                script.onerror = (err) => {
                    console.error('Failed to load Clerk SDK', err);
                    reject(err);
                };
                
                document.head.appendChild(script);
            });
        }

        // 初始化 Clerk
        async function initClerk() {
            const statusEl = document.getElementById('status');
            const outputEl = document.getElementById('output');
            
            try {
                // 載入 SDK
                statusEl.textContent = '載入 Clerk SDK...';
                await loadClerkSDK();
                
                // 等待 Clerk 可用
                statusEl.textContent = '等待 Clerk 初始化...';
                let attempts = 0;
                while (!window.Clerk && attempts < 20) {
                    await new Promise(r => setTimeout(r, 250));
                    attempts++;
                }
                
                if (!window.Clerk) {
                    throw new Error('Clerk 未在預期時間內載入');
                }
                
                // 初始化 Clerk
                statusEl.textContent = '初始化 Clerk...';
                const clerk = new window.Clerk(CLERK_PUBLISHABLE_KEY);
                await clerk.load();
                
                window.clerk = clerk;
                
                statusEl.className = 'status success';
                statusEl.textContent = '✅ Clerk 初始化成功！';
                
                // 顯示狀態
                outputEl.textContent = JSON.stringify({
                    isReady: true,
                    user: clerk.user ? {
                        id: clerk.user.id,
                        email: clerk.user.primaryEmailAddress?.emailAddress
                    } : null,
                    session: clerk.session ? {
                        id: clerk.session.id,
                        status: clerk.session.status
                    } : null
                }, null, 2);
                
                // 顯示操作按鈕
                document.getElementById('actions').style.display = 'block';
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '❌ 錯誤：' + error.message;
                outputEl.textContent = error.stack;
                
                // 提供替代方案
                outputEl.textContent += '\n\n建議：\n';
                outputEl.textContent += '1. 檢查網路連線\n';
                outputEl.textContent += '2. 確認 Clerk 服務狀態\n';
                outputEl.textContent += '3. 使用傳統登入方式';
            }
        }

        // 測試登入
        async function testSignIn() {
            const outputEl = document.getElementById('output');
            
            if (!window.clerk) {
                outputEl.textContent = '錯誤：Clerk 未初始化';
                return;
            }
            
            try {
                // 開啟登入視窗
                await window.clerk.openSignIn({
                    afterSignInUrl: '/project-list.html'
                });
                
                outputEl.textContent = '登入視窗已開啟';
            } catch (error) {
                outputEl.textContent = '登入錯誤：' + error.message;
            }
        }

        // 登出
        async function testSignOut() {
            const outputEl = document.getElementById('output');
            
            if (!window.clerk) {
                outputEl.textContent = '錯誤：Clerk 未初始化';
                return;
            }
            
            try {
                await window.clerk.signOut();
                outputEl.textContent = '已登出';
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                outputEl.textContent = '登出錯誤：' + error.message;
            }
        }

        // 檢查狀態
        function checkStatus() {
            const outputEl = document.getElementById('output');
            
            if (!window.clerk) {
                outputEl.textContent = '錯誤：Clerk 未初始化';
                return;
            }
            
            outputEl.textContent = JSON.stringify({
                user: window.clerk.user ? {
                    id: window.clerk.user.id,
                    email: window.clerk.user.primaryEmailAddress?.emailAddress,
                    fullName: window.clerk.user.fullName
                } : null,
                session: window.clerk.session ? {
                    id: window.clerk.session.id,
                    status: window.clerk.session.status,
                    lastActiveAt: window.clerk.session.lastActiveAt
                } : null,
                client: {
                    isReady: window.clerk.isReady(),
                    sessionList: window.clerk.client?.sessions?.length || 0
                }
            }, null, 2);
        }

        // 進入系統
        function goToApp() {
            if (window.clerk?.user) {
                window.location.href = 'project-list.html';
            } else {
                alert('請先登入');
            }
        }

        // 開始初始化
        initClerk();
    </script>
</body>
</html>